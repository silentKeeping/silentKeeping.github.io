[{"content":"","date":"12 September 2023","permalink":"/tags/bpftrace/","section":"Tags","summary":"","title":"bpftrace"},{"content":"","date":"12 September 2023","permalink":"/tags/linux/","section":"Tags","summary":"","title":"Linux"},{"content":"","date":"12 September 2023","permalink":"/tags/","section":"Tags","summary":"","title":"Tags"},{"content":"","date":"12 September 2023","permalink":"/tags/tcp/","section":"Tags","summary":"","title":"TCP"},{"content":"ğŸ™‹â€â™‚ï¸Hello,æˆ‘æ˜¯ğŸ‘¨â€ğŸ’»FeixiangFu\nğŸ®èµ„æ·±DOTA2äº‘ç©å®¶ğŸ‡¨ğŸ‡³CN Dota Best DotağŸ’¯ğŸ’¯ğŸ’¯\nğŸ®èµ„æ·±ç‹è€…å†œè¯ğŸ…æ‰‹æ®‹é€‰æ‰‹ğŸŒš ğŸ†’\nğŸ¤æ„Ÿå…´è¶£å¯ä»¥ä¸€èµ·äº¤æµå­¦ä¹  ğŸ˜Š\n","date":"12 September 2023","permalink":"/","section":"Welcome to feixiang's blog ğŸ‰","summary":"ğŸ™‹â€â™‚ï¸Hello,æˆ‘æ˜¯ğŸ‘¨â€ğŸ’»FeixiangFu\nğŸ®èµ„æ·±DOTA2äº‘ç©å®¶ğŸ‡¨ğŸ‡³CN Dota Best DotağŸ’¯ğŸ’¯ğŸ’¯\nğŸ®èµ„æ·±ç‹è€…å†œè¯ğŸ…æ‰‹æ®‹é€‰æ‰‹ğŸŒš ğŸ†’\nğŸ¤æ„Ÿå…´è¶£å¯ä»¥ä¸€èµ·äº¤æµå­¦ä¹  ğŸ˜Š","title":"Welcome to feixiang's blog ğŸ‰"},{"content":"","date":"12 September 2023","permalink":"/posts/","section":"åšå®¢","summary":"","title":"åšå®¢"},{"content":"èƒŒæ™¯ # æœåŠ¡podå®ä¾‹è®¿é—®å¯¹æ–¹æ¥å£é¢‘ç¹è¶…æ—¶ï¼Œå¼•èµ·å®¢è¯‰ã€‚æˆ‘ä»¬é€šè¿‡ä¸“çº¿ä¸å¯¹æ–¹æœºæˆ¿äº’è”ï¼Œå¹¶ä¸”ä¸“çº¿æ¥å…¥ä¾§éƒ¨ç½²æœ‰ä¸“ç”¨ç‰©ç†è®¾å¤‡(vpnåŠ å¯†é€šé“)ï¼Œæ¶æ„å›¾å¦‚ä¸‹ é—®é¢˜åˆ†æ # å®¢æˆ·ç«¯è¯·æ±‚æŠ“åŒ… # å¯¹æœåŠ¡podå®ä¾‹æŠ“åŒ…åˆ†æï¼Œå‘ç°è¶…æ—¶çš„httpè¯·æ±‚å‡ä¸ºå‘é€synåŒ…æ— å“åº”å¯¼è‡´tcpè¿æ¥å»ºç«‹å¤±è´¥è¶…æ—¶ã€‚åŒæ—¶ä¸“çº¿ç½‘ç»œç›‘æ§æ¯”è¾ƒç¨³ï¼Œå¯ä»¥æ’é™¤ä¸“çº¿ç½‘ç»œä¸¢åŒ…çš„åŸå›  å¯¹æ–¹æœåŠ¡å™¨æŠ“åŒ… # è”ç³»å¯¹æ–¹ååŠ©åœ¨serveræœºå™¨ä¸ŠæŠ“åŒ…ï¼Œåˆ†æå¯¹æ–¹æä¾›çš„æŠ“åŒ…æ–‡ä»¶:\nå®¢æˆ·ç«¯è¯·æ±‚ç»è¿‡é˜²ç«å¢™SNATåï¼Œå¯¹æ–¹serverçœ‹åˆ°çš„å®¢æˆ·ç«¯IPéƒ½ä¸€æ · æœåŠ¡å™¨ä¸Šæ”¶åˆ°äº†SYNåŒ…ï¼Œä½†æ˜¯å›å¤çš„æ˜¯ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACKåŒ… è¶…æ—¶é‡ä¼ éƒ½å‘ç”Ÿåœ¨å®¢æˆ·ç«¯è¯·æ±‚æºç«¯å£å¤ç”¨æ—¶(åå‡ ç§’~ä¹åå‡ ç§’) clientå¤ç”¨ç«¯å£æ—¶ï¼Œå¯¹æ¯”serverå‘é€çš„ACKåŒ…å’Œç›¸åŒäº”å…ƒç»„TCPè¿æ¥æ–­å¼€æ—¶å‘é€çš„æœ€åä¸€ä¸ªACKåŒ…ï¼ŒAcknowledgment numberæ˜¯ç›¸åŒçš„ HTTP response headerä¸­åŒ…å«Connection: closeï¼Œserveråªæ”¯æŒhttp1.0çŸ­è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåserverä¸»åŠ¨æ–­å¼€TCPè¿æ¥å¹¶è¿›å…¥TIME-WAITçŠ¶æ€ æ ¹æ®ä»¥ä¸Šåˆ†ææ¨æ–­ï¼Œå¯¹äºæ–°è¯·æ±‚serverç«¯å¤ç”¨äº†ä¹‹å‰çš„TCPè¿æ¥ï¼ŒTCPè¿æ¥å¤„äºTIME-WAITçŠ¶æ€\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œserverå›å¤äº†ACKåŒ…ï¼Œå®¢æˆ·ç«¯ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°ï¼Ÿ é€šè¿‡åœ¨ä¸“ç”¨è®¾å¤‡ä¸ŠæŠ“åŒ…åˆ†æï¼Œå‘ç°æ”¶åˆ°äº†ACKå›åŒ…ï¼Œæ¨æµ‹æ˜¯è¢«é˜²ç«å¢™dropã€‚å› ä¸ºé˜²ç«å¢™TCPè¿æ¥TIME-WAITçŠ¶æ€timeoutæ—¶é—´ä¸º1sï¼Œå¯¹äºå®¢æˆ·ç«¯æ–°è¯·æ±‚SYNåŒ…ï¼Œä¼šæ–°å»ºtcp sessionï¼Œæ”¶åˆ°server ACKå›åŒ…åï¼Œè®¤ä¸ºéæ³•å°±dropäº†\nè§£å†³æ–¹æ¡ˆ # æ”¯æŒHTTP1.1é•¿è¿æ¥ # æ¥å£æ”¯æŒhttp1.1é•¿è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåä¼šä¸»åŠ¨æ–­å¼€TCPè¿æ¥ï¼ŒTIME-WAITçŠ¶æ€ç»´æŒåœ¨å®¢æˆ·ç«¯ã€‚å¯¹æ–¹åé¦ˆæ— æ³•æ”¯æŒ\nå¢åŠ é˜²ç«å¢™SNATåœ°å€æ±  # å½“å‰ä¸šåŠ¡çš„é˜²ç«å¢™ç­–ç•¥çš„SNAT IP Poolåªæœ‰ä¸€ä¸ª3.3.10.10ï¼Œå°è¯•å†å¢åŠ ä¸€ä¸ª3.3.10.11ï¼Œå‘ç°é˜²ç«å¢™å¹¶æ²¡æœ‰è½®è¯¢ä½¿ç”¨ã€‚æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºå½“å‰åœ¨ç”¨çš„IP Poolç±»å‹ä¸ºoverloadï¼Œä¼šæ ¹æ®å®¢æˆ·ç«¯IPåˆ†é…snatåœ°å€ã€‚æ¯”èµ·å·§åˆçš„æ˜¯å½“å‰å®¢æˆ·ç«¯å››ä¸ªpod ip è®¡ç®—å‡ºæ¥éƒ½ä¼šä½¿ç”¨3.3.10.10ã€‚æ‰€ä»¥å®¢æˆ·ç«¯pod IPéšæœºåˆ†é…ï¼Œæœ€ç»ˆä½¿ç”¨snatåœ°å€ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼Œè€ƒè™‘æŠŠSNAT IP Poolåˆ‡æ¢ä¸º one-to-oneç±»å‹\none-to-oneæ¨¡å¼æ˜¯: å†…éƒ¨ IP åœ°å€å’Œå¤–éƒ¨ï¼ˆè½¬æ¢åçš„ï¼‰IP åœ°å€ä¸€å¯¹ä¸€åŒ¹é…\né…ç½®ä¸€ä¸ª28ä½çš„æ–°åœ°å€æ± ä¹‹åï¼Œè¶…æ—¶è¯·æ±‚ç‡å¤§å¹…é™ä½ã€‚ä½†æ˜¯one-to-one IP poolå¹¶ä¸æ˜¯é™æ€SNATï¼Œæ‰€ä»¥æ¯æ¬¡å®¢æˆ·ç«¯è¯·æ±‚ç»“æŸåï¼Œä¼šé‡Šæ”¾snat IPåˆ°æ± å­é‡Œï¼Œè¿˜æ˜¯æœ‰ä¸€å®šå‡ ç‡è¶…æ—¶ã€‚\nå¦‚æœè¦å½»åº•è§£å†³ï¼Œéœ€è¦ç‰©ç†æœºæˆ–è™šæœºéƒ¨ç½²å›ºå®šIPï¼Œç„¶åé…ç½®é˜²ç«å¢™é…ç½®é™æ€SNAT\nå†…æ ¸æºç çœ‹TIME_WAITè¿æ¥å¤„ç† # ä¸ºä»€ä¹ˆä¼šè¿”å›ACK? ä»å†…æ ¸æºç ä¸­æ‰¾ç­”æ¡ˆï¼Œå†…æ ¸ç‰ˆæœ¬3.10.0-1062\ntcp_v4_rcv() # tcp_v4_rcvå‡½æ•°è´Ÿè´£æ¥æ”¶å’Œå¤„ç†ä¼ å…¥çš„TCP ipv4 æ•°æ®åŒ…\nint tcp_v4_rcv(struct sk_buff *skb) { const struct iphdr *iph; const struct tcphdr *th; struct sock *sk; /* ä¸­é—´çœç•¥ */ process: // TCPè¿æ¥å¤„äºTIMT_WAITçŠ¶æ€æ—¶ï¼Œè·³è½¬åˆ°do_time_wait if (sk-\u0026gt;sk_state == TCP_TIME_WAIT) goto do_time_wait; /* ä¸­é—´çœç•¥ */ do_time_wait: /* ä¸­é—´çœç•¥ */ // æ ¹æ®tcp_timewait_state_processå‡½æ•°è¿”å›å€¼ï¼Œç¡®å®šä¸‹ä¸€æ­¥åŠ¨ä½œ switch (tcp_timewait_state_process(inet_twsk(sk), skb, th)) { // åˆæ³•SYNåŒ…ï¼Œå¯ä»¥å¤ç”¨TCPè¿æ¥ï¼ŒtcpçŠ¶æ€å¯ä»¥åˆ‡æ¢è‡³SYN_RECV case TCP_TW_SYN: { struct sock *sk2 = inet_lookup_listener(dev_net(skb-\u0026gt;dev), \u0026amp;tcp_hashinfo, iph-\u0026gt;saddr, th-\u0026gt;source, iph-\u0026gt;daddr, th-\u0026gt;dest, inet_iif(skb)); if (sk2) { inet_twsk_deschedule(inet_twsk(sk), \u0026amp;tcp_death_row); inet_twsk_put(inet_twsk(sk)); sk = sk2; goto process; } /* Fall through to ACK */ } /* å‘é€ACKåŒ… 1.TCP_FIN_WAIT2çŠ¶æ€æ”¶åˆ°FINåŒ…ï¼Œå‘é€æœ€åä¸€æ¬¡æŒ¥æ‰‹çš„ACKåŒ… 2.TCP_TIME_WAITçŠ¶æ€ä¸‹å‘é€ä¸Šä¸€æ¬¡çš„ACKåŒ… */ case TCP_TW_ACK: tcp_v4_timewait_ack(sk, skb); break; // å‘é€RESETåŒ… case TCP_TW_RST: tcp_v4_send_reset(sk, skb); inet_twsk_deschedule(inet_twsk(sk), \u0026amp;tcp_death_row); inet_twsk_put(inet_twsk(sk)); goto discard_it; // ç›´æ¥ä¸¢å¼ƒï¼Œä¸åšå¤„ç† case TCP_TW_SUCCESS:; } goto discard_it; } ç»“åˆä¸Šé¢çš„åœºæ™¯ï¼Œserverå¤„ç†æµç¨‹åº”è¯¥æ˜¯: æ”¶åˆ°SYNåŒ…ï¼ŒtcpçŠ¶æ€ä¸ºTCP_TIME_WAITï¼Œtcp_timewait_state_process()å‡½æ•°å¤„ç†å¹¶è¿”å›äº†TCP_TW_ACK\ntcp_timewait_state_process() # tcp_timewait_state_process() å‡½æ•°å¤„ç†\ntcp_timewait_state_process(struct inet_timewait_sock *tw, struct sk_buff *skb, const struct tcphdr *th) { struct tcp_options_received tmp_opt; struct tcp_timewait_sock *tcptw = tcp_twsk((struct sock *)tw); bool paws_reject = false; tmp_opt.saw_tstamp = 0; // tcp headerä¸­å¼€å¯äº†optionsä¸”å½“å‰tcpè¿æ¥å¼€å¯äº†æ—¶é—´æˆ³é€‰é¡¹ if (th-\u0026gt;doff \u0026gt; (sizeof(*th) \u0026gt;\u0026gt; 2) \u0026amp;\u0026amp; tcptw-\u0026gt;tw_ts_recent_stamp) { tcp_parse_options(skb, \u0026amp;tmp_opt, 0, NULL); if (tmp_opt.saw_tstamp) { if (tmp_opt.rcv_tsecr) tmp_opt.rcv_tsecr -= tcptw-\u0026gt;tw_ts_offset; tmp_opt.ts_recent\t= tcptw-\u0026gt;tw_ts_recent; tmp_opt.ts_recent_stamp\t= tcptw-\u0026gt;tw_ts_recent_stamp; /* å¦‚æœå¼€å¯äº†TCP timestampå¯é€‰é¡¹ï¼Œåˆ¤æ–­æ˜¯å¦å‘ç”Ÿæ—¶é—´æˆ³å›ç»• 1. paws_reject = false æ—¶é—´æˆ³æ²¡æœ‰å›ç»• 2. paws_reject = true æ—¶é—´æˆ³å›ç»• */ paws_reject = tcp_paws_reject(\u0026amp;tmp_opt, th-\u0026gt;rst); } } // tcpçŠ¶æ€æ˜¯FIN_WAIT2çš„å¤„ç†é€»è¾‘ if (tw-\u0026gt;tw_substate == TCP_FIN_WAIT2) { /* ä¸­é—´çœç•¥ */ } // æ—¶é—´æˆ³æ²¡æœ‰å›ç»• if (!paws_reject \u0026amp;\u0026amp; // æŠ¥æ–‡åºåˆ—å· ç­‰äº é¢„æœŸæ¥æ”¶çš„åºåˆ—å· (TCP_SKB_CB(skb)-\u0026gt;seq == tcptw-\u0026gt;tw_rcv_nxt \u0026amp;\u0026amp; /* TCP_SKB_CB(skb)-\u0026gt;end_seq = (TCP_SKB_CB(skb)-\u0026gt;seq + th-\u0026gt;syn + th-\u0026gt;fin + skb-\u0026gt;len - th-\u0026gt;doff * 4); æ²¡æœ‰æºå¸¦æ•°æ®æŠ¥æ–‡ï¼Œåªæœ‰tcp headerä¸”æ²¡æœ‰syn/finæ ‡å¿—ä½ï¼Œåªèƒ½æ˜¯resetæˆ–è€…ack */ (TCP_SKB_CB(skb)-\u0026gt;seq == TCP_SKB_CB(skb)-\u0026gt;end_seq || th-\u0026gt;rst))) { /* In window segment, it may be only reset or bare ack. */ if (th-\u0026gt;rst) { // net.ipv4.tcp_rfc1337å†…æ ¸å‚æ•°ç­‰äº0æ—¶ if (sysctl_tcp_rfc1337 == 0) { kill: //æ¸…ç†TIME_WAITè¿æ¥ inet_twsk_deschedule(tw, \u0026amp;tcp_death_row); inet_twsk_put(tw); return TCP_TW_SUCCESS; } } else { // é‡ç½®TIME_WAITçŠ¶æ€timeoutæ—¶é—´ inet_twsk_schedule(tw, \u0026amp;tcp_death_row, TCP_TIMEWAIT_LEN, TCP_TIMEWAIT_LEN); } if (tmp_opt.saw_tstamp) { tcptw-\u0026gt;tw_ts_recent\t= tmp_opt.rcv_tsval; tcptw-\u0026gt;tw_ts_recent_stamp = get_seconds(); } inet_twsk_put(tw); return TCP_TW_SUCCESS; } // SYNåŒ…ä¸”æ²¡æœ‰rst/ackæ ‡å¿—ä½ï¼Œæ—¶é—´æˆ³æ²¡æœ‰å›ç»• if (th-\u0026gt;syn \u0026amp;\u0026amp; !th-\u0026gt;rst \u0026amp;\u0026amp; !th-\u0026gt;ack \u0026amp;\u0026amp; !paws_reject \u0026amp;\u0026amp; // åºåˆ—å·æ²¡æœ‰å›ç»• æˆ–è€… (after(TCP_SKB_CB(skb)-\u0026gt;seq, tcptw-\u0026gt;tw_rcv_nxt) || // è¯·æ±‚æŠ¥æ–‡ä¸­å¼€å¯timestampå¯é€‰é¡¹å¹¶ä¸”æ—¶é—´æˆ³æ²¡æœ‰å›ç»• (tmp_opt.saw_tstamp \u0026amp;\u0026amp; (s32)(tcptw-\u0026gt;tw_ts_recent - tmp_opt.rcv_tsval) \u0026lt; 0))) { u32 isn = tcptw-\u0026gt;tw_snd_nxt + 65535 + 2; if (isn == 0) isn++; TCP_SKB_CB(skb)-\u0026gt;tcp_tw_isn = isn; return TCP_TW_SYN; } if (paws_reject) // æ›´æ–° /proc/net/netstat NET_INC_STATS_BH(twsk_net(tw), LINUX_MIB_PAWSESTABREJECTED); if (!th-\u0026gt;rst) { /* In this case we must reset the TIMEWAIT timer. * * If it is ACKless SYN it may be both old duplicate * and new good SYN with random sequence number \u0026lt;rcv_nxt. * Do not reschedule in the last case. */ if (paws_reject || th-\u0026gt;ack) // é‡ç½®TIME_WAITçŠ¶æ€timeoutæ—¶é—´ inet_twsk_schedule(tw, \u0026amp;tcp_death_row, TCP_TIMEWAIT_LEN, TCP_TIMEWAIT_LEN); /* if (*last_oow_ack_time) { s32 elapsed = (s32)(tcp_time_stamp - *last_oow_ack_time); // è®¡ç®—å½“å‰çš„tcp timestamp(jiffies)å’Œä¸Šæ¬¡å‘é€ackæ—¶çš„tcp timestamp å·®å€¼ // å¦‚æœå°äºå†…æ ¸å‚æ•°net.ipv4.tcp_invalid_ratelimit è¡¨ç¤ºé€Ÿç‡è¿‡å¿«ï¼Œéœ€è¦é™é€Ÿ if (0 \u0026lt;= elapsed \u0026amp;\u0026amp; elapsed \u0026lt; sysctl_tcp_invalid_ratelimit) { // æ›´æ–° /proc/net/netstat NET_INC_STATS(net, mib_idx); return true; } } å¦‚æœdupacksæ²¡æœ‰é™é€Ÿ return TCP_TW_ACKï¼Œå¦åˆ™return TCP_TW_SUCCESS */ return tcp_timewait_check_oow_rate_limit( tw, skb, LINUX_MIB_TCPACKSKIPPEDTIMEWAIT); } inet_twsk_put(tw); return TCP_TW_SUCCESS; } th-\u0026gt;doff æ•°æ®åç§»å­—æ®µï¼Œ4-bitçš„æ— ç¬¦å·æ•´å‹(æ•°æ®èŒƒå›´0~15) è¡¨ç¤ºtcp headerçš„é•¿åº¦ï¼Œå•ä½æ˜¯32-bit(å³4 bytes)ï¼ŒèŒƒå›´5~15 tcp header(no options)é•¿åº¦ä¸º5ï¼Œå¤§å° 5 * 32-bit (4 bytes) = 20 bytes\nsizeof(*th) \u0026raquo; 2 tcphdrç»“æ„ä½“å¤§å°æ˜¯20 bytesï¼Œ20 \u0026raquo; 2 = 20 / 4 = 5\næ—¶é—´æˆ³å›ç»•åˆ¤æ–­ # static inline bool tcp_paws_reject(const struct tcp_options_received *rx_opt, int rst) { // tcp_paws_check()å‡½æ•°åˆ¤æ–­æ˜¯å¦é€šè¿‡æ£€æŸ¥ if (tcp_paws_check(rx_opt, 0)) return false; if (rst \u0026amp;\u0026amp; get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_MSL) return false; return true; } static inline bool tcp_paws_check(const struct tcp_options_received *rx_opt, int paws_win) { if ((s32)(rx_opt-\u0026gt;ts_recent - rx_opt-\u0026gt;rcv_tsval) \u0026lt;= paws_win) return true; if (unlikely(get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_24DAYS)) return true; if (!rx_opt-\u0026gt;ts_recent) return true; return false; } (s32)(rx_opt-\u0026gt;ts_recent - rx_opt-\u0026gt;rcv_tsval) \u0026lt;= 0 å½“å‰tcpè¿æ¥serverä¸Šä¸€æ¬¡å‘é€çš„tcpæŠ¥æ–‡ä¸­çš„TSecrå’ŒtcpæŠ¥æ–‡é€‰ä¸­çš„TSvalçš„å·®å€¼å°äºç­‰äº0ï¼Œæ£€æŸ¥é€šè¿‡\ntcp timestampæ˜¯u32æ— ç¬¦å·æ•´å‹ï¼Œæ•°æ®èŒƒå›´0~2^32-1 s32æ˜¯æœ‰ç¬¦åˆæ•´å‹ï¼Œæ•°æ®èŒƒå›´æ˜¯-2^31~2^31-1 u32æ— ç¬¦å·æ•´å‹å‡æ³•ï¼Œå¦‚æœ|x|\u0026gt;yï¼Œåˆ™y-x = 2^32-|x-y| å¯¹u32å·®å€¼åšå¼ºåˆ¶ç±»å‹è½¬æ¢çš„è¯ï¼Œå¦‚æœè¶…è¿‡2^31å°±ä¼šæº¢å‡ºã€‚æ‰€ä»¥rcv_tsval - ts_recent \u0026gt; 2^31æ—¶ï¼Œæ—¶é—´æˆ³å›ç»•æ£€æŸ¥ä¸ä¼šé€šè¿‡ tcp timestampå–å€¼æ¥æºäºjiffiesï¼Œå’ŒæœåŠ¡å™¨è¿è¡Œæ—¶é•¿æœ‰å…³ï¼Œè®°å½•çš„æ˜¯ä»å¼€æœºåˆ°ç°åœ¨æ—¶é—´æˆ³æ—¶é’Ÿæ›´æ–°äº†å¤šå°‘æ¬¡ï¼Œrfcè§„å®šæ›´æ–°é¢‘ç‡æ˜¯1ms~1sï¼ŒæœåŠ¡å™¨é‡å¯åjiffiesé‡ç½®\nCentosä¸­æŸ¥çœ‹å†…æ ¸æ—¶é—´æˆ³æ—¶é’Ÿé¢‘ç‡ï¼Œ1s/1000=1msï¼Œé‚£ä¹ˆ2^31/1000/(3600*24)=24.8å¤©åå›ç»•\n$ cat /boot/config-3.10.0-1062.el7.x86_64 |grep -w \u0026#34;CONFIG_HZ\u0026#34; CONFIG_HZ=1000 get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_24DAYS\n#define TCP_PAWS_24DAYS (60 * 60 * 24 * 24) ï¼Œå•ä½æ˜¯s\nå½“å‰ç³»ç»Ÿæ—¶é—´æˆ³åœ¨tcpè¿æ¥ä¸Šä¸€æ¬¡æ”¶åˆ°rcv_tsvalæ—¶çš„ç³»ç»Ÿæ—¶é—´æˆ³çš„24å¤©ä¹‹åçš„è¯ï¼Œåˆ™æ—¶é—´æˆ³å›ç»•æ£€æŸ¥é€šè¿‡\næ—¶é’Ÿé¢‘ç‡æ˜¯1msï¼Œé‚£ä¹ˆrcv_tsvalå¢åŠ åˆ°æº¢å‡ºçš„æ—¶é—´æ˜¯2^31/1000/(3600*24)=24.8å¤©\næ‰€ä»¥å¢åŠ äº†ä¸€ä¸ªè¶…è¿‡TCP_PAWS_24DAYSçš„åˆ¤æ–­ï¼Œç›´æ¥æ£€æŸ¥é€šè¿‡\nåºåˆ—å·å›ç»•åˆ¤æ–­ # å¯¹äºSYNåŒ…ï¼Œä¼šæ¯”è¾ƒtcpæŠ¥æ–‡çš„åºåˆ—å·æ˜¯å¦å¤§äºtcpè¿æ¥è®°å½•çš„è¦é¢„æœŸæ¥æ”¶çš„åºåˆ—å·\nafter(TCP_SKB_CB(skb)-\u0026gt;seq, tcptw-\u0026gt;tw_rcv_nxt)\n// afterå‡½æ•°å®šä¹‰ static inline bool before(__u32 seq1, __u32 seq2) { return (__s32)(seq1-seq2) \u0026lt; 0; } #define after(seq2, seq1) before(seq1, seq2) (__s32)(seq1-seq2) ä¹Ÿæ˜¯å¯¹u32å·®å€¼å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ŒåŒæ ·å­˜åœ¨æº¢å‡ºæƒ…å†µã€‚æ‰€ä»¥å¦‚æœSYNåŒ…çš„seqæ¯”tcptw-\u0026gt;tw_rcv_nxtå¤§è¶…è¿‡2^31ï¼Œåˆ™è®¤ä¸ºåºåˆ—å·å›ç»•ï¼Œä¸èƒ½å¤ç”¨TIME_WAITè¿æ¥\nç»“åˆä¸Šæ–‡æŠ“åŒ…åˆ†æ,\nseq=2123642848ï¼Œ ack=554887750\nts_recent = 869333586ï¼Œrcv_tsval = 28962444\nä»£ç è¿è¡Œç»“æœæ˜¾ç¤ºï¼Œæ—¶é—´æˆ³å‘ç”Ÿå›ç»•ï¼Œæ‰€ä»¥paws_reject = trueï¼Œè¿”å›äº†TCP_TW_ACK\né—®é¢˜åœºæ™¯æ¨¡æ‹Ÿ # æµ‹è¯•ç¯å¢ƒæ­å»º # æœåŠ¡å™¨éƒ½æ˜¯åŸºäºåŒä¸€ç‰©ç†æœºä¸Škvmè™šæ‹ŸåŒ–éƒ¨ç½²ï¼Œå†…æ ¸ç‰ˆæœ¬ 3.10.0-1062.el7.x86_64\nclient è¯·æ±‚ http://172.16.10.8:80 ,è·¯ç”±è½¬å‘åˆ°firewallï¼ŒfilrewallæœåŠ¡å™¨ä¸Šä½¿ç”¨iptablesé…ç½®snatå’Œdnatï¼Œå†è·¯ç”±è½¬å‘åˆ°gatewayï¼Œgatewayå†è½¬å‘åˆ°server\nrole device ip special route system client-1 eth0 172.16.9.131 172.16.10.8 via 172.16.9.133 dev eth0 centos 7.7 client-2 eth0 172.16.9.132 172.16.10.8 via 172.16.9.133 dev eth0 centos 7.7 firewall eth0 172.16.9.133 centos 7.7 eth1 192.168.102.3 192.168.10.9 via 192.168.102.2 dev eth1 physical gw\n(ä¸“ç”¨è®¾å¤‡) eth0 192.168.102.2 3.3.10.10 via 192.168.102.3 dev eth0 centos 7.7 eth1 192.168.10.8 server eth0 192.168.10.9 3.3.10.10 via 192.168.10.8 dev eth0 centos 7.7 firewallé…ç½® # iptablesé…ç½®snatå’Œdnat\n#dnat æ”¶åˆ°è®¿é—®172.16.10.8:80è¯·æ±‚è·¯ç”±è½¬å‘åˆ°192.168.10.9:80 $ iptables -t nat -A PREROUTING -d 172.16.10.8/32 -i eth0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.10.9:80 #snat è®¿é—®192.168.10.9:80çš„è¯·æ±‚ï¼Œæºåœ°å€è½¬æ¢ä¸º3.3.10.10 $ iptables -t nat -A POSTROUTING -d 192.168.10.9/32 -o eth1 -p tcp -m tcp --dport 80 -j SNAT --to-source 3.3.10.10 å†…æ ¸å‚æ•°\n$ sysctl -w net.ipv4.ip_forward=1 # å‚è€ƒç‰©ç†é˜²ç«å¢™é…ç½® $ systcl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=2 gatewayé…ç½® # ä¸“ç”¨è®¾å¤‡æ˜¯ç”¨äºåŒæ–¹å»ºç«‹vpnåŠ å¯†é€šé“ï¼ŒåŸºäºiptableså¯¹è¯·æ±‚æ‰“æ ‡è®°ã€è½¬å‘åˆ°vpnç½‘å¡ã€‚æµ‹è¯•ç¯å¢ƒåªåŠ äº†conntrackè®°å½•\n$ iptables -t nat -A PREROUTING -m conntrack --ctstate INVALID -j LOG --log-prefix \u0026#34;Conntrack INVALID: \u0026#34; --log-level 7 # conntrackæ—¥å¿—è®°å½•æ–‡ä»¶ $ grep conntrack /etc/rsyslog.conf kern.* /var/log/conntrack.log $ sysctl -w net.ipv4.ip_forward=1 # å‚ç…§ä¸“ç”¨è®¾å¤‡é…ç½® $ systcl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=60 serveré…ç½® # # SimpleHTTPServeré»˜è®¤æ˜¯HTTP/1.0 $ nohup python -m SimpleHTTPServer 80 \u0026amp; é—®é¢˜å¤ç° # client-1è¯·æ±‚ # [root@node1] ~$ curl --local-port 54321 172.16.10.8:80 \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD HTML 3.2 Final//EN\u0026#34;\u0026gt;\u0026lt;html\u0026gt; \u0026lt;title\u0026gt;Directory listing for /\u0026lt;/title\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;Directory listing for /\u0026lt;/h2\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;nohup.out\u0026#34;\u0026gt;nohup.out\u0026lt;/a\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;test.file\u0026#34;\u0026gt;test.file\u0026lt;/a\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; åŒæ—¶serveræŠ“åŒ…\n[root@localhost] $ tcpdump -ieth0 port 80 -nnS 17:08:16.798635 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [S], seq 2851797271, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 9], length 0 17:08:16.798704 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [S.], seq 912495348, ack 2851797272, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 9], length 0 ...çœç•¥... 17:08:16.806065 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [F.], seq 2851797347, ack 912495758, win 60, length 0 17:08:16.806073 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [.], ack 2851797348, win 58, length 0 client-2æ¨¡æ‹Ÿè¯·æ±‚ # serverç«¯çš„æŠ“åŒ…è®°å½•å¯ä»¥çœ‹å‡ºï¼Œtcptw-\u0026gt;tw_rcv_nxt = 2851797348ã€‚ä½¿ç”¨python scapyï¼Œå‘é€ä¸€ä¸ªseqå°äº2851797348çš„SYNåŒ…\n[root@node2] /data0/fake$ python send_test.py 2851797340 [root@node2] /data0/fake$ cat send_test.py #!/usr/bin/python #-*- coding:utf-8 -*- from scapy.all import * import sys if len(sys.argv) \u0026lt; 2: print \u0026#39;lack args\u0026#39; sys.exit() # åˆ›å»ºä¸€ä¸ªIPæ•°æ®åŒ…ï¼Œè®¾ç½®æºIPã€ç›®æ ‡IP ip_packet = IP(src=\u0026#34;172.16.9.132\u0026#34;, dst=\u0026#34;172.16.10.8\u0026#34;) # åˆ›å»ºä¸€ä¸ªTCPæ•°æ®åŒ…ï¼Œè®¾ç½®æºç«¯å£ã€ç›®æ ‡ç«¯å£å’Œåºåˆ—å· tcp_packet = TCP(sport=54321, dport=80,flags=\u0026#39;S\u0026#39;, seq=int(sys.argv[1])) # ç»„è£…æ•°æ®åŒ… syn = ip_packet / tcp_packet send(syn)serverç«¯æŠ“åŒ…è®°å½•å¯ä»¥çœ‹åˆ°ï¼Œå›å¤äº†seqä¸º2851797348ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACK 17:08:24.023783 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [S], seq 2851797340, win 8192, length 0 17:08:24.023842 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [.], ack 2851797348, win 58, length 0 serverç«¯ä½¿ç”¨bpftraceè„šæœ¬æŸ¥çœ‹tcp_timewait_state_process()å‡½æ•°æ”¶åˆ°SYNåŒ…çš„å†…æ ¸å¤„ç†æµç¨‹\n[root@localhost] $ bpftrace trace-time_wait.bt Attaching 4 probes... tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:1,ack:0,fin:0,rst:0], seq:1351613457, ack:0, win:32120, tw_rcv_nxt:1125813282 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_SYN ################################ tcp sockå¤„äºTCP_TIME_WAITçŠ¶æ€ï¼Œæ”¶åˆ°çš„SYNåŒ…seq=1351613457 \u0026gt; tw_rcv_nxt=1125813282ï¼Œå‡½æ•°è¿”å›TCP_TW_SYN\né—®é¢˜å»¶ä¼¸ # å®¢æˆ·ç«¯å‘é€SYNåŒ…åï¼Œæ”¶åˆ°ACKåŒ…ä¼šæ€ä¹ˆå¤„ç†?\næŸ¥çœ‹å†…æ ¸æºç ï¼Œå®¢æˆ·ç«¯å‘é€SYNåï¼ŒçŠ¶æ€åˆ‡æ¢ä¸ºSYN_SENTã€‚æ”¶åˆ°tcpå›åŒ…åçš„å¤„ç†æµç¨‹: tcp_v4_rcv -\u0026gt; tcp_v4_do_rcv -\u0026gt; tcp_rcv_state_process -\u0026gt; tcp_rcv_synsent_state_process\nçœ‹ä¸€ä¸‹tcp_rcv_synsent_state_processå‡½æ•°ï¼Œå¦‚æœæ”¶åˆ°å›åŒ…è®¾ç½®äº†ACKæ ‡å¿—ä½ï¼Œåˆ¤æ–­è¯¥æ•°æ®åŒ…seqå’Œtimestampæ˜¯å¦ç¬¦åˆé¢„æœŸ\n(!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una)\nsnd_unaæ˜¯å¯¹åº”å‘é€çª—å£è®°å½•çš„æœªè¢«ç¡®è®¤çš„seqå·ï¼Œå¦‚æœack_seq =\u0026lt; snd_unaï¼Œè¿”å›reset\nafter(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt))\nsnd_nxtæ˜¯å¯¹åº”å‘é€çª—å£è®°å½•çš„ä¸‹ä¸€æ¬¡å‘é€çš„seqå·ï¼Œå¦‚æœack_seq \u0026gt; snd_nxtï¼Œè¿”å›reset\næ£€æŸ¥é€šè¿‡åï¼Œå¦‚æœæ•°æ®åŒ…è®¾ç½®äº†RSTæ ‡å¿—ä½ï¼Œç›´æ¥ä¸¢å¼ƒï¼ŒtcpçŠ¶æ€åˆ‡æ¢ä¸ºCLOSEã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œç»§ç»­æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†SYNæ ‡å¿—ä½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç›´æ¥ä¸¢å¼ƒã€‚\nstatic int tcp_rcv_synsent_state_process(struct sock *sk, struct sk_buff *skb, const struct tcphdr *th, unsigned int len) { struct inet_connection_sock *icsk = inet_csk(sk); struct tcp_sock *tp = tcp_sk(sk); struct tcp_fastopen_cookie foc = { .len = -1 }; int saved_clamp = tp-\u0026gt;rx_opt.mss_clamp; tcp_parse_options(skb, \u0026amp;tp-\u0026gt;rx_opt, 0, \u0026amp;foc); if (tp-\u0026gt;rx_opt.saw_tstamp \u0026amp;\u0026amp; tp-\u0026gt;rx_opt.rcv_tsecr) tp-\u0026gt;rx_opt.rcv_tsecr -= tp-\u0026gt;tsoffset; if (th-\u0026gt;ack) { /* rfc793: * \u0026#34;If the state is SYN-SENT then * first check the ACK bit * If the ACK bit is set *\tIf SEG.ACK =\u0026lt; ISS, or SEG.ACK \u0026gt; SND.NXT, send * a reset (unless the RST bit is set, if so drop * the segment and return)\u0026#34; */ if (!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una) || after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt)) goto reset_and_undo; if (tp-\u0026gt;rx_opt.saw_tstamp \u0026amp;\u0026amp; tp-\u0026gt;rx_opt.rcv_tsecr \u0026amp;\u0026amp; !between(tp-\u0026gt;rx_opt.rcv_tsecr, tp-\u0026gt;retrans_stamp, tcp_time_stamp)) { NET_INC_STATS_BH(sock_net(sk), LINUX_MIB_PAWSACTIVEREJECTED); goto reset_and_undo; } /* Now ACK is acceptable. * * \u0026#34;If the RST bit is set * If the ACK was acceptable then signal the user \u0026#34;error: * connection reset\u0026#34;, drop the segment, enter CLOSED state, * delete TCB, and return.\u0026#34; */ if (th-\u0026gt;rst) { tcp_reset(sk); goto discard; } /* rfc793: * \u0026#34;fifth, if neither of the SYN or RST bits is set then * drop the segment and return.\u0026#34; * * See note below! * --ANK(990513) */ if (!th-\u0026gt;syn) goto discard_and_undo; ...çœç•¥... æ„é€ è¯·æ±‚ # å¯ä»¥å€ŸåŠ© Scapy_TcpsessionæŒ‡å®štcp sequenceå‘é€httpè¯·æ±‚ï¼Œæ¥å¤ç°\nclient-1 å‘é€tcp seqenceä¸º1çš„httpè¯·æ±‚ [root@nod[root@node1] /data0$ python scapy_http.py 1 [root@nod[root@node1] /data0$ cat scapy_http.py #!/usr/bin/python #-*- coding:utf-8 -*- from Scapy_Tcpsession import TcpSession import sys if len(sys.argv) \u0026lt; 2: print \u0026#39;lack args\u0026#39; sys.exit() sess = TcpSession((\u0026#39;172.16.10.8\u0026#39;,80,int(sys.argv[1]),54321)) sess.connect() http_get=( \u0026#34;GET / HTTP/1.0\\r\\n\u0026#34; \u0026#34;Host: 172.16.10.8:80\\r\\n\u0026#34; \u0026#34;User-Agent: Python Scapy\\r\\n\u0026#34; \u0026#34;Connection: close\\r\\n\\r\\n\u0026#34; ) sess.send(http_get) client-2 è¯·æ±‚172.16.10.8:80å‘ç°è¿”å›æ­£å¸¸ [root@node2] ~$ curl --local-port 54321 172.16.10.8:80 ã€\u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD HTML 3.2 Final//EN\u0026#34;\u0026gt;\u0026lt;html\u0026gt; \u0026lt;title\u0026gt;Directory listing for /\u0026lt;/title\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;Directory listing for /\u0026lt;/h2\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;nohup.out\u0026#34;\u0026gt;nohup.out\u0026lt;/a\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;test.file\u0026#34;\u0026gt;test.file\u0026lt;/a\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; bpftraceè·Ÿè¸ªå†…æ ¸å¤„ç†è¿‡ç¨‹ # ä½¿ç”¨bpftraceå·¥å…·è§‚å¯Ÿä¸‹client-2 æ”¶åˆ°ACKåŒ…çš„å¤„ç†æµç¨‹\n[root@node2] /data0/kernel$ bpftrace synsent.bt #!/usr/bin/env bpftrace #include \u0026lt;linux/tcp.h\u0026gt; #include \u0026lt;net/tcp.h\u0026gt; BEGIN { @tcp_sk_status[2] = \u0026#34;TCP_SYN_SENT\u0026#34;; @tcp_sk_status[9] = \u0026#34;TCP_LAST_ACK\u0026#34;; } kprobe:tcp_rcv_state_process { $sk=(struct sock *)arg0; $tp=(struct tcp_sock *)$sk; $skb = (struct sk_buff *)arg1; $iphd = ((struct iphdr *)($skb-\u0026gt;head + $skb-\u0026gt;network_header)); $th = ((struct tcphdr *)($skb-\u0026gt;head + $skb-\u0026gt;transport_header)); $dport = $th-\u0026gt;dest; $dport = ($dport \u0026gt;\u0026gt; 8) | (($dport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); if ($dport == 54321) { $ack = $th-\u0026gt;ack_seq; $ack = ($ack \u0026gt;\u0026gt; 24) | (($ack \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $ack \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($ack \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $skc_state=$sk-\u0026gt;__sk_common.skc_state; printf(\u0026#34;%s:\\ntcp_sk_status: %s, syn:%u,ack:%u,fin:%u,ack_seq:%u, snd_una:%u, snd_nxt:%u\\n\u0026#34;,func,@tcp_sk_status[$skc_state],$th-\u0026gt;syn,$th-\u0026gt;ack,$th-\u0026gt;fin,$ack,$tp-\u0026gt;snd_una,$tp-\u0026gt;snd_nxt); $una = $tp-\u0026gt;snd_una - $ack; $int_una = (int32) $una; // (!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una) if (!((int32)($tp-\u0026gt;snd_una - $ack) \u0026lt; 0)) { printf(\u0026#34;%d, SEG.ACK =\u0026lt; ISS\\n\u0026#34;,$int_una); } $nxt = $tp-\u0026gt;snd_nxt - $ack; $int_nxt = (int32) $nxt; // after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt)) if ((int32)($tp-\u0026gt;snd_nxt - $ack) \u0026lt; 0) { printf(\u0026#34;%d, SEG.ACK \u0026gt; SND.NXT\\n\u0026#34;,$int_nxt); } } } END { clear(@tcp_sk_status); } [root@node2] /data0/kernel$ bpftrace synsent.bt tcp_rcv_state_process: tcp_sk_status: TCP_SYN_SENT, syn:0,ack:1,fin:0,ack_seq:88, snd_una:2387012236, snd_nxt:2387012237 -1907955147, SEG.ACK \u0026gt; SND.NXT tcp_rcv_state_process: tcp_sk_status: TCP_SYN_SENT, syn:1,ack:1,fin:0,ack_seq:2387012237, snd_una:2387012236, snd_nxt:2387012237 tcp_rcv_state_process: tcp_sk_status: TCP_LAST_ACK, syn:0,ack:1,fin:0,ack_seq:2387012313, snd_una:2387012312, snd_nxt:2387012313 å¯ä»¥çœ‹åˆ°ï¼Œclient-2æ”¶åˆ°serverçš„ACKå›åŒ…å\nå†…æ ¸tcp_rcv_state_processå‡½æ•°åˆ¤æ–­ ack_seq = 88 \u0026gt; snd_una = 2387012236 (u32å·®å€¼å¼ºåˆ¶int32è½¬æ¢ï¼Œç›¸å·®2^31æº¢å‡ºå¯¼è‡´)ï¼Œå‘é€server resetæ•°æ®åŒ… serverç«¯æ”¶åˆ°resetåŒ…åï¼Œæ¸…ç†tcp TIME_WAITè¿æ¥ client-2é‡å‘synåŒ…ï¼Œserverç«¯è¿”å›syn+ackï¼Œæ¡æ‰‹æˆåŠŸ åŒæ ·ä½¿ç”¨bpftraceå·¥å…·è§‚å¯Ÿserverçš„å¤„ç†è¿‡ç¨‹ï¼Œ\n[root@localhost] $ cat trace-time_wait.bt #!/usr/bin/env bpftrace #include \u0026lt;linux/tcp.h\u0026gt; #include \u0026lt;net/tcp.h\u0026gt; #include \u0026lt;net/inet_timewait_sock.h\u0026gt; BEGIN { @tw_substate[5] = \u0026#34;TCP_FIN_WAIT2\u0026#34;; @tw_substate[6] = \u0026#34;TCP_TIME_WAIT\u0026#34;; @tcp_tw_status[0] = \u0026#34;TCP_TW_SUCCESS\u0026#34;; @tcp_tw_status[2] = \u0026#34;TCP_TW_ACK\u0026#34;; @tcp_tw_status[3] = \u0026#34;TCP_TW_SYN\u0026#34;; } kprobe:tcp_timewait_state_process { $inet = (struct inet_timewait_sock *)arg0; $tw = (struct tcp_timewait_sock *)$inet; $skb = (struct sk_buff *)arg1; $th = (struct tcphdr *)arg2; $iphd = ((struct iphdr *)($skb-\u0026gt;head + $skb-\u0026gt;network_header)); if ($iphd-\u0026gt;protocol == IPPROTO_TCP) { $srcaddr = $iphd-\u0026gt;saddr; $dstaddr = $iphd-\u0026gt;daddr; $srcip = ntop($iphd-\u0026gt;saddr); $dstip = ntop($iphd-\u0026gt;daddr); // $th = ((struct tcphdr *)($skb-\u0026gt;head + $skb-\u0026gt;transport_header)); $dport = $th-\u0026gt;dest; $dport = ($dport \u0026gt;\u0026gt; 8) | (($dport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); if ($dport == 80) { $sport = $th-\u0026gt;source; $sport = ($sport \u0026gt;\u0026gt; 8) | (($sport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); // $st = *$th; $seq = $th-\u0026gt;seq; $seq = ($seq \u0026gt;\u0026gt; 24) | (($seq \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $seq \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($seq \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $ack = $th-\u0026gt;ack_seq; $ack = ($ack \u0026gt;\u0026gt; 24) | (($ack \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $ack \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($ack \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $win = $th-\u0026gt;window; $win = ($win \u0026gt;\u0026gt; 8) | (($win \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); $tw_rcv_nxt = $tw-\u0026gt;tw_rcv_nxt; printf(\u0026#34;%s:\\n\u0026#34;,func); printf(\u0026#34;%s:%d -\u0026gt; %s:%d\\n\u0026#34;,$srcip, $sport, $dstip, $dport); /* TCP_FIN_WAIT2çŠ¶æ€æ”¶åˆ°finåŒ…: tcptw-\u0026gt;tw_rcv_nxt = TCP_SKB_CB(skb)-\u0026gt;end_seq; å›å¤å¯¹æ–¹çš„ackåŒ…ä¸­ ack=tw_rcv_nxt=seq+1 TCP_SKB_CB(skb)-\u0026gt;end_seq = (TCP_SKB_CB(skb)-\u0026gt;seq + th-\u0026gt;syn + th-\u0026gt;fin + skb-\u0026gt;len - th-\u0026gt;doff * 4); */ printf(\u0026#34;[syn:%d,ack:%d,fin:%d,rst:%d], seq:%-u, ack:%u, win:%u, tw_rcv_nxt:%u\\n\u0026#34;,$th-\u0026gt;syn, $th-\u0026gt;ack, $th-\u0026gt;fin, $th-\u0026gt;rst, $seq, $ack, $win, $tw_rcv_nxt); // printf(\u0026#34;%d compare %d\\n\u0026#34;,$th-\u0026gt;doff,sizeof($st)\u0026gt;\u0026gt;2); $state = $inet-\u0026gt;tw_substate; $statestr = @tw_substate[$state]; printf(\u0026#34;tw_substate: %s\\n\u0026#34;,$statestr); } } } kretprobe:tcp_timewait_state_process { $ret = retval; $statestr = @tcp_tw_status[$ret]; printf(\u0026#34;tcp_tw_status: %s\\n\u0026#34;,$statestr); print(\u0026#34;################################\u0026#34;); } END { clear(@tw_substate); clear(@tcp_tw_status); } [root@localhost] $ bpftrace trace-time_wait.bt tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:1,ack:0,fin:0,rst:0], seq:2387012236, ack:0, win:32120, tw_rcv_nxt:88 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_ACK ################################ tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:0,ack:0,fin:0,rst:1], seq:88, ack:0, win:0, tw_rcv_nxt:88 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_SUCCESS ################################ å¯ä»¥çœ‹åˆ°ï¼Œserveræ”¶åˆ°SYNåŒ…å\ntcp_timewait_state_processå‡½æ•°åˆ¤æ–­sequenceå›ç»•ï¼ˆseq \u0026lt; tw_rcv_nxtï¼‰ï¼Œè¿”å›ç»™client-2 ACKåŒ… æ”¶åˆ°client-2å‘é€çš„resetåŒ…ï¼Œç›´æ¥æ¸…ç†tcp TIME_WAITè¿æ¥ æµ‹è¯•ç¯å¢ƒæ­å»ºåå‘ç°serverç«¯TIME_WAITçŠ¶æ€æŒç»­æ—¶é—´ä¸º60sï¼Œè¿™æ˜¯å› ä¸ºå†…æ ¸ç‰ˆæœ¬çš„å·®å¼‚ã€‚å‚è€ƒè¿™ç¯‡æ–‡ç«  ä» Linux æºç çœ‹ TIME_WAIT çŠ¶æ€çš„æŒç»­æ—¶é—´\n","date":"12 September 2023","permalink":"/posts/%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95/","section":"åšå®¢","summary":"èƒŒæ™¯ # æœåŠ¡podå®ä¾‹è®¿é—®å¯¹æ–¹æ¥å£é¢‘ç¹è¶…æ—¶ï¼Œå¼•èµ·å®¢è¯‰ã€‚æˆ‘ä»¬é€šè¿‡ä¸“çº¿ä¸å¯¹æ–¹æœºæˆ¿äº’è”ï¼Œå¹¶ä¸”ä¸“çº¿æ¥å…¥ä¾§éƒ¨ç½²æœ‰ä¸“ç”¨ç‰©ç†è®¾å¤‡(vpnåŠ å¯†é€šé“)ï¼Œæ¶æ„å›¾å¦‚ä¸‹ é—®é¢˜åˆ†æ # å®¢æˆ·ç«¯è¯·æ±‚æŠ“åŒ… # å¯¹æœåŠ¡podå®ä¾‹æŠ“åŒ…åˆ†æï¼Œå‘ç°è¶…æ—¶çš„httpè¯·æ±‚å‡ä¸ºå‘é€synåŒ…æ— å“åº”å¯¼è‡´tcpè¿æ¥å»ºç«‹å¤±è´¥è¶…æ—¶ã€‚åŒæ—¶ä¸“çº¿ç½‘ç»œç›‘æ§æ¯”è¾ƒç¨³ï¼Œå¯ä»¥æ’é™¤ä¸“çº¿ç½‘ç»œä¸¢åŒ…çš„åŸå›  å¯¹æ–¹æœåŠ¡å™¨æŠ“åŒ… # è”ç³»å¯¹æ–¹ååŠ©åœ¨serveræœºå™¨ä¸ŠæŠ“åŒ…ï¼Œåˆ†æå¯¹æ–¹æä¾›çš„æŠ“åŒ…æ–‡ä»¶:\nå®¢æˆ·ç«¯è¯·æ±‚ç»è¿‡é˜²ç«å¢™SNATåï¼Œå¯¹æ–¹serverçœ‹åˆ°çš„å®¢æˆ·ç«¯IPéƒ½ä¸€æ · æœåŠ¡å™¨ä¸Šæ”¶åˆ°äº†SYNåŒ…ï¼Œä½†æ˜¯å›å¤çš„æ˜¯ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACKåŒ… è¶…æ—¶é‡ä¼ éƒ½å‘ç”Ÿåœ¨å®¢æˆ·ç«¯è¯·æ±‚æºç«¯å£å¤ç”¨æ—¶(åå‡ ç§’~ä¹åå‡ ç§’) clientå¤ç”¨ç«¯å£æ—¶ï¼Œå¯¹æ¯”serverå‘é€çš„ACKåŒ…å’Œç›¸åŒäº”å…ƒç»„TCPè¿æ¥æ–­å¼€æ—¶å‘é€çš„æœ€åä¸€ä¸ªACKåŒ…ï¼ŒAcknowledgment numberæ˜¯ç›¸åŒçš„ HTTP response headerä¸­åŒ…å«Connection: closeï¼Œserveråªæ”¯æŒhttp1.0çŸ­è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåserverä¸»åŠ¨æ–­å¼€TCPè¿æ¥å¹¶è¿›å…¥TIME-WAITçŠ¶æ€ æ ¹æ®ä»¥ä¸Šåˆ†ææ¨æ–­ï¼Œå¯¹äºæ–°è¯·æ±‚serverç«¯å¤ç”¨äº†ä¹‹å‰çš„TCPè¿æ¥ï¼ŒTCPè¿æ¥å¤„äºTIME-WAITçŠ¶æ€\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œserverå›å¤äº†ACKåŒ…ï¼Œå®¢æˆ·ç«¯ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°ï¼Ÿ é€šè¿‡åœ¨ä¸“ç”¨è®¾å¤‡ä¸ŠæŠ“åŒ…åˆ†æï¼Œå‘ç°æ”¶åˆ°äº†ACKå›åŒ…ï¼Œæ¨æµ‹æ˜¯è¢«é˜²ç«å¢™dropã€‚å› ä¸ºé˜²ç«å¢™TCPè¿æ¥TIME-WAITçŠ¶æ€timeoutæ—¶é—´ä¸º1sï¼Œå¯¹äºå®¢æˆ·ç«¯æ–°è¯·æ±‚SYNåŒ…ï¼Œä¼šæ–°å»ºtcp sessionï¼Œæ”¶åˆ°server ACKå›åŒ…åï¼Œè®¤ä¸ºéæ³•å°±dropäº†\nè§£å†³æ–¹æ¡ˆ # æ”¯æŒHTTP1.1é•¿è¿æ¥ # æ¥å£æ”¯æŒhttp1.1é•¿è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåä¼šä¸»åŠ¨æ–­å¼€TCPè¿æ¥ï¼ŒTIME-WAITçŠ¶æ€ç»´æŒåœ¨å®¢æˆ·ç«¯ã€‚å¯¹æ–¹åé¦ˆæ— æ³•æ”¯æŒ","title":"ä¸€æ¬¡è¯·æ±‚è¶…æ—¶é—®é¢˜æ’æŸ¥è®°å½•"},{"content":"èƒŒæ™¯ # æœåŠ¡podå®ä¾‹è®¿é—®å¯¹æ–¹æ¥å£é¢‘ç¹è¶…æ—¶ï¼Œå¼•èµ·å®¢è¯‰ã€‚æˆ‘ä»¬é€šè¿‡ä¸“çº¿ä¸å¯¹æ–¹æœºæˆ¿äº’è”ï¼Œå¹¶ä¸”ä¸“çº¿æ¥å…¥ä¾§éƒ¨ç½²æœ‰ä¸“ç”¨ç‰©ç†è®¾å¤‡(vpnåŠ å¯†é€šé“)ï¼Œæ¶æ„å›¾å¦‚ä¸‹ é—®é¢˜åˆ†æ # å®¢æˆ·ç«¯è¯·æ±‚æŠ“åŒ… # å¯¹æœåŠ¡podå®ä¾‹æŠ“åŒ…åˆ†æï¼Œå‘ç°è¶…æ—¶çš„httpè¯·æ±‚å‡ä¸ºå‘é€synåŒ…æ— å“åº”å¯¼è‡´tcpè¿æ¥å»ºç«‹å¤±è´¥è¶…æ—¶ã€‚åŒæ—¶ä¸“çº¿ç½‘ç»œç›‘æ§æ¯”è¾ƒç¨³ï¼Œå¯ä»¥æ’é™¤ä¸“çº¿ç½‘ç»œä¸¢åŒ…çš„åŸå›  å¯¹æ–¹æœåŠ¡å™¨æŠ“åŒ… # è”ç³»å¯¹æ–¹ååŠ©åœ¨serveræœºå™¨ä¸ŠæŠ“åŒ…ï¼Œåˆ†æå¯¹æ–¹æä¾›çš„æŠ“åŒ…æ–‡ä»¶:\nå®¢æˆ·ç«¯è¯·æ±‚ç»è¿‡é˜²ç«å¢™SNATåï¼Œå¯¹æ–¹serverçœ‹åˆ°çš„å®¢æˆ·ç«¯IPéƒ½ä¸€æ · æœåŠ¡å™¨ä¸Šæ”¶åˆ°äº†SYNåŒ…ï¼Œä½†æ˜¯å›å¤çš„æ˜¯ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACKåŒ… è¶…æ—¶é‡ä¼ éƒ½å‘ç”Ÿåœ¨å®¢æˆ·ç«¯è¯·æ±‚æºç«¯å£å¤ç”¨æ—¶(åå‡ ç§’~ä¹åå‡ ç§’) clientå¤ç”¨ç«¯å£æ—¶ï¼Œå¯¹æ¯”serverå‘é€çš„ACKåŒ…å’Œç›¸åŒäº”å…ƒç»„TCPè¿æ¥æ–­å¼€æ—¶å‘é€çš„æœ€åä¸€ä¸ªACKåŒ…ï¼ŒAcknowledgment numberæ˜¯ç›¸åŒçš„ HTTP response headerä¸­åŒ…å«Connection: closeï¼Œserveråªæ”¯æŒhttp1.0çŸ­è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåserverä¸»åŠ¨æ–­å¼€TCPè¿æ¥å¹¶è¿›å…¥TIME-WAITçŠ¶æ€ æ ¹æ®ä»¥ä¸Šåˆ†ææ¨æ–­ï¼Œå¯¹äºæ–°è¯·æ±‚serverç«¯å¤ç”¨äº†ä¹‹å‰çš„TCPè¿æ¥ï¼ŒTCPè¿æ¥å¤„äºTIME-WAITçŠ¶æ€\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œserverå›å¤äº†ACKåŒ…ï¼Œå®¢æˆ·ç«¯ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°ï¼Ÿ é€šè¿‡åœ¨ä¸“ç”¨è®¾å¤‡ä¸ŠæŠ“åŒ…åˆ†æï¼Œå‘ç°æ”¶åˆ°äº†ACKå›åŒ…ï¼Œæ¨æµ‹æ˜¯è¢«é˜²ç«å¢™dropã€‚å› ä¸ºé˜²ç«å¢™TCPè¿æ¥TIME-WAITçŠ¶æ€timeoutæ—¶é—´ä¸º1sï¼Œå¯¹äºå®¢æˆ·ç«¯æ–°è¯·æ±‚SYNåŒ…ï¼Œä¼šæ–°å»ºtcp sessionï¼Œæ”¶åˆ°server ACKå›åŒ…åï¼Œè®¤ä¸ºéæ³•å°±dropäº†\nè§£å†³æ–¹æ¡ˆ # æ”¯æŒHTTP1.1é•¿è¿æ¥ # æ¥å£æ”¯æŒhttp1.1é•¿è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåä¼šä¸»åŠ¨æ–­å¼€TCPè¿æ¥ï¼ŒTIME-WAITçŠ¶æ€ç»´æŒåœ¨å®¢æˆ·ç«¯ã€‚å¯¹æ–¹åé¦ˆæ— æ³•æ”¯æŒ\nå¢åŠ é˜²ç«å¢™SNATåœ°å€æ±  # å½“å‰ä¸šåŠ¡çš„é˜²ç«å¢™ç­–ç•¥çš„SNAT IP Poolåªæœ‰ä¸€ä¸ª3.3.10.10ï¼Œå°è¯•å†å¢åŠ ä¸€ä¸ª3.3.10.11ï¼Œå‘ç°é˜²ç«å¢™å¹¶æ²¡æœ‰è½®è¯¢ä½¿ç”¨ã€‚æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºå½“å‰åœ¨ç”¨çš„IP Poolç±»å‹ä¸ºoverloadï¼Œä¼šæ ¹æ®å®¢æˆ·ç«¯IPåˆ†é…snatåœ°å€ã€‚æ¯”èµ·å·§åˆçš„æ˜¯å½“å‰å®¢æˆ·ç«¯å››ä¸ªpod ip è®¡ç®—å‡ºæ¥éƒ½ä¼šä½¿ç”¨3.3.10.10ã€‚æ‰€ä»¥å®¢æˆ·ç«¯pod IPéšæœºåˆ†é…ï¼Œæœ€ç»ˆä½¿ç”¨snatåœ°å€ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼Œè€ƒè™‘æŠŠSNAT IP Poolåˆ‡æ¢ä¸º one-to-oneç±»å‹\none-to-oneæ¨¡å¼æ˜¯: å†…éƒ¨ IP åœ°å€å’Œå¤–éƒ¨ï¼ˆè½¬æ¢åçš„ï¼‰IP åœ°å€ä¸€å¯¹ä¸€åŒ¹é…\né…ç½®ä¸€ä¸ª28ä½çš„æ–°åœ°å€æ± ä¹‹åï¼Œè¶…æ—¶è¯·æ±‚ç‡å¤§å¹…é™ä½ã€‚ä½†æ˜¯one-to-one IP poolå¹¶ä¸æ˜¯é™æ€SNATï¼Œæ‰€ä»¥æ¯æ¬¡å®¢æˆ·ç«¯è¯·æ±‚ç»“æŸåï¼Œä¼šé‡Šæ”¾snat IPåˆ°æ± å­é‡Œï¼Œè¿˜æ˜¯æœ‰ä¸€å®šå‡ ç‡è¶…æ—¶ã€‚\nå¦‚æœè¦å½»åº•è§£å†³ï¼Œéœ€è¦ç‰©ç†æœºæˆ–è™šæœºéƒ¨ç½²å›ºå®šIPï¼Œç„¶åé…ç½®é˜²ç«å¢™é…ç½®é™æ€SNAT\nå†…æ ¸æºç çœ‹TIME_WAITè¿æ¥å¤„ç† # ä¸ºä»€ä¹ˆä¼šè¿”å›ACK? ä»å†…æ ¸æºç ä¸­æ‰¾ç­”æ¡ˆï¼Œå†…æ ¸ç‰ˆæœ¬3.10.0-1062\ntcp_v4_rcv() # tcp_v4_rcvå‡½æ•°è´Ÿè´£æ¥æ”¶å’Œå¤„ç†ä¼ å…¥çš„TCP ipv4 æ•°æ®åŒ…\nint tcp_v4_rcv(struct sk_buff *skb) { const struct iphdr *iph; const struct tcphdr *th; struct sock *sk; /* ä¸­é—´çœç•¥ */ process: // TCPè¿æ¥å¤„äºTIMT_WAITçŠ¶æ€æ—¶ï¼Œè·³è½¬åˆ°do_time_wait if (sk-\u0026gt;sk_state == TCP_TIME_WAIT) goto do_time_wait; /* ä¸­é—´çœç•¥ */ do_time_wait: /* ä¸­é—´çœç•¥ */ // æ ¹æ®tcp_timewait_state_processå‡½æ•°è¿”å›å€¼ï¼Œç¡®å®šä¸‹ä¸€æ­¥åŠ¨ä½œ switch (tcp_timewait_state_process(inet_twsk(sk), skb, th)) { // åˆæ³•SYNåŒ…ï¼Œå¯ä»¥å¤ç”¨TCPè¿æ¥ï¼ŒtcpçŠ¶æ€å¯ä»¥åˆ‡æ¢è‡³SYN_RECV case TCP_TW_SYN: { struct sock *sk2 = inet_lookup_listener(dev_net(skb-\u0026gt;dev), \u0026amp;tcp_hashinfo, iph-\u0026gt;saddr, th-\u0026gt;source, iph-\u0026gt;daddr, th-\u0026gt;dest, inet_iif(skb)); if (sk2) { inet_twsk_deschedule(inet_twsk(sk), \u0026amp;tcp_death_row); inet_twsk_put(inet_twsk(sk)); sk = sk2; goto process; } /* Fall through to ACK */ } /* å‘é€ACKåŒ… 1.TCP_FIN_WAIT2çŠ¶æ€æ”¶åˆ°FINåŒ…ï¼Œå‘é€æœ€åä¸€æ¬¡æŒ¥æ‰‹çš„ACKåŒ… 2.TCP_TIME_WAITçŠ¶æ€ä¸‹å‘é€ä¸Šä¸€æ¬¡çš„ACKåŒ… */ case TCP_TW_ACK: tcp_v4_timewait_ack(sk, skb); break; // å‘é€RESETåŒ… case TCP_TW_RST: tcp_v4_send_reset(sk, skb); inet_twsk_deschedule(inet_twsk(sk), \u0026amp;tcp_death_row); inet_twsk_put(inet_twsk(sk)); goto discard_it; // ç›´æ¥ä¸¢å¼ƒï¼Œä¸åšå¤„ç† case TCP_TW_SUCCESS:; } goto discard_it; } ç»“åˆä¸Šé¢çš„åœºæ™¯ï¼Œserverå¤„ç†æµç¨‹åº”è¯¥æ˜¯: æ”¶åˆ°SYNåŒ…ï¼ŒtcpçŠ¶æ€ä¸ºTCP_TIME_WAITï¼Œtcp_timewait_state_process()å‡½æ•°å¤„ç†å¹¶è¿”å›äº†TCP_TW_ACK\ntcp_timewait_state_process() # tcp_timewait_state_process() å‡½æ•°å¤„ç†\ntcp_timewait_state_process(struct inet_timewait_sock *tw, struct sk_buff *skb, const struct tcphdr *th) { struct tcp_options_received tmp_opt; struct tcp_timewait_sock *tcptw = tcp_twsk((struct sock *)tw); bool paws_reject = false; tmp_opt.saw_tstamp = 0; // tcp headerä¸­å¼€å¯äº†optionsä¸”å½“å‰tcpè¿æ¥å¼€å¯äº†æ—¶é—´æˆ³é€‰é¡¹ if (th-\u0026gt;doff \u0026gt; (sizeof(*th) \u0026gt;\u0026gt; 2) \u0026amp;\u0026amp; tcptw-\u0026gt;tw_ts_recent_stamp) { tcp_parse_options(skb, \u0026amp;tmp_opt, 0, NULL); if (tmp_opt.saw_tstamp) { if (tmp_opt.rcv_tsecr) tmp_opt.rcv_tsecr -= tcptw-\u0026gt;tw_ts_offset; tmp_opt.ts_recent\t= tcptw-\u0026gt;tw_ts_recent; tmp_opt.ts_recent_stamp\t= tcptw-\u0026gt;tw_ts_recent_stamp; /* å¦‚æœå¼€å¯äº†TCP timestampå¯é€‰é¡¹ï¼Œåˆ¤æ–­æ˜¯å¦å‘ç”Ÿæ—¶é—´æˆ³å›ç»• 1. paws_reject = false æ—¶é—´æˆ³æ²¡æœ‰å›ç»• 2. paws_reject = true æ—¶é—´æˆ³å›ç»• */ paws_reject = tcp_paws_reject(\u0026amp;tmp_opt, th-\u0026gt;rst); } } // tcpçŠ¶æ€æ˜¯FIN_WAIT2çš„å¤„ç†é€»è¾‘ if (tw-\u0026gt;tw_substate == TCP_FIN_WAIT2) { /* ä¸­é—´çœç•¥ */ } // æ—¶é—´æˆ³æ²¡æœ‰å›ç»• if (!paws_reject \u0026amp;\u0026amp; // æŠ¥æ–‡åºåˆ—å· ç­‰äº é¢„æœŸæ¥æ”¶çš„åºåˆ—å· (TCP_SKB_CB(skb)-\u0026gt;seq == tcptw-\u0026gt;tw_rcv_nxt \u0026amp;\u0026amp; /* TCP_SKB_CB(skb)-\u0026gt;end_seq = (TCP_SKB_CB(skb)-\u0026gt;seq + th-\u0026gt;syn + th-\u0026gt;fin + skb-\u0026gt;len - th-\u0026gt;doff * 4); æ²¡æœ‰æºå¸¦æ•°æ®æŠ¥æ–‡ï¼Œåªæœ‰tcp headerä¸”æ²¡æœ‰syn/finæ ‡å¿—ä½ï¼Œåªèƒ½æ˜¯resetæˆ–è€…ack */ (TCP_SKB_CB(skb)-\u0026gt;seq == TCP_SKB_CB(skb)-\u0026gt;end_seq || th-\u0026gt;rst))) { /* In window segment, it may be only reset or bare ack. */ if (th-\u0026gt;rst) { // net.ipv4.tcp_rfc1337å†…æ ¸å‚æ•°ç­‰äº0æ—¶ if (sysctl_tcp_rfc1337 == 0) { kill: //æ¸…ç†TIME_WAITè¿æ¥ inet_twsk_deschedule(tw, \u0026amp;tcp_death_row); inet_twsk_put(tw); return TCP_TW_SUCCESS; } } else { // é‡ç½®TIME_WAITçŠ¶æ€timeoutæ—¶é—´ inet_twsk_schedule(tw, \u0026amp;tcp_death_row, TCP_TIMEWAIT_LEN, TCP_TIMEWAIT_LEN); } if (tmp_opt.saw_tstamp) { tcptw-\u0026gt;tw_ts_recent\t= tmp_opt.rcv_tsval; tcptw-\u0026gt;tw_ts_recent_stamp = get_seconds(); } inet_twsk_put(tw); return TCP_TW_SUCCESS; } // SYNåŒ…ä¸”æ²¡æœ‰rst/ackæ ‡å¿—ä½ï¼Œæ—¶é—´æˆ³æ²¡æœ‰å›ç»• if (th-\u0026gt;syn \u0026amp;\u0026amp; !th-\u0026gt;rst \u0026amp;\u0026amp; !th-\u0026gt;ack \u0026amp;\u0026amp; !paws_reject \u0026amp;\u0026amp; // åºåˆ—å·æ²¡æœ‰å›ç»• æˆ–è€… (after(TCP_SKB_CB(skb)-\u0026gt;seq, tcptw-\u0026gt;tw_rcv_nxt) || // è¯·æ±‚æŠ¥æ–‡ä¸­å¼€å¯timestampå¯é€‰é¡¹å¹¶ä¸”æ—¶é—´æˆ³æ²¡æœ‰å›ç»• (tmp_opt.saw_tstamp \u0026amp;\u0026amp; (s32)(tcptw-\u0026gt;tw_ts_recent - tmp_opt.rcv_tsval) \u0026lt; 0))) { u32 isn = tcptw-\u0026gt;tw_snd_nxt + 65535 + 2; if (isn == 0) isn++; TCP_SKB_CB(skb)-\u0026gt;tcp_tw_isn = isn; return TCP_TW_SYN; } if (paws_reject) // æ›´æ–° /proc/net/netstat NET_INC_STATS_BH(twsk_net(tw), LINUX_MIB_PAWSESTABREJECTED); if (!th-\u0026gt;rst) { /* In this case we must reset the TIMEWAIT timer. * * If it is ACKless SYN it may be both old duplicate * and new good SYN with random sequence number \u0026lt;rcv_nxt. * Do not reschedule in the last case. */ if (paws_reject || th-\u0026gt;ack) // é‡ç½®TIME_WAITçŠ¶æ€timeoutæ—¶é—´ inet_twsk_schedule(tw, \u0026amp;tcp_death_row, TCP_TIMEWAIT_LEN, TCP_TIMEWAIT_LEN); /* if (*last_oow_ack_time) { s32 elapsed = (s32)(tcp_time_stamp - *last_oow_ack_time); // è®¡ç®—å½“å‰çš„tcp timestamp(jiffies)å’Œä¸Šæ¬¡å‘é€ackæ—¶çš„tcp timestamp å·®å€¼ // å¦‚æœå°äºå†…æ ¸å‚æ•°net.ipv4.tcp_invalid_ratelimit è¡¨ç¤ºé€Ÿç‡è¿‡å¿«ï¼Œéœ€è¦é™é€Ÿ if (0 \u0026lt;= elapsed \u0026amp;\u0026amp; elapsed \u0026lt; sysctl_tcp_invalid_ratelimit) { // æ›´æ–° /proc/net/netstat NET_INC_STATS(net, mib_idx); return true; } } å¦‚æœdupacksæ²¡æœ‰é™é€Ÿ return TCP_TW_ACKï¼Œå¦åˆ™return TCP_TW_SUCCESS */ return tcp_timewait_check_oow_rate_limit( tw, skb, LINUX_MIB_TCPACKSKIPPEDTIMEWAIT); } inet_twsk_put(tw); return TCP_TW_SUCCESS; } th-\u0026gt;doff æ•°æ®åç§»å­—æ®µï¼Œ4-bitçš„æ— ç¬¦å·æ•´å‹(æ•°æ®èŒƒå›´0~15) è¡¨ç¤ºtcp headerçš„é•¿åº¦ï¼Œå•ä½æ˜¯32-bit(å³4 bytes)ï¼ŒèŒƒå›´5~15 tcp header(no options)é•¿åº¦ä¸º5ï¼Œå¤§å° 5 * 32-bit (4 bytes) = 20 bytes\nsizeof(*th) \u0026raquo; 2 tcphdrç»“æ„ä½“å¤§å°æ˜¯20 bytesï¼Œ20 \u0026raquo; 2 = 20 / 4 = 5\næ—¶é—´æˆ³å›ç»•åˆ¤æ–­ # static inline bool tcp_paws_reject(const struct tcp_options_received *rx_opt, int rst) { // tcp_paws_check()å‡½æ•°åˆ¤æ–­æ˜¯å¦é€šè¿‡æ£€æŸ¥ if (tcp_paws_check(rx_opt, 0)) return false; if (rst \u0026amp;\u0026amp; get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_MSL) return false; return true; } static inline bool tcp_paws_check(const struct tcp_options_received *rx_opt, int paws_win) { if ((s32)(rx_opt-\u0026gt;ts_recent - rx_opt-\u0026gt;rcv_tsval) \u0026lt;= paws_win) return true; if (unlikely(get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_24DAYS)) return true; if (!rx_opt-\u0026gt;ts_recent) return true; return false; } (s32)(rx_opt-\u0026gt;ts_recent - rx_opt-\u0026gt;rcv_tsval) \u0026lt;= 0 å½“å‰tcpè¿æ¥serverä¸Šä¸€æ¬¡å‘é€çš„tcpæŠ¥æ–‡ä¸­çš„TSecrå’ŒtcpæŠ¥æ–‡é€‰ä¸­çš„TSvalçš„å·®å€¼å°äºç­‰äº0ï¼Œæ£€æŸ¥é€šè¿‡\ntcp timestampæ˜¯u32æ— ç¬¦å·æ•´å‹ï¼Œæ•°æ®èŒƒå›´0~2^32-1 s32æ˜¯æœ‰ç¬¦åˆæ•´å‹ï¼Œæ•°æ®èŒƒå›´æ˜¯-2^31~2^31-1 u32æ— ç¬¦å·æ•´å‹å‡æ³•ï¼Œå¦‚æœ|x|\u0026gt;yï¼Œåˆ™y-x = 2^32-|x-y| å¯¹u32å·®å€¼åšå¼ºåˆ¶ç±»å‹è½¬æ¢çš„è¯ï¼Œå¦‚æœè¶…è¿‡2^31å°±ä¼šæº¢å‡ºã€‚æ‰€ä»¥rcv_tsval - ts_recent \u0026gt; 2^31æ—¶ï¼Œæ—¶é—´æˆ³å›ç»•æ£€æŸ¥ä¸ä¼šé€šè¿‡ tcp timestampå–å€¼æ¥æºäºjiffiesï¼Œå’ŒæœåŠ¡å™¨è¿è¡Œæ—¶é•¿æœ‰å…³ï¼Œè®°å½•çš„æ˜¯ä»å¼€æœºåˆ°ç°åœ¨æ—¶é—´æˆ³æ—¶é’Ÿæ›´æ–°äº†å¤šå°‘æ¬¡ï¼Œrfcè§„å®šæ›´æ–°é¢‘ç‡æ˜¯1ms~1sï¼ŒæœåŠ¡å™¨é‡å¯åjiffiesé‡ç½®\nCentosä¸­æŸ¥çœ‹å†…æ ¸æ—¶é—´æˆ³æ—¶é’Ÿé¢‘ç‡ï¼Œ1s/1000=1msï¼Œé‚£ä¹ˆ2^31/1000/(3600*24)=24.8å¤©åå›ç»•\n$ cat /boot/config-3.10.0-1062.el7.x86_64 |grep -w \u0026#34;CONFIG_HZ\u0026#34; CONFIG_HZ=1000 get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_24DAYS\n#define TCP_PAWS_24DAYS (60 * 60 * 24 * 24) ï¼Œå•ä½æ˜¯s\nå½“å‰ç³»ç»Ÿæ—¶é—´æˆ³åœ¨tcpè¿æ¥ä¸Šä¸€æ¬¡æ”¶åˆ°rcv_tsvalæ—¶çš„ç³»ç»Ÿæ—¶é—´æˆ³çš„24å¤©ä¹‹åçš„è¯ï¼Œåˆ™æ—¶é—´æˆ³å›ç»•æ£€æŸ¥é€šè¿‡\næ—¶é’Ÿé¢‘ç‡æ˜¯1msï¼Œé‚£ä¹ˆrcv_tsvalå¢åŠ åˆ°æº¢å‡ºçš„æ—¶é—´æ˜¯2^31/1000/(3600*24)=24.8å¤©\næ‰€ä»¥å¢åŠ äº†ä¸€ä¸ªè¶…è¿‡TCP_PAWS_24DAYSçš„åˆ¤æ–­ï¼Œç›´æ¥æ£€æŸ¥é€šè¿‡\nåºåˆ—å·å›ç»•åˆ¤æ–­ # å¯¹äºSYNåŒ…ï¼Œä¼šæ¯”è¾ƒtcpæŠ¥æ–‡çš„åºåˆ—å·æ˜¯å¦å¤§äºtcpè¿æ¥è®°å½•çš„è¦é¢„æœŸæ¥æ”¶çš„åºåˆ—å·\nafter(TCP_SKB_CB(skb)-\u0026gt;seq, tcptw-\u0026gt;tw_rcv_nxt)\n// afterå‡½æ•°å®šä¹‰ static inline bool before(__u32 seq1, __u32 seq2) { return (__s32)(seq1-seq2) \u0026lt; 0; } #define after(seq2, seq1) before(seq1, seq2) (__s32)(seq1-seq2) ä¹Ÿæ˜¯å¯¹u32å·®å€¼å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ŒåŒæ ·å­˜åœ¨æº¢å‡ºæƒ…å†µã€‚æ‰€ä»¥å¦‚æœSYNåŒ…çš„seqæ¯”tcptw-\u0026gt;tw_rcv_nxtå¤§è¶…è¿‡2^31ï¼Œåˆ™è®¤ä¸ºåºåˆ—å·å›ç»•ï¼Œä¸èƒ½å¤ç”¨TIME_WAITè¿æ¥\nç»“åˆä¸Šæ–‡æŠ“åŒ…åˆ†æ,\nseq=2123642848ï¼Œ ack=554887750\nts_recent = 869333586ï¼Œrcv_tsval = 28962444\nä»£ç è¿è¡Œç»“æœæ˜¾ç¤ºï¼Œæ—¶é—´æˆ³å‘ç”Ÿå›ç»•ï¼Œæ‰€ä»¥paws_reject = trueï¼Œè¿”å›äº†TCP_TW_ACK\né—®é¢˜åœºæ™¯æ¨¡æ‹Ÿ # æµ‹è¯•ç¯å¢ƒæ­å»º # æœåŠ¡å™¨éƒ½æ˜¯åŸºäºåŒä¸€ç‰©ç†æœºä¸Škvmè™šæ‹ŸåŒ–éƒ¨ç½²ï¼Œå†…æ ¸ç‰ˆæœ¬ 3.10.0-1062.el7.x86_64\nclient è¯·æ±‚ http://172.16.10.8:80 ,è·¯ç”±è½¬å‘åˆ°firewallï¼ŒfilrewallæœåŠ¡å™¨ä¸Šä½¿ç”¨iptablesé…ç½®snatå’Œdnatï¼Œå†è·¯ç”±è½¬å‘åˆ°gatewayï¼Œgatewayå†è½¬å‘åˆ°server\nrole device ip special route system client-1 eth0 172.16.9.131 172.16.10.8 via 172.16.9.133 dev eth0 centos 7.7 client-2 eth0 172.16.9.132 172.16.10.8 via 172.16.9.133 dev eth0 centos 7.7 firewall eth0 172.16.9.133 centos 7.7 eth1 192.168.102.3 192.168.10.9 via 192.168.102.2 dev eth1 physical gw\n(ä¸“ç”¨è®¾å¤‡) eth0 192.168.102.2 3.3.10.10 via 192.168.102.3 dev eth0 centos 7.7 eth1 192.168.10.8 server eth0 192.168.10.9 3.3.10.10 via 192.168.10.8 dev eth0 centos 7.7 firewallé…ç½® # iptablesé…ç½®snatå’Œdnat\n#dnat æ”¶åˆ°è®¿é—®172.16.10.8:80è¯·æ±‚è·¯ç”±è½¬å‘åˆ°192.168.10.9:80 $ iptables -t nat -A PREROUTING -d 172.16.10.8/32 -i eth0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.10.9:80 #snat è®¿é—®192.168.10.9:80çš„è¯·æ±‚ï¼Œæºåœ°å€è½¬æ¢ä¸º3.3.10.10 $ iptables -t nat -A POSTROUTING -d 192.168.10.9/32 -o eth1 -p tcp -m tcp --dport 80 -j SNAT --to-source 3.3.10.10 å†…æ ¸å‚æ•°\n$ sysctl -w net.ipv4.ip_forward=1 # å‚è€ƒç‰©ç†é˜²ç«å¢™é…ç½® $ systcl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=2 gatewayé…ç½® # ä¸“ç”¨è®¾å¤‡æ˜¯ç”¨äºåŒæ–¹å»ºç«‹vpnåŠ å¯†é€šé“ï¼ŒåŸºäºiptableså¯¹è¯·æ±‚æ‰“æ ‡è®°ã€è½¬å‘åˆ°vpnç½‘å¡ã€‚æµ‹è¯•ç¯å¢ƒåªåŠ äº†conntrackè®°å½•\n$ iptables -t nat -A PREROUTING -m conntrack --ctstate INVALID -j LOG --log-prefix \u0026#34;Conntrack INVALID: \u0026#34; --log-level 7 # conntrackæ—¥å¿—è®°å½•æ–‡ä»¶ $ grep conntrack /etc/rsyslog.conf kern.* /var/log/conntrack.log $ sysctl -w net.ipv4.ip_forward=1 # å‚ç…§ä¸“ç”¨è®¾å¤‡é…ç½® $ systcl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=60 serveré…ç½® # # SimpleHTTPServeré»˜è®¤æ˜¯HTTP/1.0 $ nohup python -m SimpleHTTPServer 80 \u0026amp; é—®é¢˜å¤ç° # client-1è¯·æ±‚ # [root@node1] ~$ curl --local-port 54321 172.16.10.8:80 \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD HTML 3.2 Final//EN\u0026#34;\u0026gt;\u0026lt;html\u0026gt; \u0026lt;title\u0026gt;Directory listing for /\u0026lt;/title\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;Directory listing for /\u0026lt;/h2\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;nohup.out\u0026#34;\u0026gt;nohup.out\u0026lt;/a\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;test.file\u0026#34;\u0026gt;test.file\u0026lt;/a\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; åŒæ—¶serveræŠ“åŒ…\n[root@localhost] $ tcpdump -ieth0 port 80 -nnS 17:08:16.798635 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [S], seq 2851797271, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 9], length 0 17:08:16.798704 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [S.], seq 912495348, ack 2851797272, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 9], length 0 ...çœç•¥... 17:08:16.806065 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [F.], seq 2851797347, ack 912495758, win 60, length 0 17:08:16.806073 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [.], ack 2851797348, win 58, length 0 client-2æ¨¡æ‹Ÿè¯·æ±‚ # serverç«¯çš„æŠ“åŒ…è®°å½•å¯ä»¥çœ‹å‡ºï¼Œtcptw-\u0026gt;tw_rcv_nxt = 2851797348ã€‚ä½¿ç”¨python scapyï¼Œå‘é€ä¸€ä¸ªseqå°äº2851797348çš„SYNåŒ…\n[root@node2] /data0/fake$ python send_test.py 2851797340 [root@node2] /data0/fake$ cat send_test.py #!/usr/bin/python #-*- coding:utf-8 -*- from scapy.all import * import sys if len(sys.argv) \u0026lt; 2: print \u0026#39;lack args\u0026#39; sys.exit() # åˆ›å»ºä¸€ä¸ªIPæ•°æ®åŒ…ï¼Œè®¾ç½®æºIPã€ç›®æ ‡IP ip_packet = IP(src=\u0026#34;172.16.9.132\u0026#34;, dst=\u0026#34;172.16.10.8\u0026#34;) # åˆ›å»ºä¸€ä¸ªTCPæ•°æ®åŒ…ï¼Œè®¾ç½®æºç«¯å£ã€ç›®æ ‡ç«¯å£å’Œåºåˆ—å· tcp_packet = TCP(sport=54321, dport=80,flags=\u0026#39;S\u0026#39;, seq=int(sys.argv[1])) # ç»„è£…æ•°æ®åŒ… syn = ip_packet / tcp_packet send(syn)serverç«¯æŠ“åŒ…è®°å½•å¯ä»¥çœ‹åˆ°ï¼Œå›å¤äº†seqä¸º2851797348ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACK 17:08:24.023783 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [S], seq 2851797340, win 8192, length 0 17:08:24.023842 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [.], ack 2851797348, win 58, length 0 serverç«¯ä½¿ç”¨bpftraceè„šæœ¬æŸ¥çœ‹tcp_timewait_state_process()å‡½æ•°æ”¶åˆ°SYNåŒ…çš„å†…æ ¸å¤„ç†æµç¨‹\n[root@localhost] $ bpftrace trace-time_wait.bt Attaching 4 probes... tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:1,ack:0,fin:0,rst:0], seq:1351613457, ack:0, win:32120, tw_rcv_nxt:1125813282 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_SYN ################################ tcp sockå¤„äºTCP_TIME_WAITçŠ¶æ€ï¼Œæ”¶åˆ°çš„SYNåŒ…seq=1351613457 \u0026gt; tw_rcv_nxt=1125813282ï¼Œå‡½æ•°è¿”å›TCP_TW_SYN\né—®é¢˜å»¶ä¼¸ # å®¢æˆ·ç«¯å‘é€SYNåŒ…åï¼Œæ”¶åˆ°ACKåŒ…ä¼šæ€ä¹ˆå¤„ç†?\næŸ¥çœ‹å†…æ ¸æºç ï¼Œå®¢æˆ·ç«¯å‘é€SYNåï¼ŒçŠ¶æ€åˆ‡æ¢ä¸ºSYN_SENTã€‚æ”¶åˆ°tcpå›åŒ…åçš„å¤„ç†æµç¨‹: tcp_v4_rcv -\u0026gt; tcp_v4_do_rcv -\u0026gt; tcp_rcv_state_process -\u0026gt; tcp_rcv_synsent_state_process\nçœ‹ä¸€ä¸‹tcp_rcv_synsent_state_processå‡½æ•°ï¼Œå¦‚æœæ”¶åˆ°å›åŒ…è®¾ç½®äº†ACKæ ‡å¿—ä½ï¼Œåˆ¤æ–­è¯¥æ•°æ®åŒ…seqå’Œtimestampæ˜¯å¦ç¬¦åˆé¢„æœŸ\n(!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una)\nsnd_unaæ˜¯å¯¹åº”å‘é€çª—å£è®°å½•çš„æœªè¢«ç¡®è®¤çš„seqå·ï¼Œå¦‚æœack_seq =\u0026lt; snd_unaï¼Œè¿”å›reset\nafter(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt))\nsnd_nxtæ˜¯å¯¹åº”å‘é€çª—å£è®°å½•çš„ä¸‹ä¸€æ¬¡å‘é€çš„seqå·ï¼Œå¦‚æœack_seq \u0026gt; snd_nxtï¼Œè¿”å›reset\næ£€æŸ¥é€šè¿‡åï¼Œå¦‚æœæ•°æ®åŒ…è®¾ç½®äº†RSTæ ‡å¿—ä½ï¼Œç›´æ¥ä¸¢å¼ƒï¼ŒtcpçŠ¶æ€åˆ‡æ¢ä¸ºCLOSEã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œç»§ç»­æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†SYNæ ‡å¿—ä½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç›´æ¥ä¸¢å¼ƒã€‚\nstatic int tcp_rcv_synsent_state_process(struct sock *sk, struct sk_buff *skb, const struct tcphdr *th, unsigned int len) { struct inet_connection_sock *icsk = inet_csk(sk); struct tcp_sock *tp = tcp_sk(sk); struct tcp_fastopen_cookie foc = { .len = -1 }; int saved_clamp = tp-\u0026gt;rx_opt.mss_clamp; tcp_parse_options(skb, \u0026amp;tp-\u0026gt;rx_opt, 0, \u0026amp;foc); if (tp-\u0026gt;rx_opt.saw_tstamp \u0026amp;\u0026amp; tp-\u0026gt;rx_opt.rcv_tsecr) tp-\u0026gt;rx_opt.rcv_tsecr -= tp-\u0026gt;tsoffset; if (th-\u0026gt;ack) { /* rfc793: * \u0026#34;If the state is SYN-SENT then * first check the ACK bit * If the ACK bit is set *\tIf SEG.ACK =\u0026lt; ISS, or SEG.ACK \u0026gt; SND.NXT, send * a reset (unless the RST bit is set, if so drop * the segment and return)\u0026#34; */ if (!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una) || after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt)) goto reset_and_undo; if (tp-\u0026gt;rx_opt.saw_tstamp \u0026amp;\u0026amp; tp-\u0026gt;rx_opt.rcv_tsecr \u0026amp;\u0026amp; !between(tp-\u0026gt;rx_opt.rcv_tsecr, tp-\u0026gt;retrans_stamp, tcp_time_stamp)) { NET_INC_STATS_BH(sock_net(sk), LINUX_MIB_PAWSACTIVEREJECTED); goto reset_and_undo; } /* Now ACK is acceptable. * * \u0026#34;If the RST bit is set * If the ACK was acceptable then signal the user \u0026#34;error: * connection reset\u0026#34;, drop the segment, enter CLOSED state, * delete TCB, and return.\u0026#34; */ if (th-\u0026gt;rst) { tcp_reset(sk); goto discard; } /* rfc793: * \u0026#34;fifth, if neither of the SYN or RST bits is set then * drop the segment and return.\u0026#34; * * See note below! * --ANK(990513) */ if (!th-\u0026gt;syn) goto discard_and_undo; ...çœç•¥... æ„é€ è¯·æ±‚ # å¯ä»¥å€ŸåŠ© Scapy_TcpsessionæŒ‡å®štcp sequenceå‘é€httpè¯·æ±‚ï¼Œæ¥å¤ç°\nclient-1 å‘é€tcp seqenceä¸º1çš„httpè¯·æ±‚ [root@nod[root@node1] /data0$ python scapy_http.py 1 [root@nod[root@node1] /data0$ cat scapy_http.py #!/usr/bin/python #-*- coding:utf-8 -*- from Scapy_Tcpsession import TcpSession import sys if len(sys.argv) \u0026lt; 2: print \u0026#39;lack args\u0026#39; sys.exit() sess = TcpSession((\u0026#39;172.16.10.8\u0026#39;,80,int(sys.argv[1]),54321)) sess.connect() http_get=( \u0026#34;GET / HTTP/1.0\\r\\n\u0026#34; \u0026#34;Host: 172.16.10.8:80\\r\\n\u0026#34; \u0026#34;User-Agent: Python Scapy\\r\\n\u0026#34; \u0026#34;Connection: close\\r\\n\\r\\n\u0026#34; ) sess.send(http_get) client-2 è¯·æ±‚172.16.10.8:80å‘ç°è¿”å›æ­£å¸¸ [root@node2] ~$ curl --local-port 54321 172.16.10.8:80 ã€\u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD HTML 3.2 Final//EN\u0026#34;\u0026gt;\u0026lt;html\u0026gt; \u0026lt;title\u0026gt;Directory listing for /\u0026lt;/title\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;Directory listing for /\u0026lt;/h2\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;nohup.out\u0026#34;\u0026gt;nohup.out\u0026lt;/a\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;test.file\u0026#34;\u0026gt;test.file\u0026lt;/a\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; bpftraceè·Ÿè¸ªå†…æ ¸å¤„ç†è¿‡ç¨‹ # ä½¿ç”¨bpftraceå·¥å…·è§‚å¯Ÿä¸‹client-2 æ”¶åˆ°ACKåŒ…çš„å¤„ç†æµç¨‹\n[root@node2] /data0/kernel$ bpftrace synsent.bt #!/usr/bin/env bpftrace #include \u0026lt;linux/tcp.h\u0026gt; #include \u0026lt;net/tcp.h\u0026gt; BEGIN { @tcp_sk_status[2] = \u0026#34;TCP_SYN_SENT\u0026#34;; @tcp_sk_status[9] = \u0026#34;TCP_LAST_ACK\u0026#34;; } kprobe:tcp_rcv_state_process { $sk=(struct sock *)arg0; $tp=(struct tcp_sock *)$sk; $skb = (struct sk_buff *)arg1; $iphd = ((struct iphdr *)($skb-\u0026gt;head + $skb-\u0026gt;network_header)); $th = ((struct tcphdr *)($skb-\u0026gt;head + $skb-\u0026gt;transport_header)); $dport = $th-\u0026gt;dest; $dport = ($dport \u0026gt;\u0026gt; 8) | (($dport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); if ($dport == 54321) { $ack = $th-\u0026gt;ack_seq; $ack = ($ack \u0026gt;\u0026gt; 24) | (($ack \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $ack \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($ack \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $skc_state=$sk-\u0026gt;__sk_common.skc_state; printf(\u0026#34;%s:\\ntcp_sk_status: %s, syn:%u,ack:%u,fin:%u,ack_seq:%u, snd_una:%u, snd_nxt:%u\\n\u0026#34;,func,@tcp_sk_status[$skc_state],$th-\u0026gt;syn,$th-\u0026gt;ack,$th-\u0026gt;fin,$ack,$tp-\u0026gt;snd_una,$tp-\u0026gt;snd_nxt); $una = $tp-\u0026gt;snd_una - $ack; $int_una = (int32) $una; // (!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una) if (!((int32)($tp-\u0026gt;snd_una - $ack) \u0026lt; 0)) { printf(\u0026#34;%d, SEG.ACK =\u0026lt; ISS\\n\u0026#34;,$int_una); } $nxt = $tp-\u0026gt;snd_nxt - $ack; $int_nxt = (int32) $nxt; // after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt)) if ((int32)($tp-\u0026gt;snd_nxt - $ack) \u0026lt; 0) { printf(\u0026#34;%d, SEG.ACK \u0026gt; SND.NXT\\n\u0026#34;,$int_nxt); } } } END { clear(@tcp_sk_status); } [root@node2] /data0/kernel$ bpftrace synsent.bt tcp_rcv_state_process: tcp_sk_status: TCP_SYN_SENT, syn:0,ack:1,fin:0,ack_seq:88, snd_una:2387012236, snd_nxt:2387012237 -1907955147, SEG.ACK \u0026gt; SND.NXT tcp_rcv_state_process: tcp_sk_status: TCP_SYN_SENT, syn:1,ack:1,fin:0,ack_seq:2387012237, snd_una:2387012236, snd_nxt:2387012237 tcp_rcv_state_process: tcp_sk_status: TCP_LAST_ACK, syn:0,ack:1,fin:0,ack_seq:2387012313, snd_una:2387012312, snd_nxt:2387012313 å¯ä»¥çœ‹åˆ°ï¼Œclient-2æ”¶åˆ°serverçš„ACKå›åŒ…å\nå†…æ ¸tcp_rcv_state_processå‡½æ•°åˆ¤æ–­ ack_seq = 88 \u0026gt; snd_una = 2387012236 (u32å·®å€¼å¼ºåˆ¶int32è½¬æ¢ï¼Œç›¸å·®2^31æº¢å‡ºå¯¼è‡´)ï¼Œå‘é€server resetæ•°æ®åŒ… serverç«¯æ”¶åˆ°resetåŒ…åï¼Œæ¸…ç†tcp TIME_WAITè¿æ¥ client-2é‡å‘synåŒ…ï¼Œserverç«¯è¿”å›syn+ackï¼Œæ¡æ‰‹æˆåŠŸ åŒæ ·ä½¿ç”¨bpftraceå·¥å…·è§‚å¯Ÿserverçš„å¤„ç†è¿‡ç¨‹ï¼Œ\n[root@localhost] $ cat trace-time_wait.bt #!/usr/bin/env bpftrace #include \u0026lt;linux/tcp.h\u0026gt; #include \u0026lt;net/tcp.h\u0026gt; #include \u0026lt;net/inet_timewait_sock.h\u0026gt; BEGIN { @tw_substate[5] = \u0026#34;TCP_FIN_WAIT2\u0026#34;; @tw_substate[6] = \u0026#34;TCP_TIME_WAIT\u0026#34;; @tcp_tw_status[0] = \u0026#34;TCP_TW_SUCCESS\u0026#34;; @tcp_tw_status[2] = \u0026#34;TCP_TW_ACK\u0026#34;; @tcp_tw_status[3] = \u0026#34;TCP_TW_SYN\u0026#34;; } kprobe:tcp_timewait_state_process { $inet = (struct inet_timewait_sock *)arg0; $tw = (struct tcp_timewait_sock *)$inet; $skb = (struct sk_buff *)arg1; $th = (struct tcphdr *)arg2; $iphd = ((struct iphdr *)($skb-\u0026gt;head + $skb-\u0026gt;network_header)); if ($iphd-\u0026gt;protocol == IPPROTO_TCP) { $srcaddr = $iphd-\u0026gt;saddr; $dstaddr = $iphd-\u0026gt;daddr; $srcip = ntop($iphd-\u0026gt;saddr); $dstip = ntop($iphd-\u0026gt;daddr); // $th = ((struct tcphdr *)($skb-\u0026gt;head + $skb-\u0026gt;transport_header)); $dport = $th-\u0026gt;dest; $dport = ($dport \u0026gt;\u0026gt; 8) | (($dport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); if ($dport == 80) { $sport = $th-\u0026gt;source; $sport = ($sport \u0026gt;\u0026gt; 8) | (($sport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); // $st = *$th; $seq = $th-\u0026gt;seq; $seq = ($seq \u0026gt;\u0026gt; 24) | (($seq \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $seq \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($seq \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $ack = $th-\u0026gt;ack_seq; $ack = ($ack \u0026gt;\u0026gt; 24) | (($ack \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $ack \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($ack \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $win = $th-\u0026gt;window; $win = ($win \u0026gt;\u0026gt; 8) | (($win \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); $tw_rcv_nxt = $tw-\u0026gt;tw_rcv_nxt; printf(\u0026#34;%s:\\n\u0026#34;,func); printf(\u0026#34;%s:%d -\u0026gt; %s:%d\\n\u0026#34;,$srcip, $sport, $dstip, $dport); /* TCP_FIN_WAIT2çŠ¶æ€æ”¶åˆ°finåŒ…: tcptw-\u0026gt;tw_rcv_nxt = TCP_SKB_CB(skb)-\u0026gt;end_seq; å›å¤å¯¹æ–¹çš„ackåŒ…ä¸­ ack=tw_rcv_nxt=seq+1 TCP_SKB_CB(skb)-\u0026gt;end_seq = (TCP_SKB_CB(skb)-\u0026gt;seq + th-\u0026gt;syn + th-\u0026gt;fin + skb-\u0026gt;len - th-\u0026gt;doff * 4); */ printf(\u0026#34;[syn:%d,ack:%d,fin:%d,rst:%d], seq:%-u, ack:%u, win:%u, tw_rcv_nxt:%u\\n\u0026#34;,$th-\u0026gt;syn, $th-\u0026gt;ack, $th-\u0026gt;fin, $th-\u0026gt;rst, $seq, $ack, $win, $tw_rcv_nxt); // printf(\u0026#34;%d compare %d\\n\u0026#34;,$th-\u0026gt;doff,sizeof($st)\u0026gt;\u0026gt;2); $state = $inet-\u0026gt;tw_substate; $statestr = @tw_substate[$state]; printf(\u0026#34;tw_substate: %s\\n\u0026#34;,$statestr); } } } kretprobe:tcp_timewait_state_process { $ret = retval; $statestr = @tcp_tw_status[$ret]; printf(\u0026#34;tcp_tw_status: %s\\n\u0026#34;,$statestr); print(\u0026#34;################################\u0026#34;); } END { clear(@tw_substate); clear(@tcp_tw_status); } [root@localhost] $ bpftrace trace-time_wait.bt tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:1,ack:0,fin:0,rst:0], seq:2387012236, ack:0, win:32120, tw_rcv_nxt:88 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_ACK ################################ tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:0,ack:0,fin:0,rst:1], seq:88, ack:0, win:0, tw_rcv_nxt:88 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_SUCCESS ################################ å¯ä»¥çœ‹åˆ°ï¼Œserveræ”¶åˆ°SYNåŒ…å\ntcp_timewait_state_processå‡½æ•°åˆ¤æ–­sequenceå›ç»•ï¼ˆseq \u0026lt; tw_rcv_nxtï¼‰ï¼Œè¿”å›ç»™client-2 ACKåŒ… æ”¶åˆ°client-2å‘é€çš„resetåŒ…ï¼Œç›´æ¥æ¸…ç†tcp TIME_WAITè¿æ¥ æµ‹è¯•ç¯å¢ƒæ­å»ºåå‘ç°serverç«¯TIME_WAITçŠ¶æ€æŒç»­æ—¶é—´ä¸º60sï¼Œè¿™æ˜¯å› ä¸ºå†…æ ¸ç‰ˆæœ¬çš„å·®å¼‚ã€‚å‚è€ƒè¿™ç¯‡æ–‡ç«  ä» Linux æºç çœ‹ TIME_WAIT çŠ¶æ€çš„æŒç»­æ—¶é—´\n","date":"12 December 2021","permalink":"/posts/blog-test/","section":"åšå®¢","summary":"èƒŒæ™¯ # æœåŠ¡podå®ä¾‹è®¿é—®å¯¹æ–¹æ¥å£é¢‘ç¹è¶…æ—¶ï¼Œå¼•èµ·å®¢è¯‰ã€‚æˆ‘ä»¬é€šè¿‡ä¸“çº¿ä¸å¯¹æ–¹æœºæˆ¿äº’è”ï¼Œå¹¶ä¸”ä¸“çº¿æ¥å…¥ä¾§éƒ¨ç½²æœ‰ä¸“ç”¨ç‰©ç†è®¾å¤‡(vpnåŠ å¯†é€šé“)ï¼Œæ¶æ„å›¾å¦‚ä¸‹ é—®é¢˜åˆ†æ # å®¢æˆ·ç«¯è¯·æ±‚æŠ“åŒ… # å¯¹æœåŠ¡podå®ä¾‹æŠ“åŒ…åˆ†æï¼Œå‘ç°è¶…æ—¶çš„httpè¯·æ±‚å‡ä¸ºå‘é€synåŒ…æ— å“åº”å¯¼è‡´tcpè¿æ¥å»ºç«‹å¤±è´¥è¶…æ—¶ã€‚åŒæ—¶ä¸“çº¿ç½‘ç»œç›‘æ§æ¯”è¾ƒç¨³ï¼Œå¯ä»¥æ’é™¤ä¸“çº¿ç½‘ç»œä¸¢åŒ…çš„åŸå›  å¯¹æ–¹æœåŠ¡å™¨æŠ“åŒ… # è”ç³»å¯¹æ–¹ååŠ©åœ¨serveræœºå™¨ä¸ŠæŠ“åŒ…ï¼Œåˆ†æå¯¹æ–¹æä¾›çš„æŠ“åŒ…æ–‡ä»¶:\nå®¢æˆ·ç«¯è¯·æ±‚ç»è¿‡é˜²ç«å¢™SNATåï¼Œå¯¹æ–¹serverçœ‹åˆ°çš„å®¢æˆ·ç«¯IPéƒ½ä¸€æ · æœåŠ¡å™¨ä¸Šæ”¶åˆ°äº†SYNåŒ…ï¼Œä½†æ˜¯å›å¤çš„æ˜¯ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACKåŒ… è¶…æ—¶é‡ä¼ éƒ½å‘ç”Ÿåœ¨å®¢æˆ·ç«¯è¯·æ±‚æºç«¯å£å¤ç”¨æ—¶(åå‡ ç§’~ä¹åå‡ ç§’) clientå¤ç”¨ç«¯å£æ—¶ï¼Œå¯¹æ¯”serverå‘é€çš„ACKåŒ…å’Œç›¸åŒäº”å…ƒç»„TCPè¿æ¥æ–­å¼€æ—¶å‘é€çš„æœ€åä¸€ä¸ªACKåŒ…ï¼ŒAcknowledgment numberæ˜¯ç›¸åŒçš„ HTTP response headerä¸­åŒ…å«Connection: closeï¼Œserveråªæ”¯æŒhttp1.0çŸ­è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåserverä¸»åŠ¨æ–­å¼€TCPè¿æ¥å¹¶è¿›å…¥TIME-WAITçŠ¶æ€ æ ¹æ®ä»¥ä¸Šåˆ†ææ¨æ–­ï¼Œå¯¹äºæ–°è¯·æ±‚serverç«¯å¤ç”¨äº†ä¹‹å‰çš„TCPè¿æ¥ï¼ŒTCPè¿æ¥å¤„äºTIME-WAITçŠ¶æ€\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œserverå›å¤äº†ACKåŒ…ï¼Œå®¢æˆ·ç«¯ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°ï¼Ÿ é€šè¿‡åœ¨ä¸“ç”¨è®¾å¤‡ä¸ŠæŠ“åŒ…åˆ†æï¼Œå‘ç°æ”¶åˆ°äº†ACKå›åŒ…ï¼Œæ¨æµ‹æ˜¯è¢«é˜²ç«å¢™dropã€‚å› ä¸ºé˜²ç«å¢™TCPè¿æ¥TIME-WAITçŠ¶æ€timeoutæ—¶é—´ä¸º1sï¼Œå¯¹äºå®¢æˆ·ç«¯æ–°è¯·æ±‚SYNåŒ…ï¼Œä¼šæ–°å»ºtcp sessionï¼Œæ”¶åˆ°server ACKå›åŒ…åï¼Œè®¤ä¸ºéæ³•å°±dropäº†\nè§£å†³æ–¹æ¡ˆ # æ”¯æŒHTTP1.1é•¿è¿æ¥ # æ¥å£æ”¯æŒhttp1.1é•¿è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåä¼šä¸»åŠ¨æ–­å¼€TCPè¿æ¥ï¼ŒTIME-WAITçŠ¶æ€ç»´æŒåœ¨å®¢æˆ·ç«¯ã€‚å¯¹æ–¹åé¦ˆæ— æ³•æ”¯æŒ","title":"ä¸€æ¬¡è¯·æ±‚è¶…æ—¶é—®é¢˜æ’æŸ¥è®°å½•"},{"content":"","date":"1 January 0001","permalink":"/categories/","section":"Categories","summary":"","title":"Categories"},{"content":"ğŸ¤æ„Ÿå…´è¶£å¯ä»¥åŠ ä¸ªå¥½å‹ ","date":"1 January 0001","permalink":"/me/","section":"Welcome to feixiang's blog ğŸ‰","summary":"ğŸ¤æ„Ÿå…´è¶£å¯ä»¥åŠ ä¸ªå¥½å‹ ","title":"My Wechat"},{"content":"","date":"1 January 0001","permalink":"/series/","section":"Series","summary":"","title":"Series"}]