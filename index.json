[{"content":"","date":"12 September 2023","permalink":"/tags/bpftrace/","section":"Tags","summary":"","title":"bpftrace"},{"content":"","date":"12 September 2023","permalink":"/tags/linux/","section":"Tags","summary":"","title":"Linux"},{"content":"","date":"12 September 2023","permalink":"/tags/","section":"Tags","summary":"","title":"Tags"},{"content":"","date":"12 September 2023","permalink":"/tags/tcp/","section":"Tags","summary":"","title":"TCP"},{"content":"ğŸ™‹â€â™‚ï¸Hello,æˆ‘æ˜¯ğŸ‘¨â€ğŸ’»FeixiangFu\nğŸ®èµ„æ·±DOTA2äº‘ç©å®¶ğŸ‡¨ğŸ‡³CN Dota Best DotağŸ’¯ğŸ’¯ğŸ’¯\nğŸ¤æ„Ÿå…´è¶£å¯ä»¥ä¸€èµ·äº¤æµå­¦ä¹  ğŸ˜Š\n","date":"12 September 2023","permalink":"/","section":"Welcome to feixiang's blog ğŸ‰","summary":"ğŸ™‹â€â™‚ï¸Hello,æˆ‘æ˜¯ğŸ‘¨â€ğŸ’»FeixiangFu\nğŸ®èµ„æ·±DOTA2äº‘ç©å®¶ğŸ‡¨ğŸ‡³CN Dota Best DotağŸ’¯ğŸ’¯ğŸ’¯\nğŸ¤æ„Ÿå…´è¶£å¯ä»¥ä¸€èµ·äº¤æµå­¦ä¹  ğŸ˜Š","title":"Welcome to feixiang's blog ğŸ‰"},{"content":"","date":"12 September 2023","permalink":"/posts/","section":"åšå®¢","summary":"","title":"åšå®¢"},{"content":"èƒŒæ™¯ # æœåŠ¡podå®ä¾‹è®¿é—®å¯¹æ–¹æ¥å£é¢‘ç¹è¶…æ—¶ï¼Œå¼•èµ·å®¢è¯‰ã€‚æˆ‘ä»¬é€šè¿‡ä¸“çº¿ä¸å¯¹æ–¹æœºæˆ¿äº’è”ï¼Œå¹¶ä¸”ä¸“çº¿æ¥å…¥ä¾§éƒ¨ç½²æœ‰ä¸“ç”¨ç‰©ç†è®¾å¤‡(vpnåŠ å¯†é€šé“)ï¼Œæ¶æ„å›¾å¦‚ä¸‹ é—®é¢˜åˆ†æ # å®¢æˆ·ç«¯è¯·æ±‚æŠ“åŒ… # å¯¹æœåŠ¡podå®ä¾‹æŠ“åŒ…åˆ†æï¼Œå‘ç°è¶…æ—¶çš„httpè¯·æ±‚å‡ä¸ºå‘é€synåŒ…æ— å“åº”å¯¼è‡´tcpè¿æ¥å»ºç«‹å¤±è´¥è¶…æ—¶ã€‚åŒæ—¶ä¸“çº¿ç½‘ç»œç›‘æ§æ¯”è¾ƒç¨³ï¼Œå¯ä»¥æ’é™¤ä¸“çº¿ç½‘ç»œä¸¢åŒ…çš„åŸå›  å¯¹æ–¹æœåŠ¡å™¨æŠ“åŒ… # è”ç³»å¯¹æ–¹ååŠ©åœ¨serveræœºå™¨ä¸ŠæŠ“åŒ…ï¼Œåˆ†æå¯¹æ–¹æä¾›çš„æŠ“åŒ…æ–‡ä»¶:\nå®¢æˆ·ç«¯è¯·æ±‚ç»è¿‡é˜²ç«å¢™SNATåï¼Œå¯¹æ–¹serverçœ‹åˆ°çš„å®¢æˆ·ç«¯IPéƒ½ä¸€æ · æœåŠ¡å™¨ä¸Šæ”¶åˆ°äº†SYNåŒ…ï¼Œä½†æ˜¯å›å¤çš„æ˜¯ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACKåŒ… è¶…æ—¶é‡ä¼ éƒ½å‘ç”Ÿåœ¨å®¢æˆ·ç«¯è¯·æ±‚æºç«¯å£å¤ç”¨æ—¶(åå‡ ç§’~ä¹åå‡ ç§’) clientå¤ç”¨ç«¯å£æ—¶ï¼Œå¯¹æ¯”serverå‘é€çš„ACKåŒ…å’Œç›¸åŒäº”å…ƒç»„TCPè¿æ¥æ–­å¼€æ—¶å‘é€çš„æœ€åä¸€ä¸ªACKåŒ…ï¼ŒAcknowledgment numberæ˜¯ç›¸åŒçš„ HTTP response headerä¸­åŒ…å«Connection: closeï¼Œserveråªæ”¯æŒhttp1.0çŸ­è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåserverä¸»åŠ¨æ–­å¼€TCPè¿æ¥å¹¶è¿›å…¥TIME-WAITçŠ¶æ€ æ ¹æ®ä»¥ä¸Šåˆ†ææ¨æ–­ï¼Œå¯¹äºæ–°è¯·æ±‚serverç«¯å¤ç”¨äº†ä¹‹å‰çš„TCPè¿æ¥ï¼ŒTCPè¿æ¥å¤„äºTIME-WAITçŠ¶æ€\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œserverå›å¤äº†ACKåŒ…ï¼Œå®¢æˆ·ç«¯ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°ï¼Ÿ é€šè¿‡åœ¨ä¸“ç”¨è®¾å¤‡ä¸ŠæŠ“åŒ…åˆ†æï¼Œå‘ç°æ”¶åˆ°äº†ACKå›åŒ…ï¼Œæ¨æµ‹æ˜¯è¢«é˜²ç«å¢™dropã€‚å› ä¸ºé˜²ç«å¢™TCPè¿æ¥TIME-WAITçŠ¶æ€timeoutæ—¶é—´ä¸º1sï¼Œå¯¹äºå®¢æˆ·ç«¯æ–°è¯·æ±‚SYNåŒ…ï¼Œä¼šæ–°å»ºtcp sessionï¼Œæ”¶åˆ°server ACKå›åŒ…åï¼Œè®¤ä¸ºéæ³•å°±dropäº†\nè§£å†³æ–¹æ¡ˆ # æ”¯æŒHTTP1.1é•¿è¿æ¥ # æ¥å£æ”¯æŒhttp1.1é•¿è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåä¼šä¸»åŠ¨æ–­å¼€TCPè¿æ¥ï¼ŒTIME-WAITçŠ¶æ€ç»´æŒåœ¨å®¢æˆ·ç«¯ã€‚å¯¹æ–¹åé¦ˆæ— æ³•æ”¯æŒ\nå¢åŠ é˜²ç«å¢™SNATåœ°å€æ±  # å½“å‰ä¸šåŠ¡çš„é˜²ç«å¢™ç­–ç•¥çš„SNAT IP Poolåªæœ‰ä¸€ä¸ª3.3.10.10ï¼Œå°è¯•å†å¢åŠ ä¸€ä¸ª3.3.10.11ï¼Œå‘ç°é˜²ç«å¢™å¹¶æ²¡æœ‰è½®è¯¢ä½¿ç”¨ã€‚æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºå½“å‰åœ¨ç”¨çš„IP Poolç±»å‹ä¸ºoverloadï¼Œä¼šæ ¹æ®å®¢æˆ·ç«¯IPåˆ†é…snatåœ°å€ã€‚æ¯”èµ·å·§åˆçš„æ˜¯å½“å‰å®¢æˆ·ç«¯å››ä¸ªpod ip è®¡ç®—å‡ºæ¥éƒ½ä¼šä½¿ç”¨3.3.10.10ã€‚æ‰€ä»¥å®¢æˆ·ç«¯pod IPéšæœºåˆ†é…ï¼Œæœ€ç»ˆä½¿ç”¨snatåœ°å€ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼Œè€ƒè™‘æŠŠSNAT IP Poolåˆ‡æ¢ä¸º one-to-oneç±»å‹\none-to-oneæ¨¡å¼æ˜¯: å†…éƒ¨ IP åœ°å€å’Œå¤–éƒ¨ï¼ˆè½¬æ¢åçš„ï¼‰IP åœ°å€ä¸€å¯¹ä¸€åŒ¹é…\né…ç½®ä¸€ä¸ª28ä½çš„æ–°åœ°å€æ± ä¹‹åï¼Œè¶…æ—¶è¯·æ±‚ç‡å¤§å¹…é™ä½ã€‚ä½†æ˜¯one-to-one IP poolå¹¶ä¸æ˜¯é™æ€SNATï¼Œæ‰€ä»¥æ¯æ¬¡å®¢æˆ·ç«¯è¯·æ±‚ç»“æŸåï¼Œä¼šé‡Šæ”¾snat IPåˆ°æ± å­é‡Œï¼Œè¿˜æ˜¯æœ‰ä¸€å®šå‡ ç‡è¶…æ—¶ã€‚\nå¦‚æœè¦å½»åº•è§£å†³ï¼Œéœ€è¦ç‰©ç†æœºæˆ–è™šæœºéƒ¨ç½²å›ºå®šIPï¼Œç„¶åé…ç½®é˜²ç«å¢™é…ç½®é™æ€SNAT\nå†…æ ¸æºç çœ‹TIME_WAITè¿æ¥å¤„ç† # ä¸ºä»€ä¹ˆä¼šè¿”å›ACK? ä»å†…æ ¸æºç ä¸­æ‰¾ç­”æ¡ˆï¼Œå†…æ ¸ç‰ˆæœ¬3.10.0-1062\ntcp_v4_rcv() # tcp_v4_rcvå‡½æ•°è´Ÿè´£æ¥æ”¶å’Œå¤„ç†ä¼ å…¥çš„TCP ipv4 æ•°æ®åŒ…\nint tcp_v4_rcv(struct sk_buff *skb) { const struct iphdr *iph; const struct tcphdr *th; struct sock *sk; /* ä¸­é—´çœç•¥ */ process: // TCPè¿æ¥å¤„äºTIMT_WAITçŠ¶æ€æ—¶ï¼Œè·³è½¬åˆ°do_time_wait if (sk-\u0026gt;sk_state == TCP_TIME_WAIT) goto do_time_wait; /* ä¸­é—´çœç•¥ */ do_time_wait: /* ä¸­é—´çœç•¥ */ // æ ¹æ®tcp_timewait_state_processå‡½æ•°è¿”å›å€¼ï¼Œç¡®å®šä¸‹ä¸€æ­¥åŠ¨ä½œ switch (tcp_timewait_state_process(inet_twsk(sk), skb, th)) { // åˆæ³•SYNåŒ…ï¼Œå¯ä»¥å¤ç”¨TCPè¿æ¥ï¼ŒtcpçŠ¶æ€å¯ä»¥åˆ‡æ¢è‡³SYN_RECV case TCP_TW_SYN: { struct sock *sk2 = inet_lookup_listener(dev_net(skb-\u0026gt;dev), \u0026amp;tcp_hashinfo, iph-\u0026gt;saddr, th-\u0026gt;source, iph-\u0026gt;daddr, th-\u0026gt;dest, inet_iif(skb)); if (sk2) { inet_twsk_deschedule(inet_twsk(sk), \u0026amp;tcp_death_row); inet_twsk_put(inet_twsk(sk)); sk = sk2; goto process; } /* Fall through to ACK */ } /* å‘é€ACKåŒ… 1.TCP_FIN_WAIT2çŠ¶æ€æ”¶åˆ°FINåŒ…ï¼Œå‘é€æœ€åä¸€æ¬¡æŒ¥æ‰‹çš„ACKåŒ… 2.TCP_TIME_WAITçŠ¶æ€ä¸‹å‘é€ä¸Šä¸€æ¬¡çš„ACKåŒ… */ case TCP_TW_ACK: tcp_v4_timewait_ack(sk, skb); break; // å‘é€RESETåŒ… case TCP_TW_RST: tcp_v4_send_reset(sk, skb); inet_twsk_deschedule(inet_twsk(sk), \u0026amp;tcp_death_row); inet_twsk_put(inet_twsk(sk)); goto discard_it; // ç›´æ¥ä¸¢å¼ƒï¼Œä¸åšå¤„ç† case TCP_TW_SUCCESS:; } goto discard_it; } ç»“åˆä¸Šé¢çš„åœºæ™¯ï¼Œserverå¤„ç†æµç¨‹åº”è¯¥æ˜¯: æ”¶åˆ°SYNåŒ…ï¼ŒtcpçŠ¶æ€ä¸ºTCP_TIME_WAITï¼Œtcp_timewait_state_process()å‡½æ•°å¤„ç†å¹¶è¿”å›äº†TCP_TW_ACK\ntcp_timewait_state_process() # tcp_timewait_state_process() å‡½æ•°å¤„ç†\ntcp_timewait_state_process(struct inet_timewait_sock *tw, struct sk_buff *skb, const struct tcphdr *th) { struct tcp_options_received tmp_opt; struct tcp_timewait_sock *tcptw = tcp_twsk((struct sock *)tw); bool paws_reject = false; tmp_opt.saw_tstamp = 0; // tcp headerä¸­å¼€å¯äº†optionsä¸”å½“å‰tcpè¿æ¥å¼€å¯äº†æ—¶é—´æˆ³é€‰é¡¹ if (th-\u0026gt;doff \u0026gt; (sizeof(*th) \u0026gt;\u0026gt; 2) \u0026amp;\u0026amp; tcptw-\u0026gt;tw_ts_recent_stamp) { tcp_parse_options(skb, \u0026amp;tmp_opt, 0, NULL); if (tmp_opt.saw_tstamp) { if (tmp_opt.rcv_tsecr) tmp_opt.rcv_tsecr -= tcptw-\u0026gt;tw_ts_offset; tmp_opt.ts_recent\t= tcptw-\u0026gt;tw_ts_recent; tmp_opt.ts_recent_stamp\t= tcptw-\u0026gt;tw_ts_recent_stamp; /* å¦‚æœå¼€å¯äº†TCP timestampå¯é€‰é¡¹ï¼Œåˆ¤æ–­æ˜¯å¦å‘ç”Ÿæ—¶é—´æˆ³å›ç»• 1. paws_reject = false æ—¶é—´æˆ³æ²¡æœ‰å›ç»• 2. paws_reject = true æ—¶é—´æˆ³å›ç»• */ paws_reject = tcp_paws_reject(\u0026amp;tmp_opt, th-\u0026gt;rst); } } // tcpçŠ¶æ€æ˜¯FIN_WAIT2çš„å¤„ç†é€»è¾‘ if (tw-\u0026gt;tw_substate == TCP_FIN_WAIT2) { /* ä¸­é—´çœç•¥ */ } // æ—¶é—´æˆ³æ²¡æœ‰å›ç»• if (!paws_reject \u0026amp;\u0026amp; // æŠ¥æ–‡åºåˆ—å· ç­‰äº é¢„æœŸæ¥æ”¶çš„åºåˆ—å· (TCP_SKB_CB(skb)-\u0026gt;seq == tcptw-\u0026gt;tw_rcv_nxt \u0026amp;\u0026amp; /* TCP_SKB_CB(skb)-\u0026gt;end_seq = (TCP_SKB_CB(skb)-\u0026gt;seq + th-\u0026gt;syn + th-\u0026gt;fin + skb-\u0026gt;len - th-\u0026gt;doff * 4); æ²¡æœ‰æºå¸¦æ•°æ®æŠ¥æ–‡ï¼Œåªæœ‰tcp headerä¸”æ²¡æœ‰syn/finæ ‡å¿—ä½ï¼Œåªèƒ½æ˜¯resetæˆ–è€…ack */ (TCP_SKB_CB(skb)-\u0026gt;seq == TCP_SKB_CB(skb)-\u0026gt;end_seq || th-\u0026gt;rst))) { /* In window segment, it may be only reset or bare ack. */ if (th-\u0026gt;rst) { // net.ipv4.tcp_rfc1337å†…æ ¸å‚æ•°ç­‰äº0æ—¶ if (sysctl_tcp_rfc1337 == 0) { kill: //æ¸…ç†TIME_WAITè¿æ¥ inet_twsk_deschedule(tw, \u0026amp;tcp_death_row); inet_twsk_put(tw); return TCP_TW_SUCCESS; } } else { // é‡ç½®TIME_WAITçŠ¶æ€timeoutæ—¶é—´ inet_twsk_schedule(tw, \u0026amp;tcp_death_row, TCP_TIMEWAIT_LEN, TCP_TIMEWAIT_LEN); } if (tmp_opt.saw_tstamp) { tcptw-\u0026gt;tw_ts_recent\t= tmp_opt.rcv_tsval; tcptw-\u0026gt;tw_ts_recent_stamp = get_seconds(); } inet_twsk_put(tw); return TCP_TW_SUCCESS; } // SYNåŒ…ä¸”æ²¡æœ‰rst/ackæ ‡å¿—ä½ï¼Œæ—¶é—´æˆ³æ²¡æœ‰å›ç»• if (th-\u0026gt;syn \u0026amp;\u0026amp; !th-\u0026gt;rst \u0026amp;\u0026amp; !th-\u0026gt;ack \u0026amp;\u0026amp; !paws_reject \u0026amp;\u0026amp; // åºåˆ—å·æ²¡æœ‰å›ç»• æˆ–è€… (after(TCP_SKB_CB(skb)-\u0026gt;seq, tcptw-\u0026gt;tw_rcv_nxt) || // è¯·æ±‚æŠ¥æ–‡ä¸­å¼€å¯timestampå¯é€‰é¡¹å¹¶ä¸”æ—¶é—´æˆ³æ²¡æœ‰å›ç»• (tmp_opt.saw_tstamp \u0026amp;\u0026amp; (s32)(tcptw-\u0026gt;tw_ts_recent - tmp_opt.rcv_tsval) \u0026lt; 0))) { u32 isn = tcptw-\u0026gt;tw_snd_nxt + 65535 + 2; if (isn == 0) isn++; TCP_SKB_CB(skb)-\u0026gt;tcp_tw_isn = isn; return TCP_TW_SYN; } if (paws_reject) // æ›´æ–° /proc/net/netstat NET_INC_STATS_BH(twsk_net(tw), LINUX_MIB_PAWSESTABREJECTED); if (!th-\u0026gt;rst) { /* In this case we must reset the TIMEWAIT timer. * * If it is ACKless SYN it may be both old duplicate * and new good SYN with random sequence number \u0026lt;rcv_nxt. * Do not reschedule in the last case. */ if (paws_reject || th-\u0026gt;ack) // é‡ç½®TIME_WAITçŠ¶æ€timeoutæ—¶é—´ inet_twsk_schedule(tw, \u0026amp;tcp_death_row, TCP_TIMEWAIT_LEN, TCP_TIMEWAIT_LEN); /* if (*last_oow_ack_time) { s32 elapsed = (s32)(tcp_time_stamp - *last_oow_ack_time); // è®¡ç®—å½“å‰çš„tcp timestamp(jiffies)å’Œä¸Šæ¬¡å‘é€ackæ—¶çš„tcp timestamp å·®å€¼ // å¦‚æœå°äºå†…æ ¸å‚æ•°net.ipv4.tcp_invalid_ratelimit è¡¨ç¤ºé€Ÿç‡è¿‡å¿«ï¼Œéœ€è¦é™é€Ÿ if (0 \u0026lt;= elapsed \u0026amp;\u0026amp; elapsed \u0026lt; sysctl_tcp_invalid_ratelimit) { // æ›´æ–° /proc/net/netstat NET_INC_STATS(net, mib_idx); return true; } } å¦‚æœdupacksæ²¡æœ‰é™é€Ÿ return TCP_TW_ACKï¼Œå¦åˆ™return TCP_TW_SUCCESS */ return tcp_timewait_check_oow_rate_limit( tw, skb, LINUX_MIB_TCPACKSKIPPEDTIMEWAIT); } inet_twsk_put(tw); return TCP_TW_SUCCESS; } th-\u0026gt;doff æ•°æ®åç§»å­—æ®µï¼Œ4-bitçš„æ— ç¬¦å·æ•´å‹(æ•°æ®èŒƒå›´0~15) è¡¨ç¤ºtcp headerçš„é•¿åº¦ï¼Œå•ä½æ˜¯32-bit(å³4 bytes)ï¼ŒèŒƒå›´5~15 tcp header(no options)é•¿åº¦ä¸º5ï¼Œå¤§å° 5 * 32-bit (4 bytes) = 20 bytes\nsizeof(*th) \u0026raquo; 2 tcphdrç»“æ„ä½“å¤§å°æ˜¯20 bytesï¼Œ20 \u0026raquo; 2 = 20 / 4 = 5\næ—¶é—´æˆ³å›ç»•åˆ¤æ–­ # static inline bool tcp_paws_reject(const struct tcp_options_received *rx_opt, int rst) { // tcp_paws_check()å‡½æ•°åˆ¤æ–­æ˜¯å¦é€šè¿‡æ£€æŸ¥ if (tcp_paws_check(rx_opt, 0)) return false; if (rst \u0026amp;\u0026amp; get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_MSL) return false; return true; } static inline bool tcp_paws_check(const struct tcp_options_received *rx_opt, int paws_win) { if ((s32)(rx_opt-\u0026gt;ts_recent - rx_opt-\u0026gt;rcv_tsval) \u0026lt;= paws_win) return true; if (unlikely(get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_24DAYS)) return true; if (!rx_opt-\u0026gt;ts_recent) return true; return false; } (s32)(rx_opt-\u0026gt;ts_recent - rx_opt-\u0026gt;rcv_tsval) \u0026lt;= 0 å½“å‰tcpè¿æ¥serverä¸Šä¸€æ¬¡å‘é€çš„tcpæŠ¥æ–‡ä¸­çš„TSecrå’ŒtcpæŠ¥æ–‡é€‰ä¸­çš„TSvalçš„å·®å€¼å°äºç­‰äº0ï¼Œæ£€æŸ¥é€šè¿‡\ntcp timestampæ˜¯u32æ— ç¬¦å·æ•´å‹ï¼Œæ•°æ®èŒƒå›´0~2^32-1 s32æ˜¯æœ‰ç¬¦åˆæ•´å‹ï¼Œæ•°æ®èŒƒå›´æ˜¯-2^31~2^31-1 u32æ— ç¬¦å·æ•´å‹å‡æ³•ï¼Œå¦‚æœ|x|\u0026gt;yï¼Œåˆ™y-x = 2^32-|x-y| å¯¹u32å·®å€¼åšå¼ºåˆ¶ç±»å‹è½¬æ¢çš„è¯ï¼Œå¦‚æœè¶…è¿‡2^31å°±ä¼šæº¢å‡ºã€‚æ‰€ä»¥rcv_tsval - ts_recent \u0026gt; 2^31æ—¶ï¼Œæ—¶é—´æˆ³å›ç»•æ£€æŸ¥ä¸ä¼šé€šè¿‡ tcp timestampå–å€¼æ¥æºäºjiffiesï¼Œå’ŒæœåŠ¡å™¨è¿è¡Œæ—¶é•¿æœ‰å…³ï¼Œè®°å½•çš„æ˜¯ä»å¼€æœºåˆ°ç°åœ¨æ—¶é—´æˆ³æ—¶é’Ÿæ›´æ–°äº†å¤šå°‘æ¬¡ï¼Œrfcè§„å®šæ›´æ–°é¢‘ç‡æ˜¯1ms~1sï¼ŒæœåŠ¡å™¨é‡å¯åjiffiesé‡ç½®\nCentosä¸­æŸ¥çœ‹å†…æ ¸æ—¶é—´æˆ³æ—¶é’Ÿé¢‘ç‡ï¼Œ1s/1000=1msï¼Œé‚£ä¹ˆ2^31/1000/(3600*24)=24.8å¤©åå›ç»•\n$ cat /boot/config-3.10.0-1062.el7.x86_64 |grep -w \u0026#34;CONFIG_HZ\u0026#34; CONFIG_HZ=1000 get_seconds() \u0026gt;= rx_opt-\u0026gt;ts_recent_stamp + TCP_PAWS_24DAYS\n#define TCP_PAWS_24DAYS (60 * 60 * 24 * 24) ï¼Œå•ä½æ˜¯s\nå½“å‰ç³»ç»Ÿæ—¶é—´æˆ³åœ¨tcpè¿æ¥ä¸Šä¸€æ¬¡æ”¶åˆ°rcv_tsvalæ—¶çš„ç³»ç»Ÿæ—¶é—´æˆ³çš„24å¤©ä¹‹åçš„è¯ï¼Œåˆ™æ—¶é—´æˆ³å›ç»•æ£€æŸ¥é€šè¿‡\næ—¶é’Ÿé¢‘ç‡æ˜¯1msï¼Œé‚£ä¹ˆrcv_tsvalå¢åŠ åˆ°æº¢å‡ºçš„æ—¶é—´æ˜¯2^31/1000/(3600*24)=24.8å¤©\næ‰€ä»¥å¢åŠ äº†ä¸€ä¸ªè¶…è¿‡TCP_PAWS_24DAYSçš„åˆ¤æ–­ï¼Œç›´æ¥æ£€æŸ¥é€šè¿‡\nåºåˆ—å·å›ç»•åˆ¤æ–­ # å¯¹äºSYNåŒ…ï¼Œä¼šæ¯”è¾ƒtcpæŠ¥æ–‡çš„åºåˆ—å·æ˜¯å¦å¤§äºtcpè¿æ¥è®°å½•çš„è¦é¢„æœŸæ¥æ”¶çš„åºåˆ—å·\nafter(TCP_SKB_CB(skb)-\u0026gt;seq, tcptw-\u0026gt;tw_rcv_nxt)\n// afterå‡½æ•°å®šä¹‰ static inline bool before(__u32 seq1, __u32 seq2) { return (__s32)(seq1-seq2) \u0026lt; 0; } #define after(seq2, seq1) before(seq1, seq2) (__s32)(seq1-seq2) ä¹Ÿæ˜¯å¯¹u32å·®å€¼å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ŒåŒæ ·å­˜åœ¨æº¢å‡ºæƒ…å†µã€‚æ‰€ä»¥å¦‚æœSYNåŒ…çš„seqæ¯”tcptw-\u0026gt;tw_rcv_nxtå¤§è¶…è¿‡2^31ï¼Œåˆ™è®¤ä¸ºåºåˆ—å·å›ç»•ï¼Œä¸èƒ½å¤ç”¨TIME_WAITè¿æ¥\nç»“åˆä¸Šæ–‡æŠ“åŒ…åˆ†æ,\nseq=2123642848ï¼Œ ack=554887750\nts_recent = 869333586ï¼Œrcv_tsval = 28962444\nä»£ç è¿è¡Œç»“æœæ˜¾ç¤ºï¼Œæ—¶é—´æˆ³å‘ç”Ÿå›ç»•ï¼Œæ‰€ä»¥paws_reject = trueï¼Œè¿”å›äº†TCP_TW_ACK\né—®é¢˜åœºæ™¯æ¨¡æ‹Ÿ # æµ‹è¯•ç¯å¢ƒæ­å»º # æœåŠ¡å™¨éƒ½æ˜¯åŸºäºåŒä¸€ç‰©ç†æœºä¸Škvmè™šæ‹ŸåŒ–éƒ¨ç½²ï¼Œå†…æ ¸ç‰ˆæœ¬ 3.10.0-1062.el7.x86_64\nclient è¯·æ±‚ http://172.16.10.8:80 ,è·¯ç”±è½¬å‘åˆ°firewallï¼ŒfilrewallæœåŠ¡å™¨ä¸Šä½¿ç”¨iptablesé…ç½®snatå’Œdnatï¼Œå†è·¯ç”±è½¬å‘åˆ°gatewayï¼Œgatewayå†è½¬å‘åˆ°server\nrole device ip special route system client-1 eth0 172.16.9.131 172.16.10.8 via 172.16.9.133 dev eth0 centos 7.7 client-2 eth0 172.16.9.132 172.16.10.8 via 172.16.9.133 dev eth0 centos 7.7 firewall eth0 172.16.9.133 centos 7.7 eth1 192.168.102.3 192.168.10.9 via 192.168.102.2 dev eth1 physical gw\n(ä¸“ç”¨è®¾å¤‡) eth0 192.168.102.2 3.3.10.10 via 192.168.102.3 dev eth0 centos 7.7 eth1 192.168.10.8 server eth0 192.168.10.9 3.3.10.10 via 192.168.10.8 dev eth0 centos 7.7 firewallé…ç½® # iptablesé…ç½®snatå’Œdnat\n#dnat æ”¶åˆ°è®¿é—®172.16.10.8:80è¯·æ±‚è·¯ç”±è½¬å‘åˆ°192.168.10.9:80 $ iptables -t nat -A PREROUTING -d 172.16.10.8/32 -i eth0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.10.9:80 #snat è®¿é—®192.168.10.9:80çš„è¯·æ±‚ï¼Œæºåœ°å€è½¬æ¢ä¸º3.3.10.10 $ iptables -t nat -A POSTROUTING -d 192.168.10.9/32 -o eth1 -p tcp -m tcp --dport 80 -j SNAT --to-source 3.3.10.10 å†…æ ¸å‚æ•°\n$ sysctl -w net.ipv4.ip_forward=1 # å‚è€ƒç‰©ç†é˜²ç«å¢™é…ç½® $ systcl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=2 gatewayé…ç½® # ä¸“ç”¨è®¾å¤‡æ˜¯ç”¨äºåŒæ–¹å»ºç«‹vpnåŠ å¯†é€šé“ï¼ŒåŸºäºiptableså¯¹è¯·æ±‚æ‰“æ ‡è®°ã€è½¬å‘åˆ°vpnç½‘å¡ã€‚æµ‹è¯•ç¯å¢ƒåªåŠ äº†conntrackè®°å½•\n$ iptables -t nat -A PREROUTING -m conntrack --ctstate INVALID -j LOG --log-prefix \u0026#34;Conntrack INVALID: \u0026#34; --log-level 7 # conntrackæ—¥å¿—è®°å½•æ–‡ä»¶ $ grep conntrack /etc/rsyslog.conf kern.* /var/log/conntrack.log $ sysctl -w net.ipv4.ip_forward=1 # å‚ç…§ä¸“ç”¨è®¾å¤‡é…ç½® $ systcl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=60 serveré…ç½® # # SimpleHTTPServeré»˜è®¤æ˜¯HTTP/1.0 $ nohup python -m SimpleHTTPServer 80 \u0026amp; é—®é¢˜å¤ç° # client-1è¯·æ±‚ # [root@node1] ~$ curl --local-port 54321 172.16.10.8:80 \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD HTML 3.2 Final//EN\u0026#34;\u0026gt;\u0026lt;html\u0026gt; \u0026lt;title\u0026gt;Directory listing for /\u0026lt;/title\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;Directory listing for /\u0026lt;/h2\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;nohup.out\u0026#34;\u0026gt;nohup.out\u0026lt;/a\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;test.file\u0026#34;\u0026gt;test.file\u0026lt;/a\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; åŒæ—¶serveræŠ“åŒ…\n[root@localhost] $ tcpdump -ieth0 port 80 -nnS 17:08:16.798635 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [S], seq 2851797271, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 9], length 0 17:08:16.798704 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [S.], seq 912495348, ack 2851797272, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 9], length 0 ...çœç•¥... 17:08:16.806065 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [F.], seq 2851797347, ack 912495758, win 60, length 0 17:08:16.806073 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [.], ack 2851797348, win 58, length 0 client-2æ¨¡æ‹Ÿè¯·æ±‚ # serverç«¯çš„æŠ“åŒ…è®°å½•å¯ä»¥çœ‹å‡ºï¼Œtcptw-\u0026gt;tw_rcv_nxt = 2851797348ã€‚ä½¿ç”¨python scapyï¼Œå‘é€ä¸€ä¸ªseqå°äº2851797348çš„SYNåŒ…\n[root@node2] /data0/fake$ python send_test.py 2851797340 [root@node2] /data0/fake$ cat send_test.py #!/usr/bin/python #-*- coding:utf-8 -*- from scapy.all import * import sys if len(sys.argv) \u0026lt; 2: print \u0026#39;lack args\u0026#39; sys.exit() # åˆ›å»ºä¸€ä¸ªIPæ•°æ®åŒ…ï¼Œè®¾ç½®æºIPã€ç›®æ ‡IP ip_packet = IP(src=\u0026#34;172.16.9.132\u0026#34;, dst=\u0026#34;172.16.10.8\u0026#34;) # åˆ›å»ºä¸€ä¸ªTCPæ•°æ®åŒ…ï¼Œè®¾ç½®æºç«¯å£ã€ç›®æ ‡ç«¯å£å’Œåºåˆ—å· tcp_packet = TCP(sport=54321, dport=80,flags=\u0026#39;S\u0026#39;, seq=int(sys.argv[1])) # ç»„è£…æ•°æ®åŒ… syn = ip_packet / tcp_packet send(syn)serverç«¯æŠ“åŒ…è®°å½•å¯ä»¥çœ‹åˆ°ï¼Œå›å¤äº†seqä¸º2851797348ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACK 17:08:24.023783 IP 3.3.10.10.54321 \u0026gt; 192.168.10.9.80: Flags [S], seq 2851797340, win 8192, length 0 17:08:24.023842 IP 192.168.10.9.80 \u0026gt; 3.3.10.10.54321: Flags [.], ack 2851797348, win 58, length 0 serverç«¯ä½¿ç”¨bpftraceè„šæœ¬æŸ¥çœ‹tcp_timewait_state_process()å‡½æ•°æ”¶åˆ°SYNåŒ…çš„å†…æ ¸å¤„ç†æµç¨‹\n[root@localhost] $ bpftrace trace-time_wait.bt Attaching 4 probes... tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:1,ack:0,fin:0,rst:0], seq:1351613457, ack:0, win:32120, tw_rcv_nxt:1125813282 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_SYN ################################ tcp sockå¤„äºTCP_TIME_WAITçŠ¶æ€ï¼Œæ”¶åˆ°çš„SYNåŒ…seq=1351613457 \u0026gt; tw_rcv_nxt=1125813282ï¼Œå‡½æ•°è¿”å›TCP_TW_SYN\né—®é¢˜å»¶ä¼¸ # å®¢æˆ·ç«¯å‘é€SYNåŒ…åï¼Œæ”¶åˆ°ACKåŒ…ä¼šæ€ä¹ˆå¤„ç†?\næŸ¥çœ‹å†…æ ¸æºç ï¼Œå®¢æˆ·ç«¯å‘é€SYNåï¼ŒçŠ¶æ€åˆ‡æ¢ä¸ºSYN_SENTã€‚æ”¶åˆ°tcpå›åŒ…åçš„å¤„ç†æµç¨‹: tcp_v4_rcv -\u0026gt; tcp_v4_do_rcv -\u0026gt; tcp_rcv_state_process -\u0026gt; tcp_rcv_synsent_state_process\nçœ‹ä¸€ä¸‹tcp_rcv_synsent_state_processå‡½æ•°ï¼Œå¦‚æœæ”¶åˆ°å›åŒ…è®¾ç½®äº†ACKæ ‡å¿—ä½ï¼Œåˆ¤æ–­è¯¥æ•°æ®åŒ…seqå’Œtimestampæ˜¯å¦ç¬¦åˆé¢„æœŸ\n(!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una)\nsnd_unaæ˜¯å¯¹åº”å‘é€çª—å£è®°å½•çš„æœªè¢«ç¡®è®¤çš„seqå·ï¼Œå¦‚æœack_seq =\u0026lt; snd_unaï¼Œè¿”å›reset\nafter(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt))\nsnd_nxtæ˜¯å¯¹åº”å‘é€çª—å£è®°å½•çš„ä¸‹ä¸€æ¬¡å‘é€çš„seqå·ï¼Œå¦‚æœack_seq \u0026gt; snd_nxtï¼Œè¿”å›reset\næ£€æŸ¥é€šè¿‡åï¼Œå¦‚æœæ•°æ®åŒ…è®¾ç½®äº†RSTæ ‡å¿—ä½ï¼Œç›´æ¥ä¸¢å¼ƒï¼ŒtcpçŠ¶æ€åˆ‡æ¢ä¸ºCLOSEã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œç»§ç»­æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†SYNæ ‡å¿—ä½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç›´æ¥ä¸¢å¼ƒã€‚\nstatic int tcp_rcv_synsent_state_process(struct sock *sk, struct sk_buff *skb, const struct tcphdr *th, unsigned int len) { struct inet_connection_sock *icsk = inet_csk(sk); struct tcp_sock *tp = tcp_sk(sk); struct tcp_fastopen_cookie foc = { .len = -1 }; int saved_clamp = tp-\u0026gt;rx_opt.mss_clamp; tcp_parse_options(skb, \u0026amp;tp-\u0026gt;rx_opt, 0, \u0026amp;foc); if (tp-\u0026gt;rx_opt.saw_tstamp \u0026amp;\u0026amp; tp-\u0026gt;rx_opt.rcv_tsecr) tp-\u0026gt;rx_opt.rcv_tsecr -= tp-\u0026gt;tsoffset; if (th-\u0026gt;ack) { /* rfc793: * \u0026#34;If the state is SYN-SENT then * first check the ACK bit * If the ACK bit is set *\tIf SEG.ACK =\u0026lt; ISS, or SEG.ACK \u0026gt; SND.NXT, send * a reset (unless the RST bit is set, if so drop * the segment and return)\u0026#34; */ if (!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una) || after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt)) goto reset_and_undo; if (tp-\u0026gt;rx_opt.saw_tstamp \u0026amp;\u0026amp; tp-\u0026gt;rx_opt.rcv_tsecr \u0026amp;\u0026amp; !between(tp-\u0026gt;rx_opt.rcv_tsecr, tp-\u0026gt;retrans_stamp, tcp_time_stamp)) { NET_INC_STATS_BH(sock_net(sk), LINUX_MIB_PAWSACTIVEREJECTED); goto reset_and_undo; } /* Now ACK is acceptable. * * \u0026#34;If the RST bit is set * If the ACK was acceptable then signal the user \u0026#34;error: * connection reset\u0026#34;, drop the segment, enter CLOSED state, * delete TCB, and return.\u0026#34; */ if (th-\u0026gt;rst) { tcp_reset(sk); goto discard; } /* rfc793: * \u0026#34;fifth, if neither of the SYN or RST bits is set then * drop the segment and return.\u0026#34; * * See note below! * --ANK(990513) */ if (!th-\u0026gt;syn) goto discard_and_undo; ...çœç•¥... æ„é€ è¯·æ±‚ # å¯ä»¥å€ŸåŠ© Scapy_TcpsessionæŒ‡å®štcp sequenceå‘é€httpè¯·æ±‚ï¼Œæ¥å¤ç°\nclient-1 å‘é€tcp seqenceä¸º1çš„httpè¯·æ±‚ [root@nod[root@node1] /data0$ python scapy_http.py 1 [root@nod[root@node1] /data0$ cat scapy_http.py #!/usr/bin/python #-*- coding:utf-8 -*- from Scapy_Tcpsession import TcpSession import sys if len(sys.argv) \u0026lt; 2: print \u0026#39;lack args\u0026#39; sys.exit() sess = TcpSession((\u0026#39;172.16.10.8\u0026#39;,80,int(sys.argv[1]),54321)) sess.connect() http_get=( \u0026#34;GET / HTTP/1.0\\r\\n\u0026#34; \u0026#34;Host: 172.16.10.8:80\\r\\n\u0026#34; \u0026#34;User-Agent: Python Scapy\\r\\n\u0026#34; \u0026#34;Connection: close\\r\\n\\r\\n\u0026#34; ) sess.send(http_get) client-2 è¯·æ±‚172.16.10.8:80å‘ç°è¿”å›æ­£å¸¸ [root@node2] ~$ curl --local-port 54321 172.16.10.8:80 ã€\u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD HTML 3.2 Final//EN\u0026#34;\u0026gt;\u0026lt;html\u0026gt; \u0026lt;title\u0026gt;Directory listing for /\u0026lt;/title\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;Directory listing for /\u0026lt;/h2\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;nohup.out\u0026#34;\u0026gt;nohup.out\u0026lt;/a\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;test.file\u0026#34;\u0026gt;test.file\u0026lt;/a\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; bpftraceè·Ÿè¸ªå†…æ ¸å¤„ç†è¿‡ç¨‹ # ä½¿ç”¨bpftraceå·¥å…·è§‚å¯Ÿä¸‹client-2 æ”¶åˆ°ACKåŒ…çš„å¤„ç†æµç¨‹\n[root@node2] /data0/kernel$ bpftrace synsent.bt #!/usr/bin/env bpftrace #include \u0026lt;linux/tcp.h\u0026gt; #include \u0026lt;net/tcp.h\u0026gt; BEGIN { @tcp_sk_status[2] = \u0026#34;TCP_SYN_SENT\u0026#34;; @tcp_sk_status[9] = \u0026#34;TCP_LAST_ACK\u0026#34;; } kprobe:tcp_rcv_state_process { $sk=(struct sock *)arg0; $tp=(struct tcp_sock *)$sk; $skb = (struct sk_buff *)arg1; $iphd = ((struct iphdr *)($skb-\u0026gt;head + $skb-\u0026gt;network_header)); $th = ((struct tcphdr *)($skb-\u0026gt;head + $skb-\u0026gt;transport_header)); $dport = $th-\u0026gt;dest; $dport = ($dport \u0026gt;\u0026gt; 8) | (($dport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); if ($dport == 54321) { $ack = $th-\u0026gt;ack_seq; $ack = ($ack \u0026gt;\u0026gt; 24) | (($ack \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $ack \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($ack \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $skc_state=$sk-\u0026gt;__sk_common.skc_state; printf(\u0026#34;%s:\\ntcp_sk_status: %s, syn:%u,ack:%u,fin:%u,ack_seq:%u, snd_una:%u, snd_nxt:%u\\n\u0026#34;,func,@tcp_sk_status[$skc_state],$th-\u0026gt;syn,$th-\u0026gt;ack,$th-\u0026gt;fin,$ack,$tp-\u0026gt;snd_una,$tp-\u0026gt;snd_nxt); $una = $tp-\u0026gt;snd_una - $ack; $int_una = (int32) $una; // (!after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_una) if (!((int32)($tp-\u0026gt;snd_una - $ack) \u0026lt; 0)) { printf(\u0026#34;%d, SEG.ACK =\u0026lt; ISS\\n\u0026#34;,$int_una); } $nxt = $tp-\u0026gt;snd_nxt - $ack; $int_nxt = (int32) $nxt; // after(TCP_SKB_CB(skb)-\u0026gt;ack_seq, tp-\u0026gt;snd_nxt)) if ((int32)($tp-\u0026gt;snd_nxt - $ack) \u0026lt; 0) { printf(\u0026#34;%d, SEG.ACK \u0026gt; SND.NXT\\n\u0026#34;,$int_nxt); } } } END { clear(@tcp_sk_status); } [root@node2] /data0/kernel$ bpftrace synsent.bt tcp_rcv_state_process: tcp_sk_status: TCP_SYN_SENT, syn:0,ack:1,fin:0,ack_seq:88, snd_una:2387012236, snd_nxt:2387012237 -1907955147, SEG.ACK \u0026gt; SND.NXT tcp_rcv_state_process: tcp_sk_status: TCP_SYN_SENT, syn:1,ack:1,fin:0,ack_seq:2387012237, snd_una:2387012236, snd_nxt:2387012237 tcp_rcv_state_process: tcp_sk_status: TCP_LAST_ACK, syn:0,ack:1,fin:0,ack_seq:2387012313, snd_una:2387012312, snd_nxt:2387012313 å¯ä»¥çœ‹åˆ°ï¼Œclient-2æ”¶åˆ°serverçš„ACKå›åŒ…å\nå†…æ ¸tcp_rcv_state_processå‡½æ•°åˆ¤æ–­ ack_seq = 88 \u0026gt; snd_una = 2387012236 (u32å·®å€¼å¼ºåˆ¶int32è½¬æ¢ï¼Œç›¸å·®2^31æº¢å‡ºå¯¼è‡´)ï¼Œå‘é€server resetæ•°æ®åŒ… serverç«¯æ”¶åˆ°resetåŒ…åï¼Œæ¸…ç†tcp TIME_WAITè¿æ¥ client-2é‡å‘synåŒ…ï¼Œserverç«¯è¿”å›syn+ackï¼Œæ¡æ‰‹æˆåŠŸ åŒæ ·ä½¿ç”¨bpftraceå·¥å…·è§‚å¯Ÿserverçš„å¤„ç†è¿‡ç¨‹ï¼Œ\n[root@localhost] $ cat trace-time_wait.bt #!/usr/bin/env bpftrace #include \u0026lt;linux/tcp.h\u0026gt; #include \u0026lt;net/tcp.h\u0026gt; #include \u0026lt;net/inet_timewait_sock.h\u0026gt; BEGIN { @tw_substate[5] = \u0026#34;TCP_FIN_WAIT2\u0026#34;; @tw_substate[6] = \u0026#34;TCP_TIME_WAIT\u0026#34;; @tcp_tw_status[0] = \u0026#34;TCP_TW_SUCCESS\u0026#34;; @tcp_tw_status[2] = \u0026#34;TCP_TW_ACK\u0026#34;; @tcp_tw_status[3] = \u0026#34;TCP_TW_SYN\u0026#34;; } kprobe:tcp_timewait_state_process { $inet = (struct inet_timewait_sock *)arg0; $tw = (struct tcp_timewait_sock *)$inet; $skb = (struct sk_buff *)arg1; $th = (struct tcphdr *)arg2; $iphd = ((struct iphdr *)($skb-\u0026gt;head + $skb-\u0026gt;network_header)); if ($iphd-\u0026gt;protocol == IPPROTO_TCP) { $srcaddr = $iphd-\u0026gt;saddr; $dstaddr = $iphd-\u0026gt;daddr; $srcip = ntop($iphd-\u0026gt;saddr); $dstip = ntop($iphd-\u0026gt;daddr); // $th = ((struct tcphdr *)($skb-\u0026gt;head + $skb-\u0026gt;transport_header)); $dport = $th-\u0026gt;dest; $dport = ($dport \u0026gt;\u0026gt; 8) | (($dport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); if ($dport == 80) { $sport = $th-\u0026gt;source; $sport = ($sport \u0026gt;\u0026gt; 8) | (($sport \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); // $st = *$th; $seq = $th-\u0026gt;seq; $seq = ($seq \u0026gt;\u0026gt; 24) | (($seq \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $seq \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($seq \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $ack = $th-\u0026gt;ack_seq; $ack = ($ack \u0026gt;\u0026gt; 24) | (($ack \u0026amp; 0x00FF0000) \u0026gt;\u0026gt; 8) | (( $ack \u0026amp; 0x00FF00) \u0026lt;\u0026lt; 8) | (($ack \u0026amp; 0xFF) \u0026lt;\u0026lt; 24); $win = $th-\u0026gt;window; $win = ($win \u0026gt;\u0026gt; 8) | (($win \u0026lt;\u0026lt; 8) \u0026amp; 0x00FF00); $tw_rcv_nxt = $tw-\u0026gt;tw_rcv_nxt; printf(\u0026#34;%s:\\n\u0026#34;,func); printf(\u0026#34;%s:%d -\u0026gt; %s:%d\\n\u0026#34;,$srcip, $sport, $dstip, $dport); /* TCP_FIN_WAIT2çŠ¶æ€æ”¶åˆ°finåŒ…: tcptw-\u0026gt;tw_rcv_nxt = TCP_SKB_CB(skb)-\u0026gt;end_seq; å›å¤å¯¹æ–¹çš„ackåŒ…ä¸­ ack=tw_rcv_nxt=seq+1 TCP_SKB_CB(skb)-\u0026gt;end_seq = (TCP_SKB_CB(skb)-\u0026gt;seq + th-\u0026gt;syn + th-\u0026gt;fin + skb-\u0026gt;len - th-\u0026gt;doff * 4); */ printf(\u0026#34;[syn:%d,ack:%d,fin:%d,rst:%d], seq:%-u, ack:%u, win:%u, tw_rcv_nxt:%u\\n\u0026#34;,$th-\u0026gt;syn, $th-\u0026gt;ack, $th-\u0026gt;fin, $th-\u0026gt;rst, $seq, $ack, $win, $tw_rcv_nxt); // printf(\u0026#34;%d compare %d\\n\u0026#34;,$th-\u0026gt;doff,sizeof($st)\u0026gt;\u0026gt;2); $state = $inet-\u0026gt;tw_substate; $statestr = @tw_substate[$state]; printf(\u0026#34;tw_substate: %s\\n\u0026#34;,$statestr); } } } kretprobe:tcp_timewait_state_process { $ret = retval; $statestr = @tcp_tw_status[$ret]; printf(\u0026#34;tcp_tw_status: %s\\n\u0026#34;,$statestr); print(\u0026#34;################################\u0026#34;); } END { clear(@tw_substate); clear(@tcp_tw_status); } [root@localhost] $ bpftrace trace-time_wait.bt tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:1,ack:0,fin:0,rst:0], seq:2387012236, ack:0, win:32120, tw_rcv_nxt:88 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_ACK ################################ tcp_timewait_state_process: 3.3.10.10:54321 -\u0026gt; 192.168.10.9:80 [syn:0,ack:0,fin:0,rst:1], seq:88, ack:0, win:0, tw_rcv_nxt:88 tw_substate: TCP_TIME_WAIT tcp_tw_status: TCP_TW_SUCCESS ################################ å¯ä»¥çœ‹åˆ°ï¼Œserveræ”¶åˆ°SYNåŒ…å\ntcp_timewait_state_processå‡½æ•°åˆ¤æ–­sequenceå›ç»•ï¼ˆseq \u0026lt; tw_rcv_nxtï¼‰ï¼Œè¿”å›ç»™client-2 ACKåŒ… æ”¶åˆ°client-2å‘é€çš„resetåŒ…ï¼Œç›´æ¥æ¸…ç†tcp TIME_WAITè¿æ¥ æµ‹è¯•ç¯å¢ƒæ­å»ºåå‘ç°serverç«¯TIME_WAITçŠ¶æ€æŒç»­æ—¶é—´ä¸º60sï¼Œè¿™æ˜¯å› ä¸ºå†…æ ¸ç‰ˆæœ¬çš„å·®å¼‚ã€‚å‚è€ƒè¿™ç¯‡æ–‡ç«  ä» Linux æºç çœ‹ TIME_WAIT çŠ¶æ€çš„æŒç»­æ—¶é—´\n","date":"12 September 2023","permalink":"/2023/09/timeout-time_wait/","section":"åšå®¢","summary":"èƒŒæ™¯ # æœåŠ¡podå®ä¾‹è®¿é—®å¯¹æ–¹æ¥å£é¢‘ç¹è¶…æ—¶ï¼Œå¼•èµ·å®¢è¯‰ã€‚æˆ‘ä»¬é€šè¿‡ä¸“çº¿ä¸å¯¹æ–¹æœºæˆ¿äº’è”ï¼Œå¹¶ä¸”ä¸“çº¿æ¥å…¥ä¾§éƒ¨ç½²æœ‰ä¸“ç”¨ç‰©ç†è®¾å¤‡(vpnåŠ å¯†é€šé“)ï¼Œæ¶æ„å›¾å¦‚ä¸‹ é—®é¢˜åˆ†æ # å®¢æˆ·ç«¯è¯·æ±‚æŠ“åŒ… # å¯¹æœåŠ¡podå®ä¾‹æŠ“åŒ…åˆ†æï¼Œå‘ç°è¶…æ—¶çš„httpè¯·æ±‚å‡ä¸ºå‘é€synåŒ…æ— å“åº”å¯¼è‡´tcpè¿æ¥å»ºç«‹å¤±è´¥è¶…æ—¶ã€‚åŒæ—¶ä¸“çº¿ç½‘ç»œç›‘æ§æ¯”è¾ƒç¨³ï¼Œå¯ä»¥æ’é™¤ä¸“çº¿ç½‘ç»œä¸¢åŒ…çš„åŸå›  å¯¹æ–¹æœåŠ¡å™¨æŠ“åŒ… # è”ç³»å¯¹æ–¹ååŠ©åœ¨serveræœºå™¨ä¸ŠæŠ“åŒ…ï¼Œåˆ†æå¯¹æ–¹æä¾›çš„æŠ“åŒ…æ–‡ä»¶:\nå®¢æˆ·ç«¯è¯·æ±‚ç»è¿‡é˜²ç«å¢™SNATåï¼Œå¯¹æ–¹serverçœ‹åˆ°çš„å®¢æˆ·ç«¯IPéƒ½ä¸€æ · æœåŠ¡å™¨ä¸Šæ”¶åˆ°äº†SYNåŒ…ï¼Œä½†æ˜¯å›å¤çš„æ˜¯ACKåŒ…ï¼Œè€Œä¸æ˜¯SYN+ACKåŒ… è¶…æ—¶é‡ä¼ éƒ½å‘ç”Ÿåœ¨å®¢æˆ·ç«¯è¯·æ±‚æºç«¯å£å¤ç”¨æ—¶(åå‡ ç§’~ä¹åå‡ ç§’) clientå¤ç”¨ç«¯å£æ—¶ï¼Œå¯¹æ¯”serverå‘é€çš„ACKåŒ…å’Œç›¸åŒäº”å…ƒç»„TCPè¿æ¥æ–­å¼€æ—¶å‘é€çš„æœ€åä¸€ä¸ªACKåŒ…ï¼ŒAcknowledgment numberæ˜¯ç›¸åŒçš„ HTTP response headerä¸­åŒ…å«Connection: closeï¼Œserveråªæ”¯æŒhttp1.0çŸ­è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåserverä¸»åŠ¨æ–­å¼€TCPè¿æ¥å¹¶è¿›å…¥TIME-WAITçŠ¶æ€ æ ¹æ®ä»¥ä¸Šåˆ†ææ¨æ–­ï¼Œå¯¹äºæ–°è¯·æ±‚serverç«¯å¤ç”¨äº†ä¹‹å‰çš„TCPè¿æ¥ï¼ŒTCPè¿æ¥å¤„äºTIME-WAITçŠ¶æ€\nè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œserverå›å¤äº†ACKåŒ…ï¼Œå®¢æˆ·ç«¯ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°ï¼Ÿ é€šè¿‡åœ¨ä¸“ç”¨è®¾å¤‡ä¸ŠæŠ“åŒ…åˆ†æï¼Œå‘ç°æ”¶åˆ°äº†ACKå›åŒ…ï¼Œæ¨æµ‹æ˜¯è¢«é˜²ç«å¢™dropã€‚å› ä¸ºé˜²ç«å¢™TCPè¿æ¥TIME-WAITçŠ¶æ€timeoutæ—¶é—´ä¸º1sï¼Œå¯¹äºå®¢æˆ·ç«¯æ–°è¯·æ±‚SYNåŒ…ï¼Œä¼šæ–°å»ºtcp sessionï¼Œæ”¶åˆ°server ACKå›åŒ…åï¼Œè®¤ä¸ºéæ³•å°±dropäº†\nè§£å†³æ–¹æ¡ˆ # æ”¯æŒHTTP1.1é•¿è¿æ¥ # æ¥å£æ”¯æŒhttp1.1é•¿è¿æ¥ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å®Œæˆåä¼šä¸»åŠ¨æ–­å¼€TCPè¿æ¥ï¼ŒTIME-WAITçŠ¶æ€ç»´æŒåœ¨å®¢æˆ·ç«¯ã€‚å¯¹æ–¹åé¦ˆæ— æ³•æ”¯æŒ","title":"ä¸€æ¬¡è¯·æ±‚è¶…æ—¶é—®é¢˜æ’æŸ¥è®°å½•"},{"content":"","date":"16 August 2022","permalink":"/tags/kvm/","section":"Tags","summary":"","title":"KVM"},{"content":"1.èµ„æ–™å‡†å¤‡ # 1.1 isoæ–‡ä»¶ä¸‹è½½ # å¯ä»¥é€šè¿‡è®¿é—®å®˜æ–¹é¡µé¢ä¸‹è½½( é“¾æ¥)ï¼Œä½†æ˜¯ä¸‹è½½é€Ÿåº¦æ¯”è¾ƒæ…¢ã€‚ æˆ‘è¿™é‡Œé€‰æ‹©ä½¿ç”¨p2pä¸‹è½½å·¥å…·mldonkeyï¼ŒCentos7ç³»ç»Ÿå®‰è£…å¯ä»¥å‚è€ƒ Centos7éƒ¨ç½²mldonkeyï¼Œisoæ–‡ä»¶e2dkä¸‹è½½é“¾æ¥å¯ä»¥ä» msdn.itellyou.cnç½‘ç«™è·å–\ned2k://|file|cn_windows_server_2019_updated_march_2019_x64_dvd_c1ffb46c.iso|5347280896|49FCF8C558517608537E0396854560D6|/ 1.2 virtioé©±åŠ¨ç¨‹åºä¸‹è½½ # kvmå®‰è£…è¿è¡Œwindows serverç³»ç»Ÿéœ€è¦å®‰è£…ç£ç›˜scsiã€ç½‘å¡é©±åŠ¨\nyumå®‰è£… wget https://fedorapeople.org/groups/virt/virtio-win/virtio-win.repo -O /etc/yum.repos.d/virtio-win.repo yum install -y virtio-win æ‰‹åŠ¨ä¸‹è½½é©±åŠ¨æ–‡ä»¶ virtio-win-0.1.173_x86.vfd æˆ–è€… virtio-win-0.1.173.iso ä¸‹è½½é“¾æ¥ 2.kvmåˆ¶ä½œwindows serveråŸºç¡€é•œåƒ # 2.1åˆ›å»ºkvmé•œåƒæ–‡ä»¶ # [root@kvm-1 ~]# qemu-img create -f qcow2 win2019-dc.qcow2 50G Formatting \u0026#39;win2019-dc.qcow2\u0026#39;, fmt=qcow2 size=53687091200 cluster_size=65536 lazy_refcounts=off refcount_bits=16 2.2å®‰è£…windows server # æœ‰ä¸¤ç§æ–¹å¼å®‰è£…è™šæ‹ŸåŒ–é©±åŠ¨ç¨‹åº\n2.2.1 æ–¹æ³•ä¸€:ä½¿ç”¨VFDè½¯ç›˜é©±åŠ¨é•œåƒ # virt-installå¯åŠ¨windows server kvmå®ä¾‹ï¼Œå¼€å¯vncè¿œç¨‹è®¿é—®ï¼Œç›‘å¬ç«¯å£5920\n[root@kvm-1 windows]virt-install \\ --name win2019dc \\ --memory 8192 \\ --vcpus sockets=1,cores=2,threads=2 \\ --os-type=windows \\ --os-variant=auto \\ --cdrom=/data/windows/cn_windows_server_2019.iso \\ --disk /data/windows/win2019-dc.qcow2,bus=virtio,size=50 \\ --disk /data/windows/virtio-win-0.1.173_x86.vfd,device=floppy \\ --network bridge=bridge0,model=virtio \\ --graphics vnc,listen=\u0026#39;0.0.0.0\u0026#39;,port=5920 \\ --hvm \\ --virt-type kvm WARNING éœ€è¦å›¾å½¢æ˜¾ç¤ºï¼Œä½†æœªè®¾ç½® DISPLAYã€‚ä¸èƒ½è¿è¡Œ virt-viewerã€‚ WARNING æ²¡æœ‰æ§åˆ¶å°ç”¨äºå¯åŠ¨å®¢æˆ·æœºï¼Œé»˜è®¤ä¸º --wait -1 å¼€å§‹å®‰è£…...... ERROR unsupported format character \u0026#39;ï¿½\u0026#39; (0xffffffe7) at index 47 åŸŸå®‰è£…å¤±è´¥ï¼Œæ‚¨å¯ä»¥è¿è¡Œä¸‹åˆ—å‘½ä»¤é‡å¯æ‚¨çš„åŸŸï¼š \u0026#39;virsh start virsh --connect qemu:///system start win2019dc\u0026#39; å¦åˆ™è¯·é‡æ–°å¼€å§‹å®‰è£…ã€‚ é€šè¿‡VNC Viewerè¿æ¥è®¿é—®kvmå®ä¾‹win2019dc,å®‰è£…windowsç³»ç»Ÿ æ‰‹åŠ¨å®‰è£…ç£ç›˜SCSIå’Œç½‘å¡é©±åŠ¨ ç»§ç»­æŒ‰æç¤ºå®Œæˆå®‰è£… 2.2.2 æ–¹æ³•äºŒ:æ‰‹åŠ¨æŒ‚è½½virtioé©±åŠ¨isoé•œåƒ # åˆ›å»ºwindowsè™šæ‹Ÿæœº\nvirt-install \\ --name win2019dc \\ --memory 8192 \\ --vcpus sockets=1,cores=2,threads=2 \\ --os-type=windows \\ --os-variant=auto \\ --cdrom=/data/windows/cn_windows_server_2019.iso \\ --disk /data/windows/win2019-dc.qcow2,bus=virtio,size=50 \\ --network bridge=bridge0,model=virtio \\ --graphics vnc,listen=\u0026#39;0.0.0.0\u0026#39;,port=5930 \\ --hvm \\ --virt-type kvm WARNING éœ€è¦å›¾å½¢æ˜¾ç¤ºï¼Œä½†æœªè®¾ç½® DISPLAYã€‚ä¸èƒ½è¿è¡Œ virt-viewerã€‚ WARNING æ²¡æœ‰æ§åˆ¶å°ç”¨äºå¯åŠ¨å®¢æˆ·æœºï¼Œé»˜è®¤ä¸º --wait -1 å¼€å§‹å®‰è£…...... ERROR unsupported format character \u0026#39;ï¿½\u0026#39; (0xffffffe7) at index 47 åŸŸå®‰è£…å¤±è´¥ï¼Œæ‚¨å¯ä»¥è¿è¡Œä¸‹åˆ—å‘½ä»¤é‡å¯æ‚¨çš„åŸŸï¼š \u0026#39;virsh start virsh --connect qemu:///system start win2019dc\u0026#39; å¦åˆ™è¯·é‡æ–°å¼€å§‹å®‰è£…ã€‚ å’Œæ–¹æ³•ä¸€ä¸€æ ·ï¼Œé€šè¿‡VNC Viewerè¿æ¥è®¿é—®kvmå®ä¾‹å®‰è£…windowsç³»ç»Ÿï¼ŒåŠ è½½é©±åŠ¨ç¨‹åºçš„è¯éœ€è¦å…ˆæ‰‹åŠ¨æŒ‚è½½ virtio-win-0.1.173.isoã€‚ å…ˆæŸ¥çœ‹cdromè®¾å¤‡å¯¹åº”è™šæ‹Ÿæœºçš„devåç§° dev='hda'\n[root@kvm-1 windows]# virsh dumpxml win2019dc|grep device.*cdrom -A5|grep \u0026#34;\u0026#34; \u0026lt;disk type=\u0026#39;file\u0026#39; device=\u0026#39;cdrom\u0026#39;\u0026gt; \u0026lt;driver name=\u0026#39;qemu\u0026#39; type=\u0026#39;raw\u0026#39;/\u0026gt; \u0026lt;source file=\u0026#39;/data/windows/cn_windows_server_2019.iso\u0026#39;/\u0026gt; \u0026lt;backingStore/\u0026gt; \u0026lt;target dev=\u0026#39;hda\u0026#39; bus=\u0026#39;ide\u0026#39;/\u0026gt; \u0026lt;readonly/\u0026gt; [root@kvm-1 windows]# virsh change-media win2019dc hda /usr/share/virtio-win/virtio-win.iso Successfully updated media. ç„¶åæ‰‹åŠ¨å®‰è£…ç£ç›˜SCSIå’Œç½‘å¡é©±åŠ¨ åˆ‡æ¢å›ç³»ç»Ÿisoé•œåƒï¼Œå¹¶ç»§ç»­æŒ‰æç¤ºå®Œæˆå®‰è£…\n[root@kvm-1 windows]# virsh change-media win2019dc hda /data/windows/cn_windows_server_2019.iso Successfully updated media. #å¸è½½isoæ–‡ä»¶çš„æ–¹æ³• virsh change-media win2019dc --eject virtio-win.iso 2.2.3 é…ç½®ç®¡ç†å‘˜å¯†ç  # 2.3 windowsé…ç½®ä¿®æ”¹ # 2.3.1 ç”µæºå’Œç¡çœ  # ` ` 2.3.2 å…³é—­äº¤äº’å¼ç™»å½•Ctrl+Atl+Del # 2.3.3 å¼€å¯è¿œç¨‹æ¡Œé¢è®¿é—® # 2.3.4 IPv4åœ°å€æŒä¹…åŒ–é…ç½® # åœ¨ C:\\Windows\\ç›®å½•æ–°å»ºè„šæœ¬ipconfig.bat\n@echo off setlocal enabledelayedexpansion set /a v=0 set ipaddr=\u0026#34;\u0026#34; set netmask=\u0026#34;\u0026#34; set gateway=\u0026#34;\u0026#34; @for /f \u0026#34;tokens=2 delims==\u0026#34; %%a in (C:\\Windows\\ip.txt) do ( set /a v+=1 if !v!==1 set ipaddr=%%a if !v!==2 set netmask=%%a if !v!==3 set gateway=%%a ) netsh interface ipv4 add address \u0026#34;ä»¥å¤ªç½‘\u0026#34; !ipaddr! !netmask! !gateway! netsh interface ipv4 add dnsservers \u0026#34;ä»¥å¤ªç½‘\u0026#34; 192.168.9.3 index=2 no endlocal æŠŠè„šæœ¬ipconfig.baté…ç½®å¼€æœºè‡ªå¯åŠ¨\n2.3.5 å®‰è£…KMSå¯†é’¥ # æœ¬æ–‡ä½¿ç”¨KMSå®¢æˆ·ç«¯å¯†é’¥ï¼Œå³ Microsoft é€šç”¨æ‰¹é‡è®¸å¯è¯å¯†é’¥ (GVLK)ã€‚\nC:\\Users\\Administrator\u0026gt; slmgr /upk C:\\Users\\Administrator\u0026gt; slmgr /cpky C:\\Users\\Administrator\u0026gt; slmgr /ckms C:\\Users\\Administrator\u0026gt; slmgr /ipk WMDGN-G9PQG-XVVXX-R3X43-63DFG C:\\Users\\Administrator\u0026gt; slmgr /dlv è¯·è‡ªè¡Œè·å–æˆ–æ­å»ºç§æœ‰å¯ç”¨KMSæœåŠ¡å™¨ C:\\Users\\Administrator\u0026gt; slmgr /skms your.kms.server C:\\Users\\Administrator\u0026gt; slmgr /ato C:\\Users\\Administrator\u0026gt; slmgr /dlv å¾®è½¯å®˜ç½‘è·å–é€šç”¨æ‰¹é‡è®¸å¯è¯å¯†é’¥ï¼Œ å¯†é’¥ç®¡ç†æœåŠ¡ (KMS) å®¢æˆ·ç«¯æ¿€æ´»å’Œäº§å“å¯†é’¥\n2.4 å‹ç¼©é•œåƒ # é…ç½®å®Œæˆä¹‹åå…³æœºï¼ŒåŸºç¡€é•œåƒwin2019-dc.qcow2å°±å®Œæˆäº†ï¼Œå½“å‰å¤§å°9.1G\n[root@kvm-1 windows]# qemu-img info win2019-dc.qcow2 image: win2019-dc.qcow2 file format: qcow2 virtual size: 50G (53687091200 bytes) disk size: 9.1G cluster_size: 65536 Format specific information: compat: 1.1 lazy refcounts: false refcount bits: 16 corrupt: false copyæ¨¡å¼å‹ç¼©é•œåƒï¼Œå‹ç¼©ä¹‹ååªæœ‰4.9G\n#ä¸´æ—¶copyæ–‡ä»¶ç©ºé—´ä¸ºvirtual size,éœ€è¦æ³¨æ„ä¸»æœºç£ç›˜ç©ºé—´ï¼Œé»˜è®¤ä¸º/tmp #å¯ä»¥é€šè¿‡--tmp /somediræˆ–è€…ç¯å¢ƒå˜é‡export TMPDIR=/somedir [root@kvm-1 windows]# virt-sparsify --compress --convert qcow2 win2019-dc.qcow2 win2019-dc-compress.qcow2 [ 0.1] Create overlay file in /tmp to protect source disk [ 0.2] Examine source disk [ 1.9] Fill free space in /dev/sda1 with zero 100% âŸ¦â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’âŸ§ 00:00 [ 9.9] Fill free space in /dev/sda2 with zero 100% âŸ¦â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’âŸ§ 00:00 [ 620.8] Copy to destination and make sparse [1150.4] Sparsify operation completed with no errors. virt-sparsify: Before deleting the old disk, carefully check that the target disk boots and works correctly. [root@kvm-1 windows]# qemu-img info win2019-dc-compress.qcow2 image: win2019-dc-compress.qcow2 file format: qcow2 virtual size: 50G (53687091200 bytes) disk size: 4.9G cluster_size: 65536 Format specific information: compat: 1.1 lazy refcounts: false refcount bits: 16 corrupt: false 3. ä½¿ç”¨åŸºç¡€é•œåƒå¯åŠ¨windows server # å®šä¹‰ä¸€ä¸ªè™šæ‹Ÿæœº\n[root@kvm-1 ~]# qemu-img create -f qcow2 win2019dc-1.qcow2 50G Formatting \u0026#39;win2019dc-1.qcow2\u0026#39;, fmt=qcow2 size=53687091200 cluster_size=65536 lazy_refcounts=off refcount_bits=16 [root@kvm-1 win2019]# virt-install \\ --name win2019dc-1 \\ --memory 8192 \\ --vcpus sockets=1,cores=2,threads=2 \\ --os-type=windows \\ --os-variant=win10 \\ --disk /data/windows/win2019/win2019dc-1.qcow2,bus=virtio,size=50 \\ --network bridge=bridge0,model=virtio \\ --hvm \\ --virt-type kvm \\ --print-xml \u0026gt; win2019dc-1.xml åˆ›å»ºIPé…ç½®æ–‡ä»¶ip.txtï¼Œæ–‡ä»¶åä¸åŸºç¡€é•œåƒä¸­ipconfig.batæŒ‡å®šçš„ä¸€è‡´\n[root@kvm-1 win2019]# cat ip.txt IPADDR=192.168.9.12 NETMASK=255.255.255.0 GATEWAY=192.168.9.1 æ‹·è´ip.txtæ–‡ä»¶åˆ°é•œåƒï¼Œä½ç½®ä¸åŸºç¡€é•œåƒä¸­ipconfig.batæŒ‡å®šçš„ä¸€è‡´\n[root@kvm-1 win2019]# yum install libguestfs-winsupport -y -q [root@kvm-1 win2019]# unix2dos ip.txt [root@kvm-1 win2019]# virt-copy-in -a ./win2019dc-1.qcow2 ip.txt /\u0026#34;Windows\u0026#34;/ å¯åŠ¨è™šæ‹Ÿæœº\n[root@kvm-1 win2019]# virsh define win2019dc-1.xml [root@kvm-1 win2019]# virsh start win2019dc-1 é€šè¿‡windowsè¿œç¨‹æ¡Œé¢è®¿é—®192.168.9.12ï¼Œadministratorå¯†ç æ˜¯æ­¥éª¤2.2.3ä¸­é…ç½®çš„å¯†ç \nå› ä¸ºä½¿ç”¨çš„ç›¸åŒé•œåƒï¼Œæ–°è™šæ‹Ÿæœºçš„ä¸»æœºåã€SID(å®‰å…¨æ ‡è¯†ç¬¦)æ˜¯ç›¸åŒçš„ å¦‚æœéœ€è¦SIDå”¯ä¸€ï¼Œå®šä¹‰è™šæ‹Ÿæœºæ—¶è¦å¼€å¯vncï¼Œè™šæ‹Ÿæœºå¯åŠ¨åä½¿ç”¨Sysprepï¼ˆç³»ç»Ÿå‡†å¤‡å·¥å…·ï¼‰ç”Ÿæˆæ–°çš„SIDï¼Œé‡å¯åï¼Œvncè¿æ¥è™šæ‹Ÿæœºå¹¶è¿›å…¥OOBEç•Œé¢è¿›è¡Œé…ç½®\n","date":"16 August 2022","permalink":"/2022/08/kvm-windowsserver2019/","section":"åšå®¢","summary":"1.èµ„æ–™å‡†å¤‡ # 1.1 isoæ–‡ä»¶ä¸‹è½½ # å¯ä»¥é€šè¿‡è®¿é—®å®˜æ–¹é¡µé¢ä¸‹è½½( é“¾æ¥)ï¼Œä½†æ˜¯ä¸‹è½½é€Ÿåº¦æ¯”è¾ƒæ…¢ã€‚ æˆ‘è¿™é‡Œé€‰æ‹©ä½¿ç”¨p2pä¸‹è½½å·¥å…·mldonkeyï¼ŒCentos7ç³»ç»Ÿå®‰è£…å¯ä»¥å‚è€ƒ Centos7éƒ¨ç½²mldonkeyï¼Œisoæ–‡ä»¶e2dkä¸‹è½½é“¾æ¥å¯ä»¥ä» msdn.itellyou.cnç½‘ç«™è·å–\ned2k://|file|cn_windows_server_2019_updated_march_2019_x64_dvd_c1ffb46c.iso|5347280896|49FCF8C558517608537E0396854560D6|/ 1.2 virtioé©±åŠ¨ç¨‹åºä¸‹è½½ # kvmå®‰è£…è¿è¡Œwindows serverç³»ç»Ÿéœ€è¦å®‰è£…ç£ç›˜scsiã€ç½‘å¡é©±åŠ¨\nyumå®‰è£… wget https://fedorapeople.org/groups/virt/virtio-win/virtio-win.repo -O /etc/yum.repos.d/virtio-win.repo yum install -y virtio-win æ‰‹åŠ¨ä¸‹è½½é©±åŠ¨æ–‡ä»¶ virtio-win-0.1.173_x86.vfd æˆ–è€… virtio-win-0.1.173.iso ä¸‹è½½é“¾æ¥ 2.","title":"kvméƒ¨ç½²WindowsServer2019"},{"content":"","date":"16 August 2022","permalink":"/tags/windowsserver/","section":"Tags","summary":"","title":"WindowsServer"},{"content":"1. mkdonkeyæ˜¯ä»€ä¹ˆ # MLDonkeyæ˜¯ä¸€ä¸ªGPLå¼€æºå…è´¹ã€è·¨å¹³å°(Linuxã€Solarisã€Mac OS Xã€Windows ä»¥åŠ MorphOS)ã€å¤šåè®®çš„P2På…±äº«è½¯ä»¶ã€‚å…¶æ”¯æŒåŒ…æ‹¬eDonkeyç”µé©´åè®®åœ¨å†…çš„å¤šç§P2Påè®®ï¼Œå¹¶èƒ½è¿è¡Œäºç±»Unix/Linuxã€Mac OS Xã€Windowsç­‰æ“ä½œç³»ç»Ÿã€‚ä¸»è¦ä½¿ç”¨OCamlè¯­è¨€ç¼–å†™,,åŒæ—¶æœ‰äº›éƒ¨åˆ†ä½¿ç”¨äº†ä¸€äº›Cè¯­è¨€ä»¥åŠæ±‡ç¼–è¯­è¨€çš„ä»£ç ï¼Œä»è€Œä¿è¯äº†å®ƒçš„é«˜æ•ˆèƒ½ã€‚å¯æ¥å—Magnet URIï¼Œèƒ½æ­é…å„ç§GUIã€‚\nMLDonkeyæœ€æ—©åªæ”¯æŒeDonkey2000åè®®ï¼ˆED2Kï¼‰ï¼Œåæ¥é€æ­¥åŠ å…¥äº†overnetã€kadã€BTã€HTTPã€FTPç­‰åè®®çš„æ”¯æŒã€‚\nå¼•ç”¨https://baike.baidu.com/item/mlDonkey/2257164?fr=ge_ala\n2. Centos7æºç å®‰è£… # â€‹\tæºç æ‰˜ç®¡åœ¨ githubï¼Œå¯ä»¥releaseä¸­è·å–ä¸‹è½½é“¾æ¥\n[root@keeping] ~$ wget https://github.com/ygrek/mldonkey/releases/download/release-3-1-7/mldonkey-3.1.7.tar.bz2 [root@keeping] ~$ tar xf mldonkey-3.1.7.tar.bz2 [root@keeping] ~$ cd mldonkey-3.1.7/ [root@keeping] ~$ ./configure [root@keeping] ~$ make # å‘½ä»¤è¡Œå¯åŠ¨æœåŠ¡ [root@keeping] ~$ ./mlnet 3. é…ç½®mldonkey # é»˜è®¤é…ç½®ç›®å½•åœ¨~/.mldonkeyã€‚ä¿®æ”¹webé¡µé¢è®¿é—®çš„ipç™½åå•~/.mldonkey/downloads.ini\n# æŒ‰éœ€é…ç½®ï¼Œè¿™é‡Œæ”¾å¼€äº†æ‰€æœ‰è®¿é—®æƒé™ï¼Œä¸å»ºè®® allowed_ips = [ \u0026#34;0.0.0.0/0\u0026#34;;] 3.1 åˆå§‹åŒ–adminå¯†ç  # webé¡µé¢ç›‘å¬ç«¯å£æ˜¯http4080ï¼Œé…ç½®å¥½è®¿é—®ç™½åå•åå¯åŠ¨æœåŠ¡ã€‚é¦–æ¬¡è®¿é—®éœ€è¦åˆå§‹åŒ–adminè´¦æˆ·ï¼Œæ–‡æœ¬æ¡†ä¸­è¾“å…¥useradd admin yourpasswdï¼Œç„¶åç‚¹å‡»inputæŒ‰é’®\nè¿™é‡Œæœ‰ä¸ªå®‰å…¨é—®é¢˜æ˜¯å¯†ç åˆå§‹åŒ–æ˜¯GETè¯·æ±‚/submit?q=useradd+admin+yourpasswordï¼Œç”¨æˆ·å¯†ç éƒ½æ˜¯æ˜æ–‡ã€‚å› ä¸ºæˆ‘æ˜¯é€šè¿‡å…¬ç½‘è®¿é—®ï¼Œæ‰€ä»¥åœ¨å‰é¢éƒ¨ç½²äº†nginxä»£ç†é€šè¿‡httpsè®¿é—®\nè‡ªç­¾åè¯ä¹¦ï¼Œå‚è€ƒ å¦‚ä½•ä½¿ç”¨opensslå·¥å…·åˆ›å»ºç§æœ‰CA\nserver { listen 34080 ssl; server_name _; ssl_certificate myserver.pem; ssl_certificate_key myserver.key; ssl_session_timeout 5m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM; ssl_prefer_server_ciphers on; location / { proxy_pass http://127.0.0.1:4080; } } ä¿®æ”¹å¯†ç åç™»å½•\n3.2 Optionsé…ç½®ä¿®æ”¹ # ç‚¹å‡»Optionsï¼Œä¿®æ”¹ä¸€ä¸‹é…ç½®:\nED2K-max_connected_servers 200 max_hard_upload_rate 20 max_hard_download_rate 20480 3.3 å¯¼å…¥æœåŠ¡å™¨åˆ—è¡¨ # é»˜è®¤æœåŠ¡åˆ—è¡¨æ¯”è¾ƒå°‘ï¼Œæ¨èæ‰‹åŠ¨å¯¼å…¥ä¸‹server.met\nç‚¹å‡»Servers-\u0026gt;Import Server.metï¼Œè´´ä¸Šé“¾æ¥ï¼Œå¯ä»¥è¯•è¯•ä¸€ä¸‹ä¸¤ä¸ªåœ°å€\nhttp://ed2k.2x4u.de/index.html ä¸»é¡µä¸­æœ‰ç›¸å…³é“¾æ¥\nhttp://upd.emule-security.org/server.met\n3.4 åˆ›å»ºä¸‹è½½ä»»åŠ¡ # åœ¨æ–‡æœ¬æ¡†è´´å…¥ed2kèµ„æºé“¾æ¥ï¼Œç‚¹å‡»InputæŒ‰é’®å®Œæˆå¯¼å…¥ã€‚ç‚¹å‡»Transfers-\u0026gt;Downloadså¯ä»¥æŸ¥çœ‹ä¸‹è½½è¿›åº¦\næ–‡ä»¶ä¸‹è½½å®Œæˆåé»˜è®¤å­˜å‚¨ä½ç½®~/.mldonkey/incoming/files/ï¼Œå¯ä»¥åœ¨downloads.iniä¸­æŒ‡å®š\n","date":"6 August 2022","permalink":"/2022/08/mldonkey/","section":"åšå®¢","summary":"1. mkdonkeyæ˜¯ä»€ä¹ˆ # MLDonkeyæ˜¯ä¸€ä¸ªGPLå¼€æºå…è´¹ã€è·¨å¹³å°(Linuxã€Solarisã€Mac OS Xã€Windows ä»¥åŠ MorphOS)ã€å¤šåè®®çš„P2På…±äº«è½¯ä»¶ã€‚å…¶æ”¯æŒåŒ…æ‹¬eDonkeyç”µé©´åè®®åœ¨å†…çš„å¤šç§P2Påè®®ï¼Œå¹¶èƒ½è¿è¡Œäºç±»Unix/Linuxã€Mac OS Xã€Windowsç­‰æ“ä½œç³»ç»Ÿã€‚ä¸»è¦ä½¿ç”¨OCamlè¯­è¨€ç¼–å†™,,åŒæ—¶æœ‰äº›éƒ¨åˆ†ä½¿ç”¨äº†ä¸€äº›Cè¯­è¨€ä»¥åŠæ±‡ç¼–è¯­è¨€çš„ä»£ç ï¼Œä»è€Œä¿è¯äº†å®ƒçš„é«˜æ•ˆèƒ½ã€‚å¯æ¥å—Magnet URIï¼Œèƒ½æ­é…å„ç§GUIã€‚\nMLDonkeyæœ€æ—©åªæ”¯æŒeDonkey2000åè®®ï¼ˆED2Kï¼‰ï¼Œåæ¥é€æ­¥åŠ å…¥äº†overnetã€kadã€BTã€HTTPã€FTPç­‰åè®®çš„æ”¯æŒã€‚\nå¼•ç”¨https://baike.baidu.com/item/mlDonkey/2257164?fr=ge_ala\n2. Centos7æºç å®‰è£… # â€‹\tæºç æ‰˜ç®¡åœ¨ githubï¼Œå¯ä»¥releaseä¸­è·å–ä¸‹è½½é“¾æ¥\n[root@keeping] ~$ wget https://github.com/ygrek/mldonkey/releases/download/release-3-1-7/mldonkey-3.1.7.tar.bz2 [root@keeping] ~$ tar xf mldonkey-3.1.7.tar.bz2 [root@keeping] ~$ cd mldonkey-3.","title":"Centos7éƒ¨ç½²mldonkey"},{"content":"","date":"8 November 2019","permalink":"/tags/kubernetes/","section":"Tags","summary":"","title":"kubernetes"},{"content":"","date":"8 November 2019","permalink":"/tags/prometheus/","section":"Tags","summary":"","title":"prometheus"},{"content":"","date":"8 November 2019","permalink":"/series/","section":"Series","summary":"","title":"Series"},{"content":"","date":"8 November 2019","permalink":"/series/%E9%AB%98%E5%8F%AF%E7%94%A8prometheus%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","section":"Series","summary":"","title":"é«˜å¯ç”¨prometheusç›‘æ§é›†ç¾¤éƒ¨ç½²"},{"content":" Prometheuså¯ä»¥å®šä¹‰è­¦æŠ¥è§„åˆ™ï¼Œæ»¡è¶³æ¡ä»¶æ—¶è§¦å‘è­¦æŠ¥ï¼Œå¹¶æ¨é€åˆ°AlertmanageræœåŠ¡ã€‚Alertmanageræ”¯æŒé«˜å¯ç”¨çš„é›†ç¾¤éƒ¨ç½²ï¼Œè´Ÿè´£ç®¡ç†ã€æ•´åˆå’Œåˆ†å‘è­¦æŠ¥åˆ°ä¸é€šç›®çš„åœ°ï¼Œå¹¶èƒ½åšåˆ°å‘Šè­¦æ”¶æ•› æœ¬ä¾‹é‡‡ç”¨statefulsetæ–¹å¼éƒ¨ç½²3ä¸ªå®ä¾‹çš„Alertmanageré«˜å¯ç”¨é›†ç¾¤\nAlertmanageré›†ç¾¤éƒ¨ç½² # åˆ›å»ºalertmanageræ•°æ®ç›®å½• # $ mkdir /data/alertmanager åˆ›å»ºstorageclass # $ cat storageclass.yaml apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: alertmanager-lpv provisioner: kubernetes.io/no-provisioner volumeBindingMode: WaitForFirstConsumer åˆ›å»ºlocal volume # $ cat pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: alertmanager-pv-0 spec: capacity: storage: 30Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Retain storageClassName: alertmanager-lpv local: path: /data/alertmanager nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - 192.168.1.50 --- apiVersion: v1 kind: PersistentVolume metadata: name: alertmanager-pv-1 spec: capacity: storage: 30Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Retain storageClassName: alertmanager-lpv local: path: /data/alertmanager nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - 192.168.1.51 --- apiVersion: v1 kind: PersistentVolume metadata: name: alertmanager-pv-2 spec: capacity: storage: 30Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Retain storageClassName: alertmanager-lpv local: path: /data/alertmanager nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - 192.168.1.52 åˆ›å»ºalertmanager.ymlçš„configmap # é€šè¿‡Alertmanageræä¾›çš„webhookæ”¯æŒï¼Œå¯ä»¥é…ç½®é’‰é’‰å‘Šè­¦ã€‚éœ€è¦å®šä¹‰åŸºäºwebhookçš„å‘Šè­¦æ¥æ”¶å™¨receiverã€‚alertmanager.ymlæ–‡ä»¶å®šä¹‰å‘Šè­¦æ–¹å¼ã€æ¨¡æ¿ã€å‘Šè­¦çš„åˆ†å‘ç­–ç•¥å’Œå‘Šè­¦æŠ‘åˆ¶ç­–ç•¥ç­‰\n#cat configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: alertmanager-config namespace: kube-system labels: kubernetes.io/cluster-service: \u0026#34;true\u0026#34; addonmanager.kubernetes.io/mode: EnsureExists data: alertmanager.yml: | global: resolve_timeout: 3m #è§£æçš„è¶…æ—¶æ—¶é—´ route: group_by: [\u0026#39;example\u0026#39;] group_wait: 60s group_interval: 60s repeat_interval: 12h receiver: \u0026#39;DingDing\u0026#39; receivers: #å®šä¹‰åŸºäºwebhookçš„å‘Šè­¦æ¥æ”¶å™¨receiver - name: \u0026#39;DingDing\u0026#39; webhook_configs: - url: http://192.168.1.50:8060/dingtalk/webhook/send send_resolved: true # å‘é€å·²è§£å†³é€šçŸ¥ éƒ¨ç½²prometheus-webhook-dingtalk # è¿™é‡Œä½¿ç”¨dockeréƒ¨ç½²\n$ docker pull timonwong/prometheus-webhook-dingtalk $ docker run -d -p 8060:8060 --name webhook timonwong/prometheus-webhook --ding.profile=\u0026#34;webhook=https://oapi.dingtalk.com/robot/send?access_token={è‡ªå·±çš„dingding token} é’‰é’‰ç¾¤æ·»åŠ è‡ªå®šä¹‰æœºå™¨äººï¼Œå¯ä»¥ç”ŸæˆWebhookåœ°å€https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxx\nåˆ›å»ºheadless service # $ cat service-statefulset.yaml apiVersion: v1 kind: Service metadata: name: alertmanager namespace: kube-system spec: ports: - name: altermanager port: 9093 targetPort: 9093 selector: k8s-app: alertmanager clusterIP: None å®šåˆ¶alertmanageré•œåƒ # alertmanageré›†ç¾¤é«˜å¯ç”¨é‡‡ç”¨statefulsetæ–¹å¼éƒ¨ç½²ï¼Œåœ¨å®ä¾‹å¯åŠ¨æ—¶ï¼Œéœ€è¦åœ¨å¯åŠ¨å‚æ•°cluster.listen-addressæŒ‡å®šå„peerçš„ipï¼Œå¯ä»¥åœ¨podå¯åŠ¨æ—¶é€šè¿‡å˜é‡ä¼ å…¥ï¼Œè‡ªå®šä¹‰å¯åŠ¨è„šæœ¬æ¥è§£å†³ 1.è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬start.sh\n$ cat start.sh #!/bin/bash IFS=\u0026#39;,\u0026#39; read -r -a peer_ips \u0026lt;\u0026lt;\u0026lt; \u0026#34;${PEER_ADDRESS}\u0026#34; str=\u0026#34;--cluster.peer=\u0026#34; args=\u0026#34;\u0026#34; for ip in ${peer_ips[@]}; do args=${args}${str}${ip}\u0026#34; \u0026#34; done /app/bin/alertmanager \\ --config.file=/etc/config/alertmanager.yml \\ --storage.path=/data \\ --web.external-url=/ \\ --cluster.listen-address=${NODE_NAME}:9094 \\ $args tail -f /app/bin/hold.txt 2.å®šåˆ¶é•œåƒ\n$ cat Dockerfile FROM prom/alertmanager:v0.15.3 as alertmanager FROM selfflying/centos7.2:latest COPY start.sh / RUN chmod +x /start.sh ENTRYPOINT [\u0026#34;sh\u0026#34;,\u0026#34;/start.sh\u0026#34;] $ docker build -t 192.168.1.50:5000/library/centos7.2_alertmanager:v0.15.3 . $ docker push 192.168.1.50:5000/library/centos7.2_alertmanager:v0.15.3 åˆ›å»ºstatefulset # apiVersion: apps/v1 kind: StatefulSet metadata: name: alertmanager namespace: kube-system labels: k8s-app: alertmanager kubernetes.io/cluster-service: \u0026#34;true\u0026#34; addonmanager.kubernetes.io/mode: Reconcile version: v0.15.3 spec: serviceName: \u0026#34;alertmanager\u0026#34; podManagementPolicy: \u0026#34;Parallel\u0026#34; replicas: 3 selector: matchLabels: k8s-app: alertmanager version: v0.15.3 template: metadata: labels: k8s-app: alertmanager version: v0.15.3 annotations: scheduler.alpha.kubernetes.io/critical-pod: \u0026#39;\u0026#39; spec: tolerations: - key: \u0026#34;CriticalAddonsOnly\u0026#34; operator: \u0026#34;Exists\u0026#34; - effect: NoSchedule key: node-role.kubernetes.io/master affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: k8s-app operator: In values: - alertmanager topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; priorityClassName: system-cluster-critical hostNetwork: true dnsPolicy: ClusterFirstWithHostNet containers: - name: prometheus-alertmanager image: \u0026#34;192.168.1.50:5000/library/centos7.2_alertmanager:v0.15.3\u0026#34; imagePullPolicy: \u0026#34;IfNotPresent\u0026#34; env: - name: NODE_NAME valueFrom: fieldRef: fieldPath: spec.nodeName - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: PEER_ADDRESS value: \u0026#34;192.168.1.50:9094,192.168.1.51:9094,192.168.1.52:9094\u0026#34; readinessProbe: httpGet: path: /#/status port: 9093 initialDelaySeconds: 30 timeoutSeconds: 30 volumeMounts: - name: config-volume mountPath: /etc/config - name: storage-volume mountPath: \u0026#34;/data\u0026#34; subPath: \u0026#34;\u0026#34; resources: limits: cpu: 1000m memory: 500Mi requests: cpu: 10m memory: 50Mi - name: prometheus-alertmanager-configmap-reload image: \u0026#34;jimmidyson/configmap-reload:v0.1\u0026#34; imagePullPolicy: \u0026#34;IfNotPresent\u0026#34; args: - --volume-dir=/etc/config - --webhook-url=http://localhost:9093/-/reload volumeMounts: - name: config-volume mountPath: /etc/config readOnly: true resources: limits: cpu: 10m memory: 10Mi requests: cpu: 10m memory: 10Mi volumes: - name: config-volume configMap: name: alertmanager-config volumeClaimTemplates: - metadata: name: storage-volume spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] storageClassName: \u0026#34;alertmanager-lpv\u0026#34; resources: requests: storage: 20Gi è®¿é—®alertmanager webé¡µé¢ # é›†ç¾¤åˆ›å»ºæˆåŠŸhttp://192.168.1.52:9093/#/statusAlertmanager\nprometheus-federateé…ç½®å‘Šè­¦è§„åˆ™ # ä¿®æ”¹prometheus-federateçš„configmap.yaml\n#cat configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: prometheus-federate-config namespace: kube-system data: alertmanager_rules.yaml: | groups: - name: example rules: - alert: InstanceDown expr: up == 0 for: 1m labels: severity: page annotations: summary: \u0026#34;Instance {{ $labels.instance }} down\u0026#34; description: \u0026#34;{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minutes.\u0026#34; - alert: NodeMemoryUsage expr: (node_memory_MemTotal_bytes -(node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes )) / node_memory_MemTotal_bytes * 100 \u0026gt; 55 for: 1m labels: team: node annotations: summary: \u0026#34;cluster:{{ $labels.cluster }} {{ $labels.instance }}: High Memory usage detected\u0026#34; description: \u0026#34;{{ $labels.instance }}: Memory usage is above 55% (current value is: {{ $value }}\u0026#34; prometheus.yml: | global: scrape_interval: 30s evaluation_interval: 30s #remote_write: # - url: \u0026#34;http://29.20.18.160:9201/write\u0026#34; alerting: alertmanagers: - static_configs: - targets: - alertmanager-0.alertmanager:9093 - alertmanager-1.alertmanager:9093 - alertmanager-2.alertmanager:9093 rule_files: - \u0026#34;/etc/prometheus/alertmanager_rules.yaml\u0026#34; scrape_configs: - job_name: \u0026#39;federate\u0026#39; scrape_interval: 30s honor_labels: true metrics_path: \u0026#39;/federate\u0026#39; params: \u0026#39;match[]\u0026#39;: - \u0026#39;{job=~\u0026#34;kubernetes.*\u0026#34;}\u0026#39; - \u0026#39;{job=\u0026#34;prometheus\u0026#34;}\u0026#39; static_configs: - targets: - \u0026#39;prometheus-0.prometheus:9090\u0026#39; - \u0026#39;prometheus-1.prometheus:9090\u0026#39; ä»prometheus federate web å¯ä»¥çœ‹åˆ°æ·»åŠ çš„ä¸¤æ¡å‘Šè­¦è§„åˆ™\nPrometheus webä¸Šå¯ä»¥çœ‹åˆ°çŠ¶æ€ä¸ºFIRINGè¡¨ç¤ºå‘Šè­¦å·²è§¦å‘\nå‘Šè­¦ä¿¡æ¯ç”Ÿå‘½å‘¨æœŸçš„3ä¸­çŠ¶æ€\ninactiveï¼šè¡¨ç¤ºå½“å‰æŠ¥è­¦ä¿¡æ¯å³ä¸æ˜¯firingçŠ¶æ€ä¹Ÿä¸æ˜¯pendingçŠ¶æ€ pendingï¼šè¡¨ç¤ºåœ¨è®¾ç½®çš„é˜ˆå€¼æ—¶é—´èŒƒå›´å†…è¢«æ¿€æ´»çš„ firingï¼šè¡¨ç¤ºè¶…è¿‡è®¾ç½®çš„é˜ˆå€¼æ—¶é—´è¢«æ¿€æ´»çš„ alertmanger webé¡µé¢å¯ä»¥çœ‹åˆ°æ­¤å‘Šè­¦ï¼Œè¡¨ç¤ºå·²æˆåŠŸæ¨é€\nåŒæ—¶ï¼Œé’‰é’‰ç¾¤ä¹Ÿæ”¶åˆ°äº†å‘Šè­¦ä¿¡æ¯\n","date":"8 November 2019","permalink":"/2019/11/k8s-prometheus-4/","section":"åšå®¢","summary":"Prometheuså¯ä»¥å®šä¹‰è­¦æŠ¥è§„åˆ™ï¼Œæ»¡è¶³æ¡ä»¶æ—¶è§¦å‘è­¦æŠ¥ï¼Œå¹¶æ¨é€åˆ°AlertmanageræœåŠ¡ã€‚Alertmanageræ”¯æŒé«˜å¯ç”¨çš„é›†ç¾¤éƒ¨ç½²ï¼Œè´Ÿè´£ç®¡ç†ã€æ•´åˆå’Œåˆ†å‘è­¦æŠ¥åˆ°ä¸é€šç›®çš„åœ°ï¼Œå¹¶èƒ½åšåˆ°å‘Šè­¦æ”¶æ•› æœ¬ä¾‹é‡‡ç”¨statefulsetæ–¹å¼éƒ¨ç½²3ä¸ªå®ä¾‹çš„Alertmanageré«˜å¯ç”¨é›†ç¾¤\nAlertmanageré›†ç¾¤éƒ¨ç½² # åˆ›å»ºalertmanageræ•°æ®ç›®å½• # $ mkdir /data/alertmanager åˆ›å»ºstorageclass # $ cat storageclass.yaml apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: alertmanager-lpv provisioner: kubernetes.io/no-provisioner volumeBindingMode: WaitForFirstConsumer åˆ›å»ºlocal volume # $ cat pv.","title":"é«˜å¯ç”¨prometheusç›‘æ§é›†ç¾¤æ­å»º(å››)"},{"content":" Prometheusçš„è”é‚¦æ¨¡å¼ï¼Œæ”¯æŒäº†é›†ç¾¤çš„åˆ†å±‚æ‰©å±•åŠè·¨æœåŠ¡æ‰©å±•ã€‚ åˆ†å±‚æ‰©å±•å…è®¸Prometheusæ‰©å±•åˆ°å¤šæ•°æ®ä¸­å¿ƒã€å¤§è§„æ¨¡ä¸»æœºé›†ç¾¤ï¼Œæ ‘å‹æ‹“æ‰‘ è·¨æœåŠ¡æ‰©å±•æ˜¯ä¸åŒç±»åˆ«çš„ç›‘æ§æŒ‡æ ‡é¡¹ç”±ä¸åŒçš„prometheus serveråˆ†åˆ«æ”¶é›† åœ¨å¤šk8sé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªé›†ç¾¤éƒ¨ç½²prometheus serverç”¨äºæ”¶é›†è¯¥é›†ç¾¤ç›¸å…³æŒ‡æ ‡,å€ŸåŠ©prometheusè”é‚¦æ¨¡å¼ï¼Œå®ç°ç›‘æ§æ•°æ®çš„ç»Ÿä¸€æ”¶é›†å±•ç°åŠå‘Šè­¦é€šçŸ¥\nè”é‚¦æ¨¡å¼éƒ¨ç½²é…ç½® # åˆ›å»ºprometheus-federateæ•°æ®ç›®å½• # #åˆ†åˆ«åœ¨ä¸»æœº192.168.1.51å’Œ192.168.1.52ä¸Šæ‰§è¡Œ $ groupadd -g 65534 nfsnobody $ useradd -g 65534 -u 65534 -s /sbin/nologinÂ nfsnobody $ chown nfsnobody. /data/prometheus-federate/ åˆ›å»ºstorageclass # $ cat storageclass.yaml apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: prometheus-federate-lpv provisioner: kubernetes.io/no-provisioner volumeBindingMode: WaitForFirstConsumer åˆ›å»ºlocal volume # $ cat pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: prometheus-federate-lpv-0 spec: capacity: storage: 50Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Retain storageClassName: prometheus-federate-lpv local: path: /data/prometheus-federate nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - 192.168.1.51 --- apiVersion: v1 kind: PersistentVolume metadata: name: prometheus-federate-lpv-1 spec: capacity: storage: 50Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Retain storageClassName: prometheus-federate-lpv local: path: /data/prometheus-federate nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - 192.168.1.52 åˆ›å»ºprometheus.ymlçš„configmap # $ cat configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: prometheus-federate-config namespace: kube-system data: prometheus.yml: | global: scrape_interval: 30s evaluation_interval: 30s scrape_configs: - job_name: \u0026#39;federate\u0026#39; scrape_interval: 30s honor_labels: true metrics_path: \u0026#39;/federate\u0026#39; params: \u0026#39;match[]\u0026#39;: - \u0026#39;{job=~\u0026#34;kubernetes.*\u0026#34;}\u0026#39; - \u0026#39;{job=\u0026#34;prometheus\u0026#34;}\u0026#39; static_configs: - targets: - \u0026#39;prometheus-0.prometheus:9090\u0026#39; - \u0026#39;prometheus-1.prometheus:9090\u0026#39; åˆ›å»ºheadless service # $ cat service-statefulset.yaml apiVersion: v1 kind: Service metadata: name: prometheus-federate namespace: kube-system spec: ports: - name: prometheus-federate port: 9091 targetPort: 9091 selector: k8s-app: prometheus-federate åˆ›å»ºstatefulset # $ cat prometheus-federate-statefulset.yaml apiVersion: apps/v1 kind: StatefulSet metadata: name: prometheus-federate namespace: kube-system labels: k8s-app: prometheus-federate kubernetes.io/cluster-service: \u0026#34;true\u0026#34; spec: serviceName: \u0026#34;prometheus-federate\u0026#34; podManagementPolicy: \u0026#34;Parallel\u0026#34; replicas: 2 selector: matchLabels: k8s-app: prometheus-federate template: metadata: labels: k8s-app: prometheus-federate annotations: scheduler.alpha.kubernetes.io/critical-pod: \u0026#39;\u0026#39; spec: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: k8s-app operator: In values: - prometheus-federate topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; priorityClassName: system-cluster-critical hostNetwork: true dnsPolicy: ClusterFirstWithHostNet containers: - name: prometheus-federate-configmap-reload image: \u0026#34;jimmidyson/configmap-reload:v0.1\u0026#34; imagePullPolicy: \u0026#34;IfNotPresent\u0026#34; args: - --volume-dir=/etc/config - --webhook-url=http://localhost:9091/-/reload volumeMounts: - name: config-volume mountPath: /etc/config readOnly: true resources: limits: cpu: 10m memory: 10Mi requests: cpu: 10m memory: 10Mi - image: prom/prometheus:v2.11.0 imagePullPolicy: IfNotPresent name: prometheus command: - \u0026#34;/bin/prometheus\u0026#34; args: - \u0026#34;--web.listen-address=0.0.0.0:9091\u0026#34; - \u0026#34;--config.file=/etc/prometheus/prometheus.yml\u0026#34; - \u0026#34;--storage.tsdb.path=/prometheus\u0026#34; - \u0026#34;--storage.tsdb.retention=24h\u0026#34; - \u0026#34;--web.console.libraries=/etc/prometheus/console_libraries\u0026#34; - \u0026#34;--web.console.templates=/etc/prometheus/consoles\u0026#34; - \u0026#34;--web.enable-lifecycle\u0026#34; ports: - containerPort: 9091 protocol: TCP volumeMounts: - mountPath: \u0026#34;/prometheus\u0026#34; name: prometheus-federate-data - mountPath: \u0026#34;/etc/prometheus\u0026#34; name: config-volume readinessProbe: httpGet: path: /-/ready port: 9091 initialDelaySeconds: 30 timeoutSeconds: 30 livenessProbe: httpGet: path: /-/healthy port: 9091 initialDelaySeconds: 30 timeoutSeconds: 30 resources: requests: cpu: 100m memory: 100Mi limits: cpu: 1000m memory: 2500Mi serviceAccountName: prometheus volumes: - name: config-volume configMap: name: prometheus-federate-config volumeClaimTemplates: - metadata: name: prometheus-federate-data spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] storageClassName: \u0026#34;prometheus-federate-lpv\u0026#34; resources: requests: storage: 20Gi è®¿é—®prometheus web UI # prometheus serverçš„jobéƒ½å·²æˆåŠŸæŠ“å–ï¼›æŸ¥è¯¢upæŒ‡æ ‡ï¼Œå¯ä»¥è·å–åˆ°ç›¸å…³metricï¼ŒåŒæ—¶éƒ½å…·æœ‰æ ‡ç­¾cluster=\u0026ldquo;01\u0026rdquo;ï¼Œå¯ç”¨äºåŒºåˆ«ä¸åŒé›†ç¾¤çš„æŒ‡æ ‡ï¼›æ­¤æ ‡ç­¾æ˜¯prometheus serveråœ¨é…ç½®æ–‡ä»¶ä¸­external_labelsæŒ‡å®š ","date":"8 November 2019","permalink":"/2019/11/k8s-prometheus-3/","section":"åšå®¢","summary":"\u003cblockquote\u003e\n\u003cp\u003ePrometheusçš„è”é‚¦æ¨¡å¼ï¼Œæ”¯æŒäº†é›†ç¾¤çš„åˆ†å±‚æ‰©å±•åŠè·¨æœåŠ¡æ‰©å±•ã€‚\n\u003ccode\u003eåˆ†å±‚æ‰©å±•\u003c/code\u003eå…è®¸Prometheusæ‰©å±•åˆ°å¤šæ•°æ®ä¸­å¿ƒã€å¤§è§„æ¨¡ä¸»æœºé›†ç¾¤ï¼Œæ ‘å‹æ‹“æ‰‘\n\u003ccode\u003eè·¨æœåŠ¡æ‰©å±•\u003c/code\u003eæ˜¯ä¸åŒç±»åˆ«çš„ç›‘æ§æŒ‡æ ‡é¡¹ç”±ä¸åŒçš„prometheus serveråˆ†åˆ«æ”¶é›†\nåœ¨å¤šk8sé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªé›†ç¾¤éƒ¨ç½²prometheus serverç”¨äºæ”¶é›†è¯¥é›†ç¾¤ç›¸å…³æŒ‡æ ‡,å€ŸåŠ©prometheusè”é‚¦æ¨¡å¼ï¼Œå®ç°ç›‘æ§æ•°æ®çš„ç»Ÿä¸€æ”¶é›†å±•ç°åŠå‘Šè­¦é€šçŸ¥\u003c/p\u003e\n\u003c/blockquote\u003e","title":"é«˜å¯ç”¨prometheusç›‘æ§é›†ç¾¤æ­å»º(ä¸‰)"},{"content":" Prometheusä½¿ç”¨exporterå·¥å…·æ¥æš´éœ²ä¸»æœºå’Œåº”ç”¨ç¨‹åºä¸Šçš„æŒ‡æ ‡ï¼Œç›®å‰æœ‰å¾ˆå¤šå¯ç”¨äºå„ç§ç›®çš„çš„exporter( https://prometheus.io/docs/instrumenting/exporters/)\nNode Exporteréƒ¨ç½² # Node exporterå¯æä¾›ç”¨äºæ”¶é›†å„ç§ä¸»æœºæŒ‡æ ‡æ•°æ®ï¼ˆåŒ…æ‹¬CPUã€å†…å­˜ã€ç½‘ç»œå’Œç£ç›˜ï¼‰ï¼Œåœ¨k8sé›†ç¾¤ä¸­å¯ä»¥ä½¿ç”¨daemonsetçš„æ–¹å¼éƒ¨ç½²ã€‚éœ€è¦å°†å®¿ä¸»æœºæ ¹æ˜ å°„åˆ°å®¹å™¨ä¸­ï¼Œæ¥æ­£ç¡®è·å–ä¸»æœºæ–‡ä»¶ç³»ç»Ÿç›‘æ§æ•°æ®\n$ cat node-exporter.yaml apiVersion: extensions/v1beta1 kind: DaemonSet metadata: name: node-exporter namespace: kube-system labels: k8s-app: node-exporter spec: template: metadata: labels: k8s-app: node-exporter spec: tolerations: - effect: NoSchedule key: node-role.kubernetes.io/master containers: - image: k8s.gcr.io/prom/node-exporter:latest imagePullPolicy: IfNotPresent name: prometheus-node-exporter ports: - containerPort: 9100 hostPort: 9100 protocol: TCP name: metrics volumeMounts: - mountPath: /host/proc name: proc - mountPath: /host/sys name: sys - mountPath: /host name: rootfs args: - --path.procfs=/host/proc - --path.sysfs=/host/sys - --path.rootfs=/host volumes: - name: proc hostPath: path: /proc - name: sys hostPath: path: /sys - name: rootfs hostPath: path: / hostNetwork: true hostPID: true --- apiVersion: v1 kind: Service metadata: annotations: prometheus.io/scrape: \u0026#34;true\u0026#34; labels: k8s-app: node-exporter name: node-exporter namespace: kube-system spec: ports: - name: http port: 9100 protocol: TCP selector: k8s-app: node-exporter $ kubectl apply -f node-exporter.yaml node-exporterçš„serviceä¸­æŒ‡å®šäº†annotation: prometheus.io/scrape: \u0026quot;true\u0026quot;, job:kubernetes-service-endpointså¯ä»¥è‡ªåŠ¨å‘ç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\nè®¿é—®graphæŸ¥è¯¢é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°node_å¼€å¤´çš„metricsä¹Ÿå·²ç»è·å–åˆ°\nkube-state-metricséƒ¨ç½² # cAdvisor(kubelet)å¯ä»¥æ”¶é›†å®¹å™¨åŠsystemdæ‰˜ç®¡æœåŠ¡çš„CPUã€å†…å­˜ã€ç½‘ç»œã€å®¹å™¨æ•°é‡ï¼Œå´ä¸èƒ½è·å–åˆ°æœ‰å…³kubennetesèµ„æºå¯¹è±¡æŒ‡æ ‡çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼šé›†ç¾¤è¿è¡Œäº†å¤šå°‘ä¸ªPODï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Œpodé‡å¯äº†å¤šå°‘æ¬¡ï¼Œpodä¸­çš„å®¹å™¨å¯åŠ¨å¤±è´¥çš„åŸå› æ˜¯ä»€ä¹ˆï¼Œdeploymentçš„éƒ¨ç½²æ˜¯å¦æˆåŠŸï¼Œdeploymentçš„è¿è¡Œå‰¯æœ¬æ•°æ˜¯å¦å’Œå…ƒæ•°æ®ä¸­çš„ä¸€è‡´\nkube-state-metricsé€šè¿‡è½®è¯¢kubernetes APIï¼Œæä¾›æœ‰å…³èµ„æºå¯¹è±¡æŒ‡æ ‡çš„metricsï¼ŒåŒ…æ‹¬ï¼šCronJobã€DaemonSetã€Deploymentã€Jobã€LimitRangeã€Nodeã€PersistentVolume ã€PersistentVolumeClaimã€Podã€Pod Disruption Budgetã€ReplicaSetã€ReplicationControllerã€ResourceQuotaã€Serviceã€StatefulSetã€Namespaceã€Horizontal Pod Autoscalerã€Endpointã€Secretã€ConfigMapã€Ingressã€CertificateSigningRequest\nrbacèµ„æºåˆå§‹åŒ– # $ cat kube-state-metrics-rbac.yaml kind: Role metadata: namespace: kube-system name: kube-state-metrics-resizer rules: - apiGroups: [\u0026#34;\u0026#34;] resources: - pods verbs: [\u0026#34;get\u0026#34;] - apiGroups: [\u0026#34;apps\u0026#34;] resources: - deployments resourceNames: [\u0026#34;kube-state-metrics\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;update\u0026#34;] - apiGroups: [\u0026#34;extensions\u0026#34;] resources: - deployments resourceNames: [\u0026#34;kube-state-metrics\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;update\u0026#34;] --- kind: RoleBinding metadata: name: kube-state-metrics namespace: kube-system roleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: kube-state-metrics-resizer subjects: - kind: ServiceAccount name: kube-state-metrics namespace: kube-system --- kind: ClusterRole metadata: name: kube-state-metrics rules: - apiGroups: [\u0026#34;\u0026#34;] resources: - configmaps - secrets - nodes - pods - services - resourcequotas - replicationcontrollers - limitranges - persistentvolumeclaims - persistentvolumes - namespaces - endpoints verbs: [\u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;extensions\u0026#34;] resources: - daemonsets - deployments - replicasets - ingresses verbs: [\u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;apps\u0026#34;] resources: - daemonsets - deployments - replicasets - statefulsets verbs: [\u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;batch\u0026#34;] resources: - cronjobs - jobs verbs: [\u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;autoscaling\u0026#34;] resources: - horizontalpodautoscalers verbs: [\u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;policy\u0026#34;] resources: - poddisruptionbudgets verbs: [\u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;certificates.k8s.io\u0026#34;] resources: - certificatesigningrequests verbs: [\u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] --- kind: ClusterRoleBinding metadata: name: kube-state-metrics roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: kube-state-metrics subjects: - kind: ServiceAccount name: kube-state-metrics namespace: kube-system --- apiVersion: v1 kind: ServiceAccount metadata: name: kube-state-metrics namespace: kube-system åˆ›å»ºdeployment # $ cat kube-state-metrics-deployment.yaml kind: Deployment metadata: name: kube-state-metrics namespace: kube-system spec: selector: matchLabels: k8s-app: kube-state-metrics replicas: 1 template: metadata: labels: k8s-app: kube-state-metrics spec: serviceAccountName: kube-state-metrics containers: - name: kube-state-metrics image: quay.io/coreos/kube-state-metrics:v1.6.0 ports: - name: http-metrics containerPort: 8080 - name: telemetry containerPort: 8081 readinessProbe: httpGet: path: /healthz port: 8080 initialDelaySeconds: 5 timeoutSeconds: 5 - name: addon-resizer image: k8s.gcr.io/addon-resizer:1.8.4 resources: limits: cpu: 150m memory: 50Mi requests: cpu: 150m memory: 50Mi env: - name: MY_POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: MY_POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace command: - /pod_nanny - --container=kube-state-metrics - --cpu=100m - --extra-cpu=1m - --memory=100Mi - --extra-memory=2Mi - --threshold=5 - --deployment=kube-state-metrics --- apiVersion: v1 kind: Service metadata: name: kube-state-metrics namespace: kube-system labels: k8s-app: kube-state-metrics annotations: prometheus.io/scrape: \u0026#39;true\u0026#39; spec: ports: - name: http-metrics port: 8080 targetPort: http-metrics protocol: TCP - name: telemetry port: 8081 targetPort: telemetry protocol: TCP selector: k8s-app: kube-state-metrics kube-state-metricsçš„serviceä¸­æŒ‡å®šäº†annotation: prometheus.io/scrape: \u0026quot;true\u0026quot;, job: kubernetes-service-endpointså¯ä»¥è‡ªåŠ¨å‘ç°\n","date":"6 November 2019","permalink":"/2019/11/k8s-prometheus-2/","section":"åšå®¢","summary":"\u003cblockquote\u003e\n\u003cp\u003ePrometheusä½¿ç”¨exporterå·¥å…·æ¥æš´éœ²ä¸»æœºå’Œåº”ç”¨ç¨‹åºä¸Šçš„æŒ‡æ ‡ï¼Œç›®å‰æœ‰å¾ˆå¤šå¯ç”¨äºå„ç§ç›®çš„çš„exporter(\u003ca href=\"https://prometheus.io/docs/instrumenting/exporters/\"   target=\"_blank\"\u003e\n    https://prometheus.io/docs/instrumenting/exporters/\u003c/a\u003e)\u003c/p\u003e\n\u003c/blockquote\u003e","title":"é«˜å¯ç”¨prometheusç›‘æ§é›†ç¾¤æ­å»º(äºŒ)"},{"content":"ç®€ä»‹ # Prometheusæ˜¯ä¸€ä¸ªå¼€æºçš„ç›‘æ§ç³»ç»Ÿï¼Œé€šè¿‡æŠ“å–æˆ–æ‹‰å–åº”ç”¨ç¨‹åºä¸­æš´éœ²çš„æ—¶é—´åºåˆ—æ•°æ®æ¥å·¥ä½œã€‚æ—¶é—´åºåˆ—æ•°æ®é€šå¸¸ç”±åº”ç”¨ç¨‹åºæœ¬èº«é€šè¿‡å®¢æˆ·ç«¯åº“æˆ–è€…æˆä¸ºexporterçš„ä»£ç†æ¥ä½œä¸ºHTTPç«¯ç‚¹æš´éœ²ã€‚ç›®å‰å·²ç»å­˜åœ¨å¾ˆå¤šexporterå’Œå®¢æˆ·ç«¯åº“ï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ã€æ¡†æ¶å’Œå¼€æºåº”ç”¨ç¨‹åºã€‚\nå®˜æ–¹æ¶æ„å›¾ # Prometheusé€šè¿‡é…ç½®targetï¼Œæ¥æŠ“å–å¯¹åº”ä¸»æœºã€è¿›ç¨‹ã€æœåŠ¡æˆ–åº”ç”¨ç¨‹åºçš„æŒ‡æ ‡ã€‚ä¸€ç»„å…·æœ‰ç›¸åŒè§’è‰²çš„targetè¢«ç§°ä¸ºjobã€‚æ¯”å¦‚ï¼Œå®šä¹‰kubernetes-nodesçš„jobï¼Œæ¥æŠ“å–é›†ç¾¤æ‰€æœ‰ä¸»æœºçš„ç›¸å…³æŒ‡æ ‡ æœåŠ¡å‘ç°ï¼ˆtargetï¼‰ é™æ€èµ„æºåˆ—è¡¨ åŸºäºæ–‡ä»¶çš„å‘ç°ï¼Œå¯ä½¿ç”¨è‡ªåŠ¨åŒ–é…ç½®ç®¡ç†å·¥å…·è‡ªåŠ¨æ›´æ–° è‡ªåŠ¨å‘ç°ï¼Œæ”¯æŒåŸºäºAWS/Consul/dns/kubernetes/marathonç­‰çš„æœåŠ¡å‘ç° Prometheuså°†æ”¶é›†æ—¶é—´åºåˆ—æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥é…ç½®remote_writeå­˜å‚¨åˆ°å…¶å®ƒæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œæ¯”å¦‚OpenTSDBã€InfluxDBã€M3DBç­‰ å¯è§†åŒ–: Prometheuså†…ç½®äº†web UIï¼Œä¹Ÿå¯ä»¥å’ŒåŠŸèƒ½å¼ºå¤§çš„å¼€æºä»ªè¡¨æ¿Grafanaé›†æˆï¼Œå¯è‡ªå®šä¹‰dashboardæ»¡è¶³å„ç§å®šåˆ¶åŒ–éœ€æ±‚ èšåˆå’Œå‘Šè­¦: Prometheuså¯ä»¥æŸ¥è¯¢å’Œèšåˆæ—¶é—´åºåˆ—æ•°æ®ï¼Œå¹¶åˆ›å»ºè§„åˆ™æ¥è®°å½•å¸¸ç”¨çš„æŸ¥è¯¢å’Œèšåˆã€‚è¿˜å¯ä»¥å®šä¹‰è­¦æŠ¥è§„åˆ™ï¼Œæ»¡è¶³æ¡ä»¶æ—¶è§¦å‘è­¦æŠ¥ï¼Œå¹¶æ¨é€åˆ°AlertmanageræœåŠ¡ã€‚Alertmanagræ”¯æŒé«˜å¯ç”¨çš„é›†ç¾¤éƒ¨ç½²ï¼Œè´Ÿè´£ç®¡ç†ã€æ•´åˆå’Œåˆ†å‘è­¦æŠ¥åˆ°ä¸é€šç›®çš„åœ°ï¼Œå¹¶èƒ½åšåˆ°å‘Šè­¦æ”¶æ•› æ•°æ®æ¨¡å‹ # Prometheusä½¿ç”¨ä¸€ä¸ªå¤šç»´æ—¶é—´åºåˆ—æ•°æ®æ¨¡å‹ï¼Œç»“åˆäº†æ—¶é—´åºåˆ—åç§°å’Œç§°ä¸ºæ ‡ç­¾(label)çš„é”®/å€¼å¯¹ï¼Œè¿™äº›æ ‡ç­¾æä¾›äº†ç»´åº¦ã€‚æ¯ä¸ªæ—¶é—´åºåˆ—ç”±æ—¶é—´åºåˆ—åç§°å’Œæ ‡ç­¾çš„ç»„åˆå”¯ä¸€æ ‡è¯†ã€‚ \u0026lt;time series name\u0026gt; {\u0026lt;label name\u0026gt;=\u0026lt;label value\u0026gt;,...}\nmachine_cpu_cores{beta_kubernetes_io_arch=\u0026ldquo;amd64\u0026rdquo;,beta_kubernetes_io_os=\u0026ldquo;linux\u0026rdquo;,instance=\u0026ldquo;192.168.1.51\u0026rdquo;,job=\u0026ldquo;kubernetes-cadvisor\u0026rdquo;,kubernetes_io_arch=\u0026ldquo;amd64\u0026rdquo;,kubernetes_io_hostname=\u0026ldquo;192.168.1.51\u0026rdquo;,kubernetes_io_os=\u0026ldquo;linux\u0026rdquo;} 2 machine_cpu_coresæ”¶é›†çš„æ˜¯ä¸»æœºçš„cpuæ ¸æ•°ï¼Œtaget labelæ ‡è¯†äº†æ˜¯job kubernetes-cadvisoræŠ“å–çš„ï¼Œinstance 192.168.1.51çš„æŒ‡æ ‡ï¼Œè¿˜åŒ…æ‹¬æ­¤nodeçš„å…¶å®ƒlabelsï¼›è·å–åˆ°çš„valueå€¼ä¸º2\né›†ç¾¤æ‹“æ‰‘å›¾ # èŠ‚ç‚¹éƒ¨ç½²è§„åˆ’ # IP k8srole service 192.168.1.50 master node-exporter/alertmanager 192.168.1.51 node node-exporter/alertmanager/grafana/prometheus-0/prometheus-federate-0/kube-state-metrics 192.168.1.52 node node-exporter/alertmanager/prometheus-1/prometheus-federate-1 éƒ¨ç½²æ¶æ„å›¾ # åœ¨å¤šk8sé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªé›†ç¾¤éƒ¨ç½²prometheus serverç”¨äºæ”¶é›†è¯¥é›†ç¾¤ç›¸å…³æŒ‡æ ‡,å€ŸåŠ©prometheusè”é‚¦æ¨¡å¼ï¼Œå®ç°ç›‘æ§æ•°æ®çš„ç»Ÿä¸€æ”¶é›†å±•ç°åŠå‘Šè­¦é€šçŸ¥ é›†ç¾¤å†…prometheus serveréƒ¨ç½² # statefulsetæ–¹å¼éƒ¨ç½²,å¹¶ä½¿ç”¨æœ¬åœ°æŒä¹…å· Local Volume\nåˆ›å»ºprometheus serveræ•°æ®ç›®å½• # $ groupadd -g 65534 nfsnobody $ useradd -g 65534 -u 65534 -s /sbin/nologin nfsnobody $ chown nfsnobody. /data/prometheus/ åˆ›å»ºstorageclass,æŒ‡å®šå·æŒ‚è½½ä¸ºæ‹“æ‰‘æ„ŸçŸ¥æ¨¡å¼ï¼Œå³podè°ƒåº¦åå†ç»‘å®šå· # $cat storageclass.yaml apiVersion: storage.k8s.io/v1 kind: StorageClass metadata: name: prometheus-lpv provisioner: kubernetes.io/no-provisioner volumeBindingMode: WaitForFirstConsumer åˆ›å»ºä¸¤ä¸ªlocal volumeï¼Œåˆ©ç”¨nodeAffinityç»‘å®šåˆ°æŒ‡å®šèŠ‚ç‚¹ # # cat pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: prometheus-lpv-0 spec: capacity: storage: 50Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Retain storageClassName: prometheus-lpv local: path: /data/prometheus nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - 192.168.1.51 --- apiVersion: v1 kind: PersistentVolume metadata: name: prometheus-lpv-1 spec: capacity: storage: 50Gi volumeMode: Filesystem accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Retain storageClassName: prometheus-lpv local: path: /data/prometheus nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname operator: In values: - 192.168.1.52 åˆå§‹åŒ–rabc # $cat rbac-setup.yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: prometheus rules: - apiGroups: [\u0026#34;\u0026#34;] resources: - nodes - nodes/proxy - services - endpoints - pods verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: - extensions resources: - ingresses verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - nonResourceURLs: [\u0026#34;/metrics\u0026#34;] verbs: [\u0026#34;get\u0026#34;] --- apiVersion: v1 kind: ServiceAccount metadata: name: prometheus namespace: kube-system --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: prometheus roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: prometheus subjects: - kind: ServiceAccount name: prometheus namespace: kube-system ######ã€€åˆ›å»ºconfigmap(prometheus.yml)\n$cat prometheus-configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: prometheus-config namespace: kube-system data: prometheus.yml: | global: scrape_interval: 30s evaluation_interval: 30s external_labels: cluster: \u0026#34;01\u0026#34; scrape_configs: - job_name: \u0026#39;prometheus\u0026#39; static_configs: - targets: - prometheus-0.prometheus:9090 - prometheus-1.prometheus:9090 - job_name: \u0026#39;kubernetes-apiservers\u0026#39; kubernetes_sd_configs: - role: endpoints scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name] action: keep regex: default;kubernetes;https - job_name: \u0026#39;kubernetes-nodes\u0026#39; kubernetes_sd_configs: - role: node scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - target_label: __address__ replacement: kubernetes.default.svc:443 - source_labels: [__meta_kubernetes_node_name] regex: (.+) target_label: __metrics_path__ replacement: /api/v1/nodes/${1}/proxy/metrics - job_name: \u0026#39;kubernetes-cadvisor\u0026#39; kubernetes_sd_configs: - role: node scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - target_label: __address__ replacement: kubernetes.default.svc:443 - source_labels: [__meta_kubernetes_node_name] regex: (.+) target_label: __metrics_path__ replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor metric_relabel_configs: - action: replace source_labels: [id] regex: \u0026#39;^/machine\\.slice/machine-rkt\\\\x2d([^\\\\]+)\\\\.+/([^/]+)\\.service$\u0026#39; target_label: rkt_container_name replacement: \u0026#39;${2}-${1}\u0026#39; - action: replace source_labels: [id] regex: \u0026#39;^/system\\.slice/(.+)\\.service$\u0026#39; target_label: systemd_service_name replacement: \u0026#39;${1}\u0026#39; - job_name: \u0026#39;kubernetes-pods\u0026#39; kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape] action: keep regex: true - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path] action: replace target_label: __metrics_path__ regex: (.+) - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port] action: replace regex: ([^:]+)(?::\\d+)?;(\\d+) replacement: $1:$2 target_label: __address__ - action: labelmap regex: __meta_kubernetes_pod_label_(.+) - source_labels: [__meta_kubernetes_namespace] action: replace target_label: kubernetes_namespace - source_labels: [__meta_kubernetes_pod_name] action: replace target_label: kubernetes_pod_name - job_name: \u0026#39;kubernetes-service-endpoints\u0026#39; kubernetes_sd_configs: - role: endpoints relabel_configs: - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape] action: keep regex: true - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme] action: replace target_label: __scheme__ regex: (https?) - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path] action: replace target_label: __metrics_path__ regex: (.+) - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port] action: replace target_label: __address__ regex: ([^:]+)(?::\\d+)?;(\\d+) replacement: $1:$2 - action: labelmap regex: __meta_kubernetes_service_label_(.+) - source_labels: [__meta_kubernetes_namespace] action: replace target_label: kubernetes_namespace - source_labels: [__meta_kubernetes_service_name] action: replace target_label: kubernetes_name - source_labels: [__address__] action: replace target_label: instance regex: (.+):(.+) replacement: $1 statefulsetåˆ›å»ºåï¼Œpodçš„å‘½åæ–¹å¼ä¸º\u0026lt;statefulset name\u0026gt;-0ã€\u0026lt;statefulset name\u0026gt;-1â€¦ å¯¹åº”ç”Ÿæˆçš„dnsåŸŸåä¸ºï¼Œpodname.stateflusetname.namespace.svc.cluster.local\njobprometheusç”¨æ¥è·å–prometheusæœ¬èº«çš„ç›‘æ§æŒ‡æ ‡ï¼Œæœ¬ä¾‹ä¸­prometheus serverä¸ºstatefulsetæ–¹å¼éƒ¨ç½²ï¼ŒæŒ‡å®štargetsä¸ºprometheus-0.prometheus:9090ã€prometheus-1.prometheus:9090 external_labelsç”¨äºå¤–éƒ¨ç³»ç»Ÿæ ‡ç­¾ï¼Œåœ¨ä½¿ç”¨remote_writeæˆ–è€…federateæ—¶ï¼Œå¯ä»¥ä¸ºè¯¥é›†ç¾¤æŒ‡æ ‡æ·»åŠ æ ‡ç­¾\nåˆ›å»ºheadless service # $cat service-statefulset.yaml apiVersion: v1 kind: Service metadata: name: prometheus namespace: kube-system spec: ports: - name: prometheus port: 9090 targetPort: 9090 selector: k8s-app: prometheus clusterIP: None åˆ›å»ºprometheus statefulset # $cat prometheus-statefulset.yaml apiVersion: apps/v1 kind: StatefulSet metadata: name: prometheus namespace: kube-system labels: k8s-app: prometheus kubernetes.io/cluster-service: \u0026#34;true\u0026#34; spec: serviceName: \u0026#34;prometheus\u0026#34; podManagementPolicy: \u0026#34;Parallel\u0026#34; replicas: 2 selector: matchLabels: k8s-app: prometheus template: metadata: labels: k8s-app: prometheus annotations: scheduler.alpha.kubernetes.io/critical-pod: \u0026#39;\u0026#39; spec: affinity: podAntiAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: k8s-app operator: In values: - prometheus topologyKey: \u0026#34;kubernetes.io/hostname\u0026#34; priorityClassName: system-cluster-critical hostNetwork: true dnsPolicy: ClusterFirstWithHostNet containers: - name: prometheus-server-configmap-reload image: \u0026#34;jimmidyson/configmap-reload:v0.1\u0026#34; imagePullPolicy: \u0026#34;IfNotPresent\u0026#34; args: - --volume-dir=/etc/config - --webhook-url=http://localhost:9090/-/reload volumeMounts: - name: config-volume mountPath: /etc/config readOnly: true resources: limits: cpu: 10m memory: 10Mi requests: cpu: 10m memory: 10Mi - image: prom/prometheus:v2.11.0 imagePullPolicy: IfNotPresent name: prometheus command: - \u0026#34;/bin/prometheus\u0026#34; args: - \u0026#34;--config.file=/etc/prometheus/prometheus.yml\u0026#34; - \u0026#34;--storage.tsdb.path=/prometheus\u0026#34; - \u0026#34;--storage.tsdb.retention=24h\u0026#34; - \u0026#34;--web.console.libraries=/etc/prometheus/console_libraries\u0026#34; - \u0026#34;--web.console.templates=/etc/prometheus/consoles\u0026#34; - \u0026#34;--web.enable-lifecycle\u0026#34; ports: - containerPort: 9090 protocol: TCP volumeMounts: - mountPath: \u0026#34;/prometheus\u0026#34; name: prometheus-data - mountPath: \u0026#34;/etc/prometheus\u0026#34; name: config-volume readinessProbe: httpGet: path: /-/ready port: 9090 initialDelaySeconds: 30 timeoutSeconds: 30 livenessProbe: httpGet: path: /-/healthy port: 9090 initialDelaySeconds: 30 timeoutSeconds: 30 resources: requests: cpu: 100m memory: 100Mi limits: cpu: 1000m memory: 2500Mi serviceAccountName: prometheus volumes: - name: config-volume configMap: name: prometheus-config volumeClaimTemplates: - metadata: name: prometheus-data spec: accessModes: [ \u0026#34;ReadWriteOnce\u0026#34; ] storageClassName: \u0026#34;prometheus-lpv\u0026#34; resources: requests: storage: 20Gi volumeClaimTemplatesæŒ‡å®šstorageclass,åœ¨podåˆ›å»ºæ—¶ä¼šç”ŸæˆPVCï¼Œä¸ºpodåˆ†é…prometheus-lpvçš„pvã€‚åªè¦PVCä¸è¢«åˆ é™¤ï¼Œpodå‡ä¼šè¢«è°ƒåº¦åˆ°å·²ç»‘å®šçš„pvèŠ‚ç‚¹ä¸Šã€‚\n$ kubectl get pv prometheus-lpv-0 50Gi RWO Retain Bound kube-system/prometheus-data-prometheus-1 prometheus-lpv 13d prometheus-lpv-1 50Gi RWO Retain Bound kube-system/prometheus-data-prometheus-0 prometheus-lpv 13d $ kubectl get pvc -n kube-system prometheus-data-prometheus-0 Bound prometheus-lpv-1 50Gi RWO prometheus-lpv 13d prometheus-data-prometheus-1 Bound prometheus-lpv-0 50Gi RWO prometheus-lpv 13d è®¿é—®prometheus web UI # prometheus.ymlä¸­æŒ‡å®šçš„jobï¼Œç›¸åº”targetå·²ç»æŠ“å–åˆ°ï¼›å¯é€šè¿‡graphæŸ¥è¯¢metrics\nâ€‹ æŒ‰ç…§ç›®å‰é…ç½®ï¼Œprometheusã€apiserverã€å®¹å™¨æŒ‡æ ‡æ•°æ®éƒ½èƒ½è·å–åˆ°ï¼Œä½†æ˜¯ä¸»æœºåŠk8sç›¸å…³èµ„æºæŒ‡æ ‡æ•°æ®è¿˜æ²¡æœ‰ï¼Œè¿˜éœ€è¦éƒ¨ç½²node-exporteråŠkube-state-metrics\n","date":"6 November 2019","permalink":"/2019/11/k8s-prometheus-1/","section":"åšå®¢","summary":"ç®€ä»‹ # Prometheusæ˜¯ä¸€ä¸ªå¼€æºçš„ç›‘æ§ç³»ç»Ÿï¼Œé€šè¿‡æŠ“å–æˆ–æ‹‰å–åº”ç”¨ç¨‹åºä¸­æš´éœ²çš„æ—¶é—´åºåˆ—æ•°æ®æ¥å·¥ä½œã€‚æ—¶é—´åºåˆ—æ•°æ®é€šå¸¸ç”±åº”ç”¨ç¨‹åºæœ¬èº«é€šè¿‡å®¢æˆ·ç«¯åº“æˆ–è€…æˆä¸ºexporterçš„ä»£ç†æ¥ä½œä¸ºHTTPç«¯ç‚¹æš´éœ²ã€‚ç›®å‰å·²ç»å­˜åœ¨å¾ˆå¤šexporterå’Œå®¢æˆ·ç«¯åº“ï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ã€æ¡†æ¶å’Œå¼€æºåº”ç”¨ç¨‹åºã€‚\nå®˜æ–¹æ¶æ„å›¾ # Prometheusé€šè¿‡é…ç½®targetï¼Œæ¥æŠ“å–å¯¹åº”ä¸»æœºã€è¿›ç¨‹ã€æœåŠ¡æˆ–åº”ç”¨ç¨‹åºçš„æŒ‡æ ‡ã€‚ä¸€ç»„å…·æœ‰ç›¸åŒè§’è‰²çš„targetè¢«ç§°ä¸ºjobã€‚æ¯”å¦‚ï¼Œå®šä¹‰kubernetes-nodesçš„jobï¼Œæ¥æŠ“å–é›†ç¾¤æ‰€æœ‰ä¸»æœºçš„ç›¸å…³æŒ‡æ ‡ æœåŠ¡å‘ç°ï¼ˆtargetï¼‰ é™æ€èµ„æºåˆ—è¡¨ åŸºäºæ–‡ä»¶çš„å‘ç°ï¼Œå¯ä½¿ç”¨è‡ªåŠ¨åŒ–é…ç½®ç®¡ç†å·¥å…·è‡ªåŠ¨æ›´æ–° è‡ªåŠ¨å‘ç°ï¼Œæ”¯æŒåŸºäºAWS/Consul/dns/kubernetes/marathonç­‰çš„æœåŠ¡å‘ç° Prometheuså°†æ”¶é›†æ—¶é—´åºåˆ—æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥é…ç½®remote_writeå­˜å‚¨åˆ°å…¶å®ƒæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œæ¯”å¦‚OpenTSDBã€InfluxDBã€M3DBç­‰ å¯è§†åŒ–: Prometheuså†…ç½®äº†web UIï¼Œä¹Ÿå¯ä»¥å’ŒåŠŸèƒ½å¼ºå¤§çš„å¼€æºä»ªè¡¨æ¿Grafanaé›†æˆï¼Œå¯è‡ªå®šä¹‰dashboardæ»¡è¶³å„ç§å®šåˆ¶åŒ–éœ€æ±‚ èšåˆå’Œå‘Šè­¦: Prometheuså¯ä»¥æŸ¥è¯¢å’Œèšåˆæ—¶é—´åºåˆ—æ•°æ®ï¼Œå¹¶åˆ›å»ºè§„åˆ™æ¥è®°å½•å¸¸ç”¨çš„æŸ¥è¯¢å’Œèšåˆã€‚è¿˜å¯ä»¥å®šä¹‰è­¦æŠ¥è§„åˆ™ï¼Œæ»¡è¶³æ¡ä»¶æ—¶è§¦å‘è­¦æŠ¥ï¼Œå¹¶æ¨é€åˆ°AlertmanageræœåŠ¡ã€‚Alertmanagræ”¯æŒé«˜å¯ç”¨çš„é›†ç¾¤éƒ¨ç½²ï¼Œè´Ÿè´£ç®¡ç†ã€æ•´åˆå’Œåˆ†å‘è­¦æŠ¥åˆ°ä¸é€šç›®çš„åœ°ï¼Œå¹¶èƒ½åšåˆ°å‘Šè­¦æ”¶æ•› æ•°æ®æ¨¡å‹ # Prometheusä½¿ç”¨ä¸€ä¸ªå¤šç»´æ—¶é—´åºåˆ—æ•°æ®æ¨¡å‹ï¼Œç»“åˆäº†æ—¶é—´åºåˆ—åç§°å’Œç§°ä¸ºæ ‡ç­¾(label)çš„é”®/å€¼å¯¹ï¼Œè¿™äº›æ ‡ç­¾æä¾›äº†ç»´åº¦ã€‚æ¯ä¸ªæ—¶é—´åºåˆ—ç”±æ—¶é—´åºåˆ—åç§°å’Œæ ‡ç­¾çš„ç»„åˆå”¯ä¸€æ ‡è¯†ã€‚ \u0026lt;time series name\u0026gt; {\u0026lt;label name\u0026gt;=\u0026lt;label value\u0026gt;,...}\nmachine_cpu_cores{beta_kubernetes_io_arch=\u0026ldquo;amd64\u0026rdquo;,beta_kubernetes_io_os=\u0026ldquo;linux\u0026rdquo;,instance=\u0026ldquo;192.168.1.51\u0026rdquo;,job=\u0026ldquo;kubernetes-cadvisor\u0026rdquo;,kubernetes_io_arch=\u0026ldquo;amd64\u0026rdquo;,kubernetes_io_hostname=\u0026ldquo;192.168.1.51\u0026rdquo;,kubernetes_io_os=\u0026ldquo;linux\u0026rdquo;} 2 machine_cpu_coresæ”¶é›†çš„æ˜¯ä¸»æœºçš„cpuæ ¸æ•°ï¼Œtaget labelæ ‡è¯†äº†æ˜¯job kubernetes-cadvisoræŠ“å–çš„ï¼Œinstance 192.","title":"é«˜å¯ç”¨prometheusç›‘æ§é›†ç¾¤æ­å»º(ä¸€)"},{"content":"","date":"23 August 2019","permalink":"/tags/flannel/","section":"Tags","summary":"","title":"flannel"},{"content":"","date":"23 August 2019","permalink":"/series/k8s1.14.6%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","section":"Series","summary":"","title":"k8s1.14.6é›†ç¾¤éƒ¨ç½²"},{"content":"1.Daemonsetæ–¹å¼ # $ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml $ cat kube-flannel.yml apiVersion: extensions/v1beta1 kind: PodSecurityPolicy metadata: name: psp.flannel.unprivileged annotations: seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default spec: privileged: false volumes: - configMap - secret - emptyDir - hostPath allowedHostPaths: - pathPrefix: \u0026#34;/etc/cni/net.d\u0026#34; - pathPrefix: \u0026#34;/etc/kube-flannel\u0026#34; - pathPrefix: \u0026#34;/run/flannel\u0026#34; readOnlyRootFilesystem: false # Users and groups runAsUser: rule: RunAsAny supplementalGroups: rule: RunAsAny fsGroup: rule: RunAsAny # Privilege Escalation allowPrivilegeEscalation: false defaultAllowPrivilegeEscalation: false # Capabilities allowedCapabilities: [\u0026#39;NET_ADMIN\u0026#39;] defaultAddCapabilities: [] requiredDropCapabilities: [] # Host namespaces hostPID: false hostIPC: false hostNetwork: true hostPorts: - min: 0 max: 65535 # SELinux seLinux: # SELinux is unsed in CaaSP rule: \u0026#39;RunAsAny\u0026#39; --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: flannel rules: - apiGroups: [\u0026#39;extensions\u0026#39;] resources: [\u0026#39;podsecuritypolicies\u0026#39;] verbs: [\u0026#39;use\u0026#39;] resourceNames: [\u0026#39;psp.flannel.unprivileged\u0026#39;] - apiGroups: - \u0026#34;\u0026#34; resources: - pods verbs: - get - apiGroups: - \u0026#34;\u0026#34; resources: - nodes verbs: - list - watch - apiGroups: - \u0026#34;\u0026#34; resources: - nodes/status verbs: - patch --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: flannel roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: flannel subjects: - kind: ServiceAccount name: flannel namespace: kube-system --- apiVersion: v1 kind: ServiceAccount metadata: name: flannel namespace: kube-system --- kind: ConfigMap apiVersion: v1 metadata: name: kube-flannel-cfg namespace: kube-system labels: tier: node app: flannel data: cni-conf.json: | { \u0026#34;name\u0026#34;: \u0026#34;cbr0\u0026#34;, \u0026#34;plugins\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;flannel\u0026#34;, \u0026#34;delegate\u0026#34;: { \u0026#34;hairpinMode\u0026#34;: true, \u0026#34;isDefaultGateway\u0026#34;: true } }, { \u0026#34;type\u0026#34;: \u0026#34;portmap\u0026#34;, \u0026#34;capabilities\u0026#34;: { \u0026#34;portMappings\u0026#34;: true } } ] } net-conf.json: | { \u0026#34;Network\u0026#34;: \u0026#34;10.244.0.0/16\u0026#34;, \u0026#34;Backend\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;vxlan\u0026#34; } } --- apiVersion: extensions/v1beta1 kind: DaemonSet metadata: name: kube-flannel-ds-amd64 namespace: kube-system labels: tier: node app: flannel spec: template: metadata: labels: tier: node app: flannel spec: hostNetwork: true nodeSelector: beta.kubernetes.io/arch: amd64 tolerations: - operator: Exists effect: NoSchedule serviceAccountName: flannel initContainers: - name: install-cni image: quay.io/coreos/flannel:v0.11.0-amd64 command: - cp args: - -f - /etc/kube-flannel/cni-conf.json - /etc/cni/net.d/10-flannel.conflist volumeMounts: - name: cni mountPath: /etc/cni/net.d - name: flannel-cfg mountPath: /etc/kube-flannel/ containers: - name: kube-flannel image: quay.io/coreos/flannel:v0.11.0-amd64 command: - /opt/bin/flanneld args: - --ip-masq - --kube-subnet-mgr resources: requests: cpu: \u0026#34;100m\u0026#34; memory: \u0026#34;50Mi\u0026#34; limits: cpu: \u0026#34;100m\u0026#34; memory: \u0026#34;50Mi\u0026#34; securityContext: privileged: false capabilities: add: [\u0026#34;NET_ADMIN\u0026#34;] env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace volumeMounts: - name: run mountPath: /run/flannel - name: flannel-cfg mountPath: /etc/kube-flannel/ volumes: - name: run hostPath: path: /run/flannel - name: cni hostPath: path: /etc/cni/net.d - name: flannel-cfg configMap: name: kube-flannel-cfg 2. é™æ€Podæ–¹å¼ # 2.1 masterèŠ‚ç‚¹ä¸Šåˆ›å»ºflannel ç›¸å…³çš„CRD\na) flannel pod çš„PodSecurityPolicyï¼Œå®šä¹‰èµ„æºè®¿é—®åŠé…ç½®é™åˆ¶ b) è®¿é—®apiserverçš„ServiceAccount, ClusterRole, ClusterRoleBinding\n$ kubectl apply -f kube-flannel-CRD.yaml $ cat kube-flannel-CRD.yaml apiVersion: extensions/v1beta1 kind: PodSecurityPolicy metadata: name: psp.flannel.unprivileged annotations: seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default spec: privileged: false volumes: - configMap - secret - emptyDir - hostPath allowedHostPaths: - pathPrefix: \u0026#34;/etc/cni/net.d\u0026#34; - pathPrefix: \u0026#34;/etc/kube-flannel\u0026#34; - pathPrefix: \u0026#34;/run/flannel\u0026#34; readOnlyRootFilesystem: false # Users and groups runAsUser: rule: RunAsAny supplementalGroups: rule: RunAsAny fsGroup: rule: RunAsAny # Privilege Escalation allowPrivilegeEscalation: false defaultAllowPrivilegeEscalation: false # Capabilities allowedCapabilities: [\u0026#39;NET_ADMIN\u0026#39;] defaultAddCapabilities: [] requiredDropCapabilities: [] # Host namespaces hostPID: false hostIPC: false hostNetwork: true hostPorts: - min: 0 max: 65535 # SELinux seLinux: # SELinux is unsed in CaaSP rule: \u0026#39;RunAsAny\u0026#39; --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: flannel rules: - apiGroups: [\u0026#39;extensions\u0026#39;] resources: [\u0026#39;podsecuritypolicies\u0026#39;] verbs: [\u0026#39;use\u0026#39;] resourceNames: [\u0026#39;psp.flannel.unprivileged\u0026#39;] - apiGroups: - \u0026#34;\u0026#34; resources: - pods verbs: - get - apiGroups: - \u0026#34;\u0026#34; resources: - nodes verbs: - list - watch - apiGroups: - \u0026#34;\u0026#34; resources: - nodes/status verbs: - patch --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: flannel roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: flannel subjects: - kind: ServiceAccount name: flannel namespace: kube-system --- apiVersion: v1 kind: ServiceAccount metadata: name: flannel namespace: kube-system 2.2 masterèŠ‚ç‚¹ä¸Šåˆ›å»ºflannelè®¿é—®apiserverçš„kubeconfig\nServiceAccount flannelå£°æ˜åï¼Œè‡ªåŠ¨åˆ›å»ºsecretå¯¹è±¡ï¼Œå¯è·å–secretä¸­çš„tokenï¼Œç”¨äºflannel pod è®¿é—®apiserver $ cat create-flannel-kubeconfig.sh SECRET=$(kubectl get sa flannel -n kube-system -o jsonpath=\u0026#39;{.secrets[].name}\u0026#39;) TOKEN=$(kubectl get secret $SECRET -n kube-system -o jsonpath=\u0026#39;{.data.token}\u0026#39;|base64 -d) KUBE_APISERVER=\u0026#34;https://192.168.18.142:6443\u0026#34; kubectl config set-cluster kubernetes \\ --certificate-authority=/root/k8s-1.14.6/ssl/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=flannel.kubeconfig kubectl config set-credentials flannel@kubernetes \\ --token=$TOKEN \\ --kubeconfig=flannel.kubeconfig kubectl config set-context flannel@kubernetes \\ --cluster=kubernetes \\ --user=flannel@kubernetes \\ --kubeconfig=flannel.kubeconfig kubectl config use-context flannel@kubernetes --kubeconfig=flannel.kubeconfig $ sh create-flannel-kubeconfig.sh å°†ç”Ÿæˆçš„flannel.kubeconfigæ–‡ä»¶åˆ†å‘åˆ°nodeèŠ‚ç‚¹192.168.18.160çš„/root/k8s-1.14.6/conf/flannelç›®å½•ä¸‹ 2.3 è®¡ç®—èŠ‚ç‚¹192.168.18.160ä¸Šåˆ›å»ºflannel cniæ’ä»¶çš„é…ç½®æ–‡ä»¶\n$ cd /root/k8s-1.14.6/conf/flannel $ cat \u0026lt;\u0026lt;EOF \u0026gt; net-conf.json { \u0026#34;Network\u0026#34;: \u0026#34;10.244.0.0/16\u0026#34;, \u0026#34;Backend\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;vxlan\u0026#34; } } EOF $ cp /etc/cni/net.d/10-flannel.conflist cni-conf.json 2.4 è®¡ç®—èŠ‚ç‚¹192.168.18.160ä¸Šåˆ›å»ºkube-flannelçš„é™æ€podæ–‡ä»¶kube-flannel-pod.yaml\napiVersion: v1 kind: Pod metadata: labels: tier: node app: flannel name: kube-flannel namespace: kube-system spec: hostNetwork: true restartPolicy: Always containers: - name: kube-flannel image: quay.io/coreos/flannel:v0.11.0-amd64 command: - /opt/bin/flanneld args: - --ip-masq - --kube-subnet-mgr - --kubeconfig-file=/etc/kube-flannel/flannel.kubeconfig resources: requests: cpu: \u0026#34;100m\u0026#34; memory: \u0026#34;50Mi\u0026#34; limits: cpu: \u0026#34;100m\u0026#34; memory: \u0026#34;50Mi\u0026#34; securityContext: privileged: false capabilities: add: [\u0026#34;NET_ADMIN\u0026#34;] env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace volumeMounts: - name: run mountPath: /run/flannel - name: cni mountPath: /etc/kube-flannel/ volumes: - name: run hostPath: path: /run/flannel - name: cni hostPath: path: /root/k8s-1.14.6/conf/flannel 2.5 æŸ¥çœ‹kube-flannelæ˜¯å¦æ­£å¸¸å¯åŠ¨\n$ docker ps bbc6831c81f9 ff281650a721 \u0026#34;/opt/bin/flanneld -â€¦\u0026#34; 16 seconds ago Up 15 seconds k8s_kube-flannel_kube-flannel-192.168.18.160_kube-system_b61385e9f07935caba0db5f9c2eb1a9e_1 f66c5be28bb1 k8s.gcr.io/pause:3.1 \u0026#34;/pause\u0026#34; 16 seconds ago Up 15 seconds k8s_POD_kube-flannel-192.168.18.160_kube-system_b61385e9f07935caba0db5f9c2eb1a9e_1 $ docker logs bbc6831c81f9 I1021 07:41:51.567961 1 main.go:514] Determining IP address of default interface I1021 07:41:51.568823 1 main.go:527] Using interface with name eth0 and address 29.20.18.160 I1021 07:41:51.568846 1 main.go:544] Defaulting external address to interface address (29.20.18.160) I1021 07:41:51.671121 1 kube.go:126] Waiting 10m0s for node controller to sync I1021 07:41:51.671194 1 kube.go:309] Starting kube subnet manager I1021 07:41:52.671328 1 kube.go:133] Node controller sync successful I1021 07:41:52.671376 1 main.go:244] Created subnet manager: Kubernetes Subnet Manager - 29.20.18.160 I1021 07:41:52.671382 1 main.go:247] Installing signal handlers I1021 07:41:52.671450 1 main.go:386] Found network config - Backend type: vxlan I1021 07:41:52.671505 1 vxlan.go:120] VXLAN config: VNI=1 Port=0 GBP=false DirectRouting=false I1021 07:41:52.673135 1 main.go:317] Wrote subnet file to /run/flannel/subnet.env I1021 07:41:52.673149 1 main.go:321] Running backend. I1021 07:41:52.673157 1 main.go:339] Waiting for all goroutines to exit I1021 07:41:52.673186 1 vxlan_network.go:60] watching for new subnet leases $ ifconfig flannel.1 flannel.1: flags=4163\u0026lt;UP,BROADCAST,RUNNING,MULTICAST\u0026gt; mtu 1400 inet 10.244.4.0 netmask 255.255.255.255 broadcast 0.0.0.0 inet6 fe80::74b1:a2ff:fefd:1e3d prefixlen 64 scopeid 0x20\u0026lt;link\u0026gt; ether 76:b1:a2:fd:1e:3d txqueuelen 0 (Ethernet) RX packets 397 bytes 50538 (49.3 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 403 bytes 55506 (54.2 KiB) TX errors 0 dropped 10 overruns 0 carrier 0 collisions 0 ","date":"23 August 2019","permalink":"/2019/08/k8s1.14.6-flannel/","section":"åšå®¢","summary":"\u003ch4 class=\"relative group\"\u003e1.Daemonsetæ–¹å¼ \n    \u003cdiv id=\"1daemonsetæ–¹å¼\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#1daemonset%e6%96%b9%e5%bc%8f\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e","title":"k8s1.14.6é›†ç¾¤æ­å»ºä¹‹kube-flanneléƒ¨ç½²"},{"content":" kube-proxyç»„ä»¶çš„éƒ¨ç½²ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨Daemonsetçš„æ–¹å¼æˆ–è€…StaticPodçš„æ–¹å¼\nDaemonsetæ–¹å¼ä¿è¯åœ¨åŠ å…¥é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œkube-proxy Pod\nStaticPodæ˜¯ç”±kubectlè¿›è¡Œç®¡ç†çš„è¿è¡Œåœ¨è¯¥Nodeä¸Šçš„Podï¼Œä¸èƒ½é€šè¿‡apiserverè¿›è¡Œç®¡ç†\n1. Daemonsetæ–¹å¼ # åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºkube-proxyçš„CRD\n$ cd /root/k8s-1.14.6/manifests $ kubeclt apply -f kube-proxy.yaml $ cat kube-proxy.yaml kind: ConfigMap apiVersion: v1 metadata: labels: app: kube-proxy name: kube-proxy namespace: kube-system data: config.conf: |- apiVersion: kubeproxy.config.k8s.io/v1alpha1 bindAddress: 0.0.0.0 clientConnection: acceptContentTypes: \u0026#34;\u0026#34; burst: 10 contentType: application/vnd.kubernetes.protobuf kubeconfig: /var/lib/kube-proxy/kubeconfig.conf qps: 5 clusterCIDR: 10.244.0.0/16 configSyncPeriod: 15m0s conntrack: max: null maxPerCore: 32768 min: 131072 tcpCloseWaitTimeout: 1h0m0s tcpEstablishedTimeout: 24h0m0s enableProfiling: false healthzBindAddress: 0.0.0.0:10256 hostnameOverride: \u0026#34;\u0026#34; iptables: masqueradeAll: false masqueradeBit: 14 minSyncPeriod: 0s syncPeriod: 30s ipvs: excludeCIDRs: null minSyncPeriod: 0s scheduler: \u0026#34;\u0026#34; strictARP: false syncPeriod: 30s kind: KubeProxyConfiguration metricsBindAddress: 127.0.0.1:10249 mode: \u0026#34;\u0026#34; nodePortAddresses: null oomScoreAdj: -999 portRange: \u0026#34;\u0026#34; resourceContainer: /kube-proxy udpIdleTimeout: 250ms winkernel: enableDSR: false networkName: \u0026#34;\u0026#34; sourceVip: \u0026#34;\u0026#34; kubeconfig.conf: |- apiVersion: v1 kind: Config clusters: - cluster: certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt server: https://192.168.18.142:6443 name: default contexts: - context: cluster: default namespace: default user: default name: default current-context: default users: - name: default user: tokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: kube-proxy:node-proxier roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:node-proxier subjects: - kind: ServiceAccount name: kube-proxy namespace: kube-system --- apiVersion: v1 kind: ServiceAccount metadata: name: kube-proxy namespace: kube-system --- apiVersion: extensions/v1beta1 kind: DaemonSet metadata: labels: k8s-app: kube-proxy name: kube-proxy namespace: kube-system spec: template: metadata: labels: k8s-app: kube-proxy spec: containers: - command: - /usr/local/bin/kube-proxy - --config=/var/lib/kube-proxy/config.conf - --hostname-override=$(NODE_NAME) env: - name: NODE_NAME valueFrom: fieldRef: apiVersion: v1 fieldPath: spec.nodeName image: k8s.gcr.io/kube-proxy:v1.14.6 name: kube-proxy securityContext: privileged: true volumeMounts: - mountPath: /var/lib/kube-proxy name: kube-proxy - mountPath: /run/xtables.lock name: xtables-lock - mountPath: /lib/modules name: lib-modules readOnly: true hostNetwork: true priorityClassName: system-node-critical serviceAccount: kube-proxy serviceAccountName: kube-proxy tolerations: - key: CriticalAddonsOnly operator: Exists - operator: Exists volumes: - configMap: defaultMode: 420 name: kube-proxy name: kube-proxy - hostPath: path: /run/xtables.lock type: FileOrCreate name: xtables-lock - hostPath: path: /lib/modules name: lib-modules updateStrategy: rollingUpdate: maxUnavailable: 1 type: RollingUpdate 2. é™æ€Podçš„æ–¹å¼ # 2.1 masterèŠ‚ç‚¹ä¸Šç­¾å‘kube-proxyçš„è®¤è¯è¯ä¹¦\n$ cd /root/k8s-1.14.6/ssl $ cat \u0026lt;\u0026lt;EOF \u0026gt; apiserver-kube-proxy-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;system:kube-proxy\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34; } ] } EOF $ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes apiserver-kube-proxy-csr.json |cfssljson -bare apiserver-kube-proxy CNæŒ‡å®šè¯¥è¯ä¹¦çš„Userä¸ºsystem:kube-proxyï¼Œkube-apiserver é¢„å®šä¹‰çš„ ClusterRoleBinding system:node-proxier å°†User system:kube-proxy ä¸ ClusterRole stem:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™\n$ kubectl get clusterrolebinding system:node-proxier -o yaml apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: annotations: rbac.authorization.kubernetes.io/autoupdate: \u0026#34;true\u0026#34; creationTimestamp: \u0026#34;2019-07-09T05:58:48Z\u0026#34; labels: kubernetes.io/bootstrapping: rbac-defaults name: system:node-proxier resourceVersion: \u0026#34;98\u0026#34; selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Anode-proxier uid: e3e61976-d2c6-11e9-9f22-fa163e67ff45 roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:node-proxier subjects: - apiGroup: rbac.authorization.k8s.io kind: User name: system:kube-proxy 2.2 ç”Ÿæˆkube-proxyè®¿é—®apiserverçš„kubeconfig\n$ cat create-kube-proxy-kubeconfig.sh KUBE_APISERVER=\u0026#34;https://192.168.18.142:6443\u0026#34; kubectl config set-cluster kubernetes \\ --certificate-authority=/root/k8s-1.14.6/ssl/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=kube-proxy.kubeconfig kubectl config set-credentials default \\ --client-certificate=/root/k8s-1.14.6/ssl/apiserver-kube-proxy.pem \\ --client-key=/root/k8s-1.14.6/ssl/apiserver-kube-proxy-key.pem \\ --embed-certs=true \\ --kubeconfig=kube-proxy.kubeconfig kubectl config set-context default \\ --cluster=kubernetes \\ --user=default \\ --kubeconfig=kube-proxy.kubeconfig kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig $ sh create-kube-proxy-kubeconfig.sh å°†ç”Ÿæˆçš„kube-proxy.kubeconfigæ–‡ä»¶åˆ†å‘åˆ°nodeèŠ‚ç‚¹192.168.18.160çš„/root/k8s-1.14.6/conf/kube-proxyç›®å½•ä¸‹\n2.3 nodeèŠ‚ç‚¹ä¸Šåˆ›å»ºkube-proxçš„yé…ç½®æ–‡ä»¶config.conf\n$ cd /root/k8s-1.14.6/conf/kube-proxy $ ls config.conf kube-proxy.kubeconfig $ cat config.conf apiVersion: kubeproxy.config.k8s.io/v1alpha1 bindAddress: 0.0.0.0 clientConnection: acceptContentTypes: \u0026#34;\u0026#34; burst: 10 contentType: application/vnd.kubernetes.protobuf kubeconfig: /var/lib/kube-proxy/kube-proxy.kubeconfig qps: 5 clusterCIDR: 10.244.0.0/16 configSyncPeriod: 15m0s conntrack: max: null maxPerCore: 32768 min: 131072 tcpCloseWaitTimeout: 1h0m0s tcpEstablishedTimeout: 24h0m0s enableProfiling: false healthzBindAddress: 0.0.0.0:10256 hostnameOverride: \u0026#34;\u0026#34; iptables: masqueradeAll: false masqueradeBit: 14 minSyncPeriod: 0s syncPeriod: 30s ipvs: excludeCIDRs: null minSyncPeriod: 0s scheduler: \u0026#34;\u0026#34; strictARP: false syncPeriod: 30s kind: KubeProxyConfiguration metricsBindAddress: 127.0.0.1:10249 mode: \u0026#34;\u0026#34; nodePortAddresses: null oomScoreAdj: -999 portRange: \u0026#34;\u0026#34; resourceContainer: /kube-proxy udpIdleTimeout: 250ms winkernel: enableDSR: false networkName: \u0026#34;\u0026#34; sourceVip: \u0026#34;\u0026#34; 2.4 è®¡ç®—èŠ‚ç‚¹ä¸Šåˆ›å»ºkube-proxyçš„é™æ€podæ–‡ä»¶kube-proxy-pod.yaml\n$ cd /root/k8s-1.14.6/manifests apiVersion: v1 kind: Pod metadata: labels: tier: node k8s-app: kube-proxy name: kube-proxy namespace: kube-system spec: containers: - command: - /usr/local/bin/kube-proxy - --config=/var/lib/kube-proxy/config.conf - --hostname-override=$(NODE_NAME) env: - name: NODE_NAME valueFrom: fieldRef: apiVersion: v1 fieldPath: spec.nodeName image: k8s.gcr.io/kube-proxy:v1.14.6 name: kube-proxy securityContext: privileged: true volumeMounts: - mountPath: /var/lib/kube-proxy name: kube-proxy - mountPath: /run/xtables.lock name: xtables-lock - mountPath: /lib/modules name: lib-modules readOnly: true hostNetwork: true restartPolicy: Always priorityClassName: system-node-critical volumes: - hostPath: path: /root/k8s-1.14.6/conf/kube-proxy name: kube-proxy name: kube-proxy - hostPath: path: /run/xtables.lock type: FileOrCreate name: xtables-lock - hostPath: path: /lib/modules name: lib-modules 2.5 æŸ¥çœ‹kube-proxyæ˜¯å¦æ­£å¸¸å¯åŠ¨\n$ docker ps 88f7d447327e ed8adf767eeb \u0026#34;/usr/local/bin/kubeâ€¦\u0026#34; 3 minutes ago Up 3 minutes k8s_kube-proxy_kube-proxy-192.168.18.160_kube-system_6a4b4c4a6b6e6cb8c0c89cb8edd2d00c_1 2f0be7471cb1 k8s.gcr.io/pause:3.1 \u0026#34;/pause\u0026#34; 3 minutes ago Up 3 minutes k8s_POD_kube-proxy-192.168.18.160_kube-system_6a4b4c4a6b6e6cb8c0c89cb8edd2d00c_1 $ docker logs 88f7d447327e W1021 06:17:23.534438 1 proxier.go:498] Failed to load kernel module ip_vs with modprobe. You can ignore this message when kube-proxy is running inside container without mounting /lib/modules W1021 06:17:23.535741 1 proxier.go:498] Failed to load kernel module ip_vs_rr with modprobe. You can ignore this message when kube-proxy is running inside container without mounting /lib/modules W1021 06:17:23.536945 1 proxier.go:498] Failed to load kernel module ip_vs_wrr with modprobe. You can ignore this message when kube-proxy is running inside container without mounting /lib/modules W1021 06:17:23.538102 1 proxier.go:498] Failed to load kernel module ip_vs_sh with modprobe. You can ignore this message when kube-proxy is running inside container without mounting /lib/modules W1021 06:17:23.543687 1 server_others.go:267] Flag proxy-mode=\u0026#34;\u0026#34; unknown, assuming iptables proxy I1021 06:17:23.553870 1 server_others.go:146] Using iptables Proxier. I1021 06:17:23.554171 1 server.go:562] Version: v1.14.6 I1021 06:17:23.565879 1 conntrack.go:52] Setting nf_conntrack_max to 131072 I1021 06:17:23.566114 1 config.go:202] Starting service config controller I1021 06:17:23.566145 1 controller_utils.go:1027] Waiting for caches to sync for service config controller I1021 06:17:23.566146 1 config.go:102] Starting endpoints config controller I1021 06:17:23.566178 1 controller_utils.go:1027] Waiting for caches to sync for endpoints config controller I1021 06:17:23.666289 1 controller_utils.go:1034] Caches are synced for service config controller I1021 06:17:23.666289 1 controller_utils.go:1034] Caches are synced for endpoints config controller ","date":"23 August 2019","permalink":"/2019/08/k8s1.14.6-kube-proxy/","section":"åšå®¢","summary":"kube-proxyç»„ä»¶çš„éƒ¨ç½²ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨Daemonsetçš„æ–¹å¼æˆ–è€…StaticPodçš„æ–¹å¼\nDaemonsetæ–¹å¼ä¿è¯åœ¨åŠ å…¥é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œkube-proxy Pod\nStaticPodæ˜¯ç”±kubectlè¿›è¡Œç®¡ç†çš„è¿è¡Œåœ¨è¯¥Nodeä¸Šçš„Podï¼Œä¸èƒ½é€šè¿‡apiserverè¿›è¡Œç®¡ç†\n1. Daemonsetæ–¹å¼ # åœ¨masterèŠ‚ç‚¹ä¸Šåˆ›å»ºkube-proxyçš„CRD\n$ cd /root/k8s-1.14.6/manifests $ kubeclt apply -f kube-proxy.yaml $ cat kube-proxy.yaml kind: ConfigMap apiVersion: v1 metadata: labels: app: kube-proxy name: kube-proxy namespace: kube-system data: config.","title":"k8s1.14.6é›†ç¾¤æ­å»ºä¹‹kube-proxyéƒ¨ç½²"},{"content":"å‰è¨€ # åœ¨éƒ¨ç½²k8s nodeèŠ‚ç‚¹æ—¶ï¼Œkubeletè¦ä¸apiserveräº¤äº’ï¼Œåœ¨åŒæ–¹æ²¡æœ‰äº’ä¿¡çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•é€šè¿‡masterçš„è®¤è¯é‰´æƒï¼Ÿkubelet bootstrapå°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œæœ¬æ–‡ä½¿ç”¨Bootstrap Token Authenticationçš„è®¤è¯æ–¹å¼ï¼Œä½¿å¾—kubeleté€šè¿‡apiserverçš„è®¤è¯ã€è·å–apiserverçš„CAè¯ä¹¦ï¼Œå¹¶æˆåŠŸæ³¨å†Œåˆ°é›†ç¾¤ä¸­\n1. åˆ›å»ºkubelet bootstrapçš„kubeconfig # 1.1 masterèŠ‚ç‚¹192.168.18.142ä¸Šæ‰§è¡Œcreate-bootstrap-kubeconfig.shè„šæœ¬\nå…ˆåˆ›å»ºbootstrap-tokenï¼Œå†ç”Ÿæˆbootstrap.kubeconfigï¼Œå†åˆ›å»ºclusterrolebinding\n$ cat create-bootstrap-kubeconfig.sh KUBE_APISERVER=\u0026#34;https://192.168.18.142:6443\u0026#34; TOKEN_ID=$(openssl rand -hex 3) TOKEN_SECRET=$(openssl rand -hex 8) BOOTSTRAP_TOKEN=\u0026#34;${TOKEN_ID}.${TOKEN_SECRET}\u0026#34; AUTH_EXTRA_GROUPS=\u0026#34;system:bootstrappers:default-node-token\u0026#34; cat \u0026lt;\u0026lt;EOF | kubectl apply -f - apiVersion: v1 kind: Secret metadata: name: bootstrap-token-${TOKEN_ID} namespace: kube-system type: bootstrap.kubernetes.io/token stringData: description: \u0026#34;The bootstrap token for k8s.\u0026#34; token-id: ${TOKEN_ID} token-secret: ${TOKEN_SECRET} expiration: 2029-07-16T00:00:00Z usage-bootstrap-authentication: \u0026#34;true\u0026#34; usage-bootstrap-signing: \u0026#34;true\u0026#34; auth-extra-groups: ${AUTH_EXTRA_GROUPS} EOF kubectl config set-cluster kubernetes \\ --certificate-authority=/root/k8s-1.14.6/ssl/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=bootstrap.kubeconfig kubectl config set-credentials tls-bootstrap-token-user \\ --token ${BOOTSTRAP_TOKEN} \\ --kubeconfig=bootstrap.kubeconfig kubectl config set-context tls-bootstrap-token-user@kubernetes \\ --cluster kubernetes \\ --user tls-bootstrap-token-user \\ --kubeconfig=bootstrap.kubeconfig kubectl config use-context tls-bootstrap-token-user@kubernetes --kubeconfig=bootstrap.kubeconfig #å°†è‡ªå®šä¹‰çš„auth-extra-groupsç»‘å®šè§’è‰²system:node-bootstrapper kubectl create clusterrolebinding kubelet-bootstrap \\ --clusterrole system:node-bootstrapper \\ --group ${AUTH_EXTRA_GROUPS} #å°†è‡ªå®šä¹‰çš„auth-extra-groupsç»‘å®šè§’è‰²,å®ç°è‡ªåŠ¨ç­¾ç½²è¯ä¹¦è¯·æ±‚ kubectl create clusterrolebinding node-autoapprove-bootstrap \\ --clusterrole system:certificates.k8s.io:certificatesigningrequests:nodeclient \\ --group ${AUTH_EXTRA_GROUPS} #å°†system:nodeç»‘å®šè§’è‰²,å®ç°è‡ªåŠ¨åˆ·æ–°nodeèŠ‚ç‚¹è¿‡æœŸè¯ä¹¦ kubectl create clusterrolebinding node-autoapprove-certificate-rotation \\ --clusterrole system:certificates.k8s.io:certificatesigningrequests:selfnodeclient \\ --group system:node $ sh create-bootstrap-kubeconfig.sh tokençš„nameå¿…é¡»æ˜¯ bootstrap-token-\u0026lt;token-id\u0026gt; çš„æ ¼å¼ tokençš„typeå¿…é¡»æ˜¯ bootstrap.kubernetes.io/token tokençš„token-idå’Œtoken-secretåˆ†åˆ«æ˜¯6ä½å’Œ16ä½æ•°å­—å’Œå­—æ¯çš„ç»„åˆ auth-extra-groups å®šä¹‰äº†tokenä»£è¡¨çš„ç”¨æˆ·æ‰€å±çš„é¢å¤–çš„groupï¼Œè€Œé»˜è®¤groupåä¸ºsystem:bootstrappers è¿™ç§ç±»å‹tokenä»£è¡¨çš„ç”¨æˆ·åä¸º system:bootstrap:\u0026lt;token-id\u0026gt; expirationå­—æ®µå®šä¹‰tokençš„è¿‡æœŸæ—¶é—´ 1.2 å°†ç”Ÿæˆçš„bootstrap.kubeconfigåˆ†å‘åˆ°è®¡ç®—èŠ‚ç‚¹192.168.18.160ä¸Š\n$ scp bootstrap.kubeconfig 192.168.18.160:/root/k8s-1.14.6/kubelet/ 2. è®¡ç®—èŠ‚ç‚¹é…ç½®å¹¶å¯åŠ¨kubelet # $ swapoff -a $ sed -i \u0026#39;s/.*swap.*/#\u0026amp;/\u0026#39; /etc/fstab $ cat \u0026gt; /etc/sysctl.d/k8s.conf \u0026lt;\u0026lt;EOF net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF $ sysctl --system 2.1 åˆ›å»ºkubelet.service\n$ cat \u0026lt;\u0026lt;EOF \u0026gt; /usr/lib/systemd/system/kubelet.service [Unit] Description=kubelet: The Kubernetes Node Agent Documentation=https://kubernetes.io/docs/ [Service] Environment=\u0026#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/root/k8s-1.14.6/kubelet/bootstrap.kubeconfig --kubeconfig=/root/k8s-1.14.6/kubelet/kubelet.conf\u0026#34; Environment=\u0026#34;KUBELET_CONFIG_ARGS=--config=/root/k8s-1.14.6/kubelet/config.yaml\u0026#34; EnvironmentFile=-/etc/sysconfig/kubelet ExecStart=/root/k8s-1.14.6/bin/kubelet \\$KUBELET_KUBECONFIG_ARGS \\$KUBELET_CONFIG_ARGS \\$KUBELET_EXTRA_ARGS Restart=always StartLimitInterval=0 RestartSec=10 [Install]\tWantedBy=multi-user.target EOF /root/k8s-1.14.6/kubelet/kubelet.confæ˜¯kubelet.serviceå¯åŠ¨åç”Ÿæˆçš„kubeconfigæ–‡ä»¶ï¼Œç”¨äºè®¿é—®apiserver\n2.2 åˆ›å»ºkubeleté…ç½®æ–‡ä»¶config.yamlã€/etc/sysconfig/kubelet\n$ã€€cat config.yaml address: 0.0.0.0 apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: false webhook: cacheTTL: 2m0s enabled: true x509: clientCAFile: /root/k8s-1.14.6/ssl/ca.pem authorization: mode: Webhook webhook: cacheAuthorizedTTL: 5m0s cacheUnauthorizedTTL: 30s cgroupDriver: systemd cgroupsPerQOS: true clusterDNS: - 172.16.0.10 clusterDomain: cluster.local configMapAndSecretChangeDetectionStrategy: Watch containerLogMaxFiles: 5 containerLogMaxSize: 10Mi contentType: application/vnd.kubernetes.protobuf cpuCFSQuota: true cpuCFSQuotaPeriod: 100ms cpuManagerPolicy: none cpuManagerReconcilePeriod: 10s enableControllerAttachDetach: true enableDebuggingHandlers: true enforceNodeAllocatable: - pods eventBurst: 10 eventRecordQPS: 5 evictionHard: imagefs.available: 15% memory.available: 100Mi nodefs.available: 10% nodefs.inodesFree: 5% evictionPressureTransitionPeriod: 5m0s failSwapOn: true fileCheckFrequency: 20s hairpinMode: promiscuous-bridge healthzBindAddress: 127.0.0.1 healthzPort: 10248 httpCheckFrequency: 20s imageGCHighThresholdPercent: 85 imageGCLowThresholdPercent: 80 imageMinimumGCAge: 2m0s iptablesDropBit: 15 iptablesMasqueradeBit: 14 kind: KubeletConfiguration kubeAPIBurst: 10 kubeAPIQPS: 5 makeIPTablesUtilChains: true maxOpenFiles: 1000000 maxPods: 110 nodeLeaseDurationSeconds: 40 nodeStatusReportFrequency: 1m0s nodeStatusUpdateFrequency: 10s oomScoreAdj: -999 podPidsLimit: -1 port: 10250 registryBurst: 10 registryPullQPS: 5 resolvConf: /etc/resolv.conf rotateCertificates: true runtimeRequestTimeout: 2m0s serializeImagePulls: true staticPodPath: /root/k8s-1.14.6/manifests streamingConnectionIdleTimeout: 4h0m0s syncFrequency: 1m0s volumeStatsAggPeriod: 1m0s $ cat /etc/sysconfig/kubelet KUBELET_EXTRA_ARGS=\u0026#34;--hostname-override=192.168.18.160 --cert-dir=/root/k8s-1.14.6/kubelet/ssl --pod-infra-container-image=k8s.gcr.io/pause:3.1 --network-plugin=cni\u0026#34; 2.3 é…ç½®dockerçš„cgroupdriverä¸ºsystemd\n$ cat /etc/docker/daemon.json { \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], \u0026#34;insecure-registries\u0026#34;: [\u0026#34;0.0.0.0/0\u0026#34;], \u0026#34;hosts\u0026#34;: [\u0026#34;unix:///var/run/docker.sock\u0026#34;, \u0026#34;tcp://0.0.0.0:20008\u0026#34;], \u0026#34;graph\u0026#34;: \u0026#34;/data/docker\u0026#34;, \u0026#34;storage-driver\u0026#34;: \u0026#34;overlay2\u0026#34;, \u0026#34;storage-opts\u0026#34;: [ \u0026#34;overlay2.override_kernel_check=true\u0026#34; ], \u0026#34;userland-proxy\u0026#34;:false } 2.4 å®‰è£…cniç½‘ç»œæ’ä»¶\nkubeletå‚æ•°ä¸­\n--network-plugin=cniå¯ç”¨cniç½‘ç»œæ’ä»¶ --cni-conf-diræŒ‡å®šnetworkconfigç›®å½•ï¼Œé»˜è®¤è·¯å¾„æ˜¯:/etc/cni/net.d --cni-bin-diræŒ‡å®šæ’ä»¶å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•ï¼Œé»˜è®¤è·¯å¾„æ˜¯:/opt/cni/bin $ wget https://github.com/containernetworking/plugins/releases/download/v0.7.5/cni-plugins-amd64-v0.7.5.tgz $ mkdir -pv /opt/cni/bin $ tar xf cni-plugins-amd64-v0.7.5.tgz -C /opt/cni/bin $ ls -l /opt/cni/bin bridge dhcp flannel host-device host-local ipvlan loopback macvlan portmap ptp sample tuning vlan 2.5 åˆ›å»ºcnié…ç½®æ–‡ä»¶\næœ¬æ–‡çš„k8sé›†ç¾¤ä½¿ç”¨flannelç½‘ç»œæ’ä»¶ï¼Œä¿®æ”¹é…ç½®å¦‚ä¸‹:\n$ mkdir /etc/cni/net.d/ -pv $ cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/cni/net.d/10-flannel.conflist { \u0026#34;name\u0026#34;: \u0026#34;cbr0\u0026#34;, \u0026#34;plugins\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;flannel\u0026#34;, \u0026#34;delegate\u0026#34;: { \u0026#34;hairpinMode\u0026#34;: true, \u0026#34;isDefaultGateway\u0026#34;: true } }, { \u0026#34;type\u0026#34;: \u0026#34;portmap\u0026#34;, \u0026#34;capabilities\u0026#34;: { \u0026#34;portMappings\u0026#34;: true } } ] } EOF 2.6 å¯åŠ¨kubelet.service\n$ systemctl daemon-reload $ systemctl start kubelet.service ","date":"23 August 2019","permalink":"/2019/08/k8s1.14.6-node/","section":"åšå®¢","summary":"\u003ch4 class=\"relative group\"\u003eå‰è¨€ \n    \u003cdiv id=\"å‰è¨€\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e5%89%8d%e8%a8%80\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003eåœ¨éƒ¨ç½²k8s nodeèŠ‚ç‚¹æ—¶ï¼Œkubeletè¦ä¸apiserveräº¤äº’ï¼Œåœ¨åŒæ–¹æ²¡æœ‰äº’ä¿¡çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•é€šè¿‡masterçš„è®¤è¯é‰´æƒï¼Ÿkubelet bootstrapå°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œæœ¬æ–‡ä½¿ç”¨Bootstrap Token Authenticationçš„è®¤è¯æ–¹å¼ï¼Œä½¿å¾—kubeleté€šè¿‡apiserverçš„è®¤è¯ã€è·å–apiserverçš„CAè¯ä¹¦ï¼Œå¹¶æˆåŠŸæ³¨å†Œåˆ°é›†ç¾¤ä¸­\u003c/p\u003e\n\u003c/blockquote\u003e","title":"k8s1.14.6é›†ç¾¤æ­å»ºä¹‹nodeèŠ‚ç‚¹éƒ¨ç½²"},{"content":"","date":"22 August 2019","permalink":"/tags/etcd/","section":"Tags","summary":"","title":"etcd"},{"content":"1. åˆ›å»ºè‡ªç­¾åCAåŠç›¸å…³è¯ä¹¦ # 1.1 åˆ›å»ºè‡ªç­¾åCA(apiserverè®¿é—®ç›¸å…³)\n$ cd /root/k8s-1.14.6/ssl/ $ cat \u0026lt;\u0026lt;EOF \u0026gt; ca-config.json { \u0026#34;signing\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34; }, \u0026#34;profiles\u0026#34;: { \u0026#34;kubernetes\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34;, \u0026#34;usages\u0026#34;: [ \u0026#34;signing\u0026#34;, \u0026#34;key encipherment\u0026#34;, \u0026#34;server auth\u0026#34;, \u0026#34;client auth\u0026#34; ] } } } } EOF $ cat \u0026lt;\u0026lt;EOF \u0026gt; ca-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;kubernetes\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34; } ] } EOF $ gencert -initca ca-csr.json|cfssljson -bare ca 1.2 ç­¾åè¯ä¹¦apiserver.pemã€apiserver-kubelet-client.pem\n$ cat \u0026lt;\u0026lt;EOF \u0026gt; apiserver-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;kube-apiserver\u0026#34;, \u0026#34;hosts\u0026#34;: [ \u0026#34;172.16.0.1\u0026#34;, --\u0026gt; ä¸ºservice-cluster-ip-rangeå‚æ•°å€¼ \u0026#34;127.0.0.1\u0026#34;, \u0026#34;192.168.18.142\u0026#34;, --\u0026gt; masteré›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ip \u0026#34;kubernetes\u0026#34;, \u0026#34;kubernetes.default\u0026#34;, \u0026#34;kubernetes.default.svc\u0026#34;, \u0026#34;kubernetes.default.svc.cluster\u0026#34;, \u0026#34;kubernetes.default.svc.cluster.local\u0026#34; --\u0026gt; clusterDomain ], \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34; } ] } EOF $ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes apiserver-csr.json |cfssljson -bare apiserver $ cat \u0026lt;\u0026lt;EOF \u0026gt; apiserver-kubelet-client-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;kube-apiserver-kubelet-client\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;system:masters\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34; } ] } EOF $ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes apiserver-kubelet-client-csr.json |cfssljson -bare apiserver-kubelet-client 1.3 åˆ›å»ºfront-proxyè‡ªç­¾åCAï¼Œå¼€å¯k8s api aggregationè¦ç”¨\n$ cd /root/k8s-1.14.6/ssl/front-proxy $ cat \u0026lt;\u0026lt;EOF \u0026gt; ca-config.json { \u0026#34;signing\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34; }, \u0026#34;profiles\u0026#34;: { \u0026#34;kubernetes\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34;, \u0026#34;usages\u0026#34;: [ \u0026#34;signing\u0026#34;, \u0026#34;key encipherment\u0026#34;, \u0026#34;server auth\u0026#34;, \u0026#34;client auth\u0026#34; ] } } } } EOF $ cat \u0026lt;\u0026lt;EOF \u0026gt; ca-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;front-proxy-ca\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34; } ] } EOF $ cfssl gencert -initca ca-csr.json|cfssljson -bare ca 1.4 ç­¾åfront-proxyç›¸å…³è¯ä¹¦\n$ cat \u0026lt;\u0026lt;EOF \u0026gt; front-proxy-client-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;front-proxy-client\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34; } ] } EOF $ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes front-proxy-client-csr.json |cfssljson -bare front-proxy-client 1.5 åˆ›å»ºç”¨äºserver-accountè®¤è¯çš„å…¬é’¥ä¸ç§é’¥\n$ openssl genrsa -out sa.key 2048 $ openssl rsa -in sa.key -out sa.pub -pubout 2. éƒ¨ç½²apiserver # $ swapoff -a $ sed -i \u0026#39;s/.*swap.*/#\u0026amp;/\u0026#39; /etc/fstab $ cat \u0026gt; /etc/sysctl.d/k8s.conf \u0026lt;\u0026lt;EOF net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF $ sysctl --system 2.1 äºŒè¿›åˆ¶æ–¹å¼å¯åŠ¨ï¼Œç”±systemdæ‰˜ç®¡\n$ kube-apiserver \\ --logtostderr=false \\ --v=2 \\ --log-file=/root/k8s-1.14.6/logs/kube-apiserver.log \\ --advertise-address=192.168.18.142 \\ --allow-privileged=true \\ --authorization-mode=Node,RBAC \\ --client-ca-file=/root/k8s-1.14.6/ssl/ca.pem \\ --enable-admission-plugins=NodeRestriction \\ --enable-bootstrap-token-auth=true \\ --etcd-cafile=/root/k8s-1.14.6/ssl/etcd/ca.pem \\ --etcd-certfile=/root/k8s-1.14.6/ssl/etcd/apiserver-etcd-client.pem \\ --etcd-keyfile=/root/k8s-1.14.6/ssl/etcd/apiserver-etcd-client-key.pem \\ --etcd-servers=https://192.168.18.142:2379 \\ --insecure-port=0 \\ --kubelet-client-certificate=/root/k8s-1.14.6/ssl/apiserver-kubelet-client.pem \\ --kubelet-client-key=/root/k8s-1.14.6/ssl/apiserver-kubelet-client-key.pem \\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\ --proxy-client-cert-file=/root/k8s-1.14.6/ssl/front-proxy/front-proxy-client.pem \\ --proxy-client-key-file=/root/k8s-1.14.6/ssl/front-proxy/front-proxy-client-key.pem \\ --requestheader-allowed-names=front-proxy-client \\ --requestheader-client-ca-file=/root/k8s-1.14.6/ssl/front-proxy/ca.pem \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-username-headers=X-Remote-User \\ --secure-port=6443 \\ --service-account-key-file=/root/k8s-1.14.6/ssl/sa.pub \\ --service-cluster-ip-range=172.16.0.0/16 \\ --tls-cert-file=/root/k8s-1.14.6/ssl/apiserver.pem \\ --tls-private-key-file=/root/k8s-1.14.6/ssl/apiserver-key.pem 2.2 Staticpodæ–¹å¼\n2.2.1 MasterèŠ‚ç‚¹éƒ¨ç½²kubelet.service\n$ swapoff â€“a --\u0026gt; è¿˜è¦æ³¨é‡Š/etc/fstabä¸­çš„swapæŒ‚è½½ $ cat \u0026lt;\u0026lt;EOF \u0026gt; /usr/lib/systemd/system/kubelet.service [Unit] Description=kubelet: The Kubernetes Node Agent Documentation=https://kubernetes.io/docs/ [Service] Environment=\u0026#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/root/k8s-1.14.6/kubelet/bootstrap.kubeconfig --kubeconfig=/root/k8s-1.14.6/kubelet/kubelet.conf\u0026#34; Environment=\u0026#34;KUBELET_CONFIG_ARGS=--config=/root/k8s-1.14.6/kubelet/config.yaml\u0026#34; EnvironmentFile=-/etc/sysconfig/kubelet ExecStart=/root/k8s-1.14.6/bin/kubelet \\$KUBELET_KUBECONFIG_ARGS \\$KUBELET_CONFIG_ARGS \\$KUBELET_EXTRA_ARGS Restart=always StartLimitInterval=0 RestartSec=10 [Install]\tWantedBy=multi-user.target EOF 2.2.2 ç”Ÿæˆkubeletçš„kubeconfigæ–‡ä»¶kubelet.conf\n$ cat create-kubelet-kubeconfig.sh KUBE_APISERVER=\u0026#34;https://192.168.18.142:6443\u0026#34; --\u0026gt; é«˜å¯ç”¨masteré›†ç¾¤çš„HAæˆ–è€…F5åœ°å€ HOSTNAME=\u0026#34;192.168.18.142\u0026#34; --\u0026gt; å¯¹åº”masterèŠ‚ç‚¹IP kubectl config set-cluster kubernetes \\ --certificate-authority=/root/k8s-1.14.6/ssl/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=kubelet.conf kubectl config set-credentials system:node:${HOSTNAME} \\ --client-certificate=/root/k8s-1.14.6/ssl/apiserver-kubelet-client.pem \\ --client-key=/root/k8s-1.14.6/ssl/apiserver-kubelet-client-key.pem \\ --embed-certs=true \\ --kubeconfig=kubelet.conf kubectl config set-context system:node:${HOSTNAME}@kubernetes \\ --cluster=kubernetes \\ --user=system:node:${HOSTNAME} \\ --kubeconfig=kubelet.conf kubectl config use-context system:node:${HOSTNAME}@kubernetes --kubeconfig=kubelet.conf $ sh create-kubelet-kubeconfig.sh 2.2.3 åˆ›å»ºkubeleté…ç½®æ–‡ä»¶config.yamlä¸/etc/sysconfig/kubelet\n$ cat config.yaml address: 0.0.0.0 apiVersion: kubelet.config.k8s.io/v1beta1 authentication: anonymous: enabled: false webhook: cacheTTL: 2m0s enabled: true x509: clientCAFile: /root/k8s-1.14.6/ssl/ca.pem authorization: mode: Webhook webhook: cacheAuthorizedTTL: 5m0s cacheUnauthorizedTTL: 30s cgroupDriver: systemd --\u0026gt; é»˜è®¤ä¸ºcgroups cgroupsPerQOS: true clusterDNS: - 172.16.0.10 --\u0026gt; k8sé›†ç¾¤DNSæœåŠ¡çš„clusterIP clusterDomain: cluster.local --\u0026gt; k8sé›†ç¾¤DNSæœåŠ¡çš„domain configMapAndSecretChangeDetectionStrategy: Watch containerLogMaxFiles: 5 containerLogMaxSize: 10Mi contentType: application/vnd.kubernetes.protobuf cpuCFSQuota: true cpuCFSQuotaPeriod: 100ms cpuManagerPolicy: none cpuManagerReconcilePeriod: 10s enableControllerAttachDetach: true enableDebuggingHandlers: true enforceNodeAllocatable: - pods eventBurst: 10 eventRecordQPS: 5 evictionHard: imagefs.available: 15% memory.available: 100Mi nodefs.available: 10% nodefs.inodesFree: 5% evictionPressureTransitionPeriod: 5m0s failSwapOn: true fileCheckFrequency: 20s hairpinMode: promiscuous-bridge healthzBindAddress: 127.0.0.1 healthzPort: 10248 httpCheckFrequency: 20s imageGCHighThresholdPercent: 85 imageGCLowThresholdPercent: 80 imageMinimumGCAge: 2m0s iptablesDropBit: 15 iptablesMasqueradeBit: 14 kind: KubeletConfiguration kubeAPIBurst: 10 kubeAPIQPS: 5 makeIPTablesUtilChains: true maxOpenFiles: 1000000 maxPods: 110 nodeLeaseDurationSeconds: 40 nodeStatusReportFrequency: 1m0s nodeStatusUpdateFrequency: 10s oomScoreAdj: -999 podPidsLimit: -1 port: 10250 registryBurst: 10 registryPullQPS: 5 resolvConf: /etc/resolv.conf rotateCertificates: true runtimeRequestTimeout: 2m0s serializeImagePulls: true staticPodPath: /root/k8s-1.14.6/manifests --\u0026gt; kubetletè¯»å–é™æ€Podæ–‡ä»¶çš„è·¯å¾„ streamingConnectionIdleTimeout: 4h0m0s syncFrequency: 1m0s volumeStatsAggPeriod: 1m0s $ cat /etc/sysconfig/kubelet KUBELET_EXTRA_ARGS=\u0026#34;--hostname-override=192.168.18.142 --cert-dir=/root/k8s-1.14.6/kubelet/ssl --pod-infra-container-image=k8s.gcr.io/pause:3.1 --network-plugin=cni\u0026#34; 2.2.4 ä¿®æ”¹dockerçš„cgroupdriverä¸ºsystemd\n$ cat /etc/docker/daemon.json { \u0026#34;exec-opts\u0026#34;: [\u0026#34;native.cgroupdriver=systemd\u0026#34;], \u0026#34;insecure-registries\u0026#34;: [\u0026#34;0.0.0.0/0\u0026#34;], \u0026#34;hosts\u0026#34;: [\u0026#34;unix:///var/run/docker.sock\u0026#34;, \u0026#34;tcp://0.0.0.0:20008\u0026#34;], \u0026#34;graph\u0026#34;: \u0026#34;/data/docker\u0026#34;, \u0026#34;storage-driver\u0026#34;: \u0026#34;overlay2\u0026#34;, \u0026#34;storage-opts\u0026#34;: [ \u0026#34;overlay2.override_kernel_check=true\u0026#34; ], \u0026#34;tlsverify\u0026#34;: true, \u0026#34;tlscacert\u0026#34;: \u0026#34;/etc/docker/ca.pem\u0026#34;, \u0026#34;tlscert\u0026#34;: \u0026#34;/etc/docker/server-cert.pem\u0026#34;, \u0026#34;tlskey\u0026#34;: \u0026#34;/etc/docker/server-key.pem\u0026#34;, \u0026#34;userland-proxy\u0026#34;:false } 2.2.5 åˆ›å»ºcnié…ç½®æ–‡ä»¶\n$ mkdir /etc/cni/net.d/ -pv $ cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/cni/net.d/10-flannel.conflist { \u0026#34;name\u0026#34;: \u0026#34;cbr0\u0026#34;, \u0026#34;plugins\u0026#34;: [ { \u0026#34;type\u0026#34;: \u0026#34;flannel\u0026#34;, \u0026#34;delegate\u0026#34;: { \u0026#34;hairpinMode\u0026#34;: true, \u0026#34;isDefaultGateway\u0026#34;: true } }, { \u0026#34;type\u0026#34;: \u0026#34;portmap\u0026#34;, \u0026#34;capabilities\u0026#34;: { \u0026#34;portMappings\u0026#34;: true } } ] } EOF 2.2.6 åˆ›å»ºé™æ€podæ–‡ä»¶kube-apiserver-pod.yaml\n$ cd /root/k8s-1.14.6/manifests $ cat kube-apiserver-pod.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: component: kube-apiserver tier: control-plane name: kube-apiserver namespace: kube-system spec: containers: - command: - kube-apiserver - --logtostderr=false - --log-file=/var/log/kube-apiserver.log - --advertise-address=192.168.18.142 - --allow-privileged=true - --authorization-mode=Node,RBAC - --client-ca-file=/etc/kubernetes/pki/ca.pem - --enable-admission-plugins=NodeRestrictionc - --enable-bootstrap-token-auth=true - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.pem - --etcd-certfile=/etc/kubernetes/pki/etcd/apiserver-etcd-client.pem - --etcd-keyfile=/etc/kubernetes/pki/etcd/apiserver-etcd-client-key.pem - --etcd-servers=https://192.168.18.142:2379 --\u0026gt; etcdé›†ç¾¤é€—å·åˆ†éš” - --insecure-port=0 - --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.pem - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client-key.pem - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy/front-proxy-client.pem - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy/front-proxy-client-key.pem - --requestheader-allowed-names=front-proxy-client - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy/ca.pem - --requestheader-extra-headers-prefix=X-Remote-Extra- - --requestheader-group-headers=X-Remote-Group - --requestheader-username-headers=X-Remote-User - --secure-port=6443 - --service-account-key-file=/etc/kubernetes/pki/sa.pub - --service-cluster-ip-range=172.16.0.0/16 - --tls-cert-file=/etc/kubernetes/pki/apiserver.pem - --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem image: k8s.gcr.io/kube-apiserver:v1.14.6 imagePullPolicy: IfNotPresent livenessProbe: failureThreshold: 8 httpGet: host: 192.168.18.142 path: /healthz port: 6443 scheme: HTTPS initialDelaySeconds: 15 timeoutSeconds: 15 name: kube-apiserver resources: requests: cpu: 250m volumeMounts: - mountPath: /etc/ssl/certs name: ca-certs readOnly: true - mountPath: /etc/pki name: etc-pki readOnly: true - mountPath: /etc/kubernetes/pki name: k8s-certs readOnly: true - mountPath: /var/log name: logs hostNetwork: true priorityClassName: system-cluster-critical volumes: - hostPath: path: /etc/ssl/certs type: DirectoryOrCreate name: ca-certs - hostPath: path: /etc/pki type: DirectoryOrCreate name: etc-pki - hostPath: path: /root/k8s-1.14.6/ssl name: k8s-certs - hostPath: path: /root/k8s-1.14.6/logs name: logs status: {} 2.2.7 å¯åŠ¨kubelet.service\n$ systemctl start kubelet.service 3. é…ç½®kubectlè®¿é—®apiserver # $ cd /root/k8s-1.14.6/conf $ cat create-admin-kubeconfig.sh KUBE_APISERVER=\u0026#34;https://192.168.18.142:6443\u0026#34; kubectl config set-cluster kubernetes \\ --certificate-authority=/root/k8s-1.14.6/ssl/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=admin.conf kubectl config set-credentials kubernetes-admin \\ --client-certificate=/root/k8s-1.14.6/ssl/apiserver-kubelet-client.pem \\ --client-key=/root/k8s-1.14.6/ssl/apiserver-kubelet-client-key.pem \\ --embed-certs=true \\ --kubeconfig=admin.conf kubectl config set-context kubernetes-admin@kubernetes \\ --cluster=kubernetes \\ --user=kubernetes-admin \\ --kubeconfig=admin.conf kubectl config use-context kubernetes-admin@kubernetes --kubeconfig=admin.conf $ sh create-admin-kubeconfig.sh $ mv admin.conf /root/.kube/config $ kubectl get cs ","date":"22 August 2019","permalink":"/2019/08/k8s1.14.6-apiserver/","section":"åšå®¢","summary":"\u003ch4 class=\"relative group\"\u003e1. åˆ›å»ºè‡ªç­¾åCAåŠç›¸å…³è¯ä¹¦ \n    \u003cdiv id=\"1-åˆ›å»ºè‡ªç­¾åcaåŠç›¸å…³è¯ä¹¦\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#1-%e5%88%9b%e5%bb%ba%e8%87%aa%e7%ad%be%e5%90%8dca%e5%8f%8a%e7%9b%b8%e5%85%b3%e8%af%81%e4%b9%a6\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e\n\u003cp\u003e1.1 åˆ›å»ºè‡ªç­¾åCA(apiserverè®¿é—®ç›¸å…³)\u003c/p\u003e","title":"k8s1.14.6é›†ç¾¤æ­å»ºä¹‹apiserveréƒ¨ç½²"},{"content":"1. åˆ›å»ºkubeconfig # åˆ›å»ºcontroller-managerè®¿é—®apiserverçš„kubeconfig\n$ cd /root/k8s-1.14.6/conf $ cat create-controller-manager-kubeconfig.sh KUBE_APISERVER=\u0026#34;https://192.168.18.142:6443\u0026#34; kubectl config set-cluster kubernetes \\ --certificate-authority=/root/k8s-1.14.6/ssl/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=controller-manager.conf kubectl config set-credentials system:kube-controller-manager \\ --client-certificate=/root/k8s-1.14.6/ssl/apiserver-kubelet-client.pem \\ --client-key=/root/k8s-1.14.6/ssl/apiserver-kubelet-client-key.pem \\ --embed-certs=true \\ --kubeconfig=controller-manager.conf kubectl config set-context system:kube-controller-manager@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-controller-manager \\ --kubeconfig=controller-manager.conf kubectl config use-context system:kube-controller-manager@kubernetes --kubeconfig=controller-manager.conf $ sh create-controller-manager-kubeconfig.sh 2. éƒ¨ç½²controller-manager # 2.1 äºŒè¿›åˆ¶æ–¹å¼å¯åŠ¨\nkube-controller-manager \\ --logtostderr=false \\ --v=2 \\ --log-file=/root/k8s-1.14.6/logs/kube-controller.log \\ --allocate-node-cidrs=true \\ --authentication-kubeconfig=/root/k8s-1.14.6/conf/controller-manager.conf \\ --authorization-kubeconfig=/root/k8s-1.14.6/conf/controller-manager.conf \\ --bind-address=127.0.0.1 \\ --client-ca-file=/root/k8s-1.14.6/ssl/ca.pem \\ --cluster-cidr=10.244.0.0/16 \\ --\u0026gt; cniæ’ä»¶flannelçš„ipåŒºé—´ --cluster-signing-cert-file=/root/k8s-1.14.6/ssl/ca.pem \\ --cluster-signing-key-file=/root/k8s-1.14.6/ssl/ca-key.pem \\ --controllers=*,bootstrapsigner,tokencleaner \\ --kubeconfig=/root/k8s-1.14.6/conf/controller-manager.conf \\ --leader-elect=true \\ --node-cidr-mask-size=24 \\ --requestheader-client-ca-file=/root/k8s-1.14.6/ssl/front-proxy/ca.pem \\ --root-ca-file=/root/k8s-1.14.6/ssl/ca.pem \\ --service-account-private-key-file=/root/k8s-1.14.6/ssl/sa.key \\ --use-service-account-credentials=true é»˜è®¤ç›‘å¬10252ã€10257ç«¯å£\n2.2 StaticPodæ–¹å¼éƒ¨ç½²\nåˆ›å»ºé™æ€podæ–‡ä»¶kube-controller-manage-pod.yaml\n$ cd /root/k8s-1.14.6/manifests apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: component: kube-controller-manager tier: control-plane name: kube-controller-manager namespace: kube-system spec: containers: - command: - kube-controller-manager - --logtostderr=false - --v=2 - --log-file=/var/log/kube-controller.log - --allocate-node-cidrs=true - --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf - --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf - --bind-address=127.0.0.1 - --client-ca-file=/etc/kubernetes/pki/ca.pem - --cluster-cidr=10.244.0.0/16 --\u0026gt; cniæ’ä»¶flannelçš„ipåŒºé—´ - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem - --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem - --controllers=*,bootstrapsigner,tokencleaner - --kubeconfig=/etc/kubernetes/controller-manager.conf - --leader-elect=true - --node-cidr-mask-size=24 - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy/ca.pem - --root-ca-file=/etc/kubernetes/pki/ca.pem - --service-account-private-key-file=/etc/kubernetes/pki/sa.key - --use-service-account-credentials=true image: k8s.gcr.io/kube-controller-manager:v1.14.6 imagePullPolicy: IfNotPresent livenessProbe: failureThreshold: 8 httpGet: host: 127.0.0.1 path: /healthz port: 10252 scheme: HTTP initialDelaySeconds: 15 timeoutSeconds: 15 name: kube-controller-manager resources: requests: cpu: 200m volumeMounts: - mountPath: /etc/ssl/certs name: ca-certs readOnly: true - mountPath: /etc/pki name: etc-pki readOnly: true - mountPath: /usr/libexec/kubernetes/kubelet-plugins/volume/exec name: flexvolume-dir - mountPath: /etc/kubernetes/pki name: k8s-certs readOnly: true - mountPath: /etc/kubernetes/controller-manager.conf name: kubeconfig readOnly: true - mountPath: /var/log name: logs hostNetwork: true priorityClassName: system-cluster-critical volumes: - hostPath: path: /etc/ssl/certs type: DirectoryOrCreate name: ca-certs - hostPath: path: /etc/pki type: DirectoryOrCreate name: etc-pki - hostPath: path: /usr/libexec/kubernetes/kubelet-plugins/volume/exec type: DirectoryOrCreate name: flexvolume-dir - hostPath: path: /root/k8s-1.14.6/ssl type: DirectoryOrCreate name: k8s-certs - hostPath: path: /root/k8s-1.14.6/conf/controller-manager.conf type: FileOrCreate name: kubeconfig - hostPath: path: /root/k8s-1.14.6/logs name: logs status: {} ","date":"22 August 2019","permalink":"/2019/08/k8s1.14.6-controller-manager/","section":"åšå®¢","summary":"\u003ch4 class=\"relative group\"\u003e1. åˆ›å»ºkubeconfig \n    \u003cdiv id=\"1-åˆ›å»ºkubeconfig\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#1-%e5%88%9b%e5%bb%bakubeconfig\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e\n\u003cp\u003eåˆ›å»ºcontroller-managerè®¿é—®apiserverçš„kubeconfig\u003c/p\u003e","title":"k8s1.14.6é›†ç¾¤æ­å»ºä¹‹controller-manageréƒ¨ç½²"},{"content":"1. åˆ›å»ºè‡ªç­¾åCAåŠç›¸å…³è¯ä¹¦ # 1.1 åˆ›å»ºè‡ªç­¾åCA\ncd /root/k8s-1.14.6/ssl/etcd cat \u0026lt;\u0026lt;EOF \u0026gt; ca-config.json { \u0026#34;signing\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34; }, \u0026#34;profiles\u0026#34;: { \u0026#34;etcd\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;87600h\u0026#34;, \u0026#34;usages\u0026#34;: [ \u0026#34;signing\u0026#34;, \u0026#34;key encipherment\u0026#34;, \u0026#34;server auth\u0026#34;, \u0026#34;client auth\u0026#34; ] } } } } EOF cat \u0026lt;\u0026lt;EOF \u0026gt; ca-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;etcd-ca\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34; } ] } EOF cfssl gencert -initca ca-csr.json|cfssljson -bare ca ls /root/k8s-1.14.6/ssl/etcd ca-config.json ca.csr ca-csr.json ca-key.pem ca.pem 1.2 ç­¾åè¯ä¹¦\nä½¿ç”¨1.1æ­¥éª¤åˆ›å»ºçš„CA(ca.pem)ç­¾åç›¸å…³è¯ä¹¦server.pemã€peer.pemã€apiserver-etcd-client.pem\ncat \u0026lt;\u0026lt;EOF \u0026gt; server-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;etcd-ca\u0026#34;, \u0026#34;hosts\u0026#34;: [ \u0026#34;192.168.18.142\u0026#34; --\u0026gt; hosts: etcdé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹ ], \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34; } ] } EOF cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd server-csr.json|cfssljson -bare server cat \u0026lt;\u0026lt;EOF \u0026gt; peer-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;etcd-ca\u0026#34;, \u0026#34;hosts\u0026#34;: [ \u0026#34;192.168.18.142\u0026#34; ], \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34; } ] } EOF cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd peer-csr.json|cfssljson -bare peer cat \u0026lt;\u0026lt;EOF \u0026gt; apiserver-etcd-client-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;kube-apiserver-etcd-client\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;system:masters\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;\u0026#34; } ] EOF cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd apiserver-etcd-client-csr.json |cfssljson -bare apiserver-etcd-client 2. éƒ¨ç½²ETCD # ä»¥å•èŠ‚ç‚¹ä¸ºä¾‹ï¼Œå®¹å™¨åŒ–éƒ¨ç½²etcd\ndocker run \\ --detach \\ --name k8s1.14.6-etcd-cluster \\ --restart always \\ --volume /root/k8s-1.14.6/ssl/etcd/:/etcd/ssl \\ --volume /root/k8s-1.14.6/etcd/:/etcd/data \\ --log-driver json-file \\ --log-opt max-file=5 \\ --log-opt max-size=50m \\ --network host \\ quay.io/coreos/etcd:v3.3.10 \\ /usr/local/bin/etcd \\ --advertise-client-urls=https://192.168.18.142:2379 \\ --cert-file=/etcd/ssl/server.pem \\ --client-cert-auth=true \\ --data-dir=/etcd/data \\ --initial-advertise-peer-urls=https://192.168.18.142:2380 \\ --initial-cluster=etcd-node1=https://192.168.18.142:2380 \\ --\u0026gt; å¤šç‚¹é›†ç¾¤é€—å·åˆ†éš” --key-file=/etcd/ssl/server-key.pem \\ --listen-client-urls=https://192.168.18.142:2379 \\ --listen-peer-urls=https://192.168.18.142:2380 \\ --name=etcd-node1 \\ --\u0026gt; å½“å‰èŠ‚ç‚¹name --peer-cert-file=/etcd/ssl/peer.pem \\ --peer-client-cert-auth=true \\ --peer-key-file=/etcd/ssl/peer-key.pem \\ --peer-trusted-ca-file=/etcd/ssl/ca.pem \\ --snapshot-count=10000 \\ --trusted-ca-file=/etcd/ssl/ca.pem 2.1 etcdé›†ç¾¤æœåŠ¡éªŒè¯\n$ docker exec -it k8s1.14.6-etcd-cluster sh etcdctl --ca-file=/etcd/ssl/ca.pem \\ --cert-file=/etcd/ssl/server.pem \\ --key-file=/etcd/ssl/server-key.pem \\ --endpoints=\u0026#34;https://192.168.18.142:2379\u0026#34; cluster-health member 3980bdec1233ede9 is healthy: got healthy result from https://192.168.18.142:2379 cluster is healthy ","date":"22 August 2019","permalink":"/2019/08/k8s1.14.6-etcd/","section":"åšå®¢","summary":"\u003ch4 class=\"relative group\"\u003e1. åˆ›å»ºè‡ªç­¾åCAåŠç›¸å…³è¯ä¹¦ \n    \u003cdiv id=\"1-åˆ›å»ºè‡ªç­¾åcaåŠç›¸å…³è¯ä¹¦\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#1-%e5%88%9b%e5%bb%ba%e8%87%aa%e7%ad%be%e5%90%8dca%e5%8f%8a%e7%9b%b8%e5%85%b3%e8%af%81%e4%b9%a6\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e\n\u003cp\u003e1.1 åˆ›å»ºè‡ªç­¾åCA\u003c/p\u003e","title":"k8s1.14.6é›†ç¾¤æ­å»ºä¹‹ETCDé›†ç¾¤éƒ¨ç½²"},{"content":"1. åˆ›å»ºkubeconfig # åˆ›å»ºschedulerè®¿é—®çš„apiserverçš„kubeconfig\n$ cd /root/k8s-1.14.6/conf $ cat create-scheduler-kubeconfig.sh KUBE_APISERVER=\u0026#34;https://192.168.18.142:6443\u0026#34; kubectl config set-cluster kubernetes \\ --certificate-authority=/root/k8s-1.14.6/ssl/ca.pem \\ --embed-certs=true \\ --server=${KUBE_APISERVER} \\ --kubeconfig=scheduler.conf kubectl config set-credentials system:kube-scheduler \\ --client-certificate=/root/k8s-1.14.6/ssl/apiserver-kubelet-client.pem \\ --client-key=/root/k8s-1.14.6/ssl/apiserver-kubelet-client-key.pem \\ --embed-certs=true \\ --kubeconfig=scheduler.conf kubectl config set-context system:kube-scheduler@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-scheduler \\ --kubeconfig=scheduler.conf kubectl config use-context system:kube-scheduler@kubernetes --kubeconfig=scheduler.conf $ sh create-scheduler-kubeconfig.sh 2. éƒ¨ç½²kube-scheduler # 2.1 äºŒè¿›åˆ¶æ–¹å¼å¯åŠ¨\nkube-scheduler \\ --logtostderr=false \\ --v=2 \\ --log-file=/root/k8s-1.14.6/logs/kube-scheduler.log \\ --bind-address=127.0.0.1 \\ --kubeconfig=/root/k8s-1.14.6/conf/scheduler.conf \\ --leader-elect=true é»˜è®¤ç›‘å¬10251ã€10259ç«¯å£\n2.2 StaticPodæ–¹å¼éƒ¨ç½²\nåˆ›å»ºé™æ€podæ–‡ä»¶kube-scheduler-pod.yaml\n$ cd /root/k8s-1.14.6/manifests apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: component: kube-scheduler tier: control-plane name: kube-scheduler namespace: kube-system spec: containers: - command: - kube-scheduler - --logtostderr=false - --v=2 - --log-file=/var/log/kube-scheduler.log - --bind-address=127.0.0.1 - --kubeconfig=/etc/kubernetes/scheduler.conf - --leader-elect=true image: k8s.gcr.io/kube-scheduler:v1.14.6 imagePullPolicy: IfNotPresent livenessProbe: failureThreshold: 8 httpGet: host: 127.0.0.1 path: /healthz port: 10251 scheme: HTTP initialDelaySeconds: 15 timeoutSeconds: 15 name: kube-scheduler resources: requests: cpu: 100m volumeMounts: - mountPath: /etc/kubernetes/scheduler.conf name: kubeconfig readOnly: true - mountPath: /var/log name: logs hostNetwork: true priorityClassName: system-cluster-critical volumes: - hostPath: path: /root/k8s-1.14.6/conf/scheduler.conf type: FileOrCreate name: kubeconfig - hostPath: path: /root/k8s-1.14.6/logs name: logs status: {} 3. æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ # $ kubectl get cs NAME STATUS MESSAGE ERROR scheduler Healthy ok controller-manager Healthy ok etcd-0 Healthy {\u0026#34;health\u0026#34;:\u0026#34;true\u0026#34;} ","date":"22 August 2019","permalink":"/2019/08/k8s1.14.6-scheduler/","section":"åšå®¢","summary":"\u003ch4 class=\"relative group\"\u003e1. åˆ›å»ºkubeconfig \n    \u003cdiv id=\"1-åˆ›å»ºkubeconfig\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#1-%e5%88%9b%e5%bb%bakubeconfig\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e\n\u003cp\u003eåˆ›å»ºschedulerè®¿é—®çš„apiserverçš„kubeconfig\u003c/p\u003e","title":"k8s1.14.6é›†ç¾¤æ­å»ºä¹‹scheduleréƒ¨ç½²"},{"content":"","date":"24 March 2019","permalink":"/tags/nginx/","section":"Tags","summary":"","title":"nginx"},{"content":"å‰è¨€ # å½“nginxä»£ç†çš„åç«¯æœåŠ¡å™¨æœ‰301ã€302è·³è½¬æ—¶ï¼Œéœ€è¦æ³¨æ„æŒ‡å®šproxy_set_header Hostè¯·æ±‚å¤´éƒ¨ï¼Œä¼šç›´æ¥å½±å“nginxåé¦ˆç»™å®¢æˆ·ç«¯çš„URLè¯·æ±‚ï¼Œè¦ç»“åˆå®é™…éœ€æ±‚è°ƒæ•´proxy_set_header Hostå’Œproxy_redirectå°†è¢«ä»£ç†æœåŠ¡å™¨è®¾ç½®åœ¨response headerä¸­çš„Locationåšè½¬æ¢ã€‚\næ­å»ºæµ‹è¯•ç¯å¢ƒ # 1.æµ‹è¯•æ¶æ„è§„åˆ’\nä¸»æœº192.168.196.134 nginxè™šæ‹Ÿä¸»æœºwww.test.comï¼›ç›‘å¬ç«¯å£31001ï¼›è½¬å‘æ–‡æ ¹ /thï¼›åç«¯server 192.168.196.135:31009 nginxè™šæ‹Ÿä¸»æœº192.168.196.134ï¼›ç›‘å¬ç«¯å£31000ï¼›è½¬å‘æ–‡æ ¹ *.jspï¼›åç«¯server 192.168.196.136:31005 ä¸»æœº192.168.196.135 nginxè™šæ‹Ÿä¸»æœº 192.168.196.135ï¼›ç›‘å¬ç«¯å£31009ï¼›è½¬å‘æ–‡æ ¹ /th/ftï¼›åç«¯server 192.168.196.134:31000 ä¸»æœº192.168.196.136 tomcat server; ç›‘å¬ç«¯å£31005 192.168.196.134:31001/th \u0026mdash;\u0026gt; 192.168.196.135:31009/th/ft \u0026ndash;\u0026gt; 192.168.196.134:31000 *.jsp \u0026ndash;\u0026gt; 192.168.196.136:31005\n2.192.168.196.136ä¸Šéƒ¨ç½²waråŒ…\nsh-4.2$ cat test.jsp \u0026lt;%@ page language=\u0026#34;java\u0026#34; contentType=\u0026#34;text/html; charset=ISO-8859-1\u0026#34; pageEncoding=\u0026#34;ISO-8859-1\u0026#34;%\u0026gt; \u0026lt;% out.println(\u0026#34;Protocol: \u0026#34; + request.getProtocol()); out.println(\u0026#34;Server Name: \u0026#34; + request.getServerName()); out.println(\u0026#34;Server Port: \u0026#34; + request.getServerPort()); out.println(\u0026#34;Remote Addr: \u0026#34; + request.getRemoteAddr()); out.println(\u0026#34;Remote Host: \u0026#34; + request.getRemoteHost()); out.println(\u0026#34;Request URL: \u0026#34; + request.getRequestURL()); out.println(\u0026#34;Host: \u0026#34; + request.getHeader(\u0026#34;Host\u0026#34;)); out.println(\u0026#34;Connection : \u0026#34; + request.getHeader(\u0026#34;Connection\u0026#34;)); %\u0026gt; $jar cvf th.war th/ft/test.jsp 3.192.168.196.134ä¸Šé…ç½® nginx\nupstream backendsrv { server 192.168.196.136:31005; } server { listen 31001; server_name www.test.com; location /th { root html; index index.html index.htm; proxy_pass http://192.168.196.135:31009; #proxy_redirect ~^http://www.test.com:31009(.*) http://$host:$server_port$1; proxy_set_header Host $http_host; } } server { listen 31000; server_name www.firsthost.com 192.168.196.134; location /th/ft { root html; index index.html index.htm; } location ~* .jsp$ { proxy_pass http://backendsrv; proxy_set_header Host $http_host; } } 4.192.168.196.135ä¸Šé…ç½®nginx\nupstream backendnginx { server 192.168.196.134:31000; } server { listen 31009; server_name 192.168.196.135; location /th/ft { root html; index index.html index.htm; proxy_pass http://backendnginx; #proxy_redirect ~^http://www.test.com:31000(.*) http://$host:$server_port$1; proxy_set_header Host $http_host; } location /th { root html; index index.html index.htm; } } 5.æŒ‰ç…§å½“å‰é…ç½®åœ¨å®¢æˆ·ç«¯è®¿é—®:\n$curl -L www.test.com:31001/th/ft/test.jsp Protocol: HTTP/1.0 Server Name: www.test.com Server Port: 31001 Remote Addr: 192.168.196.134 Remote Host: 192.168.196.134 Request URL: http://www.test.com:31001/th/ft/test.jsp Host: www.test.com:31001 Connection : close ç”±äºæ¯ä¸ªè½¬å‘æ–‡æ ¹ä¸‹éƒ½è®¾ç½®äº†Hostè¯·æ±‚å¤´(proxy_set_header Host $http_host;)ï¼Œæœ€ç»ˆtomcatåº”ç”¨æœåŠ¡å™¨ä»è¯·æ±‚ä¸­è·å–çš„Hostä¿¡æ¯ä¸ºé¢å‘å®¢æˆ·ç«¯çš„ç¬¬ä¸€çº§ä»£ç†nginxçš„è™šæ‹Ÿä¸»æœºserver_nameåŠç›‘å¬ç«¯å£\n$curl -I www.test.com:31001/th HTTP/1.1 301 Moved Permanently Server: nginx Date: Thu, 21 Mar 2019 02:50:47 GMT Content-Type: text/html Content-Length: 178 Connection: keep-alive Location: http://www.test.com:31009/th/ $curl -I www.test.com:31001/th/ft HTTP/1.1 301 Moved Permanently Server: nginx Date: Thu, 21 Mar 2019 02:50:51 GMT Content-Type: text/html Content-Length: 178 Connection: keep-alive Location: http://www.test.com:31000/th/ft/ 301è·³è½¬æ—¶ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯é‡æ–°å‘é€è¯·æ±‚çš„Locationä¸­URLæœ‰é—®é¢˜ã€‚ åç«¯serverçš„å“åº”å¤´ä¸­çš„locationå­—æ®µä¿¡æ¯ä¸º: 1.hostå€¼è¢«è®¾ç½®ä¸ºç¬¬ä¸€ä¸ªè½¬å‘Locationæ‰€åœ¨è™šæ‹Ÿä¸»æœºçš„server_name www.test.com\nè¿™é‡Œè¦æ³¨æ„çš„æ—¶ï¼Œå¦‚æœnginxè½¬å‘Locationä¸­æœªè®¾ç½®Hostè¯·æ±‚å¤´ï¼Œåˆ™hostå€¼ä¸ºproxy_passåæŒ‡å®šçš„åœ°å€\n2.ç«¯å£è¢«è®¾ç½®ä¸ºæ¯ä¸ªè½¬å‘Locationä¸­proxy_pass/upstreamå®šä¹‰çš„ç«¯å£\næ­¤æ—¶è¦ç”¨proxy_redirectå°†è¢«ä»£ç†æœåŠ¡å™¨è®¾ç½®åœ¨response headerä¸­çš„Locationåšè½¬æ¢ã€‚å®˜æ–¹è§£é‡Šï¼š\nproxy_redirect è¯­æ³•ï¼šproxy_redirect [ default|off|redirect replacement ]Â é»˜è®¤å€¼ï¼šproxy_redirect defaultÂ ä½¿ç”¨å­—æ®µï¼šhttp, server, locationÂ å¦‚æœéœ€è¦ä¿®æ”¹ä»è¢«ä»£ç†æœåŠ¡å™¨ä¼ æ¥çš„åº”ç­”å¤´ä¸­çš„\u0026quot;Location\u0026quot;å’Œ\u0026quot;Refresh\u0026quot;å­—æ®µï¼Œå¯ä»¥ç”¨è¿™ä¸ªæŒ‡ä»¤è®¾ç½®ã€‚\n6.æ ¹æ®ä¸Šé¢çš„è®¿é—®ç»“æœï¼Œå¯¹åº”è·³è½¬åœ°å€ï¼š/th \u0026ndash;\u0026gt; /th/å’Œ/th/ft \u0026ndash;\u0026gt; /th/ft/\nåœ¨ç›¸åº”çš„è½¬å‘Locationä¸‹ï¼Œåˆ†åˆ«æ·»åŠ :\nproxy_redirect ~^http://www.test.com:31009(.*) http://$host:$server_port$1; proxy_redirect ~^http://www.test.com:31000(.*) http://$host:$server_port$1; $hostå’Œ$server_port åˆ†åˆ«ä¸ºè½¬å‘æ–‡æ ¹Locationæ‰€åœ¨è™šæ‹Ÿä¸»æœºçš„server_nameå’Œlisten port\n7.reload Nginxåï¼Œä»å®¢æˆ·ç«¯è®¿é—®\n$curl -I www.test.com:31001/th HTTP/1.1 301 Moved Permanently Server: nginx Date: Thu, 21 Mar 2019 03:15:10 GMT Content-Type: text/html Content-Length: 178 Connection: keep-alive Location: http://www.test.com:31001/th/ $curl -I www.test.com:31001/th/ft HTTP/1.1 301 Moved Permanently Server: nginx Date: Thu, 21 Mar 2019 03:18:22 GMT Content-Type: text/html Content-Length: 178 Connection: keep-alive Location: http://www.test.com:31001/th/ft 301è·³è½¬æ—¶ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯é‡æ–°å‘é€è¯·æ±‚çš„Locationä¸­URLå·²æ­£ç¡®æ˜¾ç¤º\næœ€ä½³å®è·µ # ä¾æ®è½¬å‘Locationä¸­Hostè¯·æ±‚å¤´æ˜¯å¦è¢«æŒ‡å®šï¼Œæ¥ä¿®æ”¹proxy_redirectçš„å€¼:\nå¦‚æœHostè¯·æ±‚å¤´æœªæŒ‡å®šè¿‡ï¼Œåˆ™åç«¯serverè¿”å›çš„Locationä¸ºnginxä¸­proxy_passåçš„servername/IPä¸proxy_passåçš„ç«¯å£æˆ–upstreamä¸­è½¬å‘ç«¯å£çš„æ‹¼æ¥\nå¦‚æœHostè¯·æ±‚å¤´åœ¨å½“å‰è½¬å‘LocationæŒ‡å®š\nHoståœ¨nginxæ”¶åˆ°çš„è¯·æ±‚ä¸­æœªæŒ‡å®šè¿‡ï¼Œåˆ™åç«¯serverè¿”å›çš„Locationä¸ºnginxå½“å‰è½¬å‘Locationçš„server_nameä¸proxy_passåçš„ç«¯å£æˆ–upstreamä¸­è½¬å‘ç«¯å£çš„æ‹¼æ¥ Hoståœ¨nginxæ”¶åˆ°çš„è¯·æ±‚ä¸­å·²æŒ‡å®šï¼Œåˆ™åç«¯serverè¿”å›çš„Locationä¸ºnginxæ¥æ”¶çš„è¯·æ±‚ä¸­Hostä¸proxy_passåçš„ç«¯å£æˆ–upstreamä¸­è½¬å‘ç«¯å£çš„æ‹¼æ¥ ","date":"24 March 2019","permalink":"/2019/03/nginx-proxy_redirect/","section":"åšå®¢","summary":"å‰è¨€ # å½“nginxä»£ç†çš„åç«¯æœåŠ¡å™¨æœ‰301ã€302è·³è½¬æ—¶ï¼Œéœ€è¦æ³¨æ„æŒ‡å®šproxy_set_header Hostè¯·æ±‚å¤´éƒ¨ï¼Œä¼šç›´æ¥å½±å“nginxåé¦ˆç»™å®¢æˆ·ç«¯çš„URLè¯·æ±‚ï¼Œè¦ç»“åˆå®é™…éœ€æ±‚è°ƒæ•´proxy_set_header Hostå’Œproxy_redirectå°†è¢«ä»£ç†æœåŠ¡å™¨è®¾ç½®åœ¨response headerä¸­çš„Locationåšè½¬æ¢ã€‚\næ­å»ºæµ‹è¯•ç¯å¢ƒ # 1.æµ‹è¯•æ¶æ„è§„åˆ’\nä¸»æœº192.168.196.134 nginxè™šæ‹Ÿä¸»æœºwww.test.comï¼›ç›‘å¬ç«¯å£31001ï¼›è½¬å‘æ–‡æ ¹ /thï¼›åç«¯server 192.168.196.135:31009 nginxè™šæ‹Ÿä¸»æœº192.168.196.134ï¼›ç›‘å¬ç«¯å£31000ï¼›è½¬å‘æ–‡æ ¹ *.jspï¼›åç«¯server 192.168.196.136:31005 ä¸»æœº192.168.196.135 nginxè™šæ‹Ÿä¸»æœº 192.168.196.135ï¼›ç›‘å¬ç«¯å£31009ï¼›è½¬å‘æ–‡æ ¹ /th/ftï¼›åç«¯server 192.168.196.134:31000 ä¸»æœº192.168.196.136 tomcat server; ç›‘å¬ç«¯å£31005 192.168.196.134:31001/th \u0026mdash;\u0026gt; 192.168.196.135:31009/th/ft \u0026ndash;\u0026gt; 192.168.196.134:31000 *.","title":"Nginxçš„proxy_redirecté…ç½®"},{"content":"å‰è¨€ # nginxåå‘ä»£ç†åç«¯åº”ç”¨æœåŠ¡å™¨æ—¶ï¼Œé‡åˆ°webåº”ç”¨æœåŠ¡å™¨éœ€è¦è·å–å®¢æˆ·ç«¯çœŸå®IPï¼Œè¯¥å¦‚ä½•æ­£ç¡®é…ç½®nginx?æœ¬æ–‡åˆ†åˆ«åœ¨ä¸€çº§åå‘ä»£ç†åŠä¸¤çº§åå‘ä»£ç†æƒ…å†µä¸‹ï¼Œæµ‹è¯•è¯·æ±‚å¤´X-Real-IPä¸X-Forwarded-Forå¦‚ä½•é…ç½®\nä¸€çº§ä»£ç†æµ‹è¯•éªŒè¯ # 1.æµ‹è¯•æ¶æ„: nginxåå‘ä»£ç† + tomcat webæœåŠ¡\nip server server port 192.168.196.135 nginx 31005 192.168.196.136 tomcat 31001 192.168.196.1 å®¢æˆ·ç«¯ - 2.éƒ¨ç½²tomcatæµ‹è¯•waråŒ…\n$cat test.jsp \u0026lt;%@ page language=\u0026#34;java\u0026#34; contentType=\u0026#34;text/html; charset=ISO-8859-1\u0026#34; pageEncoding=\u0026#34;ISO-8859-1\u0026#34;%\u0026gt; \u0026lt;% out.println(\u0026#34;Protocol: \u0026#34; + request.getProtocol()); out.println(\u0026#34;Server Name: \u0026#34; + request.getServerName()); out.println(\u0026#34;Server Port: \u0026#34; + request.getServerPort()); out.println(\u0026#34;Remote Addr: \u0026#34; + request.getRemoteAddr()); out.println(\u0026#34;Remote Host: \u0026#34; + request.getRemoteHost()); out.println(\u0026#34;Request URL: \u0026#34; + request.getRequestURL()); out.println(\u0026#34;Host: \u0026#34; + request.getHeader(\u0026#34;Host\u0026#34;)); out.println(\u0026#34;X-Real-IP: \u0026#34; + request.getHeader(\u0026#34;X-Real-IP\u0026#34;)); out.println(\u0026#34;X-Forwarded-For: \u0026#34; + request.getHeader(\u0026#34;X-Forwarded-For\u0026#34;)); out.println(\u0026#34;Connection : \u0026#34; + request.getHeader(\u0026#34;Connection\u0026#34;)); %\u0026gt; $jar cvf th.war th/test.jsp 3.ä¿®æ”¹nginx.conf\nupstream backendsrv { server 192.168.196.136:31005; } server { listen 31001; server_name www.test.com; location /th { root html; index index.html index.htm; proxy_pass http://backendsrv; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } nginxé‡è®¾è¯·æ±‚å¤´X-Real-IPä¸º$remote_addrã€ X-Forwarded-Forä¸º$proxy_add_x_forwarded_for\n$proxy_add_x_forwarded_for:\n$remote_addrå˜é‡å€¼æ·»åŠ åœ¨å®¢æˆ·ç«¯â€œX-Forwarded-Forâ€è¯·æ±‚å¤´çš„åé¢ï¼Œå¹¶ä»¥é€—å·åˆ†éš”ã€‚ å¦‚æœå®¢æˆ·ç«¯è¯·æ±‚æœªæºå¸¦â€œX-Forwarded-Forâ€è¯·æ±‚å¤´ï¼Œ$proxy_add_x_forwarded_for å˜é‡å€¼å°†ä¸$remote_addrå˜é‡ç›¸åŒ\n4.ä½¿ç”¨curlæ„é€ X-Real-IPã€X-Forwarded-Forè¯·æ±‚å¤´ï¼Œåœ¨å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚\n$curl -H \u0026#34;X-Forwarded-For: 1.1.1.1\u0026#34; -H \u0026#34;X-Real-IP: 2.2.2.2\u0026#34; 192.168.196.135:31001/th/test.jsp Protocol: HTTP/1.0 Server Name: 192.168.196.135 Server Port: 31001 Remote Addr: 192.168.196.135 Remote Host: 192.168.196.135 Request URL: http://192.168.196.135:31001/th/test.jsp Host: 192.168.196.135:31001 X-Real-IP: 192.168.196.1 X-Forwarded-For: 1.1.1.1, 192.168.196.1 Connection : close æ ¹æ®è¯·æ±‚ç»“æœçœ‹å‡ºï¼š\nnginxæ¸…ç†äº†ä¼ªé€ çš„X-Real-IPè¯·æ±‚å¤´å¹¶é‡å†™ä¸ºclientIP- nginxåœ¨X-Forwarded-Foråè¿½åŠ clientIP åç«¯webåº”ç”¨å¯é€šè¿‡X-Real-IPæˆ–è€…X-Forwarded-Forçš„æœ€åä¸€ä¸ªIPè·å–clientIP\n5.æœ¬ä¾‹ä¸­ï¼Œnginxä¸ºä¸€çº§ä»£ç†ï¼Œä¸ºé¿å…å®¢æˆ·ç«¯ä¼ªé€ X-Forwarded-Forè¯·æ±‚å¤´ï¼Œå¯æ·»åŠ  proxy_set_header X-Forwarded-For $remote_addr\nupstream backendsrv { server 192.168.196.136:31005; } server { listen 31001; server_name www.test.com; location /th { root html; index index.html index.htm; proxy_pass http://backendsrv; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } $curl -H \u0026#34;X-Forwarded-For: 1.1.1.1\u0026#34; 192.168.196.135:31001/th/test.jsp Protocol: HTTP/1.0 Server Name: 192.168.196.135 Server Port: 31001 Remote Addr: 192.168.196.135 Remote Host: 192.168.196.135 Request URL: http://192.168.196.135:31001/th/test.jsp Host: 192.168.196.135:31001 X-Real-IP: 192.168.196.1 X-Forwarded-For: 192.168.196.1 Connection : close äºŒçº§ä»£ç†æµ‹è¯•éªŒè¯ # 1.æµ‹è¯•æ¶æ„: nginx1åå‘ä»£ç† +nginx2åå‘ä»£ç†+ tomcat webæœåŠ¡\nip server server port 192.168.196.133 nginx1 31009 192.168.196.135 nginx2 31001 192.168.196.136 tomcat 31005 192.168.196.1 client - 2.ä¿®æ”¹nginx.conf\nä¸€çº§åå‘ä»£ç†nginx1 upstream backendnginx { server 192.168.196.135:31001; } server { listen 31009; server_name 192.168.196.133; location /th { root html; index index.html index.htm; proxy_pass http://backendnginx; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } äºŒçº§åå‘ä»£ç†nginx2 upstream backendsrv { server 192.168.196.136:31005; } server { listen 31001; server_name www.test.com; location /th/ft { root html; index index.html index.htm; proxy_pass http://backendsrv; proxy_set_header Host $http_host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } 3.ä½¿ç”¨curlæ„é€ X-Forwarded-Forè¯·æ±‚å¤´ï¼Œåœ¨å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚\n$curl -H \u0026#34;X-Forwarded-For: unknown, 1.1.1.1\u0026#34; 192.168.196.133:31009/th/ft/test.jsp Protocol: HTTP/1.0 Server Name: 192.168.196.133 Server Port: 31009 Remote Addr: 192.168.196.135 Remote Host: 192.168.196.135 Request URL: http://192.168.196.133:31009/th/ft/test.jsp Host: 192.168.196.133:31009 X-Real-IP: 192.168.196.1 X-Forwarded-For: unknown, 1.1.1.1, 192.168.196.1, 192.168.196.133 Connection : close nginxä¾æ¬¡å°†$remote_addrè¿½åŠ åˆ°X-Forwarded-For\nclientIPä¸ºå€’æ•°ç¬¬nä¸ªIP, nä¸ºproxyçš„æ¬¡æ•°\n4.é¢å‘å®¢æˆ·ç«¯çš„ç¬¬ä¸€çº§nginxä¸­ï¼Œæ·»åŠ proxy_set_header X-Forwarded-For $remote_addr;\nupstream backendnginx { server 192.168.196.135:31001; } server { listen 31009; server_name 192.168.196.133; location /th { root html; index index.html index.htm; proxy_pass http://backendnginx; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } $curl -H \u0026#34;X-Forwarded-For: unknown, 1.1.1.1\u0026#34; 192.168.196.133:31009/th/ft/test.jsp Protocol: HTTP/1.0 Server Name: 192.168.196.133 Server Port: 31009 Remote Addr: 192.168.196.135 Remote Host: 192.168.196.135 Request URL: http://192.168.196.133:31009/th/ft/test.jsp Host: 192.168.196.133:31009 X-Real-IP: 192.168.196.1 X-Forwarded-For: 192.168.196.1, unknown, 1.1.1.1, 192.168.196.1, 192.168.196.133 Connection : close X-Forwarded-Forçš„ç¬¬ä¸€ä¸ªIPä¸ºclientIP\næœ€ä½³å®è·µ # ç¬¬ä¸€çº§åå‘ä»£ç†nginx: proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nä¸­é—´çš„åå‘ä»£ç†nginxåªéœ€é…ç½®: proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n","date":"19 March 2019","permalink":"/2019/03/nginx-real-ip/","section":"åšå®¢","summary":"å‰è¨€ # nginxåå‘ä»£ç†åç«¯åº”ç”¨æœåŠ¡å™¨æ—¶ï¼Œé‡åˆ°webåº”ç”¨æœåŠ¡å™¨éœ€è¦è·å–å®¢æˆ·ç«¯çœŸå®IPï¼Œè¯¥å¦‚ä½•æ­£ç¡®é…ç½®nginx?æœ¬æ–‡åˆ†åˆ«åœ¨ä¸€çº§åå‘ä»£ç†åŠä¸¤çº§åå‘ä»£ç†æƒ…å†µä¸‹ï¼Œæµ‹è¯•è¯·æ±‚å¤´X-Real-IPä¸X-Forwarded-Forå¦‚ä½•é…ç½®\nä¸€çº§ä»£ç†æµ‹è¯•éªŒè¯ # 1.æµ‹è¯•æ¶æ„: nginxåå‘ä»£ç† + tomcat webæœåŠ¡\nip server server port 192.168.196.135 nginx 31005 192.168.196.136 tomcat 31001 192.168.196.1 å®¢æˆ·ç«¯ - 2.éƒ¨ç½²tomcatæµ‹è¯•waråŒ…\n$cat test.jsp \u0026lt;%@ page language=\u0026#34;java\u0026#34; contentType=\u0026#34;text/html; charset=ISO-8859-1\u0026#34; pageEncoding=\u0026#34;ISO-8859-1\u0026#34;%\u0026gt; \u0026lt;% out.","title":"nginxè¯·æ±‚å¤´X-Real-IPä¸X-Forwarded-For"},{"content":"å‰è¨€ # nginxä½œä¸ºåå‘ä»£ç†æ—¶ï¼Œå½“æ»¡è¶³locationåŒ¹é…æ¡ä»¶åï¼Œå‘åç«¯åŠ¨æ€åº”ç”¨æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨ä¼šæ ¹æ®æ­¤æ¬¡è¯·æ±‚å¤´åšä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚é€šè¿‡Hostæˆ–è€…server_nameè¯·æ±‚å¤´çš„å€¼è¿›è¡Œæ ¡éªŒç­‰ï¼‰ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚æœ¬æ–‡å°±ç”¨å®ä¾‹æ¥åˆ†æä¸€ä¸‹nginxè½¬å‘çš„è¯·æ±‚å¤´ä¿¡æ¯\nç¯å¢ƒå‡†å¤‡ # IP SERVER 10.168.11.12 Nginx1.12 10.168.11.13 Tomcat7.0 ä¸€ã€å‡†å¤‡tomcat waråŒ…\nåˆ›å»ºtest.jspæ–‡ä»¶æ¥è·å–å„è¯·æ±‚å¤´ä¿¡æ¯ \u0026lt;%@ page language=\u0026#34;java\u0026#34; contentType=\u0026#34;text/html; charset=ISO-8859-1\u0026#34; pageEncoding=\u0026#34;ISO-8859-1\u0026#34;%\u0026gt; \u0026lt;% out.println(\u0026#34;Protocol: \u0026#34; + request.getProtocol()); out.println(\u0026#34;Server Name: \u0026#34; + request.getServerName()); out.println(\u0026#34;Server Port: \u0026#34; + request.getServerPort()); out.println(\u0026#34;Remote Addr: \u0026#34; + request.getRemoteAddr()); out.println(\u0026#34;Remote Host: \u0026#34; + request.getRemoteHost()); out.println(\u0026#34;Request URL: \u0026#34; + request.getRequestURL()); out.println(\u0026#34;Host: \u0026#34; + request.getHeader(\u0026#34;Host\u0026#34;)); out.println(\u0026#34;Connection : \u0026#34; + request.getHeader(\u0026#34;Connection\u0026#34;)); %\u0026gt; æ‰“åŒ…th.warå¹¶éƒ¨ç½² jar cvf th.war th/test.jsp 10.168.11.13æœåŠ¡å™¨ä¸Šå®‰è£…Tomcat7.0ï¼Œå¹¶ç›‘å¬30000ç«¯å£ã€‚è¿™é‡Œä¸å†æè¿°tomcatå®‰è£…éƒ¨ç½²åŠå‘å¸ƒåŒ…çš„æ­¥éª¤ã€‚\nè®¿é—®http://10.168.11.13:30000/th/test.jsp tomcatä»è¯·æ±‚ä¸­è·å–çš„ä¿¡æ¯å¦‚ä¸‹ï¼š\nProtocol: HTTP/1.1 \u0026lt;-- httpåè®®ç‰ˆæœ¬ Server Name: 10.168.11.13 Server Port: 30000 Remote Addr: 10.168.196.134 \u0026lt;-- client IP Remote Host: 10.168.196.134 \u0026lt;-- client IP Request URL: http://10.168.11.13:30000/th/test.jsp Host: 10.168.11.13:30000 Connection : keep-alive äºŒã€é…ç½®Nginx\nnginx.confä¸­å®šä¹‰serverã€upstream upstream backendsrv { server 10.168.11.13:30000; } server { listen 10000; server_name www.test.com; location /th { root html; index index.html index.htm; proxy_pass http://backendsrv; } } å¯åŠ¨nginxå¹¶è®¿é—®http://10.168.11.12:10000/th/test.jsp Protocol: HTTP/1.0 Server Name: backendsrv Server Port: 80 Remote Addr: 10.168.11.12 Remote Host: 10.168.11.12 Request URL: http://backendsrv/th/test.jsp Host: backendsrv Connection : close Nginxä»£ç†å‘é€httpè¯·æ±‚é»˜è®¤ä¸ºHTTP 1.0ï¼Œå¯é€šè¿‡å®šä¹‰proxy_http_version 1.1æ¥ä¿®æ”¹ï¼Œä¸€èˆ¬æ˜¯åœ¨ä½¿ç”¨keepaliveè¿æ¥æ—¶æ‰ä½¿ç”¨1.1ç‰ˆæœ¬ åœ¨ä½¿ç”¨proxy_set_headerçš„é»˜è®¤å€¼æ—¶ï¼ŒNginxå‘å¾€åç«¯è¯·æ±‚ä¸­çš„HoståŠserver_nameä¸ºä»£ç†çš„upstreamä¸­æŒ‡å®šçš„åŸŸå ç»“æœåˆ†æ # 1.ä»¥ä¸‹æ˜¯å®˜æ–¹docä¸­çš„æè¿° Syntax:\tproxy_set_header field value; Default: â€‹ proxy_set_header Host $proxy_host; â€‹ proxy_set_header Connection close; Context: http, server, location\nå…è®¸é‡æ–°å®šä¹‰æˆ–è€…æ·»åŠ å‘å¾€åç«¯æœåŠ¡å™¨çš„è¯·æ±‚å¤´ã€‚valueå¯ä»¥åŒ…å«æ–‡æœ¬ã€å˜é‡æˆ–è€…å®ƒä»¬çš„ç»„åˆã€‚ å½“ä¸”ä»…å½“å½“å‰é…ç½®çº§åˆ«ä¸­æ²¡æœ‰å®šä¹‰proxy_set_headeræŒ‡ä»¤æ—¶ï¼Œä¼šä»ä¸Šé¢çš„çº§åˆ«ç»§æ‰¿é…ç½®ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸¤ä¸ªè¯·æ±‚å¤´ä¼šè¢«é‡æ–°å®šä¹‰ï¼š â€‹\tproxy_set_header Host $proxy_host; â€‹\tproxy_set_header Connection close;\næ‰€ä»¥å½“å®¢æˆ·ç«¯è®¿é—®æœªæºå¸¦Hostè¯·æ±‚å¤´éƒ¨ï¼Œå¹¶ä½¿ç”¨proxy_set_headeré»˜è®¤å€¼æ—¶ï¼Œè¯·æ±‚å¤´éƒ¨Hostå€¼ä¸ºbackendsrvï¼ŒConnectionå€¼ä¸ºcloseï¼Œè€Œç«¯å£åˆ™ä¸ºé»˜è®¤80\n2.$host å’Œ $http_hostçš„åŒºåˆ«\nåœ¨serverä¸Šä¸‹æ–‡ä¸­åˆ†åˆ«æŒ‡å®šè¯·æ±‚å¤´Hostå€¼ä¸º$hostå’Œ$http_hostï¼Œç»“æœå¯¹æ¯”å¦‚ä¸‹:\nproxy_set_header Host $host proxy_set_header Host $http_host Protocol HTTP/1.0 HTTP/1.0 Server Name www.test.com www.test.com Server Port 80 10000 Remote Addr 10.168.11.12 10.168.11.12 Remote Host 10.168.11.12 10.168.11.12 Request URL http://www.test.com/th/test.jsp http://www.test.com:10000/th/test.jsp Host www.test.com www.test.com:10000 Connection close close å¯ä»¥çœ‹å‡ºï¼Œç”±äºå®¢æˆ·ç«¯è®¿é—®æœªæºå¸¦Hostè¯·æ±‚å¤´éƒ¨ï¼Œæ— æ³•ç»§æ‰¿ï¼Œåˆ™è¢«ä¿®æ”¹ä¸ºserverä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„è™šæ‹Ÿä¸»æœºåwww.test.comï¼›å¹¶ä¸”$http_hostä¼šä¿®æ”¹é»˜è®¤ç«¯å£80ä¸ºserverä¸Šä¸‹æ–‡ä¸­ç›‘å¬çš„ç«¯å£10000ã€‚æ‰€ä»¥å½“åç«¯åº”ç”¨æœåŠ¡å™¨éœ€è¦æ ¹æ®è¯·æ±‚å¤´éƒ¨Hostä¿¡æ¯åšè¿›ä¸€æ­¥å¤„ç†æ—¶ï¼Œè¦æ ¹æ®éœ€æ±‚åœ¨nginxä¸­æ­£ç¡®é…ç½®Hostå€¼ã€‚\næœ€ä½³å®è·µ # å½“åç«¯æœåŠ¡å™¨æœ‰301ã€302è·³è½¬æ—¶ï¼Œéœ€è¦æ³¨æ„æŒ‡å®šproxy_set_header Hostè¯·æ±‚å¤´éƒ¨ï¼Œä¼šç›´æ¥å½±å“nginxåé¦ˆç»™å®¢æˆ·ç«¯çš„URLè¯·æ±‚ï¼Œè¦ç»“åˆå®é™…éœ€æ±‚è°ƒæ•´proxy_set_header Hostå’Œproxy_redirectå°†è¢«ä»£ç†æœåŠ¡å™¨è®¾ç½®åœ¨response headerä¸­çš„Locationåšè½¬æ¢ã€‚\n","date":"4 March 2019","permalink":"/2019/03/nginx-proxy_set_header/","section":"åšå®¢","summary":"å‰è¨€ # nginxä½œä¸ºåå‘ä»£ç†æ—¶ï¼Œå½“æ»¡è¶³locationåŒ¹é…æ¡ä»¶åï¼Œå‘åç«¯åŠ¨æ€åº”ç”¨æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œå¦‚æœåç«¯æœåŠ¡å™¨ä¼šæ ¹æ®æ­¤æ¬¡è¯·æ±‚å¤´åšä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚é€šè¿‡Hostæˆ–è€…server_nameè¯·æ±‚å¤´çš„å€¼è¿›è¡Œæ ¡éªŒç­‰ï¼‰ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚æœ¬æ–‡å°±ç”¨å®ä¾‹æ¥åˆ†æä¸€ä¸‹nginxè½¬å‘çš„è¯·æ±‚å¤´ä¿¡æ¯\nç¯å¢ƒå‡†å¤‡ # IP SERVER 10.168.11.12 Nginx1.12 10.168.11.13 Tomcat7.0 ä¸€ã€å‡†å¤‡tomcat waråŒ…\nåˆ›å»ºtest.jspæ–‡ä»¶æ¥è·å–å„è¯·æ±‚å¤´ä¿¡æ¯ \u0026lt;%@ page language=\u0026#34;java\u0026#34; contentType=\u0026#34;text/html; charset=ISO-8859-1\u0026#34; pageEncoding=\u0026#34;ISO-8859-1\u0026#34;%\u0026gt; \u0026lt;% out.println(\u0026#34;Protocol: \u0026#34; + request.getProtocol()); out.println(\u0026#34;Server Name: \u0026#34; + request.getServerName()); out.","title":"Nginxè¯·æ±‚å¤´proxy_set_header"},{"content":"","date":"9 December 2018","permalink":"/tags/docker/","section":"Tags","summary":"","title":"Docker"},{"content":"å‰è¨€ # éšç€å…¬å¸å®¹å™¨ç®¡ç†å¹³å°éƒ¨ç½²çš„ç³»ç»Ÿè¶Šæ¥è¶Šå¤šï¼Œæ‰€çº³ç®¡é›†ç¾¤ä¸»æœºä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œé¢å¯¹å¤§è§„æ¨¡çš„æ–‡ä»¶å’Œé•œåƒåˆ†å‘ï¼Œç”±äºå•ä¸€æ–‡ä»¶æœåŠ¡å™¨ã€é•œåƒä»“åº“å®ä¾‹ä¼šå—åˆ°éƒ¨ç½²ä¸»æœºçš„ç½‘ç»œå¸¦å®½é™åˆ¶ï¼Œå¯¼è‡´åˆ†å‘è€—æ—¶é•¿ã€æˆåŠŸç‡ä½çš„é—®é¢˜ã€‚åˆ©ç”¨P2PæŠ€æœ¯æ­å»ºæ–‡ä»¶å’Œé•œåƒçš„åˆ†å‘ç³»ç»Ÿï¼Œæ–‡ä»¶å’Œé•œåƒå¯åœ¨é›†ç¾¤ä¸»æœºä¹‹é—´å…±äº«ä¼ è¾“ï¼Œå¯æœ‰æ•ˆè§£å†³ä¸Šè¿°é—®é¢˜ã€‚\nDragonflyç®€ä»‹ # é˜¿é‡Œå¼€æºï¼Œæ‰˜ç®¡åœ¨githubä¸Š https://github.com/dragonflyoss/Dragonfly\næ ¸å¿ƒç»„ä»¶ï¼š â€‹ 1) cluster manger: è¶…çº§èŠ‚ç‚¹ï¼ˆsupernodeï¼‰é›†ç¾¤ â€‹\t- ç®¡ç†peerèŠ‚ç‚¹æ³¨å†Œ â€‹\t- è´Ÿè´£CDNï¼Œä»æºæ–‡ä»¶æœåŠ¡å™¨ä¸‹è½½æ–‡ä»¶å¹¶ç”Ÿæˆæ•°æ®å—å­˜å‚¨ â€‹\t- è°ƒåº¦peerèŠ‚ç‚¹åœ¨P2Pç½‘ç»œä¸­é€‰æ‹©åˆé€‚çš„ä¸‹è½½æº â€‹ 2) dfget proxyï¼š â€‹\tdfgetæ˜¯p2på®¢æˆ·ç«¯ï¼Œéƒ¨ç½²åœ¨peerèŠ‚ç‚¹ä¸Šï¼Œè´Ÿè´£æ•°æ®å—çš„ä¸‹è½½å’Œå…±äº«ã€‚åœ¨é•œåƒåˆ†å‘ç³»ç»Ÿä¸­ä¹Ÿå«dfdaemon\nDragonflyé•œåƒåˆ†å‘çš„å·¥ä½œæ¨¡å¼: â€‹\t1) dfdaemon æ‹¦æˆªpeerèŠ‚ç‚¹docker pullçš„HTTPè¯·æ±‚ï¼Œä»é•œåƒä»“åº“æœåŠ¡å™¨è·å–åˆ°é•œåƒmanifestæ–‡ä»¶åï¼Œä½¿ç”¨dfgetå‘supernodeé›†ç¾¤è¯·æ±‚ä¸‹è½½é•œåƒçš„å„layeræ–‡ä»¶ â€‹\t2) supernodeä»é•œåƒä»“åº“6ä¸‹è½½é•œåƒlayeræ–‡ä»¶å¹¶ç”Ÿæˆæ•°æ®å— â€‹\t3) peerèŠ‚ç‚¹é€šè¿‡dfgetä¸‹è½½æ•°æ®å—ï¼Œä¸‹è½½å®Œæˆåsupernodeè°ƒåº¦åç»­peerèŠ‚ç‚¹ä»¥P2Pæ–¹å¼è¿›è¡Œæ•°æ®å—ä¸‹è½½ â€‹\t4) æ‰€æœ‰layeræ–‡ä»¶é€šè¿‡dfgetä¸‹è½½å®Œæˆåï¼Œdockerè¿›ç¨‹æ ¹æ®manifestsæ–‡ä»¶æ•´åˆä¸ºæœ¬åœ°é•œåƒï¼Œå¹¶æŒ‰ç…§é•œåƒè§„èŒƒä¿å­˜å„é•œåƒlayer\nDragonflyé•œåƒåˆ†å‘ç³»ç»Ÿçš„æ­å»º # ä¸€ã€èŠ‚ç‚¹è§„åˆ’\nIP roles services 192.168.196.134 supernode,registry,webserver docker,supernode,docker-distribution,nginx 192.168.196.2 supernode docker,supernode 192.168.196.3 peer docker äºŒã€ä¸‹è½½æºç  â€‹\tæœ€è¿‘ä¸€æ¬¡releaseçš„ç‰ˆæœ¬0.2.0ï¼Œåœ¨èŠ‚ç‚¹192.168.196.134ä¸Šæ‰§è¡Œç¼–è¯‘ã€‚\n$ mkdir /data/dragonfly $ cd /data/dragonfly $ wget https://github.com/dragonflyoss/Dragonfly/archive/v0.2.0.tar.gz -O Dragonfly-0.2.0.tar.gz $ tar xf Dragonfly-0.2.0.tar.gz ä¸‰ã€ç¼–è¯‘å®‰è£…supernode\nâ€‹\t3.1 ç¼–è¯‘ç¯å¢ƒå‡†å¤‡\nâ€‹\tsupernode.jaråŒ…ç¼–è¯‘ä¾èµ–maven (yum install maven)ï¼Œé•œåƒå®šåˆ¶ä¾èµ–dockeræœåŠ¡\nâ€‹\t3.2 ä¿®æ”¹é»˜è®¤æ³¨å†Œç«¯å£8001ä¸º48001åŠé»˜è®¤ä¸‹è½½æœåŠ¡ç«¯å£8002ä¸º48002\n$cd /data/dragonfly/Dragonfly-0.2.0/src/supernode/src/main/java/com/alibaba/dragonfly/supernode/common $ sed -i \u0026#39;s/8001/48001/\u0026#39; Constants.java $ cd /data/dragonfly/Dragonfly-0.2.0/src/supernode/src/main/docker/source $ cat nginx.conf ...... server { listen 48001; location / { root /home/admin/supernode/repo; } } server { listen 48002; location /peer { proxy_pass http://127.0.0.1:8080; } ...... â€‹\t3.3 ä¿®æ”¹DockerfileåŠé…ç½®æ–‡ä»¶\nâ€‹\tæœ¬ä¾‹ä¸­ä¸»æœºdockerç‰ˆæœ¬ä¸º1.13ä¸æ”¯æŒå¤šé˜¶æ®µå®šåˆ¶ï¼Œéœ€è¦ä¿®æ”¹Dockerfileæ–‡ä»¶\nâ€‹\tæ–°å»ºconfig.propertiesé…ç½®æ–‡ä»¶ï¼Œ å‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d7y.io/user_guide/supernode_configuration/\n$ cd /data/dragonfly/Dragonfly-0.2.0/src/supernode/src/main/docker $ cat Dockerfile #ç§æœ‰centos7.2é•œåƒ(å·²é…ç½®é˜¿é‡Œyumæº) FROM 192.168.196.134:5000/library/centos7.2:01 COPY sources /tmp/sources RUN yum install -y epel-release \u0026amp;\u0026amp; \\ yum install -y -q telnet nginx java-1.8.0-openjdk.x86_64 \u0026amp;\u0026amp; \\ cp /tmp/sources/start.sh /root/start.sh \u0026amp;\u0026amp; \\ cp /tmp/sources/nginx.conf /etc/nginx/nginx.conf \u0026amp;\u0026amp; \\ cp /tmp/sources/config.properties /root/config.properties \u0026amp;\u0026amp;\\ mkdir -p /home/admin/supernode/bin \u0026amp;\u0026amp; \\ cp /tmp/sources/start.sh /home/admin/supernode/bin/ \u0026amp;\u0026amp; \\ yum clean all \u0026amp;\u0026amp; \\ rm -rf /var/cache/yum /tmp/* \u0026amp;\u0026amp; \\ history -c ADD supernode.jar supernode.jar EXPOSE 48001 48002 ENTRYPOINT [\u0026#34;/root/start.sh\u0026#34;] $ cat source/config.properties supernode.cluster[0].ip = \u0026#39;192.168.196.134\u0026#39; supernode.cluster[0].registerPort = 48001 supernode.cluster[1].ip = \u0026#39;192.168.196.2\u0026#39; supernode.cluster[1].registerPort = 48001 $ cat source/start.sh #!/usr/bin/env bash nginx java -Dspring.config.location=/root/config.properties -Djava.security.egd=file:/dev/./urandom -jar supernode.jar â€‹\t3.4 ç¼–è¯‘supernode\nâ€‹\tå‚è€ƒå®˜æ–¹æ–‡æ¡£ https://d7y.io/user_guide/install_server/\n$ cd /data/dragonfly/Dragonfly-0.2.0 $ ./build/build.sh supernode $ docker images supernode REPOSITORY TAG IMAGE ID CREATED SIZE supernode 0.2.0 aac72150e4a0 2 minutes ago 493 MB â€‹\t3.5 å¯åŠ¨supernodeæœåŠ¡\n$ docker run -d -p 48001:48001 -p 48002:48002 supernode:0.2.0 394df40d13eded44f78e943b49bbd233bf19258f777c0c42586ae969db39f142 $ docker ps -l CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES bafcf15d15ae supernode:0.2.0 \u0026#34;/root/start.sh\u0026#34; 30 seconds ago Up 26 seconds 0.0.0.0:48001-48002-\u0026gt;48001-48002/tcp stupefied_meninsky $ telnet localhost 48001 Trying ::1... Connected to localhost. Escape character is \u0026#39;^]\u0026#39;. ^] telnet\u0026gt; quit Connection closed. $ telnet localhost 48002 Trying ::1... Connected to localhost. Escape character is \u0026#39;^]\u0026#39;. ^] telnet\u0026gt; quit Connection closed. # å°†supernodeé•œåƒæ¨åˆ°ç§æœ‰ä»“åº“ $ docker tag supernode:0.2.0 192.168.196.134:5000/library/supernode:0.2.0 $ docker push 192.168.196.134:5000 # åœ¨192.168.196.2ä¸Špullé•œåƒå¹¶å¯åŠ¨supernodeå®ä¾‹ $ docker pull 192.168.196.134:5000/library/supernode:0.2.0 $ docker run -d --net host 192.168.196.134:5000/library/supernode:0.2.0 1c9bef1f4c14f4427291ecff793bef6665a617c71e10cb13c481d56763430b2d $ ss -ntl State Recv-Q Send-Q Local Address:Port Peer Address:Port LISTEN 0 128 *:22 *:* LISTEN 0 128 *:48001 *:* LISTEN 0 128 *:48002 *:* LISTEN 0 100 :::8080 :::* LISTEN 0 128 :::22 :::* å››ã€ç¼–è¯‘å®‰è£…df-client\nâ€‹\t4.1 ç¼–è¯‘ç¯å¢ƒå‡†å¤‡\nâ€‹\tä¾èµ–goç¯å¢ƒï¼Œéœ€è¦å®‰è£…golint\n$ yum install -y make go #é»˜è®¤GOPATH $ cd /root/go/src #GFWä¸‹çš„å®‰è£…æ–¹æ³• $ git clone https://github.com/golang/tools.git tools $ git clone https://github.com/golang/lint.git $ mkdir -p golang.org/x $ cp github.com/golang/lint/ golang.org/x/ -a $ go install /root/go/src/golang.org/x/lint/golint $ cp /root/go/bin/golint /usr/local/sbin/ â€‹\t4.2 ä¿®æ”¹dfgetè¯·æ±‚supernodeä¸‹è½½ç«¯å£8002ä¸º48002\n$ cd/data/dragonfly/Dragonfly-0.2.0/src/getter $ sed -i \u0026#39;s/8002/48002/\u0026#39; env.py $ sed -i \u0026#39;s/8002/48002/\u0026#39; component/httputil.py #core/server.pyä¸­æœ‰å…³peerèŠ‚ç‚¹æ•°æ®å—å­˜å‚¨æ—¶é—´çš„ä»£ç ï¼Œé»˜è®¤180s #98 expire_time = 180 #135 alive_qu.get(True, 5 * 60.0) â€‹\t4.3 ç¼–è¯‘df-client\nâ€‹\tå‚è€ƒæ–‡æ¡£ https://d7y.io/user_guide/install_client/\n$ cd /data/dragonfly/Dragonfly-0.2.0/build/client $ ./configure --prefix=/data/dragonfly $ make \u0026amp;\u0026amp; make install # å°†ç¼–è¯‘å¥½çš„df-clientï¼Œæ‰“åŒ…ä¼ åˆ°192.168.196.3èŠ‚ç‚¹ä¸Š $ cd /data/dragonfly $ tar cf df-client.tar df-client/ $ scp df-client.tar 192.168.196.3:/data/ â€‹\t4.4 åœ¨peerèŠ‚ç‚¹192.168.196.3å®‰è£…df-client\nâ€‹\t1) æ–°å»º/etc/dragonfly.confé…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šè¦æ³¨å†Œçš„supernodeé›†ç¾¤\n$ cat /etc/dragonfly.conf [node] address=192.168.196.2,192.168.196.134 â€‹\t2) ä¿®æ”¹docker daemon.jsonæ–‡ä»¶\n# é…ç½®registry-mirrors $ cat /etc/docker/daemon.json { \u0026#34;insecure-registries\u0026#34;: [\u0026#34;0.0.0.0/0\u0026#34;], \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;http://127.0.0.1:65001\u0026#34;] } $ systemctl restart docker.service â€‹\t3) å¯åŠ¨dfdaemon\n$ export PATH=/data/df-client:$PATH $ nohup dfdaemon --registry 192.168.196.134:5000 \u0026amp; $ cat nohup.out launch dfdaemon on port:65001 $ ss -ntl State Recv-Q Send-Q Local Address:Port Peer Address:Port LISTEN 0 128 *:22 *:* LISTEN 0 128 :::22 :::* LISTEN 0 128 :::65001 :::* $ cd /root/.small-dragonfly/logs $ cat dfdaemon.log time=\u0026#34;2018-09-12 21:10:00\u0026#34; level=info msg=init... time=\u0026#34;2018-09-12 21:10:00\u0026#34; level=info msg=\u0026#34;dfget version:0.2.0\\n\u0026#34; time=\u0026#34;2018-09-12 21:10:00\u0026#34; level=info msg=\u0026#34;init finish\u0026#34; time=\u0026#34;2018-09-12 21:10:00\u0026#34; level=info msg=\u0026#34;start dfdaemon param:\u0026amp;{DfPath:/data/df-client/dfget DFRepo:/root/.small-dragonfly/dfdaemon/data/ RateLimit:20M CallSystem:com_ops_dragonfly URLFilter:Signature\u0026amp;Expires\u0026amp;OSSAccessKeyId Notbs:true MaxProcs:4 Version:false Verbose:false Help:false HostIP:127.0.0.1 Port:65001 Registry:192.168.196.134:5000 DownRule: CertFile: KeyFile:}\u0026#34; äº”ã€é•œåƒåˆ†å‘æµ‹è¯•\nâ€‹\tç§æœ‰é•œåƒä»“åº“é•œåƒï¼š\nâ€‹\t192.168.196.134:5000/library/supernode:0.2.0 â€‹\t192.168.196.134:5000/testnasp/nginx:0.1\nâ€‹\tåœ¨peerèŠ‚ç‚¹ä¸Š pullé•œåƒï¼š\n$ docker pull testnasp/nginx:0.1 Trying to pull repository docker.io/testnasp/nginx ... 0.1: Pulling from docker.io/testnasp/nginx ed070c36b93c: Pull complete 07e00549345e: Pull complete c68fedf2fd94: Pull complete Digest: sha256:2ff1929d16fb3df64564eeb91686bb07e585ed365ab3601e1fed164ff3dc4bc4 Status: Downloaded newer image for docker.io/testnasp/nginx:0.1 $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE docker.io/testnasp/nginx 0.1 cd5239a0906a 6 months ago 109 MB # pullé•œåƒæ—¶å¯ä»¥æŸ¥çœ‹dfgetæ—¥å¿— $ cd /root/.small-dragonfly/logs $ tailf dfdaemon.log time=\u0026#34;2018-09-12 21:45:00\u0026#34; level=info msg=\u0026#34;start download url:http://192.168.196.134:5000/v2/testnasp/nginx/blobs/sha256:07e00549345efcbf93e50fc43440a05315c3ed049c28b7e7b709c1515b6550e0 to f5da0b91-b417-4f90-8a66-7ab99c5f581b in repo\u0026#34; time=\u0026#34;2018-09-12 21:45:00\u0026#34; level=info msg=\u0026#34;start download url:http://192.168.196.134:5000/v2/testnasp/nginx/blobs/sha256:ed070c36b93c24fc135fd9541fc687a8fb0664192a6c8e3397644e365944221a to 0afb237f-c0d1-4ee4-a8d0-ec43cfe69109 in repo\u0026#34; time=\u0026#34;2018-09-12 21:45:00\u0026#34; level=info msg=\u0026#34;dfget url:http://192.168.196.134:5000/v2/testnasp/nginx/blobs/sha256:07e00549345efcbf93e50fc43440a05315c3ed049c28b7e7b709c1515b6550e0 [SUCCESS] cost:20s\u0026#34; time=\u0026#34;2018-09-12 21:45:00\u0026#34; level=info msg=\u0026#34;dfget url:http://192.168.196.134:5000/v2/testnasp/nginx/blobs/sha256:ed070c36b93c24fc135fd9541fc687a8fb0664192a6c8e3397644e365944221a [SUCCESS] cost:22s\u0026#34; $ cat dfclient.log [2018-09-12 21:45:45,160] INFO sign:1719-1544622329.923 lineno:51 : cmd params:Namespace(callsystem=\u0026#39;com_ops_dragonfly\u0026#39;, console=False, dfdaemon=True, filter=\u0026#39;Signature\u0026amp;Expires\u0026amp;OSSAccessKeyId\u0026#39;, header=[\u0026#39;User-Agent:docker/1.13.1 go/go1.8.3 kernel/3.10.0-693.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/1.13.1 \\\\(linux\\\\))\u0026#39;, \u0026#39;Accept-Encoding:identity\u0026#39;, \u0026#39;X-Forwarded-For:127.0.0.1\u0026#39;], identifier=None, locallimit=\u0026#39;20M\u0026#39;, md5=None, node=None, notbs=True, output=\u0026#39;/root/.small-dragonfly/dfdaemon/data/f5da0b91-b417-4f90-8a66-7ab99c5f581b\u0026#39;, pattern=None, showbar=False, timeout=None, totallimit=\u0026#39;20M\u0026#39;, url=\u0026#39;http://192.168.196.134:5000/v2/testnasp/nginx/blobs/sha256:07e00549345efcbf93e50fc43440a05315c3ed049c28b7e7b709c1515b6550e0\u0026#39;, version=False),python version:sys.version_info(major=2, minor=7, micro=5, releaselevel=\u0026#39;final\u0026#39;, serial=0) ...ä¸­é—´çœç•¥... [2018-09-12 21:45:50,965] INFO sign:1720-1544622330.044 lineno:109 : move src:/root/.small-dragonfly/data/0afb237f-c0d1-4ee4-a8d0-ec43cfe69109-1720-1544622330.044 to dst:/root/.small-dragonfly/dfdaemon/data/0afb237f-c0d1-4ee4-a8d0-ec43cfe69109 result:True cost:0.057 [2018-09-12 21:45:50,965] INFO sign:1720-1544622330.044 lineno:195 : download successfully from dragonfly [2018-09-12 21:45:51,003] INFO sign:1720-1544622330.044 lineno:60 : local http result:success for path:/client/ and cost:0.002 [2018-09-12 21:45:51,003] INFO sign:1720-1544622330.044 lineno:94 : |7773d958cc784318c36095a405f4aa918d0c7ca45f7cad12c3e08c68fbca68fb|http://192.168.196.134:5000/v2/testnasp/nginx/blobs/sha256:ed070c36b93c24fc135fd9541fc687a8fb0664192a6c8e3397644e365944221a|22496029|22496059|192.168.196.134|com_ops_dragonfly|20.957| [2018-09-12 21:45:51,003] INFO sign:1720-1544622330.044 lineno:111 : download SUCCESS cost:20.959s length:22496029 reason:0 Tipsï¼š\nè¦åˆ†å‘çš„é•œåƒå‘½åç©ºé—´æ˜¯libraryæ—¶ï¼Œè¦æ³¨æ„peerèŠ‚ç‚¹pullä¸‹çš„é•œåƒåå­—\n$ docker pull library/supernode:0.2.0 Trying to pull repository docker.io/library/supernode ... 0.2.0: Pulling from docker.io/library/supernode 89ac44988659: Already exists 58f1be4f44ca: Already exists 8de7fe9b2274: Pull complete adfad6e78041: Pull complete 802d3ffa4c82: Pull complete Digest: sha256:4b49d1655f518be7fa5b450df887a54519a57a462ca289ea21ab3d9e54fc846c Status: Downloaded newer image for docker.io/supernode:0.2.0 $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE docker.io/supernode 0.2.0 aac72150e4a0 5 days ago 493 MB dfdaemonä¹Ÿå¯ä»¥å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä½¿ç”¨hostæ¨¡å¼è¿è¡Œå³å¯ã€‚è¿˜æœ‰è¦æ³¨æ„,ç›®å‰ä¸€ä¸ªdfdaemonåªèƒ½æŒ‡å®šä¸€ä¸ªä»“åº“åœ°å€ã€‚\n","date":"9 December 2018","permalink":"/2018/12/docker-dragonfly/","section":"åšå®¢","summary":"\u003ch4 class=\"relative group\"\u003eå‰è¨€ \n    \u003cdiv id=\"å‰è¨€\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e5%89%8d%e8%a8%80\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003eéšç€å…¬å¸å®¹å™¨ç®¡ç†å¹³å°éƒ¨ç½²çš„ç³»ç»Ÿè¶Šæ¥è¶Šå¤šï¼Œæ‰€çº³ç®¡é›†ç¾¤ä¸»æœºä¹Ÿè¶Šæ¥è¶Šå¤šï¼Œé¢å¯¹å¤§è§„æ¨¡çš„æ–‡ä»¶å’Œé•œåƒåˆ†å‘ï¼Œç”±äºå•ä¸€æ–‡ä»¶æœåŠ¡å™¨ã€é•œåƒä»“åº“å®ä¾‹ä¼šå—åˆ°éƒ¨ç½²ä¸»æœºçš„ç½‘ç»œå¸¦å®½é™åˆ¶ï¼Œå¯¼è‡´åˆ†å‘è€—æ—¶é•¿ã€æˆåŠŸç‡ä½çš„é—®é¢˜ã€‚åˆ©ç”¨P2PæŠ€æœ¯æ­å»ºæ–‡ä»¶å’Œé•œåƒçš„åˆ†å‘ç³»ç»Ÿï¼Œæ–‡ä»¶å’Œé•œåƒå¯åœ¨é›†ç¾¤ä¸»æœºä¹‹é—´å…±äº«ä¼ è¾“ï¼Œå¯æœ‰æ•ˆè§£å†³ä¸Šè¿°é—®é¢˜ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e","title":"P2Pæ–‡ä»¶ä¸é•œåƒåˆ†å‘å¼€æºè§£å†³æ–¹æ¡ˆDragonflyå®‰è£…éƒ¨ç½²"},{"content":" k8sæ˜¯ä¸€ä¸ªGoogleå¼€æºçš„å®¹å™¨é›†ç¾¤ç®¡ç†å¹³å°ï¼Œå¦‚ä»Šé£é¡ä¸€æ—¶ï¼Œäº†è§£å¹¶æŒæ¡è¿™é—¨æŠ€æœ¯å˜å¾—å°¤ä¸ºé‡è¦ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•æ­å»ºä¸€å¥—ç®€å•çš„k8sé›†ç¾¤å¹¶éƒ¨ç½²podã€kubernetes-dashboardã€‚å…³äºk8sæ¶æ„åŠå…¶ç»„ä»¶çš„è¯¦ç»†æ¦‚å¿µè¯·è‡ªè¡Œæœç´¢æŸ¥é˜…ã€‚\né›†ç¾¤èŠ‚ç‚¹è§„åˆ’åŠæ¶æ„ # èŠ‚ç‚¹ IP service master 192.168.196.134 etcd,flannel,docker,kubernetes-master,docker-distribution,nginx node1 192.168.196.135 flannel,docker,kubernetes-node node2 192.168.196.136 flannel,docker,kubernetes-node å¯¹äºé«˜å¯ç”¨å’Œå®¹é”™çš„Kubernetesç”Ÿäº§å’Œéƒ¨ç½²ï¼Œéœ€è¦å¤šä¸ªä¸»èŠ‚ç‚¹å’Œä¸€ä¸ªå•ç‹¬çš„etcdé›†ç¾¤\næœåŠ¡å®‰è£… # etcd # æ‰€æœ‰å…³äºé›†ç¾¤çŠ¶æ€çš„é…ç½®ä¿¡æ¯éƒ½ä»¥key/valueå¯¹çš„å½¢å¼å­˜å‚¨åœ¨etcdä¸­ï¼Œè¿™äº›çŠ¶æ€æ˜¾ç¤ºäº†é›†ç¾¤ä¸­åŒ…å«çš„èŠ‚ç‚¹å’Œéœ€è¦åœ¨å…¶ä¸­è¿è¡Œçš„pods æœ¬ä¾‹åªæ˜¯etcdå•æœºéƒ¨ç½²ï¼Œåœ¨masterèŠ‚ç‚¹ä¸Šyumå®‰è£…etcdå¹¶ä¿®æ”¹etcd.confï¼Œå¯åŠ¨etcd\n$ grep ^[^#] /etc/etcd/etcd.conf ETCD_DATA_DIR=\u0026#34;/var/lib/etcd/default.etcd\u0026#34; ETCD_LISTEN_CLIENT_URLS=\u0026#34;http://192.168.196.134:2379\u0026#34; ETCD_NAME=etcd1 ETCD_INITIAL_ADVERTISE_PEER_URLS=\u0026#34;http://192.168.196.134:2380\u0026#34; ETCD_ADVERTISE_CLIENT_URLS=\u0026#34;http://192.168.196.134:2379\u0026#34; ETCD_INITIAL_CLUSTER=\u0026#34;etcd1=http://192.168.196.134:2380\u0026#34; $ ss -ntl|egrep \u0026#34;2379|2380\u0026#34; LISTEN 0 128 192.168.196.134:2379 *:* LISTEN 0 128 127.0.0.1:2380 *:* #etcdctlç®€å•å‘½ä»¤ $ etcdctl --endpoints http://192.168.196.134:2379 mkdir /testdir $ etcdctl --endpoints http://192.168.196.134:2379 ls /testdir $ etcdctl --endpoints http://192.168.196.134:2379 ls / /testdir $ etcdctl --endpoints http://192.168.196.134:2379 mk /testdir/testkey testvalue testvalue $ etcdctl --endpoints http://192.168.196.134:2379 get /testdir/testkey testvalue $ etcdctl --endpoints http://192.168.196.134:2379 rm /testdir/testkey PrevNode.Value: testvalue $ etcdctl --endpoints http://192.168.196.134:2379 rmdir /testdir flannel # overlayç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œå®ç°podåˆ°podä¹‹é—´çš„ç½‘ç»œé€šä¿¡ï¼Œå¹¶ä¸ºæ¯ä¸ªpodæä¾›å”¯ä¸€çš„IPåœ°å€\nå„èŠ‚ç‚¹yumå®‰è£…flannelï¼Œä¿®æ”¹/etc/sysconfig/flanneld $ grep ^[^#] /etc/sysconfig/flanneld FLANNEL_ETCD_ENDPOINTS=\u0026#34;http://192.168.196.134:2379\u0026#34; FLANNEL_ETCD_PREFIX=\u0026#34;/atomic.io/network\u0026#34; \u0026lt;--å®šä¹‰åœ¨etcdä¸­å­˜å‚¨çš„ç›®å½• FLANNEL_OPTIONS=\u0026#34;-iface=ens34 -ip-masq=true\u0026#34; åœ¨etcdä¸­æ‰‹åŠ¨åˆ›å»ºè‡ªå®šä¹‰flannelç½‘æ®µçš„åœ°å€æ± 10.55.0/16 $ etcdctl --endpoints http://192.168.196.134:2379 mkdir /atomic.io $ etcdctl --endpoints http://192.168.196.134:2379 mkdir /atomic.io/network $ etcdctl --endpoints http://192.168.196.134:2379 mk /atomic.io/network/config \u0026#39;{\u0026#34;Network\u0026#34;: \u0026#34;10.55.0.0/16\u0026#34;}\u0026#39; {\u0026#34;Network\u0026#34;: \u0026#34;10.55.0.0/16\u0026#34;} å„èŠ‚ç‚¹å¯åŠ¨flanneldæœåŠ¡ï¼Œå¯æŸ¥çœ‹flannel0æ¡¥éšæœºåˆ†é…çš„åœ°å€ # masterèŠ‚ç‚¹ $ ifconfig flannel0 | grep -A1 flannel0 flannel0: flags=4305\u0026lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST\u0026gt; mtu 1472 inet 10.55.68.0 netmask 255.255.0.0 destination 10.55.68.0 # flannelé…ç½®ä¿¡æ¯å­˜åœ¨subnet.envæ–‡ä»¶ $ cat /var/run/flannel/subnet.env FLANNEL_NETWORK=10.55.0.0/16 FLANNEL_SUBNET=10.55.68.1/24 FLANNEL_MTU=1472 FLANNEL_IPMASQ=true # node1èŠ‚ç‚¹ $ ifconfig flannel0 | grep -A1 flannel0 flannel0: flags=4305\u0026lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST\u0026gt; mtu 1472 inet 10.55.91.0 netmask 255.255.0.0 destination 10.55.91.0 # node2èŠ‚ç‚¹ $ ifconfig flannel0 | grep -A1 flannel flannel0: flags=4305\u0026lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST\u0026gt; mtu 1472 inet 10.55.2.0 netmask 255.255.0.0 destination 10.55.2.0 registry # â€‹\tä¸ºé›†ç¾¤æ­å»ºç§æœ‰é•œåƒä»“åº“ï¼Œå¯ä»¥ä»dockerHubä¸Šæ‹‰å–é•œåƒå¯åŠ¨ï¼Œä¹Ÿå¯ä»¥yumå®‰è£…docker-distributionå’Œnginxè¿›è¡Œæ­å»ºï¼Œæœ¬æ–‡ä½¿ç”¨åä¸€ç§æ–¹æ³•\nåœ¨masterèŠ‚ç‚¹ä¸Šï¼Œyumå®‰è£…docker-distributionå¹¶ä¿®æ”¹config.yml,å¯åŠ¨æœåŠ¡ $ cat /etc/docker-distribution/registry/config.yml version: 0.1 log: fields: service: registry storage: cache: layerinfo: inmemory filesystem: rootdirectory: /var/lib/registry \u0026lt;--å­˜å‚¨è·¯å¾„ http: addr: 127.0.0.1:5000 \u0026lt;--ç›‘å¬åœ°å€å’Œç«¯å£ åœ¨masterèŠ‚ç‚¹ï¼Œyumå®‰è£…nginxï¼Œæ–°å»ºä¸€ä¸ªä»£ç†åˆ°åç«¯registryçš„nginxé…ç½®æ–‡ä»¶registry.conf,å¯åŠ¨æœåŠ¡ $ cat /etc/nginx/conf.d/registry.conf server { listen 8088; server_name registry; client_max_body_size 0; location / { proxy_pass http://127.0.0.1:5000; proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504; proxy_redirect off; proxy_buffering off; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } # 8080å’Œ5000ç«¯å£å·²ç›‘å¬ $ netstat -ntl Proto Recv-Q Send-Q Local Address Foreign Address State tcp 0 0 192.168.196.134:2379 0.0.0.0:* LISTEN tcp 0 0 127.0.0.1:2380 0.0.0.0:* LISTEN tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN tcp 0 0 0.0.0.0:8088 0.0.0.0:* LISTEN tcp 0 0 127.0.0.1:25 0.0.0.0:* LISTEN tcp 0 0 127.0.0.1:5000 0.0.0.0:* LISTEN tcp6 0 0 :::80 :::* LISTEN tcp6 0 0 :::22 :::* LISTEN tcp6 0 0 ::1:25 :::* LISTEN ä¿®æ”¹å„èŠ‚ç‚¹/etc/hostsæ–‡ä»¶ï¼Œé…ç½®registryè§£æï¼Œä»¥masterèŠ‚ç‚¹ä¸ºä¾‹ $ cat /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 192.168.196.134 registry 192.168.196.135 node1 192.168.196.136 node2 # éªŒè¯é•œåƒä»“åº“æœåŠ¡æ˜¯å¦æ­£å¸¸ $ curl -Lv registry:8088/v2 * About to connect() to registry port 8088 (#0) * Trying 192.168.196.134... * Connected to registry (192.168.196.134) port 8088 (#0) \u0026gt; GET /v2 HTTP/1.1 \u0026gt; User-Agent: curl/7.29.0 \u0026gt; Host: registry:8088 \u0026gt; Accept: */* \u0026gt; \u0026lt; HTTP/1.1 301 Moved Permanently \u0026lt; Server: nginx/1.12.2 \u0026lt; Date: Tue, 03 Jul 2018 14:45:49 GMT \u0026lt; Content-Type: text/html; charset=utf-8 \u0026lt; Content-Length: 39 \u0026lt; Connection: keep-alive \u0026lt; Docker-Distribution-Api-Version: registry/2.0 \u0026lt; Location: /v2/ \u0026lt; * Ignoring the response-body * Connection #0 to host registry left intact * Issue another request to this URL: \u0026#39;HTTP://registry:8088/v2/\u0026#39; * Found bundle for host registry: 0x78fee0 * Re-using existing connection! (#0) with host registry * Connected to registry (192.168.196.134) port 8088 (#0) \u0026gt; GET /v2/ HTTP/1.1 \u0026gt; User-Agent: curl/7.29.0 \u0026gt; Host: registry:8088 \u0026gt; Accept: */* \u0026gt; \u0026lt; HTTP/1.1 200 OK \u0026lt; Server: nginx/1.12.2 \u0026lt; Date: Tue, 03 Jul 2018 14:45:49 GMT \u0026lt; Content-Type: application/json; charset=utf-8 \u0026lt; Content-Length: 2 \u0026lt; Connection: keep-alive \u0026lt; Docker-Distribution-Api-Version: registry/2.0 \u0026lt; * Connection #0 to host registry left intact {} docker # 1.masterèŠ‚ç‚¹yumå®‰è£… docker-engine-1.13.1-1\nä¿®æ”¹/etc/docker/daemon.json $ cat /etc/docker/daemon.json { \u0026#34;storage-driver\u0026#34;: \u0026#34;devicemapper\u0026#34;, \u0026#34;storage-opts\u0026#34;: [ \u0026#34;dm.thinpooldev=/dev/mapper/docker--vg-thinpool\u0026#34;, \u0026#34;dm.use_deferred_removal=true\u0026#34;, \u0026#34;dm.use_deferred_deletion=true\u0026#34; ], \u0026#34;graph\u0026#34;: \u0026#34;/docker\u0026#34;, \u0026#34;insecure-registries\u0026#34;: [\u0026#34;registry:8088\u0026#34;] \u0026lt;--é…ç½®é•œåƒä»“åº“åœ°å€ } ä¿®æ”¹/usr/lib/systemd/system/docker.service åŠ å…¥$DOCKER_NETWORK_OPTIONSå¯åŠ¨å‚æ•°ï¼Œå¦åˆ™dockeræ— æ³•æ ¹æ®flannelæœåŠ¡éšæœºåˆ†é…çš„ç½‘æ®µé…ç½®docker0ç½‘æ¡¥ [service]ä¸‹æ·»åŠ ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPTï¼›å¦åˆ™ï¼Œdockerå¯åŠ¨åFORWARDé“¾çš„é»˜è®¤ç­–ç•¥ä¸ºDROP $vi /usr/lib/systemd/system/docker.service ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT #flannelæœåŠ¡å¯åŠ¨åä¼šè‡ªåŠ¨ç”Ÿæˆ/var/run/flannel/dockeræ–‡ä»¶ï¼Œå¯ç”¨äºæŒ‡å®šdockerçš„ç›¸å…³ç½‘ç»œå‚æ•° $ cat /var/run/flannel/docker DOCKER_OPT_BIP=\u0026#34;--bip=10.55.68.1/24\u0026#34; DOCKER_OPT_IPMASQ=\u0026#34;--ip-masq=false\u0026#34; DOCKER_OPT_MTU=\u0026#34;--mtu=1472\u0026#34; DOCKER_NETWORK_OPTIONS=\u0026#34; --bip=10.55.68.1/24 --ip-masq=false --mtu=1472\u0026#34; å¯åŠ¨docker $ systemctl daemon-reload $ systemctl start docker $ ifconfig|grep -A1 \u0026#34;docker0\\|flannel0\u0026#34; docker0: flags=4099\u0026lt;UP,BROADCAST,MULTICAST\u0026gt; mtu 1500 inet 10.55.68.1 netmask 255.255.255.0 broadcast 0.0.0.0 -- flannel0: flags=4305\u0026lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST\u0026gt; mtu 1472 inet 10.55.68.0 netmask 255.255.0.0 destination 10.55.68.0 $ docker info | grep -A2 Insecure Insecure Registries: registry:8088 127.0.0.0/8 2.node1èŠ‚ç‚¹å’Œnode2èŠ‚ç‚¹yumå®‰è£…docker-1.13.1\næ·»åŠ é•œåƒä»“åº“åœ°å€ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶/etc/sysconfig/docker $ grep ^[^#] /etc/sysconfig/docker OPTIONS=\u0026#39;--selinux-enabled --log-driver=journald --signature-verification=false -g /docker\u0026#39; if [ -z \u0026#34;${DOCKER_CERT_PATH}\u0026#34; ]; then DOCKER_CERT_PATH=/etc/docker fi ADD_REGISTRY=\u0026#34;--add-registry registry\u0026#34; INSECURE_REGISTRY=\u0026#34;--insecure-registry registry:8088\u0026#34; ä¿®æ”¹/usr/lib/systemd/system/docker.service\n[service]ä¸‹æ·»åŠ ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPTï¼›å¦åˆ™ï¼Œdockerå¯åŠ¨åFORWARDé“¾çš„é»˜è®¤ç­–ç•¥ä¸ºDROP\nå¯åŠ¨dockeræœåŠ¡\n$ systemctl daemon-reload $ systemctl start docker $ ifconfig |grep -A1 \u0026#34;docker0\\|flannel\u0026#34; docker0: flags=4099\u0026lt;UP,BROADCAST,MULTICAST\u0026gt; mtu 1500 inet 10.55.2.1 netmask 255.255.255.0 broadcast 0.0.0.0 -- flannel0: flags=4305\u0026lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST\u0026gt; mtu 1472 inet 10.55.2.0 netmask 255.255.0.0 destination 10.55.2.0 $ docker info|grep -A2 Insecure Insecure Registries: registry:8088 127.0.0.0/8 kubernetes-master # masterèŠ‚ç‚¹yumå®‰è£…kubernetes-masterï¼Œä¿®æ”¹/etc/kubernetes/ä¸‹çš„é…ç½®æ–‡ä»¶ $ls /etc/kubernetes/ apiserver config controller-manager scheduler #configä¸­çš„é…ç½®ä¸ºapiserverã€controller-manageråŠschedulerçš„é€šç”¨é…ç½®é¡¹ $ grep ^[^#] /etc/kubernetes/config KUBE_LOGTOSTDERR=\u0026#34;--logtostderr=true\u0026#34; KUBE_LOG_LEVEL=\u0026#34;--v=0\u0026#34; KUBE_ALLOW_PRIV=\u0026#34;--allow-privileged=false\u0026#34; KUBE_MASTER=\u0026#34;--master=http://192.168.196.134:8080\u0026#34; \u0026lt;--æŒ‡å®šapiserveråœ°å€åŠç«¯å£ $ grep ^[^#] /etc/kubernetes/apiserver KUBE_API_ADDRESS=\u0026#34;--insecure-bind-address=0.0.0.0\u0026#34; KUBE_ETCD_SERVERS=\u0026#34;--etcd-servers=http://192.168.196.134:2379\u0026#34; \u0026lt;--etcdæœåŠ¡åœ°å€ KUBE_SERVICE_ADDRESSES=\u0026#34;--service-cluster-ip-range=10.254.0.0/16\u0026#34; \u0026lt;--k8sé›†ç¾¤çš„serviceç½‘æ®µ KUBE_ADMISSION_CONTROL=\u0026#34;--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota\u0026#34; KUBE_API_ARGS=\u0026#34;\u0026#34; masterèŠ‚ç‚¹ä¸Šå¯åŠ¨kube-apiserverã€kube-schedulerã€kube-controller-manageræœåŠ¡\n2.1 Kubernetes API Server: é€šè¿‡kube-apiserverè¿›ç¨‹æä¾›æœåŠ¡ï¼›ç”¨æˆ·é€šè¿‡Restæ“ä½œæˆ–kubectl cliä¸API Serveräº¤äº’ï¼›å®ƒç”¨äºæ‰€æœ‰ä¸APIå¯¹è±¡ï¼ˆPodã€RCã€Serviceç­‰ï¼‰ç›¸å…³çš„æ“ä½œ(å¦‚å¢ã€åˆ ã€æ”¹ã€æŸ¥åŠwatchç­‰)ï¼Œæ˜¯é›†ç¾¤å†…å„åŠŸèƒ½æ¨¡å—ä¹‹é—´æ•°æ®äº¤äº’å’Œé€šä¿¡çš„ä¸­å¿ƒæ¢çº½ã€‚ 2.2 Controller Manager: é›†ç¾¤å†…éƒ¨çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒï¼Œè´Ÿè´£é›†ç¾¤å†…çš„Nodeã€Podå‰¯æœ¬ã€æœåŠ¡ç«¯ç‚¹ï¼ˆEndpointï¼‰ã€å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ã€æœåŠ¡è´¦å·ï¼ˆserviceAccountï¼‰ã€èµ„æºå®šé¢ï¼ˆResourceQuotaï¼‰ç­‰çš„ç®¡ç†ï¼Œæä¾›è‡ªæ„ˆåŠŸèƒ½ï¼Œç¡®ä¿é›†ç¾¤å§‹ç»ˆå¤„äºé¢„æœŸçš„å·¥ä½œçŠ¶æ€ 2.3 Scheduler: è´Ÿè´£Podçš„è°ƒåº¦ï¼Œå°†å¾…è°ƒåº¦çš„Pod(APIæ–°åˆ›å»ºçš„Podã€Controller Managerä¸ºè¡¥è¶³å‰¯æœ¬è€Œåˆ›å»ºçš„Podç­‰)æŒ‰ç…§ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œè°ƒåº¦ç­–ç•¥ç»‘å®šåˆ°é›†ç¾¤ä¸­æŸä¸ªnodeä¸Šï¼Œå¹¶å°†ç»‘å®šä¿¡æ¯å†™å…¥etcd\n$ systemctl start kube-apiserver.service kube-scheduler.service kube-controller-manager.service # ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·æµ‹è¯• $ kubectl -s 192.168.196.134:8080 --version Kubernetes v1.5.2 kubernetes-node # node1/node2èŠ‚ç‚¹yumå®‰è£…kubernetes-nodeï¼Œä¿®æ”¹/etc/kubernetes/ä¸‹çš„é…ç½®æ–‡ä»¶ #configä¸­çš„é…ç½®ä¸ºkubeletåŠkube-proxyçš„é€šç”¨é…ç½®é¡¹ $ grep ^[^#] /etc/kubernetes/config KUBE_LOGTOSTDERR=\u0026#34;--logtostderr=true\u0026#34; KUBE_LOG_LEVEL=\u0026#34;--v=0\u0026#34; KUBE_ALLOW_PRIV=\u0026#34;--allow-privileged=false\u0026#34; KUBE_MASTER=\u0026#34;--master=lhttp://192.168.196.134:8080\u0026#34; $ grep ^[^#] /etc/kubernetes/kubelet KUBELET_ADDRESS=\u0026#34;--address=0.0.0.0\u0026#34; KUBELET_HOSTNAME=\u0026#34;--hostname-override=node1\u0026#34; \u0026lt;--æ³¨æ„node1/node2çš„åŒºåˆ« KUBELET_API_SERVER=\u0026#34;--api-servers=http://192.168.196.134:8080\u0026#34; KUBELET_POD_INFRA_CONTAINER=\u0026#34;--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest\u0026#34; \u0026lt;--éšpodä¸€èµ·å¯åŠ¨çš„å®¹å™¨çš„é•œåƒ KUBELET_ARGS=\u0026#34;\u0026#34; åœ¨nodeèŠ‚ç‚¹ä¸Šå¯åŠ¨kubeletã€kube-proxy\n2.1 kubelet: å¤„ç†MasterèŠ‚ç‚¹ä¸‹å‘åˆ°æœ¬èŠ‚ç‚¹çš„ä»»åŠ¡ï¼Œç®¡ç†PodåŠPodä¸­çš„å®¹å™¨ï¼ˆé€šè¿‡API Serverç›‘å¬Scheduleräº§ç”Ÿçš„Podç»‘å®ševentï¼‰ï¼›æ¯ä¸ªkubeletè¿›ç¨‹ä¼šåœ¨API Serverä¸Šæ³¨å†ŒèŠ‚ç‚¹è‡ªèº«ä¿¡æ¯ï¼Œå®šæœŸå‘MasterèŠ‚ç‚¹æ±‡æŠ¥èŠ‚ç‚¹èµ„æºçš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶é€šè¿‡cAdvisorç›‘æ§å®¹å™¨å’ŒèŠ‚ç‚¹èµ„æºã€‚ 2.2 kube-proxy: kube-proxyæœåŠ¡è¿›ç¨‹ï¼Œå¯ä»¥çœ‹åšæ˜¯serviceçš„é€æ˜ä»£ç†å…¼è´Ÿè½½å‡è¡¡ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯å°†åˆ°æŸä¸ªserviceçš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¤šä¸ªPodå®ä¾‹ä¸Šï¼Œäº‹å®ä¸Šæ˜¯é€šè¿‡iptablesçš„NATè½¬æ¢æ¥å®ç°çš„ã€‚Serviceæ˜¯å¯¹ä¸€ç»„Podçš„æŠ½è±¡ï¼Œåˆ›å»ºæ—¶å¯è¢«åˆ†é…ä¸€ä¸ªè™šæ‹Ÿçš„Cluster IPã€‚\n$ systemctl start kubelet.service kube-proxy.service # ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·æµ‹è¯• $ kubectl -s 192.168.196.134:8080 get node NAME STATUS AGE node1 Ready 2m node2 Ready 2m éƒ¨ç½²ç¤ºä¾‹ # 1.æŸ¥çœ‹å½“å‰ç‰ˆæœ¬çš„kubernetesæœåŠ¡æ”¯æŒçš„APIç±»å‹åŠç‰ˆæœ¬\n$ curl 192.168.196.134:8080 { \u0026#34;paths\u0026#34;: [ \u0026#34;/api\u0026#34;, \u0026#34;/api/v1\u0026#34;, \u0026#34;/apis\u0026#34;, \u0026#34;/apis/apps\u0026#34;, \u0026#34;/apis/apps/v1beta1\u0026#34;, \u0026#34;/apis/authentication.k8s.io\u0026#34;, \u0026#34;/apis/authentication.k8s.io/v1beta1\u0026#34;, \u0026#34;/apis/authorization.k8s.io\u0026#34;, \u0026#34;/apis/authorization.k8s.io/v1beta1\u0026#34;, \u0026#34;/apis/autoscaling\u0026#34;, \u0026#34;/apis/autoscaling/v1\u0026#34;, \u0026#34;/apis/batch\u0026#34;, \u0026#34;/apis/batch/v1\u0026#34;, \u0026#34;/apis/batch/v2alpha1\u0026#34;, \u0026#34;/apis/certificates.k8s.io\u0026#34;, \u0026#34;/apis/certificates.k8s.io/v1alpha1\u0026#34;, \u0026#34;/apis/extensions\u0026#34;, \u0026#34;/apis/extensions/v1beta1\u0026#34;, \u0026#34;/apis/policy\u0026#34;, \u0026#34;/apis/policy/v1beta1\u0026#34;, \u0026#34;/apis/rbac.authorization.k8s.io\u0026#34;, \u0026#34;/apis/rbac.authorization.k8s.io/v1alpha1\u0026#34;, \u0026#34;/apis/storage.k8s.io\u0026#34;, \u0026#34;/apis/storage.k8s.io/v1beta1\u0026#34;, \u0026#34;/healthz\u0026#34;, \u0026#34;/healthz/ping\u0026#34;, \u0026#34;/healthz/poststarthook/bootstrap-controller\u0026#34;, \u0026#34;/healthz/poststarthook/extensions/third-party-resources\u0026#34;, \u0026#34;/healthz/poststarthook/rbac/bootstrap-roles\u0026#34;, \u0026#34;/logs\u0026#34;, \u0026#34;/metrics\u0026#34;, \u0026#34;/swaggerapi/\u0026#34;, \u0026#34;/ui/\u0026#34;, \u0026#34;/version\u0026#34; ] } 2.éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡çš„deploymentç¤ºä¾‹\n$ cat deployment-nginx.yml apiVersion: extensions/v1beta1 \u0026lt;--æŒ‡å®šAPIversion kind: Deployment \u0026lt;--æŒ‡å®šèµ„æºç±»å‹ä¸ºdeployment metadata: name: deployment-nginx \u0026lt;--deploymentçš„åç§° spec: replicas: 2 \u0026lt;--æœŸæœ›podçš„å‰¯æœ¬æ•° revisionHistoryLimit: 10 template: metadata: labels: \u0026lt;--podæ ‡ç­¾ app: nginx spec: containers: - name: nginx image: registry:8088/nginx:latest ports: - containerPort: 80 $ kubectl -s 192.168.196.134:8080 create -f deployment-nginx.yml æŸ¥çœ‹deploymentä¿¡æ¯\ngetæŸ¥è¯¢æŸä¸ªresourceçš„è¯¦ç»†ä¿¡æ¯ï¼ŒdescribeæŸ¥è¯¢æŸä¸ªresourceç›¸å…³çš„çŠ¶æ€ä¿¡æ¯\n$ kubectl -s 192.168.196.134:8080 get deployment NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE deployment-nginx 2 2 2 2 7d $ kubectl -s 192.168.196.134:8080 describe deployment Name: deployment-nginx Namespace: default CreationTimestamp: Fri, 27 Jul 2018 13:37:02 +0800 Labels: app=nginx Selector: app=nginx Replicas: 2 updated | 2 total | 2 available | 0 unavailable StrategyType: RollingUpdate MinReadySeconds: 0 RollingUpdateStrategy: 1 max unavailable, 1 max surge Conditions: Type Status Reason ---- ------ ------ Available True MinimumReplicasAvailable OldReplicaSets: \u0026lt;none\u0026gt; NewReplicaSet: deployment-nginx-2481570099 (2/2 replicas created) No events. $ kubectl -s 192.168.196.134:8080 get deployment -o yaml \u0026lt;--æ”¯æŒå¯¼å‡ºä¸ºjsonå’Œyamlæ ¼å¼ apiVersion: v1 items: - apiVersion: extensions/v1beta1 kind: Deployment metadata: annotations: deployment.kubernetes.io/revision: \u0026#34;1\u0026#34; creationTimestamp: 2018-07-27T05:37:02Z generation: 1 labels: app: nginx name: deployment-nginx namespace: default resourceVersion: \u0026#34;88336\u0026#34; selfLink: /apis/extensions/v1beta1/namespaces/default/deployments/deployment-nginx uid: 16ed87a7-915f-11e8-a083-000c29815d48 spec: replicas: 2 revisionHistoryLimit: 10 selector: matchLabels: app: nginx strategy: rollingUpdate: maxSurge: 1 maxUnavailable: 1 type: RollingUpdate template: metadata: creationTimestamp: null labels: app: nginx spec: containers: - image: registry:8088/nginx:latest imagePullPolicy: Always name: nginx ports: - containerPort: 80 protocol: TCP resources: {} terminationMessagePath: /dev/termination-log dnsPolicy: ClusterFirst restartPolicy: Always securityContext: {} terminationGracePeriodSeconds: 30 status: availableReplicas: 2 conditions: - lastTransitionTime: 2018-07-30T05:36:05Z lastUpdateTime: 2018-07-30T05:36:05Z message: Deployment has minimum availability. reason: MinimumReplicasAvailable status: \u0026#34;True\u0026#34; type: Available observedGeneration: 1 replicas: 2 updatedReplicas: 2 kind: List metadata: {} resourceVersion: \u0026#34;\u0026#34; selfLink: \u0026#34;\u0026#34; æŸ¥çœ‹podçš„ä¿¡æ¯ # podæ‰€éƒ¨ç½²çš„èŠ‚ç‚¹åŠåˆ†é…çš„IP $ kubectl -s 192.168.196.134:8080 get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE deployment-nginx-2481570099-cfkhn 1/1 Running 4 7d 10.55.2.2 node2 deployment-nginx-2481570099-q6xv8 1/1 Running 3 7d 10.55.91.2 node1 #é™¤äº†é€šè¿‡get/describeæŸ¥è¯¢podçš„å…¨éƒ¨ä¿¡æ¯ï¼Œè¿˜å¯ä»¥é€šè¿‡templateæŠ“å–æŒ‡å®škeyçš„å€¼ $ kubectl -s 192.168.196.134:8080 get pod -o template \\ deployment-nginx-2481570099-cfkhn --template={{.status.podIP}} 10.55.2.2 éªŒè¯flannelç½‘ç»œä¸‹podçš„è¿é€šæ€§ #ç™»å½•åˆ°node1ä¸Š $ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 17485262b0a6 registry:8088/nginx:latest \u0026#34;nginx -g \u0026#39;daemon ...\u0026#34; 5 hours ago Up 5 hours k8s_nginx.4f504e9_deployment-nginx-2481570099-q6xv8_default_16f355db-915f-11e8-a083-000c29815d48_e2f3c24d dc1833e50415 registry:8088/pod-infrastructure:v3.4 \u0026#34;/pod\u0026#34; 5 hours ago Up 5 hours k8s_POD.ee70020d_deployment-nginx-2481570099-q6xv8_default_16f355db-915f-11e8-a083-000c29815d48_7c54ed33 #è®¿é—®æœ¬èŠ‚ç‚¹ä¸Šçš„podæœåŠ¡ $ curl 10.55.91.2:80 Welcome to nginx! # è®¿é—®node2èŠ‚ç‚¹ä¸Šçš„podæœåŠ¡ $ curl 10.55.2.2:80 Welcome to nginx! #ç™»å½•åˆ°node2ä¸Š $ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES c087c12e8afd registry:8088/nginx:latest \u0026#34;nginx -g \u0026#39;daemon off\u0026#34; 5 hours ago Up 5 hours k8s_nginx.4f504e9_deployment-nginx-2481570099-cfkhn_default_16f36465-915f-11e8-a083-000c29815d48_80f894f4 195f5d3de8c1 registry:8088/pod-infrastructure:v3.4 \u0026#34;/pod\u0026#34; 5 hours ago Up 5 hours k8s_POD.ee70020d_deployment-nginx-2481570099-cfkhn_default_16f36465-915f-11e8-a083-000c29815d48_e4b4e2e1 #è®¿é—®æœ¬èŠ‚ç‚¹ä¸Šçš„podæœåŠ¡ $ curl 10.55.2.2:80 Welcome to nginx! # è®¿é—®node2èŠ‚ç‚¹ä¸Šçš„podæœåŠ¡ $ curl 10.55.91.2:80 Welcome to nginx! #åŒæ ·çš„masterèŠ‚ç‚¹ä¹Ÿé…ç½®flanneç½‘ç»œï¼Œå¯è®¿é—®podçš„åº”ç”¨ 3.éƒ¨ç½²serviceç¤ºä¾‹\n#ä¸ºéƒ¨ç½²çš„podåˆ›å»ºservice $ cat service-nginx.yml kind: Service apiVersion: v1 metadata: name: service-nginx spec: ports: - port: 80 \u0026lt;-- serviceçš„è®¿é—®ç«¯å£ targetPort: 80 \u0026lt;-- nginxå®¹å™¨æœåŠ¡ç«¯å£ selector: app: nginx \u0026lt;-- ä»¥podæ ‡ç­¾è¯†åˆ«è¦ä»£ç†çš„åç«¯åº”ç”¨ type: NodePort \u0026lt;-- è´Ÿè½½å‡è¡¡ä¸ºè½®è¯¢ #NodePortæ¨¡å¼ä¸º ç»‘å®šåˆ°podæ‰€åœ¨NodeèŠ‚ç‚¹çš„ç½‘å¡ï¼Œå¯¹å¤–æä¾›æœåŠ¡ï¼Œç«¯å£ä¸ºNodePort(ä¸æŒ‡å®šæ—¶éšæœºåˆ†é…) $ kubectl -s 192.168.196.134:8080 create -f service-nginx.yml #æŸ¥çœ‹service-nginxçš„è¯¦ç»†ä¿¡æ¯ $ kubectl -s 192.168.196.134:8080 get service -o wide service-nginx NAME CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR service-nginx 10.254.104.158 \u0026lt;nodes\u0026gt; 80:30284/TCP 7d app=nginx $ kubectl -s 192.168.196.134:8080 get service -o yaml service-nginx apiVersion: v1 kind: Service metadata: creationTimestamp: 2018-07-27T07:01:04Z name: service-nginx namespace: default resourceVersion: \u0026#34;17086\u0026#34; selfLink: /api/v1/namespaces/default/services/service-nginx uid: d437faec-916a-11e8-a083-000c29815d48 spec: clusterIP: 10.254.104.158 \u0026lt;-- ä¸ºserviceåˆ†é…çš„éšæœºclusterIP ports: - nodePort: 30284 \u0026lt;--ç»‘å®šåˆ°nodeèŠ‚ç‚¹ç‰©ç†ç½‘å¡çš„éšæœºç«¯å£ port: 80 protocol: TCP targetPort: 80 selector: app: nginx sessionAffinity: None \u0026lt;-- 1ï¼‰ type: NodePort status: loadBalancer: {} 1)é»˜è®¤è´Ÿè½½ç­–ç•¥ä¸ºè½®è¯¢ï¼Œå¯æŒ‡å®šsessionAffinityçš„å€¼ä¸ºclientIPå®ç°sessionç»‘å®š $ kubectl -s 192.168.196.134:8080 describe service service-nginx Name: service-nginx Namespace: default Labels: \u0026lt;none\u0026gt; Selector: app=nginx Type: NodePort IP: 10.254.104.158 Port: \u0026lt;unset\u0026gt; 80/TCP NodePort: \u0026lt;unset\u0026gt; 30284/TCP Endpoints: 10.55.2.2:80,10.55.91.2:80 Session Affinity: None No events. #åœ¨ä»»æ„nodeèŠ‚ç‚¹ä¸Šè®¿é—®service-nginxç»‘å®šçš„ClusterIP:Port $ curl 10.254.104.158:80 Welcome to nginx! #é€šè¿‡ç›‘æµ‹ä¸¤ä¸ªnodeçš„nginxè®¿é—®æ—¥å¿—å¯ä»¥çœ‹å‡ºæ˜¯è½¬å‘ç­–ç•¥ä¸ºè½®è¯¢ #åœ¨ä»»æ„èŠ‚ç‚¹ä¸Šè®¿é—®service-naginxç»‘å®šåœ¨ä¸»æœºç½‘å¡ä¸Šçš„NodePort [root@master ~]# curl 192.168.196.136:30284 Welcome to nginx! [root@master ~]# curl 192.168.196.135:30284 Welcome to nginx! [root@node1 ~]# curl 192.168.196.135:30284 Welcome to nginx! [root@node1 ~]# curl 192.168.196.136:30284 Welcome to nginx! [root@node2 ~]# curl 192.168.196.136:30284 Welcome to nginx! [root@node2 ~]# curl 192.168.196.135:30284 Welcome to nginx! 4.éƒ¨ç½²kubernetes dashboard â€‹\tgithubä¸Šé¡¹ç›®åœ°å€https://github.com/kubernetes/dashboard\nç”±äºå®‰è£…çš„k8sæœåŠ¡ç‰ˆæœ¬ä¸ºv1.5.2ï¼Œè¿™é‡Œé€‰æ‹©dashboard releaseç‰ˆæœ¬ä¸ºv1.5.0çš„é•œåƒï¼Œdockerhubä¸Šæœç´¢å¹¶pullåˆ°æœ¬åœ°( https://hub.docker.com/r/ist0ne/kubernetes-dashboard-amd64/ )ï¼Œæ‰“æ ‡ç­¾æ¨åˆ°ç§æœ‰ä»“åº“ è·å–githubä¸Šdashboardçš„éƒ¨ç½²æ–‡ä»¶ $ wget https://raw.githubusercontent.com/kubernetes/dashboard/v1.5.0/src/deploy/kubernetes-dashboard.yaml ä¿®æ”¹kubernetes-dashboard.yamlæ–‡ä»¶ä¸­\nimage: registry:8088/kubernetes-dashboard-amd64:v1.5.0 \u0026ndash;apiserver-host=http://192.168.196.134:8080 éƒ¨ç½²dashboard\n$ kubectl -s 192.168.196.134:8080 create -f kubernetes-dashboard.yaml deployment \u0026#34;kubernetes-dashboard\u0026#34; created service \u0026#34;kubernetes-dashboard\u0026#34; created è¿™é‡Œè¦æ³¨æ„ï¼Œkubernetes-dashboardéƒ¨ç½²çš„namespaceä¸ºkube-systemè€Œä¸æ˜¯defaultï¼Œéœ€åœ¨å‘½ä»¤è¡ŒæŒ‡å®š -n kube-systemæˆ–è€…\u0026ndash;namespace=kube-systemæ‰èƒ½è·å–åˆ°å¯¹åº”çš„èµ„æºä¿¡æ¯\næµè§ˆå™¨è®¿é—®192.168.196.134:8080/ui ","date":"9 August 2018","permalink":"/2018/08/k8s-deploy/","section":"åšå®¢","summary":"k8sæ˜¯ä¸€ä¸ªGoogleå¼€æºçš„å®¹å™¨é›†ç¾¤ç®¡ç†å¹³å°ï¼Œå¦‚ä»Šé£é¡ä¸€æ—¶ï¼Œäº†è§£å¹¶æŒæ¡è¿™é—¨æŠ€æœ¯å˜å¾—å°¤ä¸ºé‡è¦ã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•æ­å»ºä¸€å¥—ç®€å•çš„k8sé›†ç¾¤å¹¶éƒ¨ç½²podã€kubernetes-dashboardã€‚å…³äºk8sæ¶æ„åŠå…¶ç»„ä»¶çš„è¯¦ç»†æ¦‚å¿µè¯·è‡ªè¡Œæœç´¢æŸ¥é˜…ã€‚\né›†ç¾¤èŠ‚ç‚¹è§„åˆ’åŠæ¶æ„ # èŠ‚ç‚¹ IP service master 192.168.196.134 etcd,flannel,docker,kubernetes-master,docker-distribution,nginx node1 192.168.196.135 flannel,docker,kubernetes-node node2 192.168.196.136 flannel,docker,kubernetes-node å¯¹äºé«˜å¯ç”¨å’Œå®¹é”™çš„Kubernetesç”Ÿäº§å’Œéƒ¨ç½²ï¼Œéœ€è¦å¤šä¸ªä¸»èŠ‚ç‚¹å’Œä¸€ä¸ªå•ç‹¬çš„etcdé›†ç¾¤\næœåŠ¡å®‰è£… # etcd # æ‰€æœ‰å…³äºé›†ç¾¤çŠ¶æ€çš„é…ç½®ä¿¡æ¯éƒ½ä»¥key/valueå¯¹çš„å½¢å¼å­˜å‚¨åœ¨etcdä¸­ï¼Œè¿™äº›çŠ¶æ€æ˜¾ç¤ºäº†é›†ç¾¤ä¸­åŒ…å«çš„èŠ‚ç‚¹å’Œéœ€è¦åœ¨å…¶ä¸­è¿è¡Œçš„pods æœ¬ä¾‹åªæ˜¯etcdå•æœºéƒ¨ç½²ï¼Œåœ¨masterèŠ‚ç‚¹ä¸Šyumå®‰è£…etcdå¹¶ä¿®æ”¹etcd.confï¼Œå¯åŠ¨etcd\n$ grep ^[^#] /etc/etcd/etcd.conf ETCD_DATA_DIR=\u0026#34;/var/lib/etcd/default.etcd\u0026#34; ETCD_LISTEN_CLIENT_URLS=\u0026#34;http://192.168.196.134:2379\u0026#34; ETCD_NAME=etcd1 ETCD_INITIAL_ADVERTISE_PEER_URLS=\u0026#34;http://192.","title":"Kubernetesé›†ç¾¤éƒ¨ç½²"},{"content":"","date":"8 August 2018","permalink":"/tags/ca/","section":"Tags","summary":"","title":"CA"},{"content":"èƒŒæ™¯ # é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨é…ç½®docker daemonçš„ç›‘å¬æ–¹å¼ä¸ºæœ¬åœ°çš„socketå’Œå¼€æ”¾TCPç«¯å£ï¼ŒdockeræœåŠ¡å…è®¸è¿œç¨‹è®¿é—®ï¼Œæ–¹ä¾¿å¯¹dockeré›†ç¾¤çš„ä¸»æœºæ‰§è¡Œç®¡ç†å‘½ä»¤åŠè°ƒç”¨ç­‰ã€‚å¦‚æœä¸ä½¿ç”¨TLSåŠ å¯†dockerï¼Œä»»æ„å®¢æˆ·ç«¯éƒ½å¯ä»¥å¯¹dockerä¸»æœºè¿›è¡Œè¿œç¨‹æ“ä½œï¼Œæœ‰å¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚è€Œé…ç½®TLSåï¼Œåªæœ‰ä¿¡ä»»çš„å®¢æˆ·ç«¯æ‰å¯ä»¥è¿œç¨‹è®¿é—®dockeræœåŠ¡ã€‚\nTLSè®¤è¯é…ç½® # è‡ªç­¾åçš„è¯ä¹¦\u0026mdash;ä½¿ç”¨opensslåˆ›å»ºç§æœ‰CAå¹¶ç­¾å‘å…¬é’¥ #ç”Ÿæˆæ ¹è¯ä¹¦RSAç§é’¥,123456ä½ç§é’¥æ–‡ä»¶çš„å¯†ç  $ openssl genrsa -aes256 -passout pass:123456 -out cakey.pem 2048 Generating RSA private key, 2048 bit long modulus ........+++ ......................+++ e is 65537 (0x10001) #ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ $ openssl req -new -x509 -days 365 -key cakey.pem -passin pass:123456 -sha256 -out ca.pem -subj \u0026#34;/C=CN/ST=./L=./O=./CN=192.168.196.136\u0026#34; #ç”Ÿæˆserverç§é’¥ $ openssl genrsa -out server.key 2048 Generating RSA private key, 2048 bit long modulus .....................................................................+++ ...............+++ e is 65537 (0x10001) #æŒ‡å®šå…è®¸é€šè¿‡IPåœ°å€è®¿é—®çš„IPåˆ—è¡¨ï¼Œä½¿ç”¨é€—å·éš”å¼€ $ echo subjectAltName=IP:192.168.196.136 \u0026gt; extfile.cnf $ echo extendedKeyUsage=serverAuth \u0026gt;\u0026gt; extfile.cnf #ç”Ÿæˆserverè¯ä¹¦ç”³è¯·æ–‡ä»¶ $ openssl req -new -sha256 -key server.key -out server.csr -subj \u0026#34;/CN=server\u0026#34; #CAç­¾ç½²è¯ä¹¦ï¼Œå¹¶é¢å‘serverè¯ä¹¦ $ openssl x509 -passin pass:123456 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey cakey.pem -CAcreateserial -out server.crt -extfile extfile.cnf Signature ok subject=/CN=192.168.196.136 Getting CA Private Key #ç”Ÿæˆclientç§é’¥ $ openssl genrsa -out client.key 2048 Generating RSA private key, 2048 bit long modulus .................................................+++ ...................................................+++ e is 65537 (0x10001) #ç”Ÿæˆclientè¯ä¹¦ç”³è¯·æ–‡ä»¶ $ openssl req -new -sha256 -key client.key -out client.csr -subj \u0026#34;/CN=client\u0026#34; #CAç­¾ç½²è¯ä¹¦ï¼Œå¹¶é¢å‘clientè¯ä¹¦ $ openssl x509 -passin pass:123456 -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey cakey.pem -CAcreateserial -out client.crt -extfile extfile.cnf Signature ok subject=/CN=client Getting CA Private Key é…ç½®dockeræœåŠ¡å¼€å¯TLSè®¤è¯ #ä¿®æ”¹daemon.jsonæ–‡ä»¶ï¼Œé…ç½®dockeræœåŠ¡å¼€å¯TLSè®¤è¯ $ cat daemon.json { \u0026#34;hosts\u0026#34;: [\u0026#34;unix:///var/run/docker.sock\u0026#34;, \u0026#34;tcp://0.0.0.0:3666\u0026#34;], \u0026#34;insecure-registries\u0026#34;: [\u0026#34;registry:8088\u0026#34;], \u0026#34;tlsverify\u0026#34;:true, \u0026#34;tlscacert\u0026#34;:\u0026#34;/etc/docker/ca.pem\u0026#34;, \u0026#34;tlscert\u0026#34;:\u0026#34;/etc/docker/server.crt\u0026#34;, \u0026#34;tlskey\u0026#34;:\u0026#34;/etc/docker/server.key\u0026#34; } $ systemctl restart docker #åœ¨æœ¬æœºæ‰§è¡ŒéªŒè¯å‘½ä»¤ $ docker --tlsverify --tlscacert ca.pem --tlscert client.crt --tlskey=client.key -H tcp://192.168.196.136:3666 version Client: Version: 1.12.6 API version: 1.24 Package version: docker-1.12.6-61.git85d7426.el7.centos.x86_64 Go version: go1.8.3 Git commit: 85d7426/1.12.6 Built: Tue Oct 24 15:40:21 2017 OS/Arch: linux/amd64 Server: Version: 1.12.6 API version: 1.24 Package version: docker-1.12.6-61.git85d7426.el7.centos.x86_64 Go version: go1.8.3 Git commit: 85d7426/1.12.6 Built: Tue Oct 24 15:40:21 2017 OS/Arch: linux/amd64 åˆ†å‘keyæ–‡ä»¶åˆ°å®¢æˆ·ç«¯ï¼ŒéªŒè¯\nåªæœ‰æœ‰ç§˜é’¥æ–‡ä»¶çš„å®¢æˆ·ç«¯æ‰èƒ½è¿æ¥åˆ°æ­¤dockeræœåŠ¡å™¨ä¸Š\n$ scp ca.pem client.crt client.key 192.168.196.135:/root/ root@192.168.196.135\u0026#39;s password: ca.pem 100% 1245 1.2KB/s 00:00 client.crt 100% 1086 1.1KB/s 00:00 client.key 100% 1675 1.6KB/s 00:00 #ç™»å½•åˆ°135ä¸»æœº $ pwd /root $ docker --tlsverify --tlscacert ca.pem --tlscert client.crt --tlskey=client.key -H tcp://192.168.196.136:3666 version Client: Version: 1.13.1 API version: 1.24 (downgraded from 1.26) Package version: docker-1.12.6-61.git85d7426.el7.centos.x86_64 Go version: go1.9.4 Git commit: dded712/1.13.1 Built: Tue Jul 17 18:34:48 2018 OS/Arch: linux/amd64 Server: Version: 1.12.6 API version: 1.24 (minimum version ) Package version: docker-1.12.6-61.git85d7426.el7.centos.x86_64 Go version: go1.8.3 Git commit: 85d7426/1.12.6 Built: Tue Oct 24 15:40:21 2017 OS/Arch: linux/amd64 Experimental: false TLSè®¤è¯æ¨¡å¼ # æœåŠ¡ç«¯è®¤è¯æ¨¡å¼ é€‰é¡¹ è¯´æ˜ tlsverify, tlscacert, tlscert, tlskey å‘å®¢æˆ·ç«¯å‘é€æœåŠ¡ç«¯è¯ä¹¦, æ ¡éªŒå®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦ç”±æŒ‡å®šçš„CA(è‡ªç­¾åæ ¹è¯ä¹¦)ç­¾å‘ tls, tlscert, tlskey å‘å®¢æˆ·ç«¯å‘é€æœåŠ¡ç«¯è¯ä¹¦, ä¸æ ¡éªŒå®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦ç”±æŒ‡å®šçš„CA(è‡ªç­¾åæ ¹è¯ä¹¦)ç­¾å‘ å®¢æˆ·ç«¯è®¤è¯æ¨¡å¼ é€‰é¡¹ è¯´æ˜ tls æ ¡éªŒæœåŠ¡ç«¯è¯ä¹¦æ˜¯å¦ç”± å…¬å…±çš„CAæœºæ„ç­¾å‘ tlsverify, tlscacert æ ¡éªŒæœåŠ¡ç«¯è¯ä¹¦æ˜¯å¦ç”±æŒ‡å®šçš„CA(è‡ªç­¾åæ ¹è¯ä¹¦)ç­¾å‘ tls, tlscert, tlskey ä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯, ä½†ä¸æ ¡éªŒæœåŠ¡ç«¯è¯ä¹¦æ˜¯å¦ç”±æŒ‡å®šçš„CA(è‡ªç­¾åæ ¹è¯ä¹¦)ç­¾å‘ tlsverify, tlscacert, tlscert, tlskey ä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯ä¸”æ ¡éªŒæœåŠ¡ç«¯è¯ä¹¦æ˜¯å¦ç”±æŒ‡å®šçš„CA(è‡ªç­¾åæ ¹è¯ä¹¦)ç­¾å‘ â€‹\tå¼•ç”¨ä¸Šä¾‹ï¼Œæˆ‘ä»¬å°†ca.pemã€server.crtã€server.keyå¤åˆ¶åˆ°dockeré›†ç¾¤çš„192.168.196.135ä¸»æœºçš„/etc/docker/ç›®å½•ä¸‹ï¼Œå¹¶ä¿®æ”¹daemon.jsonå¼€å¯dockeræœåŠ¡TLSè®¤è¯ã€‚æ­¤æ—¶å®¢æˆ·ç«¯è®¤è¯æ¨¡å¼é€‰æ‹©ç¬¬å››ç§æ—¶ï¼Œä¼šæç¤ºserverè¯ä¹¦æ— æ•ˆï¼Œå› ä¸ºåœ¨ç­¾å‘è¯ä¹¦æ—¶æŒ‡å®šäº†å…è®¸é€šè¿‡IPåœ°å€è®¿é—®çš„IPä¸º192.168.196.135ã€‚\n#ç™»å½•åˆ°135ä¸»æœº $ cd $ docker --tlsverify --tlscacert ca.pem --tlscert client.crt --tlskey=client.key -H tcp://192.168.196.135:3666 version Client: Version: 1.13.1 API version: 1.26 Package version: error during connect: Get https://192.168.196.135:3666/v1.26/version: x509: certificate is valid for 192.168.196.136, not 192.168.196.135 $ docker --tls --tlscacert ca.pem --tlscert client.crt --tlskey=client.key -H tcp://192.168.196.135:3666 version Client: Version: 1.13.1 API version: 1.26 Package version: docker-1.13.1-68.gitdded712.el7.centos.x86_64 Go version: go1.9.4 Git commit: dded712/1.13.1 Built: Tue Jul 17 18:34:48 2018 OS/Arch: linux/amd64 Server: Version: 1.13.1 API version: 1.26 (minimum version 1.12) Package version: docker-1.13.1-68.gitdded712.el7.centos.x86_64 Go version: go1.9.4 Git commit: dded712/1.13.1 Built: Tue Jul 17 18:34:48 2018 OS/Arch: linux/amd64 Experimental: false â€‹\tå¦‚æœå®¢æˆ·ç«¯è®¤è¯æ¨¡å¼é€‰æ‹©ç¬¬å››ç§ï¼Œå¯ä»¥åœ¨ç­¾å‘serverè¯ä¹¦æ—¶ï¼Œå°†ç°æœ‰dockeré›†ç¾¤çš„IPæ·»åŠ åˆ°extfile.cnfï¼Œç„¶åæ‹·è´åˆ°é›†ç¾¤ä¸­çš„ä¸»æœºä¸Šï¼Œåˆ†åˆ«é…ç½®dockeræœåŠ¡å¼€å¯è®¤è¯å³å¯ï¼Œè€Œå¯¹äºåç»­æ–°æ·»åŠ èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦æ›´æ–°extfile.cnfå¹¶é‡æ–°ç­¾å‘serverè¯ä¹¦ã€‚\n$ echo subjectAltName=IP:192.168.196.136,IP:192.168.196.135 \u0026gt; extfile.cnf $ openssl x509 -passin pass:123456 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey cakey.pem -CAcreateserial -out server.crt -extfile extfile.cnf â€‹\tå¦‚æœå®¢æˆ·ç«¯è®¤è¯æ¨¡å¼é€‰æ‹©ä¸æ ¡éªŒæœåŠ¡ç«¯è¯ä¹¦ï¼Œåˆ™æ— éœ€æŒ‡å®šIPï¼Œç›´æ¥æ‹·è´ç­¾å‘çš„serverè¯ä¹¦åˆ°æ‰€æœ‰èŠ‚ç‚¹å³å¯\n","date":"8 August 2018","permalink":"/2018/08/docker-tls/","section":"åšå®¢","summary":"\u003ch4 class=\"relative group\"\u003eèƒŒæ™¯ \n    \u003cdiv id=\"èƒŒæ™¯\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e8%83%8c%e6%99%af\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h4\u003e\n\u003cblockquote\u003e\n\u003cp\u003eé€šå¸¸ï¼Œæˆ‘ä»¬åœ¨é…ç½®docker daemonçš„ç›‘å¬æ–¹å¼ä¸ºæœ¬åœ°çš„socketå’Œå¼€æ”¾TCPç«¯å£ï¼ŒdockeræœåŠ¡å…è®¸è¿œç¨‹è®¿é—®ï¼Œæ–¹ä¾¿å¯¹dockeré›†ç¾¤çš„ä¸»æœºæ‰§è¡Œç®¡ç†å‘½ä»¤åŠè°ƒç”¨ç­‰ã€‚å¦‚æœä¸ä½¿ç”¨TLSåŠ å¯†dockerï¼Œä»»æ„å®¢æˆ·ç«¯éƒ½å¯ä»¥å¯¹dockerä¸»æœºè¿›è¡Œè¿œç¨‹æ“ä½œï¼Œæœ‰å¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚è€Œé…ç½®TLSåï¼Œåªæœ‰ä¿¡ä»»çš„å®¢æˆ·ç«¯æ‰å¯ä»¥è¿œç¨‹è®¿é—®dockeræœåŠ¡ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e","title":"Dockeré…ç½®TLSå®‰å…¨è®¤è¯"},{"content":"","date":"8 August 2018","permalink":"/tags/openssl/","section":"Tags","summary":"","title":"openssl"},{"content":"èƒŒæ™¯ # å…¬å¸å®¹å™¨ç®¡ç†å¹³å°éœ€è¦å‘¨æœŸæ€§å¯¹weblogicé•œåƒè¿›è¡Œæ‰“è¡¥ä¸å‡çº§æ“ä½œï¼Œç”±äºdockerçš„åˆ†å±‚ç®¡ç†æœºåˆ¶ï¼Œweblogicé•œåƒä½“ç§¯ä¼šè¶Šæ¥è¶Šå¤§ï¼Œå½±å“åç»­çš„ç»´æŠ¤éƒ¨ç½²ã€‚æˆ‘å°±å†™äº†ä¸€ä¸ªæ‰¹é‡exporté•œåƒå¹¶æ¨é€è‡³é•œåƒä»“åº“çš„è„šæœ¬ï¼Œæ¥ç²¾ç®€é•œåƒå¤§å°\nè„šæœ¬è¿è¡Œç¤ºä¾‹ # è„šæœ¬æ‰§è¡Œæ­¥éª¤ # å‡†å¤‡é•œåƒåˆ—è¡¨æ–‡ä»¶\n$ cat images_list.txt \u0026lt;-- éœ€è¦exportçš„é•œåƒ registry:8088/nginx:latest registry:8088/kubernetes-dashboard-amd64:v1.5.0 #exportä¹‹å‰é•œåƒä»“åº“ä¸­çš„é•œåƒtag $ curl registry:8088/v2/nginx/tags/list {\u0026#34;name\u0026#34;:\u0026#34;nginx\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;latest\u0026#34;]} $ curl registry:8088/v2/kubernetes-dashboard-amd64/tags/list {\u0026#34;name\u0026#34;:\u0026#34;kubernetes-dashboard-amd64\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;v1.5.0\u0026#34;]} è¿è¡Œè„šæœ¬\n$ sh export-images.sh -h ------------------------------------------------------------------------- Usage: export_images.sh -f IMAGES_FILE -t IMAGE_TAG [-p THREAD_NUM] [-h] Description: IMAGES_FILE: the list of images need to be exported IMAGE_TAG: the target tag of exported images THREAD_NUM: the target thread numbers ------------------------------------------------------------------------- $ sh export-images.sh -f images_list.txt -t test -p 2 å¼€å§‹æ‰§è¡Œä»»åŠ¡ registry:8088/kubernetes-dashboard-amd64:test pushed registry:8088/nginx:test pushed ä»»åŠ¡æ‰§è¡Œç»“æŸ #exportä¹‹åé•œåƒä»“åº“ä¸­çš„é•œåƒtagï¼Œå¢åŠ äº†test $ curl registry:8088/v2/nginx/tags/list {\u0026#34;name\u0026#34;:\u0026#34;nginx\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;latest\u0026#34;,\u0026#34;test\u0026#34;]} $ curl registry:8088/v2/kubernetes-dashboard-amd64/tags/list {\u0026#34;name\u0026#34;:\u0026#34;kubernetes-dashboard-amd64\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;v1.5.0\u0026#34;,\u0026#34;test\u0026#34;]} æŸ¥çœ‹è„šæœ¬è¿è¡Œæ—¥å¿—\n$ cat export_images.log Trying to pull repository registry:8088/kubernetes-dashboard-amd64 ... v1.5.0: Pulling from registry:8088/kubernetes-dashboard-amd64 Digest: sha256:ddd3454819c089517b434a3ea42abf3c184fce9bf45704abf22513082d900eba Status: Image is up to date for registry:8088/kubernetes-dashboard-amd64:v1.5.0 .....ä¸­é—´çœç•¥..... Sending build context to Docker daemon 2.048 kB Step 1/5 : FROM registry:8088/kubernetes-dashboard-amd64:tmp ---\u0026gt; 17b601e3c483 .....ä¸­é—´çœç•¥..... Successfully built 8712115d0f0b Login Succeeded The push refers to a repository [registry:8088/nginx] .....ä¸­é—´çœç•¥..... registry:8088/kubernetes-dashboard-amd64:test pushed Untagged: registry:8088/kubernetes-dashboard-amd64:tmp Untagged: registry:8088/kubernetes-dashboard-amd64:test Untagged: registry:8088/kubernetes-dashboard-amd64@sha256:5c601d866b5a6b135fc6654417c4f8726661ce6903f00fc96ffe8127cdc272a0 .....ä¸­é—´çœç•¥..... Deleted: sha256:cc940a53e84603ed3886909d8150f456fc93d25abf85d5ea07099d92e33640d9 .....åé¢çœç•¥..... shellè„šæœ¬ # $ cat export-images.sh #!/bin/bash #Author:Feixiang Fu #set -x #æŒ‡å®šé•œåƒä»“åº“çš„éªŒè¯ç”¨æˆ·åŠå¯†ç  user_name=fufeixiang passwd=123456 tty=$(tty) usage(){ echo \u0026#34;--------------------------------------------------------------\u0026#34; echo \u0026#34;Usage:\u0026#34; echo -e \u0026#34;\\texport_images.sh -f IMAGES_FILE -t IMAGE_TAG [-p THREAD_NUM] [-h]\u0026#34; echo \u0026#34;Description:\u0026#34; echo -e \u0026#34;\\tIMAGES_FILE: the list of images need to be exported\u0026#34; echo -e \u0026#34;\\tIMAGE_TAG: the target tag of exported images\u0026#34; echo -e \u0026#34;\\tTHREAD_NUM: the target thread numbers\u0026#34; echo \u0026#34;--------------------------------------------------------------\u0026#34; exit -1 } function work(){ i=$RANDOM docker pull $org_image #éšæœºå®¹å™¨åç§° docker run -d --name container$i $org_image sh -c \u0026#34;tail -f /etc/hosts\u0026#34; docker export container$i \u0026gt; container${i}.tar docker import container${i}.tar $image_name:tmp docker rm -f container$i rm -rf container${i}.tar mkdir build-$i cat \u0026lt;\u0026lt;EOF \u0026gt; build-$i/Dockerfile FROM $image_name:tmp WORKDIR /app/bin ENTRYPOINT [\u0026#34;/usr/bin/dumb-init\u0026#34;,\u0026#34;--\u0026#34;] USER dcos CMD [\u0026#34;sh\u0026#34;, \u0026#34;/app/bin/startServer.sh\u0026#34;] EOF #exporté•œåƒä¹‹åï¼Œentrypoint/cmdç­‰ä¼šä¸¢å¤±ï¼Œéœ€è¦é‡æ–°å®šåˆ¶ docker build -t $image_name:$tag build-$i/ docker login -u $user_name -p $passwd $image_addr if [ \u0026#34;$?\u0026#34; -eq 0 ];then docker push $image_name:$tag \u0026amp;\u0026amp; echo -e \u0026#34;\\e[32m${image_name}:${tag} pushed\\e[0m\u0026#34; |tee $tty else echo -e \u0026#34;\\e[31mè´¦æˆ·${user_name}å¯†ç ä¸åŒ¹é…,${image_name}:${tag} push failed\\e[0m\u0026#34; |tee $tty fi #æ¸…ç†importçš„é•œåƒåŠbuildçš„æ–°é•œåƒ docker rmi $image_name:tmp $image_name:$tag } [ -z \u0026#34;$*\u0026#34; ] \u0026amp;\u0026amp; usage \u0026amp;\u0026amp; exit 1 while getopts \u0026#39;f:t:p:h\u0026#39; opt;do case $opt in f) IMAGES_FILE=\u0026#34;$OPTARG\u0026#34;;; t) tag=\u0026#34;$OPTARG\u0026#34;;; p) thread=\u0026#34;$OPTARG\u0026#34;;; h) usage;; ?) usage;; esac done echo \u0026#34;å¼€å§‹æ‰§è¡Œä»»åŠ¡\u0026#34; #æ”¯æŒå¤šè¿›ç¨‹æ¨¡å¼ mkfifo tmp.fifo exec 6\u0026lt;\u0026gt; tmp.fifo thread=${thread:-1} for ((j=0;j\u0026lt;$thread;j++)); do echo done \u0026gt;\u0026amp;6 while read line || [ -n \u0026#34;$line\u0026#34; ];do org_image=${line%% *} image_name=${line%:*} #user_name=`echo $line|cut -d\u0026#34; \u0026#34; -f2` #passwd=${line##* } image_addr=${line%%/*} read -u6 { work \u0026gt;\u0026gt; export_images.log echo \u0026gt;\u0026amp;6 } \u0026amp; done \u0026lt; $IMAGES_FILE wait exec 6\u0026gt;\u0026amp;- rm -rf tmp.fifo build-*/ echo \u0026#34;ä»»åŠ¡æ‰§è¡Œç»“æŸ\u0026#34; ","date":"7 August 2018","permalink":"/2018/08/docker-images-export/","section":"åšå®¢","summary":"èƒŒæ™¯ # å…¬å¸å®¹å™¨ç®¡ç†å¹³å°éœ€è¦å‘¨æœŸæ€§å¯¹weblogicé•œåƒè¿›è¡Œæ‰“è¡¥ä¸å‡çº§æ“ä½œï¼Œç”±äºdockerçš„åˆ†å±‚ç®¡ç†æœºåˆ¶ï¼Œweblogicé•œåƒä½“ç§¯ä¼šè¶Šæ¥è¶Šå¤§ï¼Œå½±å“åç»­çš„ç»´æŠ¤éƒ¨ç½²ã€‚æˆ‘å°±å†™äº†ä¸€ä¸ªæ‰¹é‡exporté•œåƒå¹¶æ¨é€è‡³é•œåƒä»“åº“çš„è„šæœ¬ï¼Œæ¥ç²¾ç®€é•œåƒå¤§å°\nè„šæœ¬è¿è¡Œç¤ºä¾‹ # è„šæœ¬æ‰§è¡Œæ­¥éª¤ # å‡†å¤‡é•œåƒåˆ—è¡¨æ–‡ä»¶\n$ cat images_list.txt \u0026lt;-- éœ€è¦exportçš„é•œåƒ registry:8088/nginx:latest registry:8088/kubernetes-dashboard-amd64:v1.5.0 #exportä¹‹å‰é•œåƒä»“åº“ä¸­çš„é•œåƒtag $ curl registry:8088/v2/nginx/tags/list {\u0026#34;name\u0026#34;:\u0026#34;nginx\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;latest\u0026#34;]} $ curl registry:8088/v2/kubernetes-dashboard-amd64/tags/list {\u0026#34;name\u0026#34;:\u0026#34;kubernetes-dashboard-amd64\u0026#34;,\u0026#34;tags\u0026#34;:[\u0026#34;v1.5.0\u0026#34;]} è¿è¡Œè„šæœ¬\n$ sh export-images.sh -h ------------------------------------------------------------------------- Usage: export_images.","title":"æ‰¹é‡export Dockeré•œåƒè„šæœ¬"},{"content":"","date":"23 July 2018","permalink":"/tags/go/","section":"Tags","summary":"","title":"go"},{"content":"1.jsonè§£æåˆ°Structç±»å‹\npackage main import ( \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; ) type Book struct { BookName string `json:\u0026#34;bookname\u0026#34;` AuthorName string `json:\u0026#34;authorname\u0026#34;` AuthorAge string `json:\u0026#34;authorage\u0026#34;` } func main() { jsonbuf := ` { \u0026#34;bookname\u0026#34;:\u0026#34;booker\u0026#34;, \u0026#34;authorname\u0026#34;: \u0026#34;Tom\u0026#34;, \u0026#34;authorage\u0026#34;: \u0026#34;28\u0026#34; }` var book Book err := json.Unmarshal([]byte(jsonbuf), \u0026amp;book) if err != nil { fmt.Println(err) return } fmt.Printf(\u0026#34;book = %+v\\n\u0026#34;, book) // book = {BookName:booker AuthorName:Tom AuthorAge:28} } 2.jsonè§£æåˆ°è‡ªå®šä¹‰ç±»å‹\ntype Unmarshaler interface { UnmarshalJSON([]byte) error } encoding/jsonåŒ…ä¸­å®šä¹‰äº†Unmarshaleræ¥å£ï¼Œé»˜è®¤UnmarshalJSONæ–¹æ³•æ˜¯å¯¹è¦è§£æçš„jsonæ•°æ®ä¸åšä»»ä½•å¤„ç†ã€‚æ‰€ä»¥è¦è§£æjsonæ•°æ®åˆ°è‡ªå®šä¹‰ç±»å‹ï¼Œæ­¤ç±»å‹éœ€å®ç°Unmarshaleræ¥å£ã€‚\npackage main import ( \u0026#34;bytes\u0026#34; \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;strings\u0026#34; ) type Book struct { BookName string `json:\u0026#34;bookname\u0026#34;` Author Author `json:\u0026#34;author\u0026#34;` } type Author struct { Name string Age string } // Authorç»“æ„ä½“å®ç°json.Unmarshaleræ¥å£ï¼Œè§£æjsonæ•°æ®æ—¶æ‰§è¡Œå…¶UnmarshalJSONæ–¹æ³• func (a *Author) UnmarshalJSON(data []byte) (err error) { str := string(bytes.Trim(data, `\u0026#34; `)) // åˆ é™¤è¦è§£æçš„dataä¸­çš„\u0026#34;å’Œç©ºæ ¼ split := strings.Split(str, \u0026#34;:\u0026#34;) if len(split) != 2 { return err } a.Name = split[0] a.Age = split[1] return nil } func main() { jsonbuf := ` { \u0026#34;bookname\u0026#34;:\u0026#34;booker\u0026#34;, \u0026#34;author\u0026#34;: \u0026#34;Tom:28\u0026#34; }` var book Book err := json.Unmarshal([]byte(jsonbuf), \u0026amp;book) if err != nil { fmt.Println(err) return } fmt.Printf(\u0026#34;book = %+v\\n\u0026#34;, book) // book = {BookName:booker Author:{Name:Tom Age:28}} } ","date":"23 July 2018","permalink":"/2018/07/golang-json/","section":"åšå®¢","summary":"1.jsonè§£æåˆ°Structç±»å‹\npackage main import ( \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; ) type Book struct { BookName string `json:\u0026#34;bookname\u0026#34;` AuthorName string `json:\u0026#34;authorname\u0026#34;` AuthorAge string `json:\u0026#34;authorage\u0026#34;` } func main() { jsonbuf := ` { \u0026#34;bookname\u0026#34;:\u0026#34;booker\u0026#34;, \u0026#34;authorname\u0026#34;: \u0026#34;Tom\u0026#34;, \u0026#34;authorage\u0026#34;: \u0026#34;28\u0026#34; }` var book Book err := json.","title":"Golangè‡ªå®šä¹‰jsonè§£æç±»å‹çš„å®ç°"},{"content":"","date":"8 May 2018","permalink":"/tags/direct-lvm/","section":"Tags","summary":"","title":"direct-lvm"},{"content":" devicemapperæ˜¯Linuxå‘è¡Œç‰ˆRHELä¸‹Docker Engineçš„é»˜è®¤å­˜å‚¨é©±åŠ¨ï¼Œå®ƒæœ‰ä¸¤ç§é…ç½®æ¨¡å¼: loop-lvmå’Œdirect-lvm\nloop-lvmæ˜¯é»˜è®¤æ¨¡å¼ï¼ŒåŸºäºloopè®¾å¤‡æ–‡ä»¶åˆ›å»ºthin poolæ¥å­˜å‚¨dockeré•œåƒåŠå®¹å™¨æ•°æ®ï¼Œå®˜æ–¹ä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ­¤æ¨¡å¼ direct-lvmæ˜¯ç›´æ¥ä½¿ç”¨å—è®¾å¤‡åˆ›å»ºthin poolï¼Œåœ¨ä¸­ç­‰è´Ÿè½½å’Œé«˜å¯†åº¦ç¯å¢ƒä¸‹ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä¹Ÿæ˜¯å®˜æ–¹æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„æ¨¡å¼ åŸºç¡€ç¯å¢ƒå‡†å¤‡ # æ“ä½œç³»ç»Ÿ: CentOS7.2\nDocker Engine: docker-engine-1.13.1-1.el7.centos.x86_64\nç¡¬ç›˜: /dev/sda,/dev/sdb\n$ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 200G 0 disk â”œâ”€sda1 8:1 0 500M 0 part /boot â””â”€sda2 8:2 0 190G 0 part â”œâ”€centos-root 253:0 0 90G 0 lvm / â””â”€centos-data 253:1 0 100G 0 lvm /data sdb 8:16 0 100G 0 disk sr0 11:0 1 603M 0 rom åˆ’åˆ†é€»è¾‘å· # åŸºäº/dev/sdbåˆ¶ä½œé€»è¾‘å·ç»„appvg, å¹¶åˆ’åˆ†é€»è¾‘å·appvg-dockerï¼Œç”¨äºæŒ‚è½½docker graphç›®å½•(/docker) $ pvcreate /dev/sdb Physical volume \u0026#34;/dev/sdb\u0026#34; successfully created $ vgcreate appvg /dev/sdb Volume group \u0026#34;appvg\u0026#34; successfully created #è§„åˆ’20Gç”¨äºé€»è¾‘å·/dev/appvg/docker $ lvcreate -n docker -L 20G appvg Logical volume \u0026#34;docker\u0026#34; created. $ lvs appvg LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert docker appvg -wi-a----- 20.00g $ mkfs.xfs /dev/appvg/docker meta-data=/dev/appvg/docker isize=256 agcount=4, agsize=1310720 blks = sectsz=512 attr=2, projid32bit=1 = crc=0 finobt=0 data = bsize=4096 blocks=5242880, imaxpct=25 = sunit=0 swidth=0 blks naming =version 2 bsize=4096 ascii-ci=0 ftype=0 log =internal log bsize=4096 blocks=2560, version=2 = sectsz=512 sunit=0 blks, lazy-count=1 realtime =none extsz=4096 blocks=0, rtextents=0 $ mkdir /docker $ mount /dev/appvg/docker /docker #å¼€æœºè‡ªåŠ¨æŒ‚è½½ $ tail -n1 /etc/fstab /dev/mapper/appvg-docker /docker xfs defaults 0 0 $ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 200G 0 disk â”œâ”€sda1 8:1 0 500M 0 part /boot â””â”€sda2 8:2 0 190G 0 part â”œâ”€centos-root 253:0 0 90G 0 lvm / â””â”€centos-data 253:1 0 100G 0 lvm /data sdb 8:16 0 100G 0 disk â””â”€appvg-docker 253:2 0 20G 0 lvm /docker sr0 11:0 1 603M 0 rom åŸºäºé€»è¾‘å·ç»„appvg, åˆ›å»ºthinpoolå’Œthinpoolmeta $ lvcreate --wipesignatures y -n thinpool -L 40G appvg Logical volume \u0026#34;thinpool\u0026#34; created. $ lvcreate --wipesignatures y -n thinpoolmeta -L 800M appvg Logical volume \u0026#34;thinpoolmeta\u0026#34; created. #å°†é€»è¾‘å·thinpoolå’Œthinpoolmetaè½¬æ¢ä¸ºthin pool $ lvconvert -y --zero n -c512K --thinpool appvg/thinpool --poolmetadata appvg/thinpoolmeta WARNING: Converting logical volume appvg/thinpool and appvg/thinpoolmeta to pool\u0026#39;s data and metadata volumes. THIS WILL DESTROY CONTENT OF LOGICAL VOLUME (filesystem etc.) Converted appvg/thinpool to thin pool. #åˆ›å»ºthinpoolè‡ªåŠ¨æ‰©å®¹é…ç½®æ–‡ä»¶ $vi /etc/lvm/profile/appvg-thinpool.profile activation { thin_pool_autoextend_threshold=60 thin_pool_autoextend_percent=20 } #åº”ç”¨thinpoolé…ç½®æ–‡ä»¶ $ lvchange --metadataprofile appvg-thinpool appvg/thinpool Logical volume \u0026#34;thinpool\u0026#34; changed. #æŸ¥çœ‹thinpoolå¤„äºç›‘æ§çŠ¶æ€ $ lvs -o+seg_monitor appvg LV VG Attr LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert Monitor docker appvg -wi-ao---- 20.00g thinpool appvg twi-a-t--- 40.00g 0.00 0.01 monitored å¯åŠ¨dockeræœåŠ¡ # åˆ›å»ºdockeré…ç½®æ–‡ä»¶/etc/docker/daemon.json $ cat /etc/docker/daemon.json { \u0026#34;insecure-registries\u0026#34;: [\u0026#34;0.0.0.0/0\u0026#34;], \u0026#34;hosts\u0026#34;: [\u0026#34;unix:///var/run/docker.sock\u0026#34;, \u0026#34;tcp://0.0.0.0:3666\u0026#34;], \u0026#34;graph\u0026#34;: \u0026#34;/docker\u0026#34;, \u0026#34;storage-driver\u0026#34;: \u0026#34;devicemapper\u0026#34;, \u0026#34;storage-opts\u0026#34;: [ \u0026#34;dm.thinpooldev=/dev/mapper/appvg-thinpool\u0026#34;, \u0026#34;dm.use_deferred_deletion=true\u0026#34;, \u0026#34;dm.use_deferred_removal=true\u0026#34; ] } å¯åŠ¨dockeræœåŠ¡å¹¶æ‰§è¡Œdocker info $ systemctl start docker $ docker info Containers: 0 Running: 0 Paused: 0 Stopped: 0 Images: 0 Server Version: 1.13.1 Storage Driver: devicemapper Pool Name: appvg-thinpool --\u0026gt; æ˜¾ç¤ºä¸ºåˆ›å»ºçš„é€»è¾‘å·thinpool Pool Blocksize: 524.3 kB Base Device Size: 10.74 GB Backing Filesystem: xfs Data file: Metadata file: Data Space Used: 20.45 MB Data Space Total: 42.95 GB Data Space Available: 42.93 GB Metadata Space Used: 110.6 kB Metadata Space Total: 838.9 MB Metadata Space Available: 838.8 MB Thin Pool Minimum Free Space: 4.295 GB Udev Sync Supported: true Deferred Removal Enabled: true Deferred Deletion Enabled: true Deferred Deleted Device Count: 0 ...ä¸­é—´çœç•¥... Docker Root Dir: /docker Debug Mode (client): false Debug Mode (server): false Registry: https://index.docker.io/v1/ WARNING: bridge-nf-call-iptables is disabled WARNING: bridge-nf-call-ip6tables is disabled Experimental: false Insecure Registries: 0.0.0.0/0 127.0.0.0/8 Live Restore Enabled: false ","date":"8 May 2018","permalink":"/2018/05/docker-devicemapper/","section":"åšå®¢","summary":"devicemapperæ˜¯Linuxå‘è¡Œç‰ˆRHELä¸‹Docker Engineçš„é»˜è®¤å­˜å‚¨é©±åŠ¨ï¼Œå®ƒæœ‰ä¸¤ç§é…ç½®æ¨¡å¼: loop-lvmå’Œdirect-lvm\nloop-lvmæ˜¯é»˜è®¤æ¨¡å¼ï¼ŒåŸºäºloopè®¾å¤‡æ–‡ä»¶åˆ›å»ºthin poolæ¥å­˜å‚¨dockeré•œåƒåŠå®¹å™¨æ•°æ®ï¼Œå®˜æ–¹ä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ­¤æ¨¡å¼ direct-lvmæ˜¯ç›´æ¥ä½¿ç”¨å—è®¾å¤‡åˆ›å»ºthin poolï¼Œåœ¨ä¸­ç­‰è´Ÿè½½å’Œé«˜å¯†åº¦ç¯å¢ƒä¸‹ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œä¹Ÿæ˜¯å®˜æ–¹æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„æ¨¡å¼ åŸºç¡€ç¯å¢ƒå‡†å¤‡ # æ“ä½œç³»ç»Ÿ: CentOS7.2\nDocker Engine: docker-engine-1.13.1-1.el7.centos.x86_64\nç¡¬ç›˜: /dev/sda,/dev/sdb\n$ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT sda 8:0 0 200G 0 disk â”œâ”€sda1 8:1 0 500M 0 part /boot â””â”€sda2 8:2 0 190G 0 part â”œâ”€centos-root 253:0 0 90G 0 lvm / â””â”€centos-data 253:1 0 100G 0 lvm /data sdb 8:16 0 100G 0 disk sr0 11:0 1 603M 0 rom åˆ’åˆ†é€»è¾‘å· # åŸºäº/dev/sdbåˆ¶ä½œé€»è¾‘å·ç»„appvg, å¹¶åˆ’åˆ†é€»è¾‘å·appvg-dockerï¼Œç”¨äºæŒ‚è½½docker graphç›®å½•(/docker) $ pvcreate /dev/sdb Physical volume \u0026#34;/dev/sdb\u0026#34; successfully created $ vgcreate appvg /dev/sdb Volume group \u0026#34;appvg\u0026#34; successfully created #è§„åˆ’20Gç”¨äºé€»è¾‘å·/dev/appvg/docker $ lvcreate -n docker -L 20G appvg Logical volume \u0026#34;docker\u0026#34; created.","title":"Dockerå­˜å‚¨é©±åŠ¨direct-lvmçš„é…ç½®"},{"content":"","date":"25 February 2018","permalink":"/tags/python/","section":"Tags","summary":"","title":"python"},{"content":"æ–¹æ³•ä¸€ # 1. os.system(\u0026lsquo;cmd\u0026rsquo;)æ–¹æ³•\nä½¿ç”¨systemæ–¹æ³•å¯ä»¥è¿”å›è¿è¡Œcmdå‘½ä»¤çš„çŠ¶æ€è¿”å›å€¼ï¼ŒåŒæ—¶ä¼šåœ¨ç»ˆç«¯è¾“å‡ºè¿è¡Œç»“æœï¼Œä½†æ— æ³•å°†æ‰§è¡Œçš„ç»“æœä¿å­˜èµ·æ¥\nsystemæ–¹æ³•æ¯”è¾ƒé€‚ç”¨äºæ‰§è¡Œå•ä¸ªå‘½ä»¤ã€é€šå¸¸æ²¡æœ‰è¾“å‡ºç»“æœçš„æƒ…å†µ\npythonäº¤äº’æ¨¡å¼ä¸‹ \u0026gt;\u0026gt;\u0026gt; os.system(\u0026#39;tar cvf /data/1.tar /data/docker\u0026#39;) tar: Removing leading `/\u0026#39; from member names /data/docker/ /data/docker/auth/ /data/docker/auth/htpasswd /data/docker/a.sh 0 \u0026lt;-- å‘½ä»¤æ‰§è¡ŒçŠ¶æ€è¿”å›å€¼ pythonè„šæœ¬ä¸­ $ cat sh-system.py #!/usr/bin/python36 import os,sys if len(sys.argv) \u0026lt; 3 : print (\u0026#39;2 arguments is needed\u0026#39;) sys.exit(1) os.system(\u0026#39;./test.sh %s %s\u0026#39;%(sys.argv[1],sys.argv[2])) \u0026lt;--è‡ªåŠ¨æ‰“å°cmdåœ¨linuxä¸Šæ‰§è¡Œçš„ä¿¡æ¯ï¼Œæ— éœ€ä½¿ç”¨print #os.system(\u0026#39;./test.sh \u0026#39;+sys.argv[1]+\u0026#39; \u0026#39;+sys.argv[2]) $ cat test.sh #!/usr/bin/bash echo -e \u0026#34;This is a shell script. \\nNAME:$1\\tAUTHOR:$2\u0026#34; è¿è¡Œpythonè„šæœ¬ï¼Œç»ˆç«¯ç»“æœå¦‚ä¸‹\n[root@master python_learning]# ./sh-system.py test tom This is a shell script. NAME:test AUTHOR:tom æ–¹æ³•äºŒ # 2. commands.getstatusoutput(\u0026lsquo;cmd1;cmd2;\u0026hellip;\u0026rsquo;)æ–¹æ³•\ncommands.getstatusoutputæ–¹æ³•å¯ä»¥å–å¾—å‘½ä»¤çš„è¾“å‡ºï¼ˆåŒ…æ‹¬æ ‡å‡†å’Œé”™è¯¯è¾“å‡ºï¼‰å’Œæ‰§è¡ŒçŠ¶æ€ä½\npython3å·²ç»ä½¿ç”¨subprocesså–ä»£\npython2äº¤äº’å¼æ¨¡å¼ä¸‹ [root@master python_learning]# python Python 2.7.5 (default, Aug 4 2017, 00:39:18) [GCC 4.8.5 20150623 (Red Hat 4.8.5-16)] on linux2 Type \u0026#34;help\u0026#34;, \u0026#34;copyright\u0026#34;, \u0026#34;credits\u0026#34; or \u0026#34;license\u0026#34; for more information. \u0026gt;\u0026gt;\u0026gt; import os,commands \u0026gt;\u0026gt;\u0026gt; status,result=commands.getstatusoutput(\u0026#39;ls\u0026#39;) \u0026gt;\u0026gt;\u0026gt; status 0 \u0026gt;\u0026gt;\u0026gt; result \u0026#39;getIP.py\\nsh-commands.py\\nsh-popen.py\\nsh-subprocess.py\\nsh-system.py\\ntest.sh\\nzipdir\\nzip.py\u0026#39; \u0026gt;\u0026gt;\u0026gt; commands.getoutput(\u0026#39;ls\u0026#39;) \u0026lt;--åªè¿”å›å‘½ä»¤æ‰§è¡Œç»“æœ \u0026#39;getIP.py\\nsh-commands.py\\nsh-popen.py\\nsh-subprocess.py\\nsh-system.py\\ntest.sh\\nzipdir\\nzip.py\u0026#39; pythonè„šæœ¬ä¸­ [root@master python_learning]# cat ./sh-commands.py #!/usr/bin/python import os,commands status,result=commands.getstatusoutput(\u0026#39;ls;cat /data/1.txt\u0026#39;) print (status) print (result) è¿è¡Œpythonè„šæœ¬ï¼Œç»ˆç«¯ç»“æœå¦‚ä¸‹\n[root@master python_learning]# ./sh-commands.py 256 \u0026lt;--cmd1;cmd2;...ä¸­æœ‰ä¸€ä¸ªcmdæ‰§è¡Œå¤±è´¥,çŠ¶æ€è¿”å›ç å°±ä¸ä¸º0 sh-commands.py sh-system.py test.sh cat: /data/1.txt: No such file or directory æ–¹æ³•ä¸‰ # 3.os.popen(\u0026lsquo;cmd\u0026rsquo;)æ–¹æ³•\npopen(command [, mode=\u0026lsquo;r\u0026rsquo; [, bufsize]])\n-\u0026gt; pipe Open a pipe to/from a command returning a file object. è¿”å›ä¸€ä¸ªç±»æ–‡ä»¶å¯¹è±¡ï¼Œè°ƒç”¨è¯¥å¯¹è±¡çš„read()æˆ–readlines()æ–¹æ³•å¯ä»¥è¯»å–è¾“å‡ºå†…å®¹\ncommand \u0026ndash; ä½¿ç”¨çš„å‘½ä»¤\nmode \u0026ndash; æ¨¡å¼æƒé™å¯ä»¥æ˜¯ \u0026lsquo;r\u0026rsquo;(é»˜è®¤) æˆ– \u0026lsquo;w\u0026rsquo;\nbufsize \u0026ndash; æŒ‡æ˜äº†æ–‡ä»¶éœ€è¦çš„ç¼“å†²å¤§å°ï¼š0æ„å‘³ç€æ— ç¼“å†²ï¼›1æ„å‘³ç€è¡Œç¼“å†²ï¼›å…¶å®ƒæ­£å€¼è¡¨ç¤ºä½¿ç”¨å‚æ•°å¤§å°çš„ç¼“å†²ï¼ˆå¤§æ¦‚å€¼ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚è´Ÿçš„bufsizeæ„å‘³ç€ä½¿ç”¨ç³»ç»Ÿçš„é»˜è®¤å€¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºttyè®¾å¤‡ï¼Œå®ƒæ˜¯è¡Œç¼“å†²ï¼›å¯¹äºå…¶å®ƒæ–‡ä»¶ï¼Œå®ƒæ˜¯å…¨ç¼“å†²ã€‚å¦‚æœæ²¡æœ‰æ”¹å‚æ•°ï¼Œä½¿ç”¨ç³»ç»Ÿçš„é»˜è®¤å€¼\npythonè„šæœ¬ä¸­ [root@master python_learning]# vim sh-popen.py #!/usr/bin/env python36 #-*- coding:utf-8 -*- import os,sys if len(sys.argv) \u0026lt; 3 : print (\u0026#39;2 arguments is needed\u0026#39;) sys.exit(1) cmd = \u0026#39;./test.sh %s %s\u0026#39;%(sys.argv[1],sys.argv[2]) print (os.popen(cmd).readlines()) \u0026lt;--è¿”å›çš„æ˜¯ç±»æ–‡ä»¶å¯¹è±¡ï¼Œéœ€è¦è°ƒç”¨printæ‰“å°å‡ºæ¥ print (os.popen(cmd).read(),end=\u0026#39;\u0026#39;) è¿è¡Œpythonè„šæœ¬ï¼Œç»ˆç«¯ç»“æœå¦‚ä¸‹\n[root@master python_learning]# ./sh-popen.py test tom [\u0026#39;This is a shell script. \\n\u0026#39;, \u0026#39;NAME:test\\tAUTHOR:tom\\n\u0026#39;] This is a shell script. NAME:test AUTHOR:tom æ–¹æ³•å›› # 4.subprocessæ¨¡å—\nsubprocessè¢«ç”¨æ¥æ›¿æ¢ä¸€äº›è€çš„æ¨¡å—å’Œå‡½æ•°ï¼Œå¦‚ï¼šos.systemã€os.spawn*ã€os.popen*ã€popen2.ã€commands.ã€‚æ‰€ä»¥å¼ºçƒˆæ¨èä½¿ç”¨subprocessæ¨¡å—ã€‚\nsubprocessæ¨¡å—ä¸­åªå®šä¹‰äº†ä¸€ä¸ªç±»: Popenã€‚å¯ä»¥ä½¿ç”¨Popenæ¥åˆ›å»ºè¿›ç¨‹ï¼Œå¹¶ä¸è¿›ç¨‹è¿›è¡Œå¤æ‚çš„äº¤äº’ã€‚å®ƒçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š\n*class subprocess.Popen(args, bufsize=-1, executable=None, stdin=None, stdout=None, stderr=None, preexec_fn=None, close_fds=False, shell=False, cwd=None, env=None, universal_newlines=False, startupinfo=None, creationflags=0,restore_signals=True, start_new_session=False, pass_fds=(), , encoding=None, errors=None)\nå„å‚æ•°è¯·å‚è€ƒ Python Documentationä¸­çš„å®šä¹‰\nå¸¸ç”¨çš„å‡ ä¸ªå‡½æ•°subprocess.call()ã€subprocess.check_call()ã€subprocess.check_output()ã€subprocess.Popen()ã€‚å®é™…ä¸Šï¼Œä¸Šé¢çš„å‡ ä¸ªå‡½æ•°éƒ½æ˜¯åŸºäºPopen()çš„å°è£…(wrapper)ã€‚è¿™äº›å°è£…çš„ç›®çš„åœ¨äºè®©æˆ‘ä»¬å®¹æ˜“ä½¿ç”¨å­è¿›ç¨‹ã€‚\nsubprocess.call() subprocess.call(args,* , stdin=None, stdout=None, stderr=None, shell=False, cwd=None, timeout=None)\nRun the command described by args. Wait for command to complete, then return the returncode attribute\nè¿è¡Œå‘½ä»¤ï¼Œçˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹å®Œæˆ(é˜»å¡)ï¼Œç„¶åè¿”å›returncode(çŠ¶æ€ç )\n[root@master python_learning]# python36 Python 3.6.3 (default, Jan 4 2018, 16:40:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-16)] on linux Type \u0026#34;help\u0026#34;, \u0026#34;copyright\u0026#34;, \u0026#34;credits\u0026#34; or \u0026#34;license\u0026#34; for more information. \u0026gt;\u0026gt;\u0026gt; import subprocess \u0026gt;\u0026gt;\u0026gt; subprocess.call([\u0026#39;ls\u0026#39;,\u0026#39;-l\u0026#39;,\u0026#39;/data\u0026#39;]) \u0026lt;--argsåºåˆ—åŒ–çš„è¡¨è¾¾æ–¹å¼ total 20 -rw-r--r--. 1 root root 10240 Feb 8 11:06 1.tar -rw-r--r--. 1 root root 24 Feb 22 14:56 1.txt drwxr-xr-x. 2 root root 79 Dec 25 09:56 build_images drwxr-xr-x. 2 root root 6 Jan 15 16:05 container drwxr-xr-x. 4 root root 30 Jan 10 15:47 dcos drwxr-xr-x. 3 root root 28 Feb 8 11:06 docker drwxr-xr-x. 3 root root 4096 Feb 22 15:31 python_learning drwxr-xr-x. 5 root root 36 Dec 11 11:07 zookeeper 0 \u0026gt;\u0026gt;\u0026gt; subprocess.call(\u0026#39;ls -l /data\u0026#39;,shell=True) \u0026lt;--argså­—ç¬¦ä¸²è¡¨è¾¾ï¼ŒæŒ‡å®šshell=True total 20 -rw-r--r--. 1 root root 10240 Feb 8 11:06 1.tar -rw-r--r--. 1 root root 24 Feb 22 14:56 1.txt drwxr-xr-x. 2 root root 79 Dec 25 09:56 build_images drwxr-xr-x. 2 root root 6 Jan 15 16:05 container drwxr-xr-x. 4 root root 30 Jan 10 15:47 dcos drwxr-xr-x. 3 root root 28 Feb 8 11:06 docker drwxr-xr-x. 3 root root 4096 Feb 22 15:31 python_learning drwxr-xr-x. 5 root root 36 Dec 11 11:07 zookeeper 0 \u0026gt;\u0026gt;\u0026gt; subprocess.call(\u0026#39;ls -l /data/ ; ls notexistfile\u0026#39;,shell=True) total 20 -rw-r--r--. 1 root root 10240 Feb 8 11:06 1.tar -rw-r--r--. 1 root root 24 Feb 22 14:56 1.txt drwxr-xr-x. 2 root root 79 Dec 25 09:56 build_images drwxr-xr-x. 2 root root 6 Jan 15 16:05 container drwxr-xr-x. 4 root root 30 Jan 10 15:47 dcos drwxr-xr-x. 3 root root 28 Feb 8 11:06 docker drwxr-xr-x. 3 root root 4096 Feb 22 15:31 python_learning drwxr-xr-x. 5 root root 36 Dec 11 11:07 zookeeper ls: cannot access notexistfile: No such file or directory 2 Tips:\nä½¿ç”¨shlex.split()æ–¹æ³•åºåˆ—åŒ–args\n\u0026gt;\u0026gt;\u0026gt; import shlex,subprocess \u0026gt;\u0026gt;\u0026gt; cmd=input() /bin/echo -e -n \u0026#34;this a test \u0026#39;$CASE\u0026#39;\u0026#34; \u0026gt;\u0026gt;\u0026gt; args=shlex.split(cmd) \u0026gt;\u0026gt;\u0026gt; print (args) [\u0026#39;/bin/echo\u0026#39;, \u0026#39;-e\u0026#39;, \u0026#39;-n\u0026#39;, \u0026#34;this a test \u0026#39;$CASE\u0026#39;\u0026#34;] \u0026gt;\u0026gt;\u0026gt; p = subprocess.Popen(args) \u0026gt;\u0026gt;\u0026gt; this a test \u0026#39;$CASE\u0026#39; subprocess.check_call() subprocess.check_call(args, *,stdin=None, stdout=None, stderr=None, shell=False, cwd=None, timeout=None)\nRun command with arguments. Wait for command to complete. If the return code was zero then return, otherwise raise CalledProcessError. The CalledProcessError object will have the return code in the returncode attribute.\nè¿è¡Œå‘½ä»¤ï¼Œçˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹å®Œæˆ(é˜»å¡)ï¼Œå¦‚æœå­è¿›ç¨‹è¿”å›çš„returncodeä¸ä¸º0çš„è¯ï¼Œå°†æŠ›å‡ºCalledProcessErrorå¼‚å¸¸ã€‚åœ¨å¼‚å¸¸å¯¹è±¡ä¸­ï¼ŒåŒ…æ‹¬è¿›ç¨‹çš„returncodeä¿¡æ¯ã€‚\n\u0026gt;\u0026gt;\u0026gt; subprocess.check_call(\u0026#39;ls -l /data/;ls notexistfile\u0026#39;,shell=True) total 20 -rw-r--r--. 1 root root 10240 Feb 8 11:06 1.tar -rw-r--r--. 1 root root 24 Feb 22 14:56 1.txt drwxr-xr-x. 2 root root 79 Dec 25 09:56 build_images drwxr-xr-x. 2 root root 6 Jan 15 16:05 container drwxr-xr-x. 4 root root 30 Jan 10 15:47 dcos drwxr-xr-x. 3 root root 28 Feb 8 11:06 docker drwxr-xr-x. 3 root root 4096 Feb 22 15:31 python_learning drwxr-xr-x. 5 root root 36 Dec 11 11:07 zookeeper ls: cannot access notexistfile: No such file or directory Traceback (most recent call last): File \u0026#34;\u0026lt;stdin\u0026gt;\u0026#34;, line 1, in \u0026lt;module\u0026gt; File \u0026#34;/usr/lib64/python3.6/subprocess.py\u0026#34;, line 291, in check_call raise CalledProcessError(retcode, cmd) subprocess.CalledProcessError: Command \u0026#39;ls -l /data/;ls notexistfile\u0026#39; returned non-zero exit status 2. subprocess.check_output() subprocess.check_output(args, *, stdin=None, stderr=None, shell=False, cwd=None, encoding=None, errors=None, universal_newlines=False, timeout=None)\nRun command with arguments and return its output.\nIf the return code was non-zero it raises a CalledProcessError. The CalledProcessError object will have the return code in the returncode attribute and any output in the output attribute.\nè¿è¡Œå‘½ä»¤ï¼Œçˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹å®Œæˆ(é˜»å¡)ï¼Œå¹¶è¿”å›å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºï¼Œå¦‚æœå­è¿›ç¨‹è¿”å›çš„returncodeä¸ä¸º0çš„è¯ï¼Œå°†æŠ›å‡ºCalledProcessErrorå¼‚å¸¸ã€‚åœ¨å¼‚å¸¸å¯¹è±¡ä¸­ï¼ŒåŒ…æ‹¬è¿›ç¨‹çš„returncodeä¿¡æ¯å’Œæ ‡å‡†è¾“å‡ºçš„ä¿¡æ¯\n\u0026gt;\u0026gt;\u0026gt; subprocess.check_output(\u0026#39;ls -l\u0026#39;,shell=True) b\u0026#39;total 32\\n-rw-r--r--. 1 root root 164 Feb 22 19:28 \\\\\\n-rwxr-xr-x. 1 root root 229 Feb 22 10:24 getIP.py\\n-rwxr-xr-x. 1 root root 253 Feb 8 13:37 sh-commands.py\\n-rwxr-xr-x. 1 root root 369 Feb 22 15:31 sh-popen.py\\n-rwxr-xr-x. 1 root root 572 Feb 8 20:44 sh-subprocess.py\\n-rwxr-xr-x. 1 root root 407 Feb 22 14:46 sh-system.py\\n-rwxr-xr-x. 1 root root 72 Feb 8 13:24 test.sh\\ndrwxr-xr-x. 4 root root 42 Feb 8 18:29 zipdir\\n-rwxr-xr-x. 1 root root 1046 Feb 8 19:00 zip.py\\n\u0026#39; \u0026gt;\u0026gt;\u0026gt; subprocess.check_output(\u0026#39;ls notexistfile\u0026#39;,shell=True) ls: cannot access notexistfile: No such file or directory Traceback (most recent call last): File \u0026#34;\u0026lt;stdin\u0026gt;\u0026#34;, line 1, in \u0026lt;module\u0026gt; File \u0026#34;/usr/lib64/python3.6/subprocess.py\u0026#34;, line 336, in check_output **kwargs).stdout File \u0026#34;/usr/lib64/python3.6/subprocess.py\u0026#34;, line 418, in run output=stdout, stderr=stderr) subprocess.CalledProcessError: Command \u0026#39;ls notexistfile\u0026#39; returned non-zero exit status 2. ä½¿ç”¨tryå’Œexceptè¯­å¥å¤„ç†subprocess.CalledProcessErrorå¼‚å¸¸\n#!/usr/bin/env python36 import subprocess code_flag=0 try: p2=subprocess.check_output(\u0026#39;ls notexistfile\u0026#39;,shell=True) print(p2) except subprocess.CalledProcessError: #print (\u0026#39;returncode is not 0\u0026#39;) code_flag=2 if code_flag != 0: print (\u0026#39;execute cmd failed\u0026#39;) å¦‚æœè¦è·å–æ ‡å‡†é”™è¯¯ï¼Œéœ€å®šä¹‰stderrå‚æ•° stderr=subprocess.STDOUT\n\u0026gt;\u0026gt;\u0026gt; subprocess.check_output( ... \u0026#34;ls non_existent_file; exit 0\u0026#34;, ... stderr=subprocess.STDOUT, ... shell=True) \u0026#39;ls: non_existent_file: No such file or directory\\n\u0026#39; subprocess.Popen() ç»å¸¸çš„ä½¿ç”¨æ–¹æ³•ä¸ºsubporcess.Popen, æˆ‘ä»¬å¯ä»¥åœ¨Popen()å»ºç«‹å­è¿›ç¨‹çš„æ—¶å€™æ”¹å˜æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ï¼Œå¹¶å¯ä»¥åˆ©ç”¨subprocess.PIPEå°†å¤šä¸ªå­è¿›ç¨‹çš„è¾“å…¥å’Œè¾“å‡ºè¿æ¥åœ¨ä¸€èµ·ï¼Œæ„æˆç®¡é“(pipe):\nimport subprocess child1 = subprocess.Popen([\u0026#34;ls\u0026#34;,\u0026#34;-l\u0026#34;], stdout=subprocess.PIPE) child2 = subprocess.Popen([\u0026#34;wc\u0026#34;], stdin=child1.stdout,stdout=subprocess.PIPE) out = child2.communicate() print(out) subprocess.PIPE\nåœ¨åˆ›å»ºPopenå¯¹è±¡æ—¶ï¼Œsubprocess.PIPEå¯ä»¥åˆå§‹åŒ–stdin, stdoutæˆ–stderrå‚æ•°ã€‚è¡¨ç¤ºä¸å­è¿›ç¨‹é€šä¿¡çš„æ ‡å‡†æµï¼Œå®ƒå®é™…ä¸Šä¸ºæ–‡æœ¬æµæä¾›ä¸€ä¸ªç¼“å­˜åŒºï¼Œç¼“å­˜åŒºæœ‰ä¸€å®šçš„å®¹é‡é™åˆ¶ï¼Œå½“ç¼“å­˜åŒºæ»¡äº†ä¹‹åï¼Œå­è¿›ç¨‹å°±ä¼šåœæ­¢å†™å…¥æ•°æ®ï¼Œç¨‹åºå°±ä¼šå¡ä½\nPopenå¯¹è±¡åˆ›å»ºåï¼Œä¸»ç¨‹åºä¸ä¼šè‡ªåŠ¨ç­‰å¾…å­è¿›ç¨‹å®Œæˆã€‚æˆ‘ä»¬å¿…é¡»è°ƒç”¨å¯¹è±¡çš„wait()æ–¹æ³•ï¼Œçˆ¶è¿›ç¨‹æ‰ä¼šç­‰å¾… (ä¹Ÿå°±æ˜¯é˜»å¡block)ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¦‚æœè¿›ç¨‹è¾“å‡ºæ–‡æœ¬æ•°æ®è¶…è¿‡buffersizeï¼ˆé»˜è®¤64kï¼‰,è°ƒç”¨wait()æ–¹æ³•ä¼šä½¿ç¨‹åºé”æ­»ï¼Œæ¨èä½¿ç”¨communicate()æ–¹æ³•ï¼ˆcommunicate()æ˜¯Popenå¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¹Ÿä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼Œç›´åˆ°å­è¿›ç¨‹å®Œæˆ ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæŠŠè¾“å‡ºæ”¾åœ¨å†…å­˜ï¼Œè€Œä¸æ˜¯ç®¡é“é‡Œï¼Œæ‰€ä»¥è¿™æ—¶å€™ä¸Šé™å°±å’Œå†…å­˜å¤§å°æœ‰å…³äº†ï¼Œä¸€èˆ¬ä¸ä¼šæœ‰é—®é¢˜ã€‚è€Œä¸”å¦‚æœè¦è·å¾—ç¨‹åºè¿”å›å€¼ï¼Œå¯ä»¥åœ¨è°ƒç”¨ Popen.communicate() ä¹‹åå– Popen.returncode çš„å€¼ã€‚ä½†å¦‚æœè¶…è¿‡å†…å­˜ï¼Œé‚£ä¹ˆè¦è€ƒè™‘æ¯”å¦‚æ–‡ä»¶ stdout=open(\u0026ldquo;process.out\u0026rdquo;, \u0026ldquo;w\u0026rdquo;) çš„æ–¹å¼æ¥è§£å†³ï¼Œä¸èƒ½å†ä½¿ç”¨ç®¡é“äº†\nPopenå¯¹è±¡çš„æ–¹æ³•ï¼š\nPopen.poll() ç”¨äºæ£€æŸ¥å­è¿›ç¨‹æ˜¯å¦å·²ç»ç»“æŸã€‚è®¾ç½®å¹¶è¿”å›returncodeå±æ€§ã€‚\nPopen.wait() ç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚è®¾ç½®å¹¶è¿”å›returncodeå±æ€§ã€‚\nPopen.communicate(input=None) ä¸å­è¿›ç¨‹è¿›è¡Œäº¤äº’ã€‚å‘stdinå‘é€æ•°æ®ï¼Œæˆ–ä»stdoutå’Œstderrä¸­è¯»å–æ•°æ®ã€‚å¯é€‰å‚æ•°inputæŒ‡å®šå‘é€åˆ°å­è¿›ç¨‹çš„å‚æ•°ã€‚ Communicate()è¿”å›ä¸€ä¸ªå…ƒç»„ï¼š(stdoutdata, stderrdata)ã€‚æ³¨æ„ï¼šå¦‚æœå¸Œæœ›é€šè¿‡è¿›ç¨‹çš„stdinå‘å…¶å‘é€æ•°æ®ï¼Œåœ¨åˆ›å»ºPopenå¯¹è±¡çš„æ—¶å€™ï¼Œå‚æ•°stdinå¿…é¡»è¢«è®¾ç½®ä¸ºPIPEã€‚åŒæ ·ï¼Œå¦‚ æœå¸Œæœ›ä»stdoutå’Œstderrè·å–æ•°æ®ï¼Œå¿…é¡»å°†stdoutå’Œstderrè®¾ç½®ä¸ºPIPEã€‚\nPopen.send_signal(signal) å‘å­è¿›ç¨‹å‘é€ä¿¡å·ã€‚\nPopen.terminate() åœæ­¢(stop)å­è¿›ç¨‹ã€‚åœ¨windowså¹³å°ä¸‹ï¼Œè¯¥æ–¹æ³•å°†è°ƒç”¨Windows API TerminateProcessï¼ˆï¼‰æ¥ç»“æŸå­è¿›ç¨‹ã€‚\nPopen.kill() æ€æ­»å­è¿›ç¨‹ã€‚\nPopen.stdin å¦‚æœåœ¨åˆ›å»ºPopenå¯¹è±¡æ˜¯ï¼Œå‚æ•°stdinè¢«è®¾ç½®ä¸ºPIPEï¼ŒPopen.stdinå°†è¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ç”¨äºç­–å­è¿›ç¨‹å‘é€æŒ‡ä»¤ã€‚å¦åˆ™è¿”å›Noneã€‚\nPopen.stdout å¦‚æœåœ¨åˆ›å»ºPopenå¯¹è±¡æ˜¯ï¼Œå‚æ•°stdoutè¢«è®¾ç½®ä¸ºPIPEï¼ŒPopen.stdoutå°†è¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ç”¨äºç­–å­è¿›ç¨‹å‘é€æŒ‡ä»¤ã€‚å¦åˆ™è¿”å› Noneã€‚ï¼ˆç±»ä¼¼äºos.popen()æ–¹æ³•ï¼‰\nPopen.stderr å¦‚æœåœ¨åˆ›å»ºPopenå¯¹è±¡æ˜¯ï¼Œå‚æ•°stdoutè¢«è®¾ç½®ä¸ºPIPEï¼ŒPopen.stdoutå°†è¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ç”¨äºç­–å­è¿›ç¨‹å‘é€æŒ‡ä»¤ã€‚å¦åˆ™è¿”å› Noneã€‚\nPopen.pid è·å–å­è¿›ç¨‹çš„è¿›ç¨‹IDã€‚\nPopen.returncode è·å–è¿›ç¨‹çš„è¿”å›å€¼ã€‚å¦‚æœè¿›ç¨‹è¿˜æ²¡æœ‰ç»“æŸï¼Œè¿”å›Noneã€‚\nå®ä¾‹ä¸€ :\nä½¿ç”¨Popençš„communicate()æ–¹æ³•ä¿å­˜å­è¿›ç¨‹è¾“å‡ºä¿¡æ¯ï¼Œé¿å…ç¨‹åºæ­»é”\n[root@master python_learning]# vim sh-subprocess.py #!/usr/bin/env python36 #-*- coding:utf-8 -*- import os,sys import subprocess if len(sys.argv) \u0026lt; 3 : print (\u0026#39;2 arguments is needed\u0026#39;) sys.exit(1) cmd = \u0026#39;./test.sh %s %s\u0026#39;%(sys.argv[1],sys.argv[2]) p=subprocess.Popen(cmd,shell=True,stdout=subprocess.PIPE) #p.wait() #é˜»å¡çˆ¶è¿›ç¨‹ï¼Œç­‰å¾…cmdæ‰§è¡Œå®Œæˆ #print(p.stdout.read()) #ä»ç®¡é“è¯»å‡ºè¾“å‡ºä¿¡æ¯ output,errors=p.communicate() #è¾“å‡ºä¿¡æ¯ç¼“å­˜åˆ°å†…å­˜ä¸­;è¿›ç¨‹ç»“æŸåï¼Œè¿”å›å…ƒç»„(stdoutdata, stderrdata) print(output) #æ‰“å°stdoutdata if p.returncode != 0: print (\u0026#34;execute shell script failed\u0026#34;) å®ä¾‹äºŒ :\nenvå‚æ•°é»˜è®¤ä¸ºNoneï¼Œå­è¿›ç¨‹é»˜è®¤ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦ä½ è‡ªå®šä¹‰äº†envçš„å€¼ï¼ˆç±»å‹ä¸ºå­—å…¸ï¼‰ï¼Œåˆ™å­ç¨‹åºçš„ç¯å¢ƒå˜é‡å…¨éƒ¨ç”±envå‚æ•°å†³å®šï¼Œä¸çˆ¶è¿›ç¨‹æ— å…³\n\u0026gt;\u0026gt;\u0026gt; p=subprocess.Popen(\u0026#39;echo this is a test \u0026#34;$case\u0026#34;\u0026#39;,env={\u0026#39;case\u0026#39;:\u0026#39;123456\u0026#39;},shell=True,stdout=subprocess.PIPE) \u0026gt;\u0026gt;\u0026gt; print(p.stdout.read()) b\u0026#39;this is 123456\\n\u0026#39; æ–¹æ³•äº” # 5.shæ¨¡å—\nå‚è€ƒ å®˜æ–¹æ–‡æ¡£\nè°ƒç”¨å¸¸ç”¨å‘½ä»¤ \u0026gt;\u0026gt;\u0026gt; import sh \u0026gt;\u0026gt;\u0026gt; sh.ls() getIP.py sh-popen.py sh-system.py test.sh zip.py sh-commands.py sh-subprocess.py sub1.py zipdir \u0026gt;\u0026gt;\u0026gt; sh.ls(\u0026#39;-l\u0026#39;,\u0026#39;./getIP.py\u0026#39;) #å‘½ä»¤å‚æ•°ä»¥å­—ç¬¦ä¸²å½¢å¼ä¼ é€’ -rwxr-xr-x. 1 root root 229 Feb 22 10:24 ./getIP.py æˆ–è€… \u0026gt;\u0026gt;\u0026gt; from sh import ls \u0026gt;\u0026gt;\u0026gt; ls() getIP.py sh-popen.py sh-system.py test.sh zip.py sh-commands.py sh-subprocess.py sub1.py zipdir \u0026gt;\u0026gt;\u0026gt; ls(\u0026#39;-l\u0026#39;,\u0026#39;./getIP.py\u0026#39;) -rwxr-xr-x. 1 root root 229 Feb 22 10:24 ./getIP.py æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚\n","date":"25 February 2018","permalink":"/2018/02/python-shell/","section":"åšå®¢","summary":"\u003ch5 class=\"relative group\"\u003eæ–¹æ³•ä¸€ \n    \u003cdiv id=\"æ–¹æ³•ä¸€\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e6%96%b9%e6%b3%95%e4%b8%80\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h5\u003e\n\u003cp\u003e\u003cstrong\u003e1. os.system(\u0026lsquo;cmd\u0026rsquo;)æ–¹æ³•\u003c/strong\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eä½¿ç”¨systemæ–¹æ³•å¯ä»¥è¿”å›è¿è¡Œcmdå‘½ä»¤çš„çŠ¶æ€è¿”å›å€¼ï¼ŒåŒæ—¶ä¼šåœ¨ç»ˆç«¯è¾“å‡ºè¿è¡Œç»“æœï¼Œä½†æ— æ³•å°†æ‰§è¡Œçš„ç»“æœä¿å­˜èµ·æ¥\u003c/p\u003e\n\u003cp\u003esystemæ–¹æ³•æ¯”è¾ƒé€‚ç”¨äºæ‰§è¡Œå•ä¸ªå‘½ä»¤ã€é€šå¸¸æ²¡æœ‰è¾“å‡ºç»“æœçš„æƒ…å†µ\u003c/p\u003e\n\u003c/blockquote\u003e","title":"pythonè„šæœ¬ä¸­è°ƒç”¨shellçš„å‡ ç§æ–¹æ³•"},{"content":"","date":"6 January 2018","permalink":"/tags/shell/","section":"Tags","summary":"","title":"shell"},{"content":"èƒŒæ™¯ # ç›®å‰ï¼Œç”±äºå…¬å¸å¤šä¸ªç›¸äº’éš”ç¦»ç¯å¢ƒå¹¶å­˜ï¼Œå„ä¸ªç¯å¢ƒéƒ½éƒ¨ç½²æœ‰å®¹å™¨ç®¡ç†å¹³å°ï¼Œå½“æœ‰docker imageæ›´æ–°çš„æ—¶å€™ï¼Œå°±éœ€è¦åœ¨æ¯ä¸ªç¯å¢ƒéƒ½ä¿®æ”¹Dockerfileå¹¶æ‰§è¡Œdocker build \u0026amp; docker pushåˆ°å…¬å…±é•œåƒä»“åº“çš„æ“ä½œï¼Œä¸ºäº†å‡å°‘é‡å¤æ€§çš„å·¥ä½œï¼Œæˆ‘å°±å†™äº†ä¸€ä¸ªè‡ªåŠ¨æ„å»ºé•œåƒçš„è„šæœ¬ï¼Œåªéœ€è¦åœ¨ä¸€ä¸ªç¯å¢ƒä¸­å‡†å¤‡å¥½æ„å»ºé•œåƒçš„DockerfileåŠä¾èµ–æ–‡ä»¶ï¼Œæ‰§è¡Œè„šæœ¬å®Œæˆæ„å»ºå’Œæ¨é€ï¼Œç„¶åæ‰“åŒ…æ„å»ºé•œåƒçš„æ–‡ä»¶å¤¹å¹¶ä¼ è¾“åˆ°å¦ä¸€ç¯å¢ƒï¼Œæ‰§è¡Œè„šæœ¬å°±å¯ä»¥è‡ªåŠ¨å®Œæˆ\nè„šæœ¬è¿è¡Œç¤ºä¾‹ # æ„å»ºè„šæœ¬çš„ç›®å½•ç»“æ„ # 01.20171229æ–‡ä»¶å¤¹ \u0026lt;\u0026mdash;\u0026gt; è¦æ„å»ºé•œåƒçš„tag\næ„å»ºé•œåƒæ­¥éª¤ # åˆ›å»ºç›®å½• # $ cd /data/dcos $ mkdir -p buildimages/01.20171229 log $ cd buildimages/01.20171229 #åˆ›å»ºå„ä¸ªéœ€è¦buildé•œåƒçš„æ–‡ä»¶å¤¹ $ mkdir centos7.2_tomcat7.0.72-all rhel7.2_tomcat7.0.63-jdk1.6.0_45 ... ä¿®æ”¹configfile # $ vim /data/dcos/buildimages/configfile TargetRegistry:192.168.196.128:5000 --\u0026gt; å½“å‰ç¯å¢ƒé•œåƒä»“åº“åœ°å€ Registry_user:admin\t--\u0026gt; ä»“åº“ç™»å½•ç”¨æˆ·å Registry_passwd:admin --\u0026gt; ä»“åº“è®¤è¯å¯†ç  å‡†å¤‡Dockerfileå’Œä¾èµ–æ–‡ä»¶ # #ç¤ºä¾‹ $ ls centos7.2_tomcat7.0.72-all Dockerfile startServer.sh æ„å»ºé•œåƒ # $ bash /data/dcos/buildimages/build.sh 01.20171229 --\u0026gt;è„šæœ¬è¦è·Ÿå‚æ•°01.20171229 æ—¥å¿—æ–‡ä»¶ # $ less /data/dcos/buildimages/log/01.20171229.log --\u0026gt;ä»¥tagå‘½åçš„æ—¥å¿—æ–‡ä»¶ Trying to pull repository 192.168.196.128:5000/admin/centos7.2_tomcat7.0.72-all ... 01.20171221: Pulling from 192.168.196.128:5000/admin/centos7.2_tomcat7.0.72-all 4f4fb700ef54: Pulling fs layer d8405e7a6b27: Pulling fs layer 02389d9a455d: Pulling fs layer ...ä¸­é—´çœç•¥... a3eef13e30fb: Pull complete 2833ecd114e0: Pull complete f8b56d99c9b0: Pull complete adb966dc304e: Pull complete Digest: sha256:861302f6da8e083b112d92fa153fc4dcde677f6d3e598ab22eea4289e312b08c Sending build context to Docker daemon 5.12 kB^M Step 1 : FROM 192.168.196.128:5000/admin/centos7.2_tomcat7.0.72-all:01.20171221 ---\u0026gt; 09ce979d3860 Step 2 : USER root ---\u0026gt; Running in 9a072cdbee5e ---\u0026gt; cc3b6b1d9bf1 Removing intermediate container 9a072cdbee5e Step 3 : COPY startServer.sh /app/bin/startServer.sh ---\u0026gt; 0d743c01403c Removing intermediate container fbdd0d775d09 Step 4 : RUN chmod +x /app/bin/startServer.sh \u0026amp;\u0026amp; chown -R dcos:docker /app/bin/startServer.sh ---\u0026gt; Running in 03b6f5d1d467 ---\u0026gt; 0f6055d1b9c5 Removing intermediate container 03b6f5d1d467 Step 5 : USER dcos ---\u0026gt; Running in 6ac2a787ae71 ---\u0026gt; ae33c0899e2a Removing intermediate container 6ac2a787ae71 Successfully built ae33c0899e2a The push refers to a repository [192.168.196.128:5000/admin/centos7.2_tomcat7.0.72-all] e623fa631602: Preparing 473647768f24: Preparing 96bd6e1cc68c: Preparing ...ä¸­é—´çœç•¥... 473647768f24: Pushed e623fa631602: Pushed 01.20171229: digest: sha256:1a5c012f2d7b4a627c5dc1aca22350d652676adf53adfde0d471943f4d390d4b size: 6798 å‹ç¼©æ„å»ºé•œåƒçš„ç›®å½• # $ tar cvf 01.20171229.tar /data/dcos/buildimages/01.20171229 è·¨ç¯å¢ƒè‡ªåŠ¨æ„å»ºé•œåƒ # ä¼ è¾“01.20171229.taræ–‡ä»¶å¹¶è§£å‹ # $ cd /data/dcos/buildimages $ tar xf 01.20171229.tar æŸ¥çœ‹å¹¶ç¡®è®¤configfile # #ç¤ºä¾‹ $ vim /data/dcos/buildimages/configfile TargetRegistry:192.168.196.128:5000 --\u0026gt; å½“å‰ç¯å¢ƒé•œåƒä»“åº“åœ°å€ Registry_user:admin Registry_passwd:admin æ„å»ºé•œåƒ # $ bash /data/dcos/buildimages/build.sh 01.20171229 shellè„šæœ¬ # #!/bin/bash #Date:2018-01-03 #version:3.0 #Author:Feixiang Fu #Description:Auto-build images based on configfile \u0026amp;\u0026amp; Auto-push images . /etc/init.d/functions [ -z \u0026#34;$*\u0026#34; ] \u0026amp;\u0026amp; echo \u0026#34;usage: \u0026#34;buildim.sh VERSIONDIR\u0026#34; (VERSIONDIR is the target image tag)\u0026#34; \u0026amp;\u0026amp; exit 1 dir=/data/dcos/buildimages build_dir=$dir/$1 if [ ! -d $build_dir ]; then action \u0026#34;ç›®æ ‡ç›®å½•${1}ä¸å­˜åœ¨\u0026#34; false exit 1 fi addr=`cat $dir/configfile | awk -F: \u0026#39;/^TargetRegistry/{print $2\u0026#34;:\u0026#34;$3}\u0026#39;` user=`cat $dir/configfile | awk -F: \u0026#39;/^Registry_user/{print $2}\u0026#39;` passwd=`cat $dir/configfile | awk -F: \u0026#39;/^Registry_passwd/{print $2}\u0026#39;` cd $build_dir imagesdir_num=`ls -d $build_dir/*/|wc -l` if [ $imagesdir_num -eq 0 ] ; then action \u0026#34;${1}ç›®å½•ä¸‹æ²¡æœ‰è¦æ„å»ºçš„é•œåƒæ–‡ä»¶å¤¹\u0026#34; false exit 1 fi docker login -u $user -p $passwd $addr \u0026amp;\u0026gt; /dev/null if [ $? -eq 0 ] ; then action \u0026#34;ç™»é™†é•œåƒä»“åº“${addr}æˆåŠŸ\u0026#34; else action \u0026#34;ç™»é™†é•œåƒä»“åº“${addr}å¤±è´¥\u0026#34; false exit 1 fi declare -a localim buildim(){ cd $build_dir/$1 \u0026amp;\u0026gt; /dev/null if [ $? -ne 0 ] ;then echo \u0026#34;${1}ä¸ºæ™®é€šæ–‡ä»¶ï¼Œç•¥è¿‡\u0026#34; continue fi if [ -f ./Dockerfile ] ;then sed -i -r \u0026#34;s#(FROM\\s+)[^/]+(\\/.*)#\\1${addr}\\2#\u0026#34; Dockerfile baseimage=`cat Dockerfile |grep FROM|cut -d\u0026#34; \u0026#34; -f2` baseimage_num=`docker images|awk \u0026#39;{print $1\u0026#34;:\u0026#34;$2}\u0026#39;|grep \u0026#34;$baseimage\u0026#34;|wc -l` baseimage_name=`echo \u0026#34;$baseimage\u0026#34; | awk -F/ \u0026#39;{print $3}\u0026#39; ` if [ $baseimage_num -eq 0 ] ; then echo -e \u0026#34;æ­£åœ¨æ‹‰å–\\e[33m${baseimage_name}\\e[0m\u0026#34; docker pull $baseimage \u0026gt;\u0026gt; $dir/log/${2}.log 2\u0026gt;\u0026amp;1 if [ $? -eq 0 ]; then action \u0026#34;æ‹‰å–${baseimage_name}æˆåŠŸ\u0026#34; localim[${#localim[*]}]=$baseimage else action \u0026#34;æ‹‰å–${baseimage_name}å¤±è´¥\u0026#34; false continue fi fi path=`echo $baseimage |cut -d: -f1,2` newimage_name=`echo $baseimage_name|sed -r \u0026#34;s/([^:]+:).*/\\1$2/\u0026#34;` echo -e \u0026#34;æ­£åœ¨æ„å»º\\e[33m${newimage_name}\\e[0m\u0026#34; docker build -t $path:$2 ./ \u0026gt;\u0026gt; $dir/log/${2}.log 2\u0026gt;\u0026amp;1 if [ $? -eq 0 ] ;then action \u0026#34;${newimage_name}æ„å»ºæˆåŠŸ\u0026#34; localim[${#localim[*]}]=$path:$2 else action \u0026#34;${newimage_name}æ„å»ºå¤±è´¥\u0026#34; false continue fi echo -e \u0026#34;æ­£åœ¨æ¨é€\\e[33m${newimage_name}\\e[0m\u0026#34; docker push $path:$2 \u0026gt;\u0026gt; $dir/log/${2}.log 2\u0026gt;\u0026amp;1 if [ $? -eq 0 ] ;then action \u0026#34;${newimage_name}æ¨é€æˆåŠŸ\u0026#34; else action \u0026#34;${newimage_name}æ¨é€å¤±è´¥\u0026#34; false fi else action \u0026#34;${1}ç›®å½•ä¸‹æ— Dockerfile\u0026#34; false\tfi } for i in `ls $build_dir` ; do echo -e \u0026#34;\\e[32m-------------------------------------------------------------------\\e[0m\u0026#34; buildim $i $1 done echo -e \u0026#34;\\e[32m-------------------------------------------------------------------\\e[0m\u0026#34; echo \u0026#34;æ­£åœ¨æ¸…ç†æœ¬åœ°é•œåƒæ–‡ä»¶\u0026#34; for j in `seq $((${#localim[*]}-1)) -1 0` ;do localim_name=$(echo \u0026#34;${localim[$j]}\u0026#34;| awk -F/ \u0026#39;{print $3}\u0026#39;) docker rmi ${localim[$j]} \u0026gt;\u0026gt; $dir/log/${1}.log 2\u0026gt;\u0026amp;1 if [ $? -eq 0 ] ;then action \u0026#34;${localim_name}æ¸…ç†æˆåŠŸ\u0026#34; else action \u0026#34;${localim_name}æ¸…ç†å¤±è´¥\u0026#34; false fi done echo -e \u0026#34;\\e[32m-------------------------------------------------------------------\\e[0m\u0026#34; [ -f $dir/log/${1}.log ] \u0026amp;\u0026amp; echo \u0026#34;logfile: $dir/log/${1}.log\u0026#34; ","date":"6 January 2018","permalink":"/2018/01/build-docker-image/","section":"åšå®¢","summary":"èƒŒæ™¯ # ç›®å‰ï¼Œç”±äºå…¬å¸å¤šä¸ªç›¸äº’éš”ç¦»ç¯å¢ƒå¹¶å­˜ï¼Œå„ä¸ªç¯å¢ƒéƒ½éƒ¨ç½²æœ‰å®¹å™¨ç®¡ç†å¹³å°ï¼Œå½“æœ‰docker imageæ›´æ–°çš„æ—¶å€™ï¼Œå°±éœ€è¦åœ¨æ¯ä¸ªç¯å¢ƒéƒ½ä¿®æ”¹Dockerfileå¹¶æ‰§è¡Œdocker build \u0026amp; docker pushåˆ°å…¬å…±é•œåƒä»“åº“çš„æ“ä½œï¼Œä¸ºäº†å‡å°‘é‡å¤æ€§çš„å·¥ä½œï¼Œæˆ‘å°±å†™äº†ä¸€ä¸ªè‡ªåŠ¨æ„å»ºé•œåƒçš„è„šæœ¬ï¼Œåªéœ€è¦åœ¨ä¸€ä¸ªç¯å¢ƒä¸­å‡†å¤‡å¥½æ„å»ºé•œåƒçš„DockerfileåŠä¾èµ–æ–‡ä»¶ï¼Œæ‰§è¡Œè„šæœ¬å®Œæˆæ„å»ºå’Œæ¨é€ï¼Œç„¶åæ‰“åŒ…æ„å»ºé•œåƒçš„æ–‡ä»¶å¤¹å¹¶ä¼ è¾“åˆ°å¦ä¸€ç¯å¢ƒï¼Œæ‰§è¡Œè„šæœ¬å°±å¯ä»¥è‡ªåŠ¨å®Œæˆ\nè„šæœ¬è¿è¡Œç¤ºä¾‹ # æ„å»ºè„šæœ¬çš„ç›®å½•ç»“æ„ # 01.20171229æ–‡ä»¶å¤¹ \u0026lt;\u0026mdash;\u0026gt; è¦æ„å»ºé•œåƒçš„tag\næ„å»ºé•œåƒæ­¥éª¤ # åˆ›å»ºç›®å½• # $ cd /data/dcos $ mkdir -p buildimages/01.20171229 log $ cd buildimages/01.20171229 #åˆ›å»ºå„ä¸ªéœ€è¦buildé•œåƒçš„æ–‡ä»¶å¤¹ $ mkdir centos7.","title":"æ‰¹é‡è‡ªåŠ¨æ„å»ºdockeré•œåƒçš„shellè„šæœ¬"},{"content":"â€‹ Tomcat æœåŠ¡å™¨æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æ”¾æºä»£ç çš„Web åº”ç”¨æœåŠ¡å™¨, æ˜¯ç¼–è¯‘JSP\\Servletçš„å®¹å™¨ï¼Œå¸¸ç”¨æ¥å¤„ç†åŠ¨æ€è¯·æ±‚ã€‚nginxå’Œapache HTTPæœåŠ¡å™¨æ˜¯é™æ€è§£æï¼Œæ“…é•¿å¤„ç†HTMLåŠå›¾ç‰‡ç­‰é™æ€è¯·æ±‚ï¼Œå¤„ç†é™æ€é¡µé¢æ•ˆç‡è¿œé«˜äºtomcatã€‚ä½¿ç”¨nginxçš„åŠ¨é™åˆ†ç¦»æœºåˆ¶ï¼Œå¯ä»¥å°†é™æ€è¯·æ±‚åˆ†å‘è‡³é™æ€æœåŠ¡å™¨(nginxæˆ–è€…apache)ï¼Œè€Œå°†åŠ¨æ€è¯·æ±‚åˆ†å‘è‡³åç«¯tomcatæœåŠ¡å™¨å¤„ç†ï¼Œä»è€Œæé«˜æœåŠ¡å™¨çš„å¹¶å‘å¤„ç†æ€§èƒ½ã€‚tomcatæ”¯æŒHTTPå’ŒAJPä¸¤ç§åè®®çš„è¿æ¥å™¨ï¼ŒAJPåè®®æ¯”HTTPæ›´ç¨³å®šå’Œæ›´å¿«ï¼Œä½†æ˜¯nginxä»…æ”¯æŒHTTPåè®®ï¼Œæ‰€ä»¥æœ¬æ–‡ä½¿ç”¨nginxåšè´Ÿè½½å‡è¡¡ï¼Œåœ¨åç«¯webæœåŠ¡å™¨ä¸Šé…ç½®apache+tomcatæœåŠ¡å¹¶ä½¿ç”¨ajpåè®®ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚\nå¯¹äºåç«¯tomcat clusterçš„sessionä¼šè¯ç®¡ç†ï¼Œæœ¬æ–‡å°†ä½¿ç”¨MSM\u0026ndash;Memcached_Session_Manageræ­å»º session server cluster, å®ç°sessionä¼šè¯ä¿æŒå’Œé«˜å¯ç”¨(sessionå…±äº«)ã€‚Memcachedæ˜¯ä¸€æ¬¾å¼€æºã€é«˜æ€§èƒ½ã€åˆ†å¸ƒå¼å†…å­˜å¯¹è±¡ç¼“å­˜ç³»ç»Ÿï¼Œå¯åº”ç”¨å„ç§éœ€è¦ç¼“å­˜çš„åœºæ™¯ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯é€šè¿‡é™ä½å¯¹Databaseçš„è®¿é—®æ¥åŠ é€Ÿwebåº”ç”¨ç¨‹åºã€‚å®ƒæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„â€œé”®å€¼å¯¹â€å­˜å‚¨ï¼Œç”¨äºå­˜å‚¨æ•°æ®åº“è°ƒç”¨ã€APIè°ƒç”¨æˆ–é¡µé¢å¼•ç”¨ç»“æœçš„ç›´æ¥æ•°æ®ï¼Œå¦‚å­—ç¬¦ä¸²ã€å¯¹è±¡ç­‰ã€‚ä½†æ˜¯ï¼Œtomcatä¸memcachedçš„ç»“åˆå¹¶ä¸æ˜¯ä¸ºäº†åŠ é€Ÿè·å–mysqlæ•°æ®çš„ï¼Œè€Œæ˜¯ä»…ä»…æŠŠtomcatè‡ªå·±ä¸å®¢æˆ·ç«¯ä¸€ä¾§ç»´æŒçš„ä¼šè¯ä¿å­˜åˆ°memcachedä¸­ï¼Œå®ƒä¸ç”¨æˆ·è¯·æ±‚æ— å…³ï¼Œæ˜¯æœåŠ¡ç«¯ä¸»åŠ¨è®°å½•clientèº«ä»½ä¿¡æ¯æˆ–è€…æ´»åŠ¨æ€§çš„æ•°æ®å¹¶å­˜åœ¨memcachedä¸­ï¼Œä»è€ŒåŠ é€Ÿå®¢æˆ·ç«¯ä¼šè¯è®¿é—®ï¼Œå®ç°åŠ¨æ€ç«™ç‚¹åŠ é€Ÿã€‚\nâ€‹\tæœ¬æ–‡é›†ç¾¤æ¶æ„å¦‚ä¸‹å›¾ï¼š IP åœ°å€åˆ†é…:\nnginx server : 192.168.196.130 web server 1 : 192.168.196.129 web server 2: 192.168.196.132 session server 1: 192.168.196.131 session server 2: 192.168.196.133 é…ç½®nginx LB server # $ yum install -y nginx $ vim /etc/nginx/conf.d/tomcat.conf upstream appsrvs { server 192.168.196.132:80; server 192.168.196.129:80; } server { listen 80 default_server; server_name www.fufeixiang.com; index index.jsp index.html; location / { proxy_pass http://appsrvs/; } } $ service nginx start æœ¬æ–‡é‡ç‚¹æ˜¯session server clusterçš„å®ç°ï¼Œè¿™é‡Œåªæ˜¯ç®€å•é…ç½®nginxåšè´Ÿè½½å‡è¡¡ï¼Œæ²¡æœ‰åšåŠ¨é™åˆ†ç¦»\né…ç½®apache+tomcat web server # web server1 apacheçš„é…ç½® $ yum install -y httpd $ vim /etc/httpd/conf.d/vhost_tom_ajp.conf \u0026lt;Virtualhost *:80\u0026gt; ServerName www.vhost1.com ProxyRequests Off ProxyVia On \u0026lt;--å“åº”æŠ¥æ–‡ä¸­æ·»åŠ Proxyviaä¿¡æ¯ ProxyPreserveHost On \u0026lt;--å‘åç«¯è½¬å‘ï¼Œä¿ç•™clientä¸»æœºå \u0026lt;Proxy *\u0026gt; Require all granted \u0026lt;/Proxy\u0026gt; ProxyPass / ajp://192.168.196.129:8009/ ProxyPassReverse / ajp://192.168.196.129:8009/ \u0026lt;--ä½¿ç”¨ajpåè®®å°†è¯·æ±‚è½¬å‘è‡³æœ¬æœºçš„tomcat \u0026lt;location /\u0026gt; Require all granted \u0026lt;/location\u0026gt; \u0026lt;/Virtualhost\u0026gt; tomcat server1 çš„é…ç½® å®‰è£…åŒ…ï¼šjava-1.8.0-openjdk-devel; tomcat-admin-webapps; tomcat-webapps; tomcat-docs-webapp â€‹ å¯¹äºsessioné›†ç¾¤çš„å…±äº«é—®é¢˜ï¼Œå‚è€ƒGitHubé¡¹ç›®https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration ï¼Œ ä½¿ç”¨memcached+javolution-serializer(å¯åºåˆ—åŒ–å·¥å…·)çš„è§£å†³æ–¹æ¡ˆã€‚ä¾æ®å…¶é…ç½®è¯´æ˜ï¼š\næ·»åŠ tomcatæ‰€ä¾èµ–çš„Memcached_Session_Manageçš„åº“æ–‡ä»¶ï¼š\njavolution-5.4.3.1.jar memcached-session-manager-tc7-2.1.1.jar memcached-session-manager-2.1.1.jar msm-javolution-serializer-2.1.1.jar spymemcached-2.11.1.jar\n$ mv javolution-5.4.3.1.jar memcached-session-manager-tc7-2.1.1.jar memcached-session-manager-2.1.1.jar msm-javolution-serializer-2.1.1.jar spymemcached-2.11.1.jar /usr/share/java/tomcat/\nä¿®æ”¹tomcatä¸»é…ç½®æ–‡ä»¶/etc/tomcat/server.xml $ vim /etc/tomcat/server.xml \u0026lt;Engine name=\u0026#34;Catalina\u0026#34; defaultHost=\u0026#34;localhost\u0026#34; jvmRoute=\u0026#34;tomcatA\u0026#34;\u0026gt; \u0026lt;--æ·»åŠ èŠ‚ç‚¹å”¯ä¸€æ ‡ç¤º \u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;webapps\u0026#34; unpackWARs=\u0026#34;true\u0026#34; autoDeploy=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;Context path=\u0026#34;/test\u0026#34; docBase=\u0026#34;/data/webapps/ROOT\u0026#34; reloadable=\u0026#34;true\u0026#34; \u0026gt; \u0026lt;--åº”ç”¨ç¨‹åºè·¯å¾„åˆ«å \u0026lt;Manager className=\u0026#34;de.javakaffee.web.msm.MemcachedBackupSessionManager\u0026#34; memcachedNodes=\u0026#34;n1:192.168.196.131:11211,n2:192.168.196.133:11211\u0026#34; \u0026lt;--å®šä¹‰session server èŠ‚ç‚¹ failoverNodes=\u0026#34;n2\u0026#34;\t\u0026lt;--n2èŠ‚ç‚¹ä¸ºbackup server requestUriIgnorePattern=\u0026#34;.*\\.(ico|png|gif|jpg|css|js)$\u0026#34; transcoderFactoryClass=\u0026#34;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory\u0026#34; /\u0026gt; \u0026lt;/Context\u0026gt; \u0026lt;Valve className=\u0026#34;org.apache.catalina.valves.AccessLogValve\u0026#34; directory=\u0026#34;logs\u0026#34; prefix=\u0026#34;localhost_access_log.\u0026#34; suffix=\u0026#34;.txt\u0026#34; pattern=\u0026#34;%h %l %u %t \u0026amp;quot;%r\u0026amp;quot; %s %b\u0026#34; /\u0026gt; \u0026lt;/Host\u0026gt; åˆ›å»ºæµ‹è¯•ç¨‹åº $ mkdir /data/webapps/ROOT/{classes,lib,WEB-INF} $ vim /data/webapps/ROOT/index.jsp \u0026lt;%@ page language=\u0026#34;java\u0026#34; %\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;TomcatA\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;\u0026lt;font color=\u0026#34;red\u0026#34;\u0026gt;TomcatA.sflying.com\u0026lt;/font\u0026gt;\u0026lt;/h1\u0026gt; \u0026lt;table align=\u0026#34;centre\u0026#34; border=\u0026#34;1\u0026#34;\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;Session ID\u0026lt;/td\u0026gt; \u0026lt;% session.setAttribute(\u0026#34;sflying.com\u0026#34;,\u0026#34;sflying.com\u0026#34;); %\u0026gt; \u0026lt;td\u0026gt;\u0026lt;%= session.getId() %\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;Created on\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;%= session.getCreationTime() %\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;/table\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; web server2 apacheçš„é…ç½® $ yum install -y httpd $ vim /etc/httpd/conf.d/vhost_tom_ajp.conf \u0026lt;Virtualhost *:80\u0026gt; ServerName www.vhost2.com ProxyRequests Off ProxyVia On ProxyPreserveHost On \u0026lt;Proxy *\u0026gt; Require all granted \u0026lt;/Proxy\u0026gt; ProxyPass / ajp://192.168.196.132:8009/ ProxyPassReverse / ajp://192.168.196.132:8009/ \u0026lt;location /\u0026gt; Require all granted \u0026lt;/location\u0026gt; \u0026lt;/Virtualhost\u0026gt; tomcat server2 çš„é…ç½® å‚ç…§tomcat server1çš„é…ç½®ï¼Œä¸‹è½½ä¾èµ–ç±»åº“ï¼Œå¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶ä»¥ä¸‹å‡ é¡¹\nserver.xml \u0026ndash;\u0026gt; \u0026lt;Engine name=\u0026quot;Catalina\u0026quot; defaultHost=\u0026quot;localhost\u0026quot; jvmRoute=\u0026quot;tomcatB\u0026quot;\u0026gt; /data/webapps/ROOT/index.jsp :\n\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;TomcatA\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;h1\u0026gt;\u0026lt;font color=\u0026quot;red\u0026quot;\u0026gt;TomcatA.sflying.com\u0026lt;/font\u0026gt;\u0026lt;/h1\u0026gt; é…ç½®memcached session server # $ yum install -y memcached $ vim /etc/sysconfig/memcached PORT=\u0026#34;11211\u0026#34; USER=\u0026#34;nobody\u0026#34; MAXCONN=\u0026#34;1024\u0026#34;\t\u0026lt;-- æœ€å¤§å¹¶å‘æ•°\tCACHESIZE=\u0026#34;64\u0026#34;\t\u0026lt;-- æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼Œegï¼š2048M\tOPTIONS=\u0026#34;\u0026#34; æµ‹è¯•ä¼šè¯ä¿æŒ # å¯åŠ¨æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—® åˆ·æ–°é¡µé¢ ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡ºï¼Œsession ID ä¸ session å‚¨å­˜èŠ‚ç‚¹ä½ç½®éƒ½ä¿æŒä¸å˜ï¼Œè‡³æ­¤åŸºäºsession server clusterçš„ä¼šè¯ä¿æŒå·²ç»å®ç°ã€‚\n","date":"19 September 2017","permalink":"/2017/09/nginx-tomcat-seesion-cluster/","section":"åšå®¢","summary":"â€‹ Tomcat æœåŠ¡å™¨æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æ”¾æºä»£ç çš„Web åº”ç”¨æœåŠ¡å™¨, æ˜¯ç¼–è¯‘JSP\\Servletçš„å®¹å™¨ï¼Œå¸¸ç”¨æ¥å¤„ç†åŠ¨æ€è¯·æ±‚ã€‚nginxå’Œapache HTTPæœåŠ¡å™¨æ˜¯é™æ€è§£æï¼Œæ“…é•¿å¤„ç†HTMLåŠå›¾ç‰‡ç­‰é™æ€è¯·æ±‚ï¼Œå¤„ç†é™æ€é¡µé¢æ•ˆç‡è¿œé«˜äºtomcatã€‚ä½¿ç”¨nginxçš„åŠ¨é™åˆ†ç¦»æœºåˆ¶ï¼Œå¯ä»¥å°†é™æ€è¯·æ±‚åˆ†å‘è‡³é™æ€æœåŠ¡å™¨(nginxæˆ–è€…apache)ï¼Œè€Œå°†åŠ¨æ€è¯·æ±‚åˆ†å‘è‡³åç«¯tomcatæœåŠ¡å™¨å¤„ç†ï¼Œä»è€Œæé«˜æœåŠ¡å™¨çš„å¹¶å‘å¤„ç†æ€§èƒ½ã€‚tomcatæ”¯æŒHTTPå’ŒAJPä¸¤ç§åè®®çš„è¿æ¥å™¨ï¼ŒAJPåè®®æ¯”HTTPæ›´ç¨³å®šå’Œæ›´å¿«ï¼Œä½†æ˜¯nginxä»…æ”¯æŒHTTPåè®®ï¼Œæ‰€ä»¥æœ¬æ–‡ä½¿ç”¨nginxåšè´Ÿè½½å‡è¡¡ï¼Œåœ¨åç«¯webæœåŠ¡å™¨ä¸Šé…ç½®apache+tomcatæœåŠ¡å¹¶ä½¿ç”¨ajpåè®®ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚\nå¯¹äºåç«¯tomcat clusterçš„sessionä¼šè¯ç®¡ç†ï¼Œæœ¬æ–‡å°†ä½¿ç”¨MSM\u0026ndash;Memcached_Session_Manageræ­å»º session server cluster, å®ç°sessionä¼šè¯ä¿æŒå’Œé«˜å¯ç”¨(sessionå…±äº«)ã€‚Memcachedæ˜¯ä¸€æ¬¾å¼€æºã€é«˜æ€§èƒ½ã€åˆ†å¸ƒå¼å†…å­˜å¯¹è±¡ç¼“å­˜ç³»ç»Ÿï¼Œå¯åº”ç”¨å„ç§éœ€è¦ç¼“å­˜çš„åœºæ™¯ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯é€šè¿‡é™ä½å¯¹Databaseçš„è®¿é—®æ¥åŠ é€Ÿwebåº”ç”¨ç¨‹åºã€‚å®ƒæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„â€œé”®å€¼å¯¹â€å­˜å‚¨ï¼Œç”¨äºå­˜å‚¨æ•°æ®åº“è°ƒç”¨ã€APIè°ƒç”¨æˆ–é¡µé¢å¼•ç”¨ç»“æœçš„ç›´æ¥æ•°æ®ï¼Œå¦‚å­—ç¬¦ä¸²ã€å¯¹è±¡ç­‰ã€‚ä½†æ˜¯ï¼Œtomcatä¸memcachedçš„ç»“åˆå¹¶ä¸æ˜¯ä¸ºäº†åŠ é€Ÿè·å–mysqlæ•°æ®çš„ï¼Œè€Œæ˜¯ä»…ä»…æŠŠtomcatè‡ªå·±ä¸å®¢æˆ·ç«¯ä¸€ä¾§ç»´æŒçš„ä¼šè¯ä¿å­˜åˆ°memcachedä¸­ï¼Œå®ƒä¸ç”¨æˆ·è¯·æ±‚æ— å…³ï¼Œæ˜¯æœåŠ¡ç«¯ä¸»åŠ¨è®°å½•clientèº«ä»½ä¿¡æ¯æˆ–è€…æ´»åŠ¨æ€§çš„æ•°æ®å¹¶å­˜åœ¨memcachedä¸­ï¼Œä»è€ŒåŠ é€Ÿå®¢æˆ·ç«¯ä¼šè¯è®¿é—®ï¼Œå®ç°åŠ¨æ€ç«™ç‚¹åŠ é€Ÿã€‚\nâ€‹\tæœ¬æ–‡é›†ç¾¤æ¶æ„å¦‚ä¸‹å›¾ï¼š IP åœ°å€åˆ†é…:\nnginx server : 192.168.196.130 web server 1 : 192.168.196.129 web server 2: 192.168.196.132 session server 1: 192.","title":"nginxè´Ÿè½½å‡è¡¡apache+tomcaté›†ç¾¤åŠsession server clusterçš„å®ç°"},{"content":"","date":"19 September 2017","permalink":"/tags/tomcat/","section":"Tags","summary":"","title":"tomcat"},{"content":"","date":"10 September 2017","permalink":"/tags/varnish/","section":"Tags","summary":"","title":"varnish"},{"content":"Varnishç®€ä»‹ # Varnishæ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ä¸”å¼€æºçš„åå‘ä»£ç†æœåŠ¡å™¨å’Œ HTTP åŠ é€Ÿå™¨ï¼Œæ”¯æŒé‡‡ç”¨åŸºäºlinuxç³»ç»Ÿå†…å­˜çš„ç¼“å­˜æœåŠ¡å™¨ã€‚\nvarnishçš„ç³»ç»Ÿæ¶æ„å¦‚ä¸‹å›¾ï¼š\nvarnishæ˜¯ä¸»è¦è¿è¡Œä¸¤ä¸ªè¿›ç¨‹ï¼šManagementè¿›ç¨‹å’ŒChildè¿›ç¨‹(ä¹Ÿå«Cacheè¿›ç¨‹)ï¼ŒåŸºäº epollæœºåˆ¶çš„å•è¿›ç¨‹å¤šçº¿ç¨‹æ¶æ„ Managementè¿›ç¨‹ç±»ä¼¼äºnginxä¸­çš„master,ä¸»è¦å®ç° ç¼–è¯‘VCLå¹¶åº”ç”¨æ–°é…ç½®(é€šçŸ¥å­è¿›ç¨‹);ç›‘æ§varnishæ ¼å­è¿›ç¨‹è¿è¡ŒçŠ¶æ€ï¼Œåˆå§‹åŒ–varnish; æä¾›ä¸€ä¸ªCLIæ¥å£(å‘½ä»¤è¡Œæ¥å£)æŒ‡æŒ¥ç®¡ç†è¿›ç¨‹ ç­‰ã€‚Managementè¿›ç¨‹ä¼šæ¯éš”å‡ ç§’é’Ÿæ¢æµ‹ä¸€ä¸‹Childè¿›ç¨‹ä»¥åˆ¤æ–­å…¶æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¦‚æœåœ¨æŒ‡å®šçš„æ—¶é•¿å†…æœªå¾—åˆ°Childè¿›ç¨‹çš„å›åº”ï¼ŒManagementå°†ä¼šé‡å¯æ­¤Childè¿›ç¨‹ã€‚ Childè¿›ç¨‹åŒ…å«å¤šç§ç±»å‹çš„çº¿ç¨‹ï¼Œå¸¸è§çš„å¦‚ï¼š Acceptorçº¿ç¨‹ï¼šæ¥æ”¶æ–°çš„è¿æ¥è¯·æ±‚å¹¶å“åº” Workerçº¿ç¨‹ï¼šchildè¿›ç¨‹ä¼šä¸ºæ¯ä¸ªä¼šè¯å¯åŠ¨ä¸€ä¸ªworkerçº¿ç¨‹ï¼Œå› æ­¤ï¼Œåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸­å¯èƒ½ä¼šå‡ºç°æ•°ç™¾ä¸ªworkerçº¿ç¨‹ç”šè‡³æ›´å¤š Expiryçº¿ç¨‹ï¼šä»ç¼“å­˜ä¸­æ¸…ç†è¿‡æœŸå†…å®¹ varnishé€šè¿‡ä½¿ç”¨VCL(Varnish Configuration Language )é…ç½®ç¼“å­˜ç³»ç»Ÿçš„ç¼“å­˜ç­–ç•¥ï¼ŒVCLç¼–è¯‘å™¨è°ƒç”¨Cç¼–è¯‘å™¨,Cç¼–è¯‘å™¨ç¼–è¯‘é…ç½®æ–‡ä»¶ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶å¹¶è¿æ¥è‡³childè¿›ç¨‹ã€‚ VCLè¯­æ³•æ ¼å¼\n(1)//ã€#æˆ–/* comment */ç”¨äºæ³¨é‡Š (2)sub $name å®šä¹‰å‡½æ•° (3)ä¸æ”¯æŒå¾ªç¯ï¼Œæœ‰å†…ç½®å˜é‡ (4)ä½¿ç”¨ç»ˆæ­¢è¯­å¥ï¼Œæ²¡æœ‰è¿”å›å€¼ (5)åŸŸä¸“ç”¨ (6)æ“ä½œç¬¦ï¼š=(èµ‹å€¼)ã€==(ç­‰å€¼æ¯”è¾ƒ)ã€~(æ¨¡å¼åŒ¹é…)ã€!(å–å)ã€\u0026amp;\u0026amp;(é€»è¾‘ä¸)ã€||(é€»è¾‘æˆ–)\nä¸‰ç±»ä¸»è¦è¯­æ³•ï¼š\nsub subroutine { ... } if CONDITION { ... } else { ... } return(), hash_data() VarnishçŠ¶æ€å¼•æ“(state engine) varnishå†…éƒ¨æœ‰å‡ ä¸ªæ‰€è°“çš„çŠ¶æ€(state)ï¼Œåœ¨è¿™äº›çŠ¶æ€ä¸Šå¯ä»¥é™„åŠ é€šè¿‡VCLå®šä¹‰çš„ç­–ç•¥ä»¥å®Œæˆç›¸åº”çš„ç¼“å­˜å¤„ç†æœºåˆ¶ï¼Œå› æ­¤VCLä¹Ÿç»å¸¸è¢«ç§°ä½œâ€œåŸŸä¸“ç”¨â€è¯­è¨€æˆ–çŠ¶æ€å¼•æ“ï¼Œâ€œåŸŸä¸“ç”¨â€æŒ‡çš„æ˜¯æœ‰äº›æ•°æ®ä»…å‡ºç°äºç‰¹å®šçš„çŠ¶æ€ä¸­ã€‚åœ¨VCLçŠ¶æ€å¼•æ“ä¸­ï¼ŒçŠ¶æ€ä¹‹é—´å…·æœ‰ç›¸å…³æ€§ï¼Œä½†å½¼æ­¤é—´äº’ç›¸éš”ç¦»ï¼Œæ¯ä¸ªå¼•æ“ä½¿ç”¨return(x)æ¥é€€å‡ºå½“å‰çŠ¶æ€å¹¶è”è‡³å“ªä¸ªä¸‹ä¸€çº§å¼•æ“ï¼›æ¯ä¸ªçŠ¶æ€å¼•æ“å¯¹åº”äºvclæ–‡ä»¶(default.vcl)ä¸­çš„ä¸€ä¸ªé…ç½®æ®µï¼Œå³ä¸ºsubroutineã€‚ä¾‹å¦‚ï¼š\nvcl_recv \u0026ndash; å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„ç¬¬ä¸€æ­¥ï¼Œåˆ†ææ˜¯å¦ä¸ºæ ‡å‡†HTTPè¯·æ±‚ï¼Œæ˜¯å¦ä¸ºå¯ç¼“å­˜èµ„æºç­‰\nvcl_synth \u0026ndash; ç”¨äºåˆæˆå“åº”æŠ¥æ–‡\nvcl_purge \u0026ndash; ç”¨äºåˆ é™¤æŸæ¡ç¼“å­˜è®°å½•\nvcl_backend_fetch \u0026ndash; æ ¹æ®æœåŠ¡å™¨ç«¯çš„å“åº”ä½œå‡ºç¼“å­˜å†³ç­–ï¼ˆeg:æ˜¯å¦å…ˆç¼“å­˜å†å“åº”ç»™å®¢æˆ·ç«¯ï¼‰\nvcl_pass \u0026ndash; ä¸èƒ½ç¼“å­˜çš„è¯·æ±‚è·³è½¬åˆ°vcl_backend_fetchçŠ¶æ€\nä¸¤ä¸ªç‰¹æ®Šçš„å¼•æ“ï¼š vcl_init \u0026ndash; åœ¨å¤„ç†ä»»ä½•è¯·æ±‚ä¹‹å‰è¦æ‰§è¡Œçš„vclä»£ç ï¼šä¸»è¦ç”¨äºåˆå§‹åŒ–åŠ è½½é¢å¤–æ¨¡å—ï¼›vclé…ç½®æ–‡ä»¶ä¸­è¦å…ˆäºvcl_recvå®šä¹‰ vcl_fini \u0026ndash; æ‰€æœ‰çš„è¯·æ±‚éƒ½å·²ç»ç»“æŸï¼Œåœ¨vclé…ç½®è¢«ä¸¢å¼ƒæ—¶è°ƒç”¨ï¼›ä¸»è¦ç”¨äºæ¸…ç†VMODsï¼›\nå˜é‡ åœ¨vclé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šç¼“å­˜è§„åˆ™æ—¶ï¼Œå¯ä»¥å¼•ç”¨å˜é‡ï¼ŒåŒ…æ‹¬å†…å»ºå˜é‡ä¸è‡ªå®šä¹‰å˜é‡\nå†…å»ºå˜é‡ï¼š â€‹ req.*ï¼šrequestï¼Œè¡¨ç¤ºç”±å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚æŠ¥æ–‡ç›¸å…³\nâ€‹ req.http.*\nâ€‹ req.http.User-Agent å®¢æˆ·ç«¯è®¾å¤‡ç±»å‹\nâ€‹ req.http.Referer è¶…é“¾æ¥è·³è½¬åœ°å€\nâ€‹ bereq.*ï¼šç”±varnishå‘å¾€BEä¸»æœºè¯·æ±‚æŠ¥æ–‡ç›¸å…³\nâ€‹ bereq.http.*\nâ€‹ beresp.*ï¼šç”±BEä¸»æœºå“åº”ç»™varnishçš„å“åº”æŠ¥æ–‡ç›¸å…³\nâ€‹ beresp.http.*\nâ€‹ resp.*ï¼šç”±varnishå“åº”ç»™clientç›¸å…³\nâ€‹ obj.*ï¼šå­˜å‚¨åœ¨ç¼“å­˜ç©ºé—´ä¸­çš„ç¼“å­˜å¯¹è±¡çš„å±æ€§ï¼›åªè¯»\nâ€‹ server.*\nâ€‹ server.ipï¼švarnishä¸»æœºçš„IP\nâ€‹ server.hostnameï¼švarnishä¸»æœºçš„Hostname\nâ€‹ client.*\nâ€‹ client.ipï¼šå‘è¯·æ±‚è‡³varnishä¸»æœºçš„å®¢æˆ·ç«¯IP\nè‡ªå®šä¹‰å˜é‡ â€‹ set/unset\nè¯¦æƒ…è¯·å‚è€ƒhttps://varnish-cache.org/docs/4.0/\nvarnishå®‰è£…ä¸é…ç½® # ä½¿ç”¨yumæºå®‰è£…varnish$ yum install -y varnish\né…ç½®æ–‡ä»¶ï¼š/etc/varnish/varnish.params \u0026ndash;\u0026gt; é…ç½®varnishæœåŠ¡è¿›ç¨‹çš„å·¥ä½œç‰¹æ€§\nVARNISH_LISTEN_PORT=6081 \u0026ndash; varnish æœåŠ¡è¿›ç¨‹ç›‘å¬çš„ç«¯å£\nVARNISH_ADMIN_LISTEN_ADDRESS=127.0.0.1\nVARNISH_ADMIN_LISTEN_PORT=6082\nâ€‹ varnishadmå‘½ä»¤è¡Œå·¥å…·è¿å…¥CLIæ¥å£çš„åœ°å€ä¸ç«¯å£\nVARNISH_STORAGE=\u0026ldquo;malloc,1024M\u0026rdquo;\nâ€‹ varnishçš„ç¼“å­˜å­˜å‚¨æœºåˆ¶( Storage Types)ï¼š\nâ€‹ malloc[,size] \u0026mdash; å†…å­˜å­˜å‚¨ï¼Œ[,size]ç”¨äºå®šä¹‰ç©ºé—´å¤§å°ï¼›é‡å¯åæ‰€æœ‰ç¼“å­˜é¡¹å¤±\nâ€‹ file[,path[,size[,granularity]]] \u0026mdash; ç£ç›˜æ–‡ä»¶å­˜å‚¨ï¼Œé»‘ç›’ï¼›é‡å¯åæ‰€æœ‰ç¼“å­˜é¡¹å¤±æ•ˆ\nâ€‹ persistent,path,size \u0026mdash; æ–‡ä»¶å­˜å‚¨ï¼Œé»‘ç›’ï¼›é‡å¯åæ‰€æœ‰ç¼“å­˜é¡¹æœ‰æ•ˆï¼›å®éªŒé˜¶æ®µ\nDAEMON_OPTS=\u0026quot;-P thread_pools=2 -p thread_pool_max=1000 thread_pool_timeout=300\u0026quot;\nâ€‹ æŒ‡å®švarnishçš„è¿è¡Œæ—¶å‚æ•°threadã€timerç›¸å…³\né…ç½®æ–‡ä»¶ï¼š/etc/varnish/default.vcl \u0026ndash;\u0026gt;é…ç½®å„Child/Cacheçº¿ç¨‹çš„ç¼“å­˜ç­–ç•¥ ç»“åˆä¸€ä¸‹ç¤ºä¾‹æ¥ç†Ÿæ‚‰vclé…ç½®ï¼š\nä½¿ç”¨å†…å»ºå˜é‡obj.hits(ç”¨äºä¿å­˜æŸç¼“å­˜é¡¹çš„ä»ç¼“å­˜ä¸­å‘½ä¸­çš„æ¬¡æ•°)åœ¨å“åº”æŠ¥æ–‡ä¸­æ·»åŠ ç¼“å­˜æ ‡è®° $ vim /etc/varnish/default.vcl backend default { \u0026lt;-- å®šä¹‰åç«¯æœåŠ¡å™¨ç›‘å¬çš„IPä¸ç«¯å£ .host = \u0026#34;192.168.196.132\u0026#34;; .port = \u0026#34;80\u0026#34;; } sub vcl_deliver { if (obj.hits\u0026gt;0) { set resp.http.X-Cache = \u0026#34;HIT via \u0026#34; + server.ip; } else { set resp.http.X-Cache = \u0026#34;MISS from \u0026#34; + server.ip; } } $ varnish_reload_vcl \u0026lt;--è‡ªåŠ¨åŠ è½½cmd Loading vcl from /etc/varnish/default.vcl Current running config name is Using new config name reload_2017-09-07T16:02:29 VCL compiled. VCL \u0026#39;reload_2017-09-07T16:02:29\u0026#39; now active available 0 boot active 0 reload_2017-09-07T16:02:29 \u0026lt;--å½“æœŸä½¿ç”¨çš„ç‰ˆæœ¬ Done æµè§ˆå™¨ä¸­è®¿é—®http://192.168.196.133:6081ï¼Œåˆ·æ–°ä¹‹åï¼Œä»å“åº”æŠ¥æ–‡çš„X-Cacheå­—æ®µå¯ä»¥çœ‹å‡ºè¯·æ±‚çš„èµ„æºæ˜¯å¦è¢«ç¼“å­˜\nå¼ºåˆ¶å¯¹æŸç±»èµ„æºçš„è¯·æ±‚ä¸æ£€æŸ¥ç¼“å­˜ï¼ˆeg:ç”¨æˆ·ç§æœ‰æ•°æ®ï¼‰ $ vim /etc/varnish/default.vcl vcl_recv { if (req.url ~ \u0026#34;(?i)^/(login|admin)\u0026#34;) { \u0026lt;-- /loginä¸/adminç›®å½•ä¸‹å‡ä¸èƒ½ç¼“å­˜ return(pass); } } $ varnishadm -S /etc/varnish/secret -T 127.0.0.1:6082 \u0026lt;-- ä½¿ç”¨varnishadmå·¥å…·æ‰‹åŠ¨reloadé…ç½®æ–‡ä»¶ vcl.list 200 available 0 boot active 0 reload_2017-09-07T16:02:29 vcl.load test1 default.vcl 200 VCL compiled. vcl.use test1 200 VCL \u0026#39;test1\u0026#39; now active æµè§ˆå™¨ä¸­è®¿é—®http://192.168.196.133:6081/loginï¼Œæ— è®ºå¦‚ä½•åˆ·æ–°ï¼ŒX-Cacheå­—æ®µå‡æ˜¾ç¤º\u0026rsquo;MISS from 192.168.196.133'\nç¼“å­˜å¯¹è±¡çš„ä¿®å‰ª \u0026ndash;\u0026gt; åœ¨ç¼“å­˜æœ‰é™æœŸå†…ï¼Œåç«¯æœåŠ¡ç«¯èµ„æºæ›´æ–°æ—¶å°±éœ€è¦æ‰‹åŠ¨åˆ é™¤ç¼“å­˜ purge ä¸€æ¬¡åˆ é™¤ä¸€æ¡ç¼“å­˜è®°å½• $ vim /etc/varnish/default.vcl acl purgers { \u0026lt;--åªå…è®¸aclå†…çš„IPèƒ½ä½¿ç”¨purgeæ–¹æ³• \u0026#34;127.0.0.0\u0026#34;/8; \u0026lt;--å¿…é¡»ä»¥127.0.0.1ä¸ºclientå‘å‡ºè¯·æ±‚æ‰ç¬¦åˆæ­¤acl \u0026#34;192.168.196.130\u0026#34;; } vcl_recv { if (req.method == \u0026#34;PURGE\u0026#34;) { \u0026lt;--è‡ªå®šä¹‰è¯·æ±‚æ–¹æ³•PURGEæ—¶è½¬åˆ°vcl_purge if (!client.ip ~ purgers) { return(synth(405,\u0026#34;Purging not allowed for \u0026#34; + client.ip)); } return(purge); } } reloadä¹‹ååœ¨å®¢æˆ·ç«¯192.168.196.130ä¸Šä½¿ç”¨curlå‘½ä»¤æµ‹è¯•\n$ curl -I http://192.168.196.133:6081 HTTP/1.1 200 OK Server: nginx/1.10.2 Date: Thu, 07 Sep 2017 12:57:43 GMT Content-Type: text/html Content-Length: 17 Last-Modified: Tue, 05 Sep 2017 07:38:56 GMT ETag: \u0026#34;59ae5490-11\u0026#34; X-Varnish: 32819 32817 Age: 2 Via: 1.1 varnish-v4 X-Cache: HIT via 192.168.196.133 \u0026lt;--å·²ç¼“å­˜ Connection: keep-alive $ curl -X PURGE http://192.168.196.133:6081 \u0026lt;--å®šä¹‰è¯·æ±‚æ–¹æ³•ä¸ºPURGE \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;200 Purged\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Error 200 Purged\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Purged\u0026lt;/p\u0026gt; \u0026lt;h3\u0026gt;Guru Meditation:\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;XID: 131101\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;p\u0026gt;Varnish cache server\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; [root@Centos7 varnish]# curl -I http://192.168.196.133:6081 HTTP/1.1 200 OK Server: nginx/1.10.2 Date: Thu, 07 Sep 2017 13:01:10 GMT Content-Type: text/html Content-Length: 17 Last-Modified: Tue, 05 Sep 2017 07:38:56 GMT ETag: \u0026#34;59ae5490-11\u0026#34; X-Varnish: 32821 Age: 0 Via: 1.1 varnish-v4 X-Cache: MISS from 192.168.196.133 \u0026lt;--æœªåˆ°è¿‡æœŸæ—¶é—´ï¼Œå·²ç»æ²¡æœ‰ç¼“å­˜ Connection: keep-alive $ curl -X PURGE 192.168.196.133:6081 \u0026lt;--å®¢æˆ·ç«¯192.168.196.132ä¸­è®¿é—® \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;405 Purging not allowed for 192.168.196.132\u0026lt;/title\u0026gt; \u0026lt;--132ä¸åœ¨aclå®šä¹‰ä¸­ï¼Œæ²¡æœ‰æƒé™ \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Error 405 Purging not allowed for 192.168.196.132\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Purging not allowed for 192.168.196.132\u0026lt;/p\u0026gt; \u0026lt;h3\u0026gt;Guru Meditation:\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;XID: 32833\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;p\u0026gt;Varnish cache server\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Banning\nä½¿ç”¨varnishadmå·¥å…·åˆ é™¤ â€‹ ban $ varnishadm -S /etc/varnish/secret -T 127.0.0.1:6082 ban req.url ~ ^/images \u0026lt;-- å°†imageså¼€å¤´çš„è¯·æ±‚çš„ç¼“å­˜ï¼Œå…¨éƒ¨åˆ é™¤ åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ï¼Œä½¿ç”¨ban()å‡½æ•° $ vim /etc/varnish/default.vcl acl bans { \u0026#34;127.0.0.0\u0026#34;/8; \u0026#34;192.168.196.130\u0026#34;; } if (req.method == \u0026#34;BAN\u0026#34; ){ if (!client.ip ~ bans){ return(synth(405,\u0026#34;Ban not allowed for \u0026#34; + client.ip)); } #å°†è¯·æ±‚çš„èµ„æºåˆ é™¤ã€‚è¯·æ±‚ä»€ä¹ˆï¼Œåˆ ä»€ä¹ˆ ban(\u0026#34;req.http.host == \u0026#34; + req.http.host + \u0026#34; \u0026amp;\u0026amp; req.url == \u0026#34; + req.url); return(synth(200,\u0026#34;Ban succeed\u0026#34;)); } reloadä¹‹ååœ¨å®¢æˆ·ç«¯192.168.196.130ä¸Šä½¿ç”¨curlå‘½ä»¤æµ‹è¯•\n$ curl -I 192.168.196.133:6081 HTTP/1.1 200 OK Server: nginx/1.10.2 Date: Thu, 07 Sep 2017 13:41:13 GMT Content-Type: text/html Content-Length: 17 Last-Modified: Tue, 05 Sep 2017 07:38:56 GMT ETag: \u0026#34;59ae5490-11\u0026#34; X-Varnish: 131127 32840 Age: 2 Via: 1.1 varnish-v4 X-Cache: HIT via 192.168.196.133 $ curl -X BAN 192.168.196.133:6081 \u0026lt;--å®šä¹‰è¯·æ±‚æ–¹æ³•ä¸ºBAN \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;200 Ban succeed\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Error 200 Ban succeed\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Ban succeed\u0026lt;/p\u0026gt; \u0026lt;h3\u0026gt;Guru Meditation:\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;XID: 131129\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;p\u0026gt;Varnish cache server\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; $ curl -X BAN 192.168.196.133:6081 \u0026lt;--å®¢æˆ·ç«¯192.168.196.132ä¸­è®¿é—® \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;405 Ban not allowed for 192.168.196.132\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Error 405 Ban not allowed for 192.168.196.132\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Ban not allowed for 192.168.196.132\u0026lt;/p\u0026gt; \u0026lt;h3\u0026gt;Guru Meditation:\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;XID: 131144\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;p\u0026gt;Varnish cache server\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; è°ƒåº¦å¤šä¸ªåç«¯ä¸»æœºçš„è®¾å®š varnishæœåŠ¡å™¨çš„è®¾å®š $ vim /etc/varnish/default.vcl import directors; \u0026lt;--éœ€è¦å…ˆå¯¼å…¥directorsæ¨¡å— backend imgsrv1 { .host = \u0026#34;192.168.196.129\u0026#34;; .port = \u0026#34;80\u0026#34;; } backend imgsrv2 { .host = \u0026#34;192.168.196.130\u0026#34;; .port = \u0026#34;80\u0026#34;; } backend default { .host = \u0026#34;192.168.196.132\u0026#34;; .port = \u0026#34;80\u0026#34;; } sub vcl_init { \u0026lt;-- åˆå§‹åŒ–directorsè®¾å®š,éœ€è¦åœ¨vcl_recvä¹‹å‰ new imgsrvs = directors.round_robin(); \u0026lt;-- è‡ªå®šä¹‰åç«¯é›†ç¾¤åå­—ã€è°ƒåº¦ç®—æ³• imgsrvs.add_backend(imgsrv1); \u0026lt;-- æŒ‡å®šè¦è°ƒåº¦çš„åç«¯ä¸»æœº imgsrvs.add_backend(imgsrv2); } sub vcl_recv { if (req.url ~ \u0026#34;(?i)\\.(jpg|png|txt)$\u0026#34;){ set req.backend_hint = imgsrvs.backend(); \u0026lt;-- å¯¹jpg/png/txtè®¿é—®è°ƒåº¦åˆ°åç«¯imgsrvsé›†ç¾¤ }else{ set req.backend_hint = default; } if (req.url ~ \u0026#34;(?i)\\.txt$\u0026#34;){ \u0026lt;-- ä¸ºçœ‹å‡ºè½®è¯¢æ•ˆæœï¼Œä¸ç¼“å­˜.txtæ–‡ä»¶ return(pass); } } åœ¨imgsrv1/imgsrv2æ ¹ç›®å½•ä¸Šåˆ†åˆ«åˆ›å»ºtest.txt\n192.168.196.129 \u0026ndash;\u0026gt; echo \u0026ldquo;Backend imgsrv1\u0026rdquo; \u0026gt; /usr/share/nginx/html/test.txt\n192.168.196.130 \u0026ndash;\u0026gt; echo \u0026ldquo;Backend imgsrv2\u0026rdquo; \u0026gt; /usr/share/nginx/html/test.txt\nä¸ºäº†çœ‹å‡ºåç«¯æœåŠ¡å™¨è½®è¯¢çš„è°ƒåº¦æ•ˆæœï¼Œåœ¨vclé…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸ç¼“å­˜.txtç»“å°¾çš„æ–‡ä»¶ï¼Œä½¿ç”¨curlå‘½ä»¤è®¿é—®\n$ while : ; do curl 192.168.196.133:6081/test.txt; sleep 1; done Backend imgsrv1 Backend imgsrv2 Backend imgsrv1 Backend imgsrv2 Backend imgsrv1 åç«¯ä¸»æœºå¥åº·æ£€æµ‹è®¾ç½® æ–¹æ³•ä¸€ï¼šç›´æ¥åœ¨Backend ä¸‹å®šä¹‰.probe å¥åº·çŠ¶æ€æ£€æµ‹æ–¹æ³•\nbackend BE_NAME { .host = .port = .probe = { .url= \u0026lt;--æ£€æµ‹æ—¶è¦è¯·æ±‚çš„URLï¼Œé»˜è®¤ä¸ºâ€/\u0026#34; .timeout= \u0026lt;--è¶…æ—¶æ—¶é•¿ .interval= \u0026lt;--æ£€æµ‹é¢‘ç‡ .window= \u0026lt;--åŸºäºæœ€è¿‘çš„å¤šå°‘æ¬¡æ£€æŸ¥æ¥åˆ¤æ–­å…¶å¥åº·çŠ¶æ€ .threshold= \u0026lt;--æœ€è¿‘.windowæ¬¡æ£€æŸ¥ä¸­å¤šå°‘æ¬¡æˆåŠŸæ‰ç®—å¥åº· } } æ–¹æ³•äºŒï¼šå®šä¹‰probe,ç„¶ååœ¨å„ä¸ªbackendä¸­è°ƒç”¨\nprobe PB_NAME { } \u0026lt;---å®šä¹‰ä¸€ä¸ªprobe å†è°ƒç”¨ backend NAME = { .probe = PB_NAME; ... } åœ¨å„ä¸ªåç«¯ä¸»æœºWebæœåŠ¡æ ¹ç›®å½•åˆ›å»º.healthchk.htmlæ–‡ä»¶ï¼Œç”¨ä½œå¥åº·æ£€æµ‹ ä¿®æ”¹vclé…ç½®æ–‡ä»¶ $ vim /etc/varnish/default.vcl probe healthchk{ .url = \u0026#34;/.healthchk.html\u0026#34;; .timeout = 1s; .interval = 2s; .window = 5; .threshold =4; } backend imgsrv1 { .host = \u0026#34;192.168.196.129\u0026#34;; .port = \u0026#34;80\u0026#34;; .probe = healthchk; } backend imgsrv2 { .host = \u0026#34;192.168.196.130\u0026#34;; .port = \u0026#34;80\u0026#34;; .probe = healthchk; } backend default { .host = \u0026#34;192.168.196.132\u0026#34;; .port = \u0026#34;80\u0026#34;; .probe = healthchk; } åœ¨reloadä¹‹åä½¿ç”¨varnishadmå·¥å…·æŸ¥çœ‹backendçŠ¶æ€ $ varnishadm -S secret -T 127.0.0.1:6082 backend.list 200 Backend name Refs Admin Probe imgsrv1(192.168.196.129,,80) 1 probe Healthy 5/5 imgsrv2(192.168.196.130,,80) 1 probe Healthy 5/5 default(192.168.196.132,,80) 1 probe Healthy 5/5 æ‰‹åŠ¨åœæ­¢imgsrv1çš„nginx webæœåŠ¡ï¼Œcurlå‘½ä»¤æµ‹è¯• $ while : ; do curl 192.168.196.133:6081/test.txt;sleep 1; done Backend imgsrv1 Backend imgsrv2 Backend imgsrv1 Backend imgsrv2 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;503 Backend fetch failed\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Error 503 Backend fetch failed\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Backend fetch failed\u0026lt;/p\u0026gt; \u0026lt;h3\u0026gt;Guru Meditation:\u0026lt;/h3\u0026gt; \u0026lt;p\u0026gt;XID: 32828\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;p\u0026gt;Varnish cache server\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Backend imgsrv2 Backend imgsrv2 Backend imgsrv2 varnishadmå·¥å…·æŸ¥çœ‹backendçŠ¶æ€, imgsrv1æ˜¾ç¤ºä¸ºSickï¼›é‡å¯imgsrv1 nginxæœåŠ¡å³å¯æ¢å¤ $ varnishadm -S secret -T 127.0.0.1:6082 backend.list 200 Backend name Refs Admin Probe imgsrv1(192.168.196.129,,80) 1 probe Sick 0/5 imgsrv2(192.168.196.130,,80) 1 probe Healthy 5/5 default(192.168.196.132,,80) 1 probe Healthy 5/5 æ‰‹åŠ¨è®¾å®šBEä¸»æœºçš„çŠ¶æ€ sick \u0026ndash; æ‰‹åŠ¨æ ‡è®°ä¸ºdown healthy \u0026ndash; ç®¡ç†up, æ°¸ä¹…å¥åº· auto \u0026ndash; probe auto $ varnishadm -S secret -T 127.0.0.1:6082 backend.set_health imgsrv1 sick 200 backend.list 200 Backend name Refs Admin Probe imgsrv1(192.168.196.129,,80) 1 sick Healthy 5/5 imgsrv2(192.168.196.130,,80) 1 probe Healthy 5/5 default(192.168.196.132,,80) 1 probe Healthy 5/5 åç«¯ä¸»æœºå…¶å®ƒå±æ€§è®¾ç½® backend BE_NAME { ... .connect_timeout = 0.5s; \u0026lt;--æ³¨æ„æ˜¯TCPè¿æ¥ï¼Œä¸æ˜¯httpè¿æ¥ .first_byte_timeout = 20s; \u0026lt;--åç«¯ä¸»æœºå“åº”é¦–å­—èŠ‚ä¼ è¾“è¶…æ—¶æ—¶é—´ .between_bytes_timeout = 5s; \u0026lt;--å­—èŠ‚ä¼ è¾“ä¸­é—´é—´éš”æ—¶é•¿ .max_connections = 50; \u0026lt;--æœ€å¤§å¹¶å‘è¿æ¥æ•° } varnishæ—¥å¿— # varnishlog \u0026ndash;Display Varnish logs å®æ—¶è·å–varnishæœåŠ¡å™¨è¯¦ç»†çš„æ¥æ”¶è¯·æ±‚åŠå“åº”æ—¥å¿—ï¼Œå¸¸ç”¨äºdebug\nvarnishncsa - Display Varnish logs in Apache / NCSA combined log format ncsaæ ¼å¼çš„æ—¥å¿—,ä½¿ç”¨å‘½ä»¤è¡Œcmdå®æ—¶è·å–\n$ varnishncsa 192.168.196.130 - - [09/Sep/2017:13:05:10 +0800] \u0026#34;GET http://192.168.196.133:6081/ HTTP/1.1\u0026#34; 200 25 \u0026#34;-\u0026#34; \u0026#34;curl/7.29.0\u0026#34; æˆ–è€…ä½¿æ­¤æœåŠ¡å·¥ä½œäºåå°è®°å½•æ—¥å¿—\n$ /usr/bin/varnishncsa -a -w /var/log/varnish/varnishncsa.log -D åœ¨Centos7ä¸­varnishncsaä¸ºå•ç‹¬çš„æœåŠ¡ï¼Œå¯åŠ¨å³å¯$systemctl start varnishncsa\n","date":"10 September 2017","permalink":"/2017/09/varnish/","section":"åšå®¢","summary":"Varnishç®€ä»‹ # Varnishæ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ä¸”å¼€æºçš„åå‘ä»£ç†æœåŠ¡å™¨å’Œ HTTP åŠ é€Ÿå™¨ï¼Œæ”¯æŒé‡‡ç”¨åŸºäºlinuxç³»ç»Ÿå†…å­˜çš„ç¼“å­˜æœåŠ¡å™¨ã€‚\nvarnishçš„ç³»ç»Ÿæ¶æ„å¦‚ä¸‹å›¾ï¼š\nvarnishæ˜¯ä¸»è¦è¿è¡Œä¸¤ä¸ªè¿›ç¨‹ï¼šManagementè¿›ç¨‹å’ŒChildè¿›ç¨‹(ä¹Ÿå«Cacheè¿›ç¨‹)ï¼ŒåŸºäº epollæœºåˆ¶çš„å•è¿›ç¨‹å¤šçº¿ç¨‹æ¶æ„ Managementè¿›ç¨‹ç±»ä¼¼äºnginxä¸­çš„master,ä¸»è¦å®ç° ç¼–è¯‘VCLå¹¶åº”ç”¨æ–°é…ç½®(é€šçŸ¥å­è¿›ç¨‹);ç›‘æ§varnishæ ¼å­è¿›ç¨‹è¿è¡ŒçŠ¶æ€ï¼Œåˆå§‹åŒ–varnish; æä¾›ä¸€ä¸ªCLIæ¥å£(å‘½ä»¤è¡Œæ¥å£)æŒ‡æŒ¥ç®¡ç†è¿›ç¨‹ ç­‰ã€‚Managementè¿›ç¨‹ä¼šæ¯éš”å‡ ç§’é’Ÿæ¢æµ‹ä¸€ä¸‹Childè¿›ç¨‹ä»¥åˆ¤æ–­å…¶æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¦‚æœåœ¨æŒ‡å®šçš„æ—¶é•¿å†…æœªå¾—åˆ°Childè¿›ç¨‹çš„å›åº”ï¼ŒManagementå°†ä¼šé‡å¯æ­¤Childè¿›ç¨‹ã€‚ Childè¿›ç¨‹åŒ…å«å¤šç§ç±»å‹çš„çº¿ç¨‹ï¼Œå¸¸è§çš„å¦‚ï¼š Acceptorçº¿ç¨‹ï¼šæ¥æ”¶æ–°çš„è¿æ¥è¯·æ±‚å¹¶å“åº” Workerçº¿ç¨‹ï¼šchildè¿›ç¨‹ä¼šä¸ºæ¯ä¸ªä¼šè¯å¯åŠ¨ä¸€ä¸ªworkerçº¿ç¨‹ï¼Œå› æ­¤ï¼Œåœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸­å¯èƒ½ä¼šå‡ºç°æ•°ç™¾ä¸ªworkerçº¿ç¨‹ç”šè‡³æ›´å¤š Expiryçº¿ç¨‹ï¼šä»ç¼“å­˜ä¸­æ¸…ç†è¿‡æœŸå†…å®¹ varnishé€šè¿‡ä½¿ç”¨VCL(Varnish Configuration Language )é…ç½®ç¼“å­˜ç³»ç»Ÿçš„ç¼“å­˜ç­–ç•¥ï¼ŒVCLç¼–è¯‘å™¨è°ƒç”¨Cç¼–è¯‘å™¨,Cç¼–è¯‘å™¨ç¼–è¯‘é…ç½®æ–‡ä»¶ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶å¹¶è¿æ¥è‡³childè¿›ç¨‹ã€‚ VCLè¯­æ³•æ ¼å¼\n(1)//ã€#æˆ–/* comment */ç”¨äºæ³¨é‡Š (2)sub $name å®šä¹‰å‡½æ•° (3)ä¸æ”¯æŒå¾ªç¯ï¼Œæœ‰å†…ç½®å˜é‡ (4)ä½¿ç”¨ç»ˆæ­¢è¯­å¥ï¼Œæ²¡æœ‰è¿”å›å€¼ (5)åŸŸä¸“ç”¨ (6)æ“ä½œç¬¦ï¼š=(èµ‹å€¼)ã€==(ç­‰å€¼æ¯”è¾ƒ)ã€~(æ¨¡å¼åŒ¹é…)ã€!","title":"varnishç¼“å­˜æœåŠ¡å™¨çš„é…ç½®"},{"content":"","date":"7 August 2017","permalink":"/tags/dns/","section":"Tags","summary":"","title":"DNS"},{"content":"\u0026ldquo;å°±è¿‘\u0026quot;è§£æçš„ä¼˜ç‚¹ # â€‹ å‡è®¾æœ‰ä¸€ä¸ªé¢å‘å…¨ç½‘ç»œçš„webæœåŠ¡ï¼Œå¹¶ä¸”æœåŠ¡å™¨éƒ½é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè€Œè®¿é—®è¯·æ±‚æ˜¯æ¥è‡ªå…¨å›½å„åœ°çš„ï¼Œç½‘ç»œä¼ è¾“çº¿è·¯çš„é•¿çŸ­åŠ¿å¿…ä¼šå½±å“è®¿é—®å“åº”è´¨é‡å’Œé€Ÿåº¦ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜å®¢æˆ·ç«¯è®¿é—®é€Ÿåº¦ã€æä¾›å®¹é”™èƒ½åŠ›ç­‰ï¼Œå…¬å¸å¯èƒ½ä¼šæŒ‰åŒºåŸŸéƒ¨ç½²æœåŠ¡å™¨ï¼Œæ¯”å¦‚è¯´åœ¨åŒ—äº¬ã€æ­å·ã€å¹¿å·ç­‰åœ°ï¼Œæ¯å°æœåŠ¡å™¨åˆšå¥½èƒ½ä¼˜å…ˆå“åº”ç¦»è‡ªå·±æœ€è¿‘çš„è®¿é—®è¯·æ±‚ï¼Œä»è€Œæé«˜æœåŠ¡å™¨å“åº”é€Ÿåº¦ã€‚\nâ€‹ å®ç°\u0026quot;å°±è¿‘\u0026quot;è§£æçš„ä¸¤ç§æ–¹æ³•ï¼š\nwebè°ƒåº¦å™¨ ä»…æä¾›è¯·æ±‚è½¬å‘åŠŸèƒ½ï¼Œè½¬å‘ç»™åŒºåŸŸwebæœåŠ¡å™¨ï¼ŒæŠŠç¦»è¯·æ±‚ä¸»æœº\u0026quot;æœ€è¿‘\u0026quot;çš„æœåŠ¡å™¨IPè¿”å›ç»™dnsæœåŠ¡å™¨ï¼Œç„¶åè§£æ\ndnsæœåŠ¡å™¨ ç”±dnsæœåŠ¡å™¨æ ¹æ®æºåœ°å€ç›´æ¥è§£æåˆ°ç¦»è¯·æ±‚ä¸»æœº\u0026quot;æœ€è¿‘\u0026quot;çš„webæœåŠ¡å™¨,æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»æ­¤æ–¹æ³•çš„å®ç°\ndnsæœåŠ¡å™¨æ®æºåœ°å€è§£æçš„å®ç° # å®éªŒç¯å¢ƒ # ç³»ç»Ÿï¼šCentOS 7 dnsæœåŠ¡ç¨‹åºï¼šbind dnsæœåŠ¡å™¨IP: 192.168.196.168 å®šä¹‰aclå’Œå¯ç”¨view # acl: æŠŠä¸€ä¸ªæˆ–å¤šä¸ªåœ°å€å½’å¹¶ä¸ºä¸€ä¸ªé›†åˆï¼Œå¹¶é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„åç§°è°ƒç”¨ åªèƒ½å…ˆå®šä¹‰ï¼Œåä½¿ç”¨,ä¸€èˆ¬å®šä¹‰åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œ å¤„äºoptionsçš„å‰é¢\nâ€‹ æ ¼å¼ï¼š\nacl acl_name { ip; PREFIX; â€¦â€¦ }; view:è§†å›¾ï¼Œä¸€ä¸ªbindæœåŠ¡å™¨å¯å®šä¹‰å¤šä¸ªviewï¼Œæ¯ä¸ªviewä¸­å¯å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªzone æ¯ä¸ªviewç”¨æ¥åŒ¹é…ä¸€ç»„å®¢æˆ·ç«¯ å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œæ˜¯è‡ªä¸Šè€Œä¸‹æ£€æŸ¥æ¯ä¸ªviewæ‰€æœåŠ¡çš„å®¢æˆ·ç«¯åˆ—è¡¨\nâ€‹ æ ¼å¼ï¼š\nview shanghaiview{ match-clients { shanghai; }; include \u0026#34;/etc/named.shanghaiview.zones\u0026#34;; \u0026lt;--æŒ‡å®šå¯¹åº”åŒºåŸŸé…ç½®æ–‡ä»¶ }; ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/named.conf\nacl beijing { 192.168.196.130 ;}; \u0026lt;--å‡è®¾beijingåŒºåŸŸåªæœ‰IP.130 acl shanghai { 192.168.196.128 ;}; \u0026lt;--å‡è®¾shanghaiåŒºåŸŸåªæœ‰IP.128 acl other { any;}; \u0026lt;--å‡è®¾å…¶å®ƒåŒ…å«åœ¨otheråŒºåŸŸ options{ listen-on port 53 { localhost; }; \u0026lt;--localhostä¸ºå…³é”®å­—ï¼Œä»£è¡¨æœ¬æœºæ‰€æœ‰IP allow-query { any ; }; \u0026lt;--å¯æä¾›å¤–éƒ¨æœåŠ¡ï¼Œå…è®¸å…¶å®ƒä¸»æœºæŸ¥è¯¢ }; åˆ›å»ºviewå¯¹åº”çš„åŒºåŸŸé…ç½®æ–‡ä»¶ # zone \u0026ldquo;.\u0026rdquo; æŠŠname.confæ–‡ä»¶å®šä¹‰çš„æ ¹åŒºç§»åŠ¨åˆ°/etc/named.rfc1912.zonesä¸­\nä¸€æ—¦å¯ç”¨äº† viewï¼Œæ‰€æœ‰çš„zoneéƒ½åªèƒ½å®šä¹‰åœ¨viewä¸­\nzone \u0026#34;.\u0026#34; IN { type hint; file \u0026#34;named.ca\u0026#34;; }; åˆ›å»º/etc/named.beijingview.zones zone \u0026#34;ffu.com\u0026#34; IN { type master; file \u0026#34;ffu.com.zone.bj\u0026#34;; \u0026lt;--å¯¹åº”å„viewçš„åŒºåŸŸåº“æ–‡ä»¶å }; åˆ›å»º/etc/named.shanghaiview.zones zone \u0026#34;ffu.com\u0026#34; IN { type master; file \u0026#34;ffu.com.zone.sh\u0026#34;; }; åˆ›å»ºå„viewçš„åŒºåŸŸåº“æ–‡ä»¶ # /var/named/ffu.com.zone.bj\n$TTL 86400\t; 1 day @\tIN SOA\tdns1.ffu.com. dns1admin.ffu.com. ( 1 ; serial 86400 ; refresh (1 day) 3600 ; retry (1 hour) 604800 ; expire (1 week) 10800 ; minimum (3 hours) ) NS\tdns1.ffu.com. A\t1.1.1.1 dns1\tA\t192.168.196.168 test\tA\t8.8.8.8 websrv\tA\t10.10.10.10 www\tCNAME\twebsrv /var/named/ffu.com.zone.sh\n$TTL 86400\t; 1 day @\tIN SOA\tdns1.ffu.com. dns1admin.ffu.com. ( 1 ; serial 86400 ; refresh (1 day) 3600 ; retry (1 hour) 604800 ; expire (1 week) 10800 ; minimum (3 hours) ) NS\tdns1.ffu.com. A\t2.2.2.2 dns1\tA\t192.168.196.168 test\tA\t9.9.9.9 websrv\tA\t13.13.13.13 www\tCNAME\twebsrv /var/named/ffu.com.zone\n$ORIGIN . $TTL 86400\t; 1 day ffu.com\tIN SOA\tdns1.ffu.com. dns1admin.ffu.com. ( 2 ; serial 86400 ; refresh (1 day) 3600 ; retry (1 hour) 604800 ; expire (1 week) 10800 ; minimum (3 hours) ) NS\tdns1.ffu.com. A\t1.1.1.1 $ORIGIN ffu.com. dns1\tA\t192.168.196.168 test\tA\t8.8.8.8 websrv\tA\t1.1.1.1 www\tCNAME\twebsrv è®¿é—®æµ‹è¯• # 192.168.196.130 ä¸»æœº\n$ dig www.ffu.com @192.168.196.168 ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.9.4-RedHat-9.9.4-37.el7 \u0026lt;\u0026lt;\u0026gt;\u0026gt; www.ffu.com @192.168.196.168 ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 60401 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 2 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;www.ffu.com. IN A ;; ANSWER SECTION: www.ffu.com. 86400 IN CNAME websrv.ffu.com. websrv.ffu.com. 86400 IN A 10.10.10.10 \u0026lt;-- .130å±äºbeijingview,è§£æåˆ°10.10.10.10æœåŠ¡å™¨ ;; AUTHORITY SECTION: ffu.com. 86400 IN NS dns1.ffu.com. ;; ADDITIONAL SECTION: dns1.ffu.com. 86400 IN A 192.168.196.168 ;; Query time: 2 msec ;; SERVER: 192.168.196.168#53(192.168.196.168) ;; WHEN: Fri Jul 28 09:55:47 CST 2017 ;; MSG SIZE rcvd: 112 192.168.196.128 ä¸»æœº\n$ dig test.ffu.com @192.168.196.168 ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.8.2rc1-RedHat-9.8.2-0.62.rc1.el6 \u0026lt;\u0026lt;\u0026gt;\u0026gt; test.ffu.com @192.168.196.168 ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 57430 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 1 ;; QUESTION SECTION: ;test.ffu.com. IN A ;; ANSWER SECTION: test.ffu.com. 86400 IN A 9.9.9.9 \u0026lt;-- .128å±äºshanghaiview,è§£æåˆ°9.9.9.9æœåŠ¡å™¨ ;; AUTHORITY SECTION: ffu.com. 86400 IN NS dns1.ffu.com. ;; ADDITIONAL SECTION: dns1.ffu.com. 86400 IN A 192.168.196.168 ;; Query time: 2 msec ;; SERVER: 192.168.196.168#53(192.168.196.168) ;; WHEN: Fri Jul 28 00:05:52 2017 ;; MSG SIZE rcvd: 81 192.168.196.155 ä¸»æœº\n$dig www.ffu.com @192.168.196.168 ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.8.2rc1-RedHat-9.8.2-0.62.rc1.el6 \u0026lt;\u0026lt;\u0026gt;\u0026gt; www.ffu.com @192.168.196.168 ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 62993 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 2 ;; QUESTION SECTION: ;www.ffu.com. IN A ;; ANSWER SECTION: www.ffu.com. 86400 IN CNAME websrv.ffu.com. websrv.ffu.com. 86400 IN A 1.1.1.1 \u0026lt;-- .155å±äºotherview,è§£æåˆ°1.1.1.1æœåŠ¡å™¨ ;; AUTHORITY SECTION: ffu.com. 86400 IN NS dns1.ffu.com. ;; ADDITIONAL SECTION: dns1.ffu.com. 86400 IN A 192.168.196.168 ;; Query time: 2 msec ;; SERVER: 192.168.196.168#53(192.168.196.168) ;; WHEN: Thu Jul 27 02:29:47 2017 ;; MSG SIZE rcvd: 152 ","date":"7 August 2017","permalink":"/2017/08/dns-acl/","section":"åšå®¢","summary":"\u003ch3 class=\"relative group\"\u003e\u0026ldquo;å°±è¿‘\u0026quot;è§£æçš„ä¼˜ç‚¹ \n    \u003cdiv id=\"å°±è¿‘è§£æçš„ä¼˜ç‚¹\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e5%b0%b1%e8%bf%91%e8%a7%a3%e6%9e%90%e7%9a%84%e4%bc%98%e7%82%b9\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h3\u003e\n\u003cp\u003eâ€‹          å‡è®¾æœ‰ä¸€ä¸ªé¢å‘å…¨ç½‘ç»œçš„webæœåŠ¡ï¼Œå¹¶ä¸”æœåŠ¡å™¨éƒ½é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè€Œè®¿é—®è¯·æ±‚æ˜¯æ¥è‡ªå…¨å›½å„åœ°çš„ï¼Œç½‘ç»œä¼ è¾“çº¿è·¯çš„é•¿çŸ­åŠ¿å¿…ä¼šå½±å“è®¿é—®å“åº”è´¨é‡å’Œé€Ÿåº¦ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜å®¢æˆ·ç«¯è®¿é—®é€Ÿåº¦ã€æä¾›å®¹é”™èƒ½åŠ›ç­‰ï¼Œå…¬å¸å¯èƒ½ä¼šæŒ‰åŒºåŸŸéƒ¨ç½²æœåŠ¡å™¨ï¼Œæ¯”å¦‚è¯´åœ¨åŒ—äº¬ã€æ­å·ã€å¹¿å·ç­‰åœ°ï¼Œæ¯å°æœåŠ¡å™¨åˆšå¥½èƒ½ä¼˜å…ˆå“åº”ç¦»è‡ªå·±æœ€è¿‘çš„è®¿é—®è¯·æ±‚ï¼Œä»è€Œæé«˜æœåŠ¡å™¨å“åº”é€Ÿåº¦ã€‚\u003c/p\u003e","title":"DNSæœåŠ¡å™¨æ®æºåœ°å€è§£æçš„å®ç°"},{"content":"","date":"8 December 2016","permalink":"/tags/mysql/","section":"Tags","summary":"","title":"Mysql"},{"content":"","date":"8 December 2016","permalink":"/tags/xtrabackup/","section":"Tags","summary":"","title":"xtrabackup"},{"content":"Xtrabackupæ˜¯ç”±perconaæä¾›çš„mysqlæ•°æ®åº“å¤‡ä»½å·¥å…·ï¼Œæ”¯æŒå¯¹Innodbå­˜å‚¨å¼•æ“çš„æ•°æ®åº“åœ¨çº¿çƒ­å¤‡ä»½ï¼ˆå¤‡ä»½æ—¶ä¸å½±å“æ•°æ®è¯»å†™), å®ƒæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\n(1)å¤‡ä»½è¿‡ç¨‹å¿«é€Ÿã€å¯é ï¼› (2)å¤‡ä»½è¿‡ç¨‹ä¸ä¼šæ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡ï¼› (3)èƒ½å¤ŸåŸºäºå‹ç¼©ç­‰åŠŸèƒ½èŠ‚çº¦ç£ç›˜ç©ºé—´å’Œæµé‡ï¼› (4)è‡ªåŠ¨å®ç°å¤‡ä»½æ£€éªŒï¼› (5)è¿˜åŸé€Ÿåº¦å¿«ï¼›\næœ¬æ–‡ä½¿ç”¨çš„è½¯ä»¶åŒ…ä¸º percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm ï¼Œæœ€æ–°ç‰ˆçš„è½¯ä»¶å¯ä» http://www.percona.com/software/percona-xtrabackup/ è·å¾—\nä¸ºè§£å†³ä¾èµ–æ€§å…³ç³»ä½¿ç”¨yumæºå®‰è£…\n$ yum install -y ./percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm æœ¬æ–‡çš„å¤‡ä»½ç­–ç•¥ï¼š å…¨é‡å¤‡ä»½+å¢é‡å¤‡ä»½+binlog\nä½¿ç”¨rootç”¨æˆ·è¿›è¡Œä¸€æ¬¡å…¨é‡å¤‡ä»½ $ cd /var/lib/mysql $ innobackupex --user=root --host=localhost --password=123456 /data/backup/ ...ä¸­é—´çœç•¥... xtrabackup: Transaction log of lsn (310138946) to (310138946) was copied. 170915 20:31:03 completed OK! \u0026lt;-- æ˜¾ç¤ºå¤‡ä»½æˆåŠŸ $ ls /data/backup 2017-09-16_08-22-55 \u0026lt;-- å…¨é‡å¤‡ä»½ç”Ÿæˆçš„æ–‡ä»¶å¤¹ $ cd 2017-09-16_08-22-55/ $ ls backup-my.cnf ibdata1 performance_schema xtrabackup_checkpoints xtrabackup_logfile database mysql testdb xtrabackup_info $ testdbåº“ä¸­åˆ›å»ºæ–°è¡¨tb3å¹¶æ·»åŠ æ•°æ® $ mysql -uroot -p123456 Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 11 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; use testdb; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; show tables; +------------------+ | Tables_in_testdb | +------------------+ | tb1 | | tb2 | +------------------+ 2 rows in set (0.00 sec) MariaDB [testdb]\u0026gt; create table tb3 (stuid int unsigned primary key,name varchar(200),age tinyint); Query OK, 0 rows affected (0.07 sec) MariaDB [testdb]\u0026gt; insert into tb3 values(1,\u0026#39;stu1\u0026#39;,22),(2,\u0026#39;stu2\u0026#39;,24),(3,\u0026#39;stu3\u0026#39;,28); Query OK, 3 rows affected (0.00 sec) Records: 3 Duplicates: 0 Warnings: 0 MariaDB [testdb]\u0026gt; select * from tb3; +-------+------+------+ | stuid | name | age | +-------+------+------+ | 1 | stu1 | 22 | | 2 | stu2 | 24 | | 3 | stu3 | 28 | +-------+------+------+ 3 rows in set (0.00 sec) è¿›è¡Œç¬¬ä¸€æ¬¡å¢é‡å¤‡ä»½ æ¯ä¸ªInnoDBçš„é¡µé¢éƒ½ä¼šåŒ…å«ä¸€ä¸ªLSN(æ—¥å¿—åºåˆ—å·)ä¿¡æ¯ï¼Œæ¯å½“ç›¸å…³çš„æ•°æ®å‘ç”Ÿæ”¹å˜ï¼Œç›¸å…³çš„é¡µé¢çš„LSNå°±ä¼šè‡ªåŠ¨å¢é•¿ã€‚è¿™æ­£æ˜¯InnoDBè¡¨å¯ä»¥è¿›è¡Œå¢é‡å¤‡ä»½çš„åŸºç¡€ï¼Œå³innobackupexé€šè¿‡å¤‡ä»½ä¸Šæ¬¡å®Œå…¨å¤‡ä»½ä¹‹åå‘ç”Ÿæ”¹å˜çš„é¡µé¢æ¥å®ç°ã€‚å¢é‡å¤‡ä»½ä»…èƒ½åº”ç”¨äºInnoDBæˆ–XtraDBè¡¨ï¼Œå¯¹äºMyISAMè¡¨è€Œè¨€ï¼Œæ‰§è¡Œå¢é‡å¤‡ä»½æ—¶å…¶å®è¿›è¡Œçš„æ˜¯å®Œå…¨å¤‡ä»½ã€‚\n$ cd /var/lib/mysql $ innobackupex --user=root --host=localhost --password=123456 --incremental /data/backup --incremental-basedir=/data/backup/2017-09-16_08-22-55 $ ls /data/backup 2017-09-16_08-22-55 2017-09-16_08-27-37 \u0026lt;-- å¢é‡å¤‡ä»½ç”Ÿæˆçš„æ–‡ä»¶å¤¹ $ cat 2017-09-16_08-22-55/xtrabackup_checkpoints backup_type = full-backuped from_lsn = 0 to_lsn = 310144589 last_lsn = 310144589 compact = 0 recover_binlog_info = 0 $ cat 2017-09-16_08-27-37/xtrabackup_checkpoints backup_type = incremental from_lsn = 310144589 \u0026lt;-- æ—¥å¿—åºåˆ—å·æ‰¿æ¥å…¨é‡å¤‡ä»½çš„ to_lsn = 310148850 last_lsn = 310148850 compact = 0 recover_binlog_info = 0 åˆ é™¤testdbåº“ä¸­tb2 $ mysql -uroot -p123456 Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 8 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement MariaDB [(none)]\u0026gt; use testdb Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; drop table tb2; MariaDB [testdb]\u0026gt; show tables; +------------------+ | Tables_in_testdb | +------------------+ | tb1 | | tb3 | +------------------+ 2 rows in set (0.00 sec) è¿›è¡Œç¬¬äºŒæ¬¡å¢é‡å¤‡ä»½ $ innobackupex --user=root --host=localhost --password=123456 --incremental /data/backup --incremental-basedir=/data/backup/2017-09-16_08-27-37 ...ä¸­é—´çœç•¥... xtrabackup: Transaction log of lsn (310149698) to (310149698) was copied. 170916 08:42:46 completed OK! $ ls /data/backup 2017-09-16_08-22-55 2017-09-16_08-27-37 2017-09-16_08-42-43 $ cat 2017-09-16_08-42-43/xtrabackup_checkpoints backup_type = incremental from_lsn = 310148850 \u0026lt;-- æ—¥å¿—åºåˆ—å·æ‰¿æ¥ç¬¬ä¸€æ¬¡å¢é‡å¤‡ä»½çš„ to_lsn = 310149698 last_lsn = 310149698 compact = 0 recover_binlog_info = 0 åˆ é™¤testdbåº“ä¸­tb1 $ mysql -uroot -p123456 Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 11 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; use testdb Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; drop table tb1; Query OK, 0 rows affected (0.03 sec) MariaDB [testdb]\u0026gt; show tables; +------------------+ | Tables_in_testdb | +------------------+ | tb3 | +------------------+ 1 row in set (0.00 sec) å¤‡ä»½æœ€è¿‘ä¸€æ¬¡å¢é‡å¤‡ä»½ä¹‹åçš„äºŒè¿›åˆ¶æ—¥å¿— $ cat 2017-09-16_08-42-43/xtrabackup_info uuid = f5036e11-9a77-11e7-abfa-00505626a77f name = tool_name = innobackupex tool_command = --user=root --host=localhost --password=... --incremental /data/backup --incremental-basedir=/data/backup/2017-09-16_08-27-37 tool_version = 2.4.7 ibbackup_version = 2.4.7 server_version = 5.5.52-MariaDB start_time = 2017-09-16 08:42:43 end_time = 2017-09-16 08:42:46 lock_time = 0 binlog_pos = filename \u0026#39;master-log.000001\u0026#39;, position \u0026#39;828\u0026#39; \u0026lt;--æœ€åä¸€æ¬¡å¢é‡å¤‡ä»½å¯¹åº”äºŒè¿›åˆ¶æ—¥å¿—ä½ç½® innodb_from_lsn = 310148850 innodb_to_lsn = 310149698 partial = N incremental = Y format = file compact = N compressed = N encrypted = N $ mysqlbinlog -j 828 /var/lib/mysql/master-log.000001 \u0026gt; /data/backup/2017-09-16_08-42-43-binlog 8 ) æ¨¡æ‹ŸæœåŠ¡å™¨æ•…éšœå¹¶æ¢å¤\næ¨¡æ‹Ÿæ•…éšœå¹¶åˆ é™¤æ•°æ® $ service mariadb stop $ rm -rf /var/lib/mysql/* prepareå¢é‡å¤‡ä»½ éœ€è¦åœ¨æ¯ä¸ªå¤‡ä»½(åŒ…æ‹¬å®Œå…¨å’Œå„ä¸ªå¢é‡å¤‡ä»½)ä¸Šï¼Œå°†å·²ç»æäº¤çš„äº‹åŠ¡è¿›è¡Œâ€œé‡æ”¾â€ã€‚â€œé‡æ”¾â€ä¹‹åï¼Œæ‰€æœ‰çš„å¤‡ä»½æ•°æ®å°†åˆå¹¶åˆ°å®Œå…¨å¤‡ä»½ä¸Šã€‚ åŸºäºæ‰€æœ‰çš„å¤‡ä»½å°†æœªæäº¤çš„äº‹åŠ¡è¿›è¡Œâ€œå›æ»šâ€ã€‚\n$ cd 2017-09-16_08-22-55/ $ innobackupex --apply-log --redo-only ./ \u0026lt;-- åˆå¹¶å®Œæˆä¹‹å‰åªé‡æ”¾ä¸å›æ»š ...ä¸­é—´çœç•¥... InnoDB: Shutdown completed; log sequence number 310150212 170916 10:10:24 completed OK! $ innobackupex --apply-log --redo-only ./ --incremental-dir=/data/backup/2017-09-16_08-27-37 $ cat 2017-09-16_08-22-55/xtrabackup_checkpoints backup_type = log-applied from_lsn = 0 to_lsn = 310148850 \u0026lt;-- å®Œå…¨å¤‡ä»½çš„lsnå·²ç»åˆå¹¶åˆ°ç¬¬ä¸€æ¬¡å¢é‡å¤‡ä»½çš„lsn last_lsn = 310148850 compact = 0 recover_binlog_info = 0 $ innobackupex --apply-log --redo-only ./ --incremental-dir=/data/backup/2017-09-16_08-42-43 $ innobackupex --apply-log ./ \u0026lt;-- åˆå¹¶å®Œæˆåè¿›è¡Œå›æ»šæ“ä½œ ä»å®Œå…¨å¤‡ä»½ä¸­æ¢å¤æ•°æ® $ cd 2017-09-16_08-22-55/ $ innobackupex --copy-back ./ $ ls -l /var/lib/mysql total 40984 drwxr-x--- 2 root root 4096 Sep 16 10:15 database -rw-r----- 1 root root 18874368 Sep 16 10:15 ibdata1 -rw-r----- 1 root root 5242880 Sep 16 10:15 ib_logfile0 -rw-r----- 1 root root 5242880 Sep 16 10:15 ib_logfile1 -rw-r----- 1 root root 12582912 Sep 16 10:15 ibtmp1 drwxr-x--- 2 root root 4096 Sep 16 10:15 mysql drwxr-x--- 2 root root 4096 Sep 16 10:15 performance_schema drwxr-x--- 2 root root 4096 Sep 16 10:15 testdb -rw-r----- 1 root root 24 Sep 16 10:15 xtrabackup_binlog_pos_innodb -rw-r----- 1 root root 569 Sep 16 10:15 xtrabackup_info $ chown -R mysql.mysql /var/lib/mysql/* \u0026lt;-- ä¿®æ”¹æ•°æ®ç›®å½•å±ä¸»å±ç»„ äºŒè¿›åˆ¶æ—¥å¿—è¿˜åŸ $ service mariadb start $ mysql -uroot -p123456 Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 3 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | database | | mysql | | performance_schema | | testdb | +--------------------+ 5 rows in set (0.00 sec) MariaDB [(none)]\u0026gt; use testdb; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; show tables; \u0026lt;-- å·²ç»æ¢å¤åˆ°æœ€åä¸€æ¬¡å¢é‡å¤‡ä»½çš„çŠ¶æ€ +------------------+ | Tables_in_testdb | +------------------+ | tb1 | | tb3 | +------------------+ 2 rows in set (0.00 sec) MariaDB [testdb]\u0026gt; set @@session.sql_log_bin=OFF; \u0026lt;-- äºŒè¿›åˆ¶æ—¥å¿—é‡æ”¾æ— éœ€è®°å½•æ—¥å¿— Query OK, 0 rows affected (0.01 sec) MariaDB [testdb]\u0026gt; \\. /data/backup/2017-09-16_08-42-43-binlog \u0026lt;-- æ ¹æ®æ•…éšœå‰å¤‡ä»½çš„äºŒè¿›åˆ¶æ—¥å¿—é‡æ”¾ Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Database changed Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Charset changed Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.01 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) Query OK, 0 rows affected (0.00 sec) MariaDB [testdb]\u0026gt; show tables; \u0026lt;-- æœ€åä¸€æ¬¡å¢é‡å¤‡ä»½åçš„æ“ä½œ(drop tb2)å·²ç»é‡æ”¾ +------------------+ | Tables_in_testdb | +------------------+ | tb3 | +------------------+ 1 row in set (0.00 sec) MariaDB [testdb]\u0026gt; set @@session.sql_log_bin=ON; \u0026lt;-- äºŒè¿›åˆ¶æ—¥å¿—è®°å½•å¼€å¯ Query OK, 0 rows affected (0.00 sec) è‡³æ­¤ï¼ŒmysqlæœåŠ¡å·²ç»å®ç°æ•°æ®æ¢å¤ï¼Œå¯ä»¥ä¸Šçº¿ï¼›æ¥ä¸‹æ¥åº”è¯¥ç«‹å³æ›´æ–°å¤‡ä»½å³è¿›è¡Œä¸€æ¬¡å…¨é‡å¤‡ä»½ã€‚\n","date":"8 December 2016","permalink":"/2016/12/xtrabackup/","section":"åšå®¢","summary":"Xtrabackupæ˜¯ç”±perconaæä¾›çš„mysqlæ•°æ®åº“å¤‡ä»½å·¥å…·ï¼Œæ”¯æŒå¯¹Innodbå­˜å‚¨å¼•æ“çš„æ•°æ®åº“åœ¨çº¿çƒ­å¤‡ä»½ï¼ˆå¤‡ä»½æ—¶ä¸å½±å“æ•°æ®è¯»å†™), å®ƒæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\n(1)å¤‡ä»½è¿‡ç¨‹å¿«é€Ÿã€å¯é ï¼› (2)å¤‡ä»½è¿‡ç¨‹ä¸ä¼šæ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡ï¼› (3)èƒ½å¤ŸåŸºäºå‹ç¼©ç­‰åŠŸèƒ½èŠ‚çº¦ç£ç›˜ç©ºé—´å’Œæµé‡ï¼› (4)è‡ªåŠ¨å®ç°å¤‡ä»½æ£€éªŒï¼› (5)è¿˜åŸé€Ÿåº¦å¿«ï¼›\næœ¬æ–‡ä½¿ç”¨çš„è½¯ä»¶åŒ…ä¸º percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm ï¼Œæœ€æ–°ç‰ˆçš„è½¯ä»¶å¯ä» http://www.percona.com/software/percona-xtrabackup/ è·å¾—\nä¸ºè§£å†³ä¾èµ–æ€§å…³ç³»ä½¿ç”¨yumæºå®‰è£…\n$ yum install -y ./percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm æœ¬æ–‡çš„å¤‡ä»½ç­–ç•¥ï¼š å…¨é‡å¤‡ä»½+å¢é‡å¤‡ä»½+binlog\nä½¿ç”¨rootç”¨æˆ·è¿›è¡Œä¸€æ¬¡å…¨é‡å¤‡ä»½ $ cd /var/lib/mysql $ innobackupex --user=root --host=localhost --password=123456 /data/backup/ .","title":"ä½¿ç”¨XtraBackupå·¥å…·å®ç°MySQLæ•°æ®å¤‡ä»½åŠæ¢å¤"},{"content":"mysqldumpæ˜¯ä¸€æ¬¾mysqlæœåŠ¡è‡ªå¸¦çš„åŠŸèƒ½å¼ºå¤§çš„é€»è¾‘å¤‡ä»½å·¥å…·ï¼Œé€šå¸¸ä½¿ç”¨mysqldumpå¯¹ MySQL æ•°æ®åº“è¿›è¡Œé€»è¾‘å…¨é‡å¤‡ä»½(æ‰€æœ‰æ•°æ®é›†)ã€‚ mysqldumpå¯ä»¥æŠŠè¦å¤‡ä»½çš„æ•°æ®åº“è£…è½½åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«æœ‰æ‰€æœ‰é‡å»ºè¯¥æ•°æ®åº“æ‰€éœ€è¦çš„SQLå‘½ä»¤ï¼Œè¿™ä¸ªæ–‡æœ¬æ–‡ä»¶å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„æ‰¹å¤„ç†å’Œä¸€ä¸ªåˆé€‚SQLè¯­å¥å¯¼å›åˆ°MySQLä¸­ï¼Œå®Œæˆæ¢å¤ã€‚\nå¤‡ä»½å•ä¸ªæ•°æ®åº“æˆ–å•ä¸ªæ•°æ®åº“ä¸­çš„æŒ‡å®šè¡¨ï¼š â€‹ mysqldump [OPTIONS] database [tables]\nå¤‡ä»½å¤šä¸ªæ•°æ®åº“ï¼š â€‹ mysqldump [OPTIONS] \u0026ndash;databases [OPTIONS] DB1 [DB2 DB3\u0026hellip;]\nå¤‡ä»½æ‰€æœ‰æ•°æ®åº“ï¼š â€‹ mysqldump [OPTIONS] \u0026ndash;all-databases [OPTIONS]\nå¯¹äºä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“çš„mysqlåªæ”¯æŒæ¸©å¤‡, Innodbå­˜å‚¨å¼•æ“è¿˜æ”¯æŒçƒ­å¤‡\nçƒ­å¤‡ï¼šè¯»å†™æ“ä½œå‡å¯è¿›è¡Œçš„çŠ¶æ€ä¸‹æ‰€åšçš„å¤‡ä»½ï¼›\næ¸©å¤‡ï¼šå¯è¯»ä½†ä¸å¯å†™çŠ¶æ€ä¸‹è¿›è¡Œçš„å¤‡ä»½\nå†·å¤‡ï¼šè¯»å†™æ“ä½œå‡ä¸å¯è¿›è¡Œçš„çŠ¶æ€ä¸‹æ‰€åšçš„å¤‡ä»½ï¼› æœåŠ¡ä¸åœ¨çº¿\nmysqldumpå‘½ä»¤è¡Œå¸¸ç”¨å‚æ•°ï¼š\n-x, \u0026ndash;lock-all-tablesï¼šé”å®šæ‰€æœ‰åº“çš„æ‰€æœ‰è¡¨ï¼Œè¯»é” \u0026lt;\u0026ndash; æ¸©å¤‡ï¼Œå¤‡ä»½æ—¶è¦é”å®šè¡¨ï¼› -l, \u0026ndash;lock-tablesï¼šé”å®šæŒ‡å®šåº“æ‰€æœ‰è¡¨ \u0026lt;\u0026ndash;æ¸©å¤‡ï¼Œå¤‡ä»½æ—¶è¦é”å®šè¡¨ï¼›\n\u0026ndash;single-transactionï¼šåˆ›å»ºä¸€ä¸ªäº‹åŠ¡ï¼ŒåŸºäºæ­¤å¿«ç…§æ‰§è¡Œå¤‡ä»½ \u0026lt;\u0026ndash;InnoDBå­˜å‚¨å¼•æ“æ”¯æŒçƒ­å¤‡\n-R, \u0026ndash;routinesï¼šå¤‡ä»½æŒ‡å®šåº“çš„å­˜å‚¨è¿‡ç¨‹å’Œå­˜å‚¨å‡½æ•°\n\u0026ndash;triggersï¼šå¤‡ä»½æŒ‡å®šåº“çš„è§¦å‘å™¨\n-E, \u0026ndash;events ï¼šå¤‡ä»½æŒ‡å®šåº“çš„äº‹ä»¶è°ƒåº¦å™¨\n\u0026ndash;master-data[=#] \u0026lt;\u0026ndash; è®°å½•å¤‡ä»½æ—¶äºŒè¿›åˆ¶æ—¥å¿—çš„position\nâ€‹ 1ï¼šè®°å½•ä¸ºCHANGE MASTER TOè¯­å¥ï¼Œæ­¤è¯­å¥ä¸è¢«æ³¨é‡Š\nâ€‹ 2ï¼šè®°å½•ä¸ºCHANGE MASTER TOè¯­å¥ï¼Œæ­¤è¯­å¥è¢«æ³¨é‡Š\n\u0026ndash;flush-logsï¼šé”å®šè¡¨å®Œæˆåï¼Œå³è¿›è¡Œæ—¥å¿—åˆ·æ–°æ“ä½œï¼› \u0026lt;\u0026ndash; æ»šåŠ¨æ—¥å¿—ï¼Œæ–¹ä¾¿æŒ‰å¤‡ä»½æ—¶é—´ç‚¹æ¢å¤\nå¤‡ä»½æ¢å¤å•ä¸ªæ•°æ®åº“ # æŸ¥çœ‹æ•°æ®åº“testdbï¼Œæ•°æ®åº“ä¸‹çš„è¡¨å¼•æ“å‡ä¸ºInnodb $\tmysql -uroot -p Enter password: Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 29 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; use testdb Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; show table status\\G; *************************** 1. row *************************** Name: test1 Engine: InnoDB Version: 10 Row_format: Compact Rows: 3 Avg_row_length: 5461 Data_length: 16384 Max_data_length: 0 Index_length: 0 Data_free: 0 Auto_increment: NULL Create_time: 2017-09-13 16:22:53 Update_time: NULL Check_time: NULL Collation: latin1_swedish_ci Checksum: NULL Create_options: Comment: 1 row in set (0.00 sec) MariaDB [testdb]\u0026gt; show table status where Engine!=\u0026#39;Innodb\u0026#39;; Empty set (0.00 sec) ä½¿ç”¨mysqldumpè¿›è¡Œå¤‡ä»½ # çƒ­å¤‡ $ mysqldump -uroot -p --single-transaction --databases testdb --master-data=2 --flush-logs \u0026gt; /tmp/testdb-fullbackup-$(date +%F-%H-%M-%S) Enter password: $ ls /tmp testdb-fullbackup-2017-09-14-19-12-45 # æ¸©å¤‡ $ mysqldump -uroot -p -x -R -E --triggers --databases testdb --master-data=2 --flush-logs \u0026gt; /tmp/testdb-fullbackup-$(date +%F-%H-%M-%S) Enter password: $ ls /tmp testdb-fullbackup-2017-09-14-19-42-54 åˆ é™¤æ•°æ®åº“testdbï¼Œå¹¶æ¢å¤ [root@Centos7 ~]# mysql -uroot -p Enter password: Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 35 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; drop database testdb; Query OK, 1 row affected (0.09 sec) MariaDB [(none)]\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mydb | | mysql | | performance_schema | +--------------------+ 4 rows in set (0.00 sec) $ mysql -uroot -p123456 \u0026lt; /tmp/testdb-fullbackup-2017-09-14-19-12-45 $ mysql -uroot -p123456 -e \u0026#39;show databases\u0026#39; +--------------------+ | Database | +--------------------+ | information_schema | | mydb | | mysql | | performance_schema | | testdb | +--------------------+ ä¸Šä¾‹åªæ˜¯ç®€å•æ¼”ç¤ºæ•°æ®åº“çš„å¤‡ä»½æ¢å¤ï¼Œå®é™…ç”Ÿäº§ä¸­æ•°æ®æ˜¯åœ¨ä¸€ç›´æ›´æ–°çš„ã€‚æ‰€æœ‰åªæ˜¯æ¢å¤å¤‡ä»½æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é‡æ”¾æ‰§è¡Œå¤‡ä»½åæ›´æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—\nå¤‡ä»½æ¢å¤æ‰€æœ‰æ•°æ®åº“ # ä½¿ç”¨mysqldumpè¿›è¡Œå¤‡ä»½ $ mysqldump -uroot -p123456 -x -R -E --triggers --databases testdb --master-data=2 --flush-logs \u0026gt; /tmp/testdb-fullbackup-$(date +%F-%H-%M-%S) $ ls /tmp testdb-fullbackup-2017-09-14-20-23-01 testdbåº“ä¸­åˆ›å»ºæ–°è¡¨test2 $ mysql -uroot -p123456 Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 43 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; use testdb; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; create table test2 (id int unsigned primary key,name varchar(200)); Query OK, 0 rows affected (0.03 sec) MariaDB [testdb]\u0026gt; show tables; +------------------+ | Tables_in_testdb | +------------------+ | test1 | | test2 | +------------------+ 2 rows in set (0.00 sec) MariaDB [testdb]\u0026gt; insert into test2 values(1,\u0026#39;tom\u0026#39;),(2,\u0026#39;jerry\u0026#39;); Query OK, 2 rows affected (0.00 sec) Records: 2 Duplicates: 0 Warnings: 0 MariaDB [testdb]\u0026gt; select * from test2; +----+-------+ | id | name | +----+-------+ | 1 | tom | | 2 | jerry | +----+-------+ 2 rows in set (0.00 sec) å¤‡ä»½äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼ˆæ‰§è¡Œå¤‡ä»½æ“ä½œåçš„ï¼‰ $ mysqlbinlog master-log.000005 \u0026gt; /tmp/testdb-backup-binlog åˆ é™¤/var/lib/mysqlç›®å½•ä¸‹æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶,æ¨¡æ‹ŸæœåŠ¡å™¨å´©æºƒ $ service mariadb stop $ rm -rf /var/lib/mysql/* å…³é—­mysqlæœåŠ¡è®°å½•äºŒè¿›åˆ¶æ—¥å¿—åŠŸèƒ½(æ¢å¤æ•°æ®æ— éœ€è®°å½•) $ vim /etc/my.cnf.d/server.cnf ... [mysqld] server_id = 1 #log_bin = master-log skip_name_resolve = ON innodb_file_per_table = ON ... å¯åŠ¨mysqlæœåŠ¡å¹¶æ¢å¤å¤‡ä»½æ•°æ® $ service mariadb start $ mysql \u0026lt; /tmp/testdb-fullbackup-2017-09-14-20-23-01 $ mysql Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 3 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mydb | | mysql | | performance_schema | | table | | test | | testdb | +--------------------+ 7 rows in set (0.00 sec) MariaDB [(none)]\u0026gt; use testdb; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; show tables; \u0026lt;-- è¿å…¥mysqlï¼Œå¤‡ä»½åçš„testdb.test2æ²¡æœ‰æ¢å¤ +------------------+ | Tables_in_testdb | +------------------+ | test1 | +------------------+ 1 row in set (0.00 sec) é‡æ”¾äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¢å¤å¤‡ä»½æ—¶é—´ç‚¹åçš„æ•°æ® $ mysql \u0026lt; /tmp/testdb-backup-binlog $ mysql Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 5 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; use testdb; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; show tables; \u0026lt;-- test2è¡¨æ•°æ®ä¹Ÿæ¢å¤äº† +------------------+ | Tables_in_testdb | +------------------+ | test1 | | test2 | +------------------+ 2 rows in set (0.00 sec) MariaDB [testdb]\u0026gt; select * from test2; +----+-------+ | id | name | +----+-------+ | 1 | tom | | 2 | jerry | +----+-------+ 2 rows in set (0.00 sec) ç”±äºmysqldumpæ˜¯åŸºäºmysqlå®¢æˆ·ç«¯åè®®çš„å¤‡ä»½å·¥å…·ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ”¯æŒè¿œç¨‹æ¢å¤æŒ‡å®šæ•°æ®åº“ã€‚è¿˜æœ‰ä¸€ç‚¹mysqldumpå·¥å…·æ˜¯å°†æ•°æ®è½¬æ¢ä¸ºç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²å¹¶æ˜¾ç¤ºå‡ºæ¥ï¼Œæ‰€ä»¥ä½¿ç”¨mysqldumpå·¥å…·å¤‡ä»½å¯¹äºæµ®ç‚¹å‹æ•°æ®ä¼šä¸¢å¤±ç²¾åº¦ã€‚\n","date":"18 November 2016","permalink":"/2016/11/mysqldump/","section":"åšå®¢","summary":"mysqldumpæ˜¯ä¸€æ¬¾mysqlæœåŠ¡è‡ªå¸¦çš„åŠŸèƒ½å¼ºå¤§çš„é€»è¾‘å¤‡ä»½å·¥å…·ï¼Œé€šå¸¸ä½¿ç”¨mysqldumpå¯¹ MySQL æ•°æ®åº“è¿›è¡Œé€»è¾‘å…¨é‡å¤‡ä»½(æ‰€æœ‰æ•°æ®é›†)ã€‚ mysqldumpå¯ä»¥æŠŠè¦å¤‡ä»½çš„æ•°æ®åº“è£…è½½åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«æœ‰æ‰€æœ‰é‡å»ºè¯¥æ•°æ®åº“æ‰€éœ€è¦çš„SQLå‘½ä»¤ï¼Œè¿™ä¸ªæ–‡æœ¬æ–‡ä»¶å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„æ‰¹å¤„ç†å’Œä¸€ä¸ªåˆé€‚SQLè¯­å¥å¯¼å›åˆ°MySQLä¸­ï¼Œå®Œæˆæ¢å¤ã€‚\nå¤‡ä»½å•ä¸ªæ•°æ®åº“æˆ–å•ä¸ªæ•°æ®åº“ä¸­çš„æŒ‡å®šè¡¨ï¼š â€‹ mysqldump [OPTIONS] database [tables]\nå¤‡ä»½å¤šä¸ªæ•°æ®åº“ï¼š â€‹ mysqldump [OPTIONS] \u0026ndash;databases [OPTIONS] DB1 [DB2 DB3\u0026hellip;]\nå¤‡ä»½æ‰€æœ‰æ•°æ®åº“ï¼š â€‹ mysqldump [OPTIONS] \u0026ndash;all-databases [OPTIONS]\nå¯¹äºä½¿ç”¨MyISAMå­˜å‚¨å¼•æ“çš„mysqlåªæ”¯æŒæ¸©å¤‡, Innodbå­˜å‚¨å¼•æ“è¿˜æ”¯æŒçƒ­å¤‡\nçƒ­å¤‡ï¼šè¯»å†™æ“ä½œå‡å¯è¿›è¡Œçš„çŠ¶æ€ä¸‹æ‰€åšçš„å¤‡ä»½ï¼›\næ¸©å¤‡ï¼šå¯è¯»ä½†ä¸å¯å†™çŠ¶æ€ä¸‹è¿›è¡Œçš„å¤‡ä»½\nå†·å¤‡ï¼šè¯»å†™æ“ä½œå‡ä¸å¯è¿›è¡Œçš„çŠ¶æ€ä¸‹æ‰€åšçš„å¤‡ä»½ï¼› æœåŠ¡ä¸åœ¨çº¿","title":"ä½¿ç”¨mysqldumpå·¥å…·å®ç°MySQLæ•°æ®å¤‡ä»½"},{"content":"MySQLä¸»ä»å¤åˆ¶åŸç† # ä»èŠ‚ç‚¹çš„I/Oçº¿ç¨‹å‘ä¸»èŠ‚ç‚¹è¯·æ±‚binlogäº‹ä»¶ï¼Œä¸»èŠ‚ç‚¹Dumpçº¿ç¨‹è¯»å–binlogäº‹ä»¶å¹¶å‘é€äº‹ä»¶è‡³ä»èŠ‚ç‚¹I/Oçº¿ç¨‹ï¼Œä»èŠ‚ç‚¹å°†äº‹ä»¶å†™åˆ°relay logï¼ˆä¸­ç»§æ—¥å¿—ï¼‰ æ–‡ä»¶ä¸­ï¼›ä¹‹åä»èŠ‚ç‚¹çš„SQL çº¿ç¨‹ï¼Œä¼šè¯»å–relay logæ–‡ä»¶ä¸­çš„æ—¥å¿—ï¼Œé‡æ”¾äº‹ä»¶æ¥å®ç°ä¸»ä»æ•°æ®ä¸€è‡´ã€‚\näº‹å®ä¸Šï¼Œä¸»èŠ‚ç‚¹æ˜¯å¯ä»¥å¹¶è¡Œå†™çš„(mysqlçš„å¹¶å‘)ï¼Œè€Œbinlogæ˜¯ä¸²è¡Œå†™(æ¯æ¬¡å†™ä¸€ä¸ªäº‹ä»¶) ï¼Œæ‰€ä»¥ä¸»ä»å¤åˆ¶ä¸­ï¼Œmysqlæ˜¯å•çº¿ç¨‹å¤åˆ¶ï¼Œä¹Ÿå°±ä¸å¯é¿å…çš„é€ æˆäº†ä¸»ä»æ•°æ®åŒæ­¥æœ‰å»¶è¿Ÿï¼Œæ‰€ä»¥ä¸»ä»å¤åˆ¶ä¹Ÿæˆä¸ºå¼‚æ­¥å¤åˆ¶\nä¸»ä»å¤åˆ¶é…ç½® # æœ¬æ–‡ä»¥ä¸€ä¸»ä¸€ä»ä¸ºä¾‹ã€‚\nåœ¨é…ç½®ä¹‹å‰ç¡®ä¿æ—¶é—´åŒæ­¥ï¼Œå¹¶ä¸”ä»èŠ‚ç‚¹çš„ç‰ˆæœ¬å·ä¸ä¸»èŠ‚ç‚¹ç›¸åŒæˆ–è€…é«˜äºä¸»èŠ‚ç‚¹çš„ç‰ˆæœ¬å·\né…ç½®ä¸»æœåŠ¡å™¨ å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—è®°å½•binlog\n$ vim /etc/my.cnf.d/server.cnf [mysqld] server_id = 1 log_bin = master-log skip_name_resolve = ON \u0026lt;-- Centos6ä¸æ”¯æŒ innodb_file_per_table = ON åˆ›å»ºç”¨äºå¤åˆ¶çš„è´¦å·å¹¶æˆæƒ\n$ systemctl start mariadb $ mysql -uroot -p123456 Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 2 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO \u0026#39;rpuser\u0026#39;@\u0026#39;192.168.196.%\u0026#39; IDENTIFIED BY \u0026#39;123456\u0026#39;; Query OK, 0 rows affected (0.01 sec) MariaDB [(none)]\u0026gt; FLUSH PRIVILEGES; Query OK, 0 rows affected (0.00 sec) MariaDB [(none)]\u0026gt; SHOW MASTER STATUS; \u0026lt;-- æŸ¥çœ‹binlogæ—¥å¿—position +-------------------+----------+--------------+------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | +-------------------+----------+--------------+------------------+ | master-log.000001 | 495 | | | +-------------------+----------+--------------+------------------+ 1 row in set (0.00 sec) é…ç½®ä»æœåŠ¡å™¨ å¼€å¯ä¸­ç»§æ—¥å¿—relay-log\n$ vim /etc/my.cnf.d/server.cnf [mysqld] server_id = 2 relay_log = relay-log skip_name_resolve = ON innodb_file_per_table = ON read_only = ON é…ç½®slaveè¿æ¥è‡³ä¸»èŠ‚ç‚¹\n$ mysql -uroot -p123456 Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 3 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; CHANGE MASTER TO MASTER_HOST=\u0026#39;192.168.196.129\u0026#39;,MASTER_USER=\u0026#39;rpuser\u0026#39;,MASTER_PASSWORD=\u0026#39;123456\u0026#39;,MASTER_LOG_FILE=\u0026#39;master-log.000001\u0026#39;,MASTER_LOG_POS=495; Query OK, 0 rows affected (0.09 sec) MariaDB [(none)]\u0026gt; START SLAVE; Query OK, 0 rows affected (0.01 sec) MariaDB [(none)]\u0026gt; SHOW SLAVE STATUS\\G; *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 192.168.196.129 Master_User: rpuser Master_Port: 3306 Connect_Retry: 60 Master_Log_File: master-log.000001 Read_Master_Log_Pos: 495 Relay_Log_File: relay-log.000002 Relay_Log_Pos: 530 Relay_Master_Log_File: master-log.000001 Slave_IO_Running: Yes \u0026lt;-- I/Oçº¿ç¨‹å¼€å¯ Slave_SQL_Running: Yes \u0026lt;-- SQLçº¿ç¨‹å¼€å¯ Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 495 Relay_Log_Space: 818 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0 Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 1 1 row in set (0.00 sec) æŸ¥çœ‹ä»èŠ‚ç‚¹çš„ä¸¤ä¸ªæ–‡ä»¶master.info ã€relay-log.info $ cat /var/lib/mysql/master.info \u0026lt;-- å‚¨å­˜æœ‰masterä¿¡æ¯ï¼Œé‡å¯ä¹Ÿä¼šç”Ÿæ•ˆ 18 master-log.000001 495 192.168.196.129 rpuser 123456 3306 60 0 0 1800.000 0 $ cat /var/lib/mysql/relay-log.info \u0026lt;-- è®°å½•æœ‰å½“å‰æ•°æ®åº“å¯¹åº”æ—¥å¿—ä½ç½® ./relay-log.000002 530 master-log.000001 495 æ›´æ–°ä¸»èŠ‚ç‚¹æœåŠ¡å™¨æ•°æ® $ mysql -uroot -p123456 MariaDB [(none)]\u0026gt; create database testdb; Query OK, 1 row affected (0.00 sec) MariaDB [(none)]\u0026gt; use testdb Database changed MariaDB [testdb]\u0026gt; create table tb1 (id int); Query OK, 0 rows affected (0.02 sec) MariaDB [testdb]\u0026gt; insert into tb1 values(1),(2); Query OK, 2 rows affected (0.00 sec) Records: 2 Duplicates: 0 Warnings: 0 MariaDB [testdb]\u0026gt; SHOW MASTER STATUS; +-------------------+----------+--------------+------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | +-------------------+----------+--------------+------------------+ | master-log.000003 | 863 | | | +-------------------+----------+--------------+------------------+ 1 row in set (0.00 sec) ä»èŠ‚ç‚¹æŸ¥çœ‹æ•°æ®å·²ç»åŒæ­¥ $ mysql -uroot -p123456 MariaDB [(none)]\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | test | | testdb | +--------------------+ 5 rows in set (0.00 sec) MariaDB [(none)]\u0026gt; use testdb; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [testdb]\u0026gt; select * from tb1; +------+ | id | +------+ | 1 | | 2 | +------+ 2 rows in set (0.00 sec) MariaDB [testdb]\u0026gt; show slave status\\G; *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 192.168.196.129 Master_User: rpuser Master_Port: 3306 Connect_Retry: 60 Master_Log_File: master-log.000003 Read_Master_Log_Pos: 863 Relay_Log_File: relay-log.000002 Relay_Log_Pos: 898 Relay_Master_Log_File: master-log.000003 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 \u0026lt;-- å‚è€ƒ 1) Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 863 Relay_Log_Space: 1186 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0 Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 1 1 row in set (0.01 sec) å¦‚æœå‡ºç°error SQLçº¿ç¨‹ä¼šåœæ­¢è¿è¡Œï¼Œæ‰§è¡Œset global sql_slave_skip_counter=# è¯­å¥åstart slave å³å¯è§£å†³ ","date":"6 November 2016","permalink":"/2016/11/mysql-replication/","section":"åšå®¢","summary":"MySQLä¸»ä»å¤åˆ¶åŸç† # ä»èŠ‚ç‚¹çš„I/Oçº¿ç¨‹å‘ä¸»èŠ‚ç‚¹è¯·æ±‚binlogäº‹ä»¶ï¼Œä¸»èŠ‚ç‚¹Dumpçº¿ç¨‹è¯»å–binlogäº‹ä»¶å¹¶å‘é€äº‹ä»¶è‡³ä»èŠ‚ç‚¹I/Oçº¿ç¨‹ï¼Œä»èŠ‚ç‚¹å°†äº‹ä»¶å†™åˆ°relay logï¼ˆä¸­ç»§æ—¥å¿—ï¼‰ æ–‡ä»¶ä¸­ï¼›ä¹‹åä»èŠ‚ç‚¹çš„SQL çº¿ç¨‹ï¼Œä¼šè¯»å–relay logæ–‡ä»¶ä¸­çš„æ—¥å¿—ï¼Œé‡æ”¾äº‹ä»¶æ¥å®ç°ä¸»ä»æ•°æ®ä¸€è‡´ã€‚\näº‹å®ä¸Šï¼Œä¸»èŠ‚ç‚¹æ˜¯å¯ä»¥å¹¶è¡Œå†™çš„(mysqlçš„å¹¶å‘)ï¼Œè€Œbinlogæ˜¯ä¸²è¡Œå†™(æ¯æ¬¡å†™ä¸€ä¸ªäº‹ä»¶) ï¼Œæ‰€ä»¥ä¸»ä»å¤åˆ¶ä¸­ï¼Œmysqlæ˜¯å•çº¿ç¨‹å¤åˆ¶ï¼Œä¹Ÿå°±ä¸å¯é¿å…çš„é€ æˆäº†ä¸»ä»æ•°æ®åŒæ­¥æœ‰å»¶è¿Ÿï¼Œæ‰€ä»¥ä¸»ä»å¤åˆ¶ä¹Ÿæˆä¸ºå¼‚æ­¥å¤åˆ¶\nä¸»ä»å¤åˆ¶é…ç½® # æœ¬æ–‡ä»¥ä¸€ä¸»ä¸€ä»ä¸ºä¾‹ã€‚\nåœ¨é…ç½®ä¹‹å‰ç¡®ä¿æ—¶é—´åŒæ­¥ï¼Œå¹¶ä¸”ä»èŠ‚ç‚¹çš„ç‰ˆæœ¬å·ä¸ä¸»èŠ‚ç‚¹ç›¸åŒæˆ–è€…é«˜äºä¸»èŠ‚ç‚¹çš„ç‰ˆæœ¬å·\né…ç½®ä¸»æœåŠ¡å™¨ å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—è®°å½•binlog\n$ vim /etc/my.cnf.d/server.cnf [mysqld] server_id = 1 log_bin = master-log skip_name_resolve = ON \u0026lt;-- Centos6ä¸æ”¯æŒ innodb_file_per_table = ON åˆ›å»ºç”¨äºå¤åˆ¶çš„è´¦å·å¹¶æˆæƒ","title":"MySQLä¸»ä»å¤åˆ¶çš„å®ç°"},{"content":"Nginxæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªIMAP/POP3/SMTPæœåŠ¡å™¨ã€‚å®ƒæ˜¯åŸºäºäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œèƒ½æ‰¿å—ä¸‡çº§åˆ«çš„é«˜å¹¶å‘httpè¯·æ±‚ã€‚ç”±äºå…¶è´Ÿè½½æ€§èƒ½å¾ˆå¥½ï¼Œå®ƒåˆé€‚åšå‰ç«¯æœåŠ¡å™¨ï¼Œè€Œé«˜é€Ÿå¤„ç†é™æ€ç±»æ–‡ä»¶ä¹Ÿæ˜¯å®ƒçš„ä¼˜ç‚¹ã€‚nginxé€šè¿‡ä½¿ç”¨ngx_http_fastcgi_moduleæ¨¡å—ä¹Ÿå¯ä»¥å°†å®¢æˆ·ç«¯åŠ¨æ€è¯·æ±‚åå‘ä»£ç†åˆ°åç«¯çš„php-fpmï¼Œä¸¤è€…ä¹‹é—´éµå¾ªFastCGIåè®®ã€‚\nphp-fpm(php-Fastcgi Process Manager)ä¹Ÿæ˜¯FastCGIçš„å…·ä½“å®ç°ï¼Œå¯ä»¥ç‹¬ç«‹è¿è¡Œå¹¶æä¾›æœåŠ¡ä¹Ÿæä¾›äº†è¿›ç¨‹ç®¡ç†çš„åŠŸèƒ½ã€‚å®ƒçš„å·¥ä½œæ¨¡å¼ç±»ä¼¼äºpreforkï¼ŒåŒ…å« master å’Œ workerä¸¤ç§è¿›ç¨‹ã€‚ master è¿›ç¨‹åªæœ‰ä¸€ä¸ªï¼Œè´Ÿè´£ç›‘å¬ç«¯å£ï¼Œæ¥æ”¶æ¥è‡ª Web Server çš„è¯·æ±‚ï¼Œè€Œ worker è¿›ç¨‹åˆ™ä¸€èˆ¬æœ‰å¤šä¸ª(å…·ä½“æ•°é‡æ ¹æ®å®é™…éœ€è¦é…ç½®)ï¼Œæ¯ä¸ªè¿›ç¨‹å“åº”ä¸€ä¸ªè¯·æ±‚ï¼Œè€Œä¸”å†…éƒ¨éƒ½åµŒå…¥äº†ä¸€ä¸ª PHP è§£é‡Šå™¨ï¼Œæ˜¯ PHP ä»£ç çœŸæ­£æ‰§è¡Œçš„åœ°æ–¹ã€‚nginxä¸php-fpmå¯ä»¥é…ç½®åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œåœ¨å¹¶å‘è®¿é—®é‡ä¸æ˜¯å¾ˆå¤§æ—¶ï¼Œå»ºè®®é‡‡ç”¨åè€…çš„ç»“åˆæ–¹å¼ã€‚\næœ¬æ–‡å°†åˆ†ç¦»éƒ¨ç½²nginxä¸php-fpmæœåŠ¡ï¼Œæ‹“æ‰‘æ¨¡å‹å¦‚ä¸‹ï¼š\nphp-fpmæœåŠ¡å™¨ä¸Šéƒ¨ç½²wordpress,å¹¶å¼€å¯nfsæœåŠ¡ï¼Œå¯¼å‡ºwordpressæ‰€åœ¨ç›®å½•åˆ°nginxæœåŠ¡å™¨ï¼Œå°†nginxæ ¹ç›®å½•æŒ‚è½½åˆ°å¯¼å‡ºç›®å½•ï¼Œé…ç½®nginxå®ç°åªå°†phpåŠ¨æ€è¯·æ±‚äº¤ç”±php-fpmæœåŠ¡å™¨å¤„ç†ï¼Œå…¶å®ƒé™æ€æ–‡ä»¶åˆ™æœ‰nginxç›´æ¥å“åº”ã€‚\né…ç½®nginxæœåŠ¡å™¨ # ä½¿ç”¨yumæºå®‰è£…$ yum install -y nginx\nåˆ›å»ºè™šæ‹ŸæœåŠ¡å™¨é…ç½®æ–‡ä»¶\n$ vim /etc/nginx/conf.d/vhost.conf #httpä¸Šä¸‹æ–‡ä¸­å®šä¹‰å‹ç¼©ï¼›serverä¸­å•ç‹¬å®šä¹‰gzip on|off; gzip_min_length 64; gzip_comp_level 2; gzip_types text/xml text/plain text/css application/json application/x-javascript application/xml application/xml+rss text/javascript; gzip_proxied any; #httpä¸Šä¸‹æ–‡ä¸­å®šä¹‰fastcgi_cache,server|locationä¸­è°ƒç”¨ fastcgi_cache_path /data/nginx/fastcgi_cache levels=1:2:1 keys_zone=fcgi:20m inactive=120s; server{ server_name www.ffu.com; listen 80 ; #å®ç°httpsè·³è½¬ rewrite /(.*)$ https://www.ffu.com/$1; } server{ server_name www.ffu.com; location / { root /data/www/web1; index index.php index.html; } #å®ç°https listen 443 ssl; ssl on; ssl_certificate /etc/nginx/nginx.crt; ssl_certificate_key /etc/nginx/nginx.key; ssl_session_cache shared:sslcache:20m; #å®šä¹‰è®¿é—®ç­–ç•¥ allow 192.168.196.0/24; deny all; #å¯ç”¨å‹ç¼©åŠŸèƒ½ gzip on; #æ–‡ä»¶æ“ä½œä¼˜åŒ– aio on; open_file_cache max=1000 inactive=20s; open_file_cache_valid 50s; open_file_cache_min_uses 2; open_file_cache_errors off; #é˜²ç›—é“¾,åªå…è®¸æŒ‡å®šåŸŸåèƒ½å¼•ç”¨èµ„æº valid_referers none block server_names *.ffu.com ffu.* ~\\.ffu\\.; if ($invalid_referer) { return http://www.ffu.com/invalid.jpg; #return 403; } location ~* \\.php$ { #åä»£phpåŠ¨æ€è¯·æ±‚åˆ°åç«¯php-fpmæœåŠ¡å™¨ä¸Šåº”ç”¨æ‰€åœ¨çš„ç›®å½• fastcgi_pass 192.168.196.131:9000; fastcgi_param SCRIPT_FILENAME /data/www/app$fastcgi_script_name; fastcgi_index index.php; include fastcgi_params; #fastcgiç¼“å­˜è®¾ç½® fastcgi_cache fcgi; fastcgi_cache_key $request_uri; fastcgi_cache_valid 200 302 10m; fastcgi_cache_valid 301 1h; fastcgi_cache_valid any 1m; } #å¯¹php-fpmçš„å†…åµŒçŠ¶æ€é¡µè¯·æ±‚ç›´æ¥åä»£åˆ°åç«¯php-fpmæœåŠ¡å™¨ location ~* ^/(status|ping) { fastcgi_pass 192.168.196.131:9000; fastcgi_param SCRIPT_FILENAME $fastcgi_script_name; include fastcgi_params; } #æŒ‡å®šé”™è¯¯é¡µé¢ error_page 404 /404.html; location = /40x.html { } error_page 500 502 503 504 /50x.html; location = /50x.html { } } å®ç°sslåŠ å¯†çš„ç§é’¥åŠè¯ä¹¦ç”³è¯·ï¼Œè¿™é‡Œä¸å†å•ç‹¬ä»‹ç»ï¼Œè¯¦æƒ…å‚è€ƒå¦ä¸€ç¯‡ å…³äºä½¿ç”¨opensslå·¥å…·åˆ›å»ºç§æœ‰CAçš„åšå®¢\né…ç½®php-fpmæœåŠ¡å™¨ # ä½¿ç”¨yumæºå®‰è£…$ yum install -y php-fpm $ vim /etc/php-fpm.d/www.conf listen = 192.168.196.131:9000 \u0026lt;-- ç›‘å¬çš„å¥—æ¥å­— user = nginx group = nginx pm = dynamic pm = static \u0026lt;--é™æ€é…ç½® pm.max_children = 256 \u0026lt;--å¼€å¯çš„æœ€å¤§phpè¿›ç¨‹æ•° pm.max_requests = 1024 \u0026lt;--åœ¨æ‰§è¡Œäº†1024ä¸ªè¯·æ±‚åé‡å¯workerè¿›ç¨‹ pm.status_path = /status ping.path = /ping æœåŠ¡å™¨å†…å­˜è¾ƒå¤§æ—¶å»ºè®®ç›´æ¥è®¡ç®—åé…ç½®é™æ€èµ„æºæ± ï¼Œå¯ä»¥å‡å°‘é¢‘ç¹preforkè¿›ç¨‹æ‰€å¸¦æ¥çš„å¼€é”€ï¼Œæé«˜æœåŠ¡è´¨é‡\né…ç½®nfsæœåŠ¡ $ yum install nfs-utils rpcbind $ useradd -r -s /sbin/nologin nginx \u0026lt;-- åˆ›å»ºnginxç”¨æˆ· $ id nginx uid=996(nginx) gid=994(nginx) groups=994(nginx) $ vim /etc/exports #è®¾å®šå¯¼å‡ºç›®å½•ï¼Œåªå…è®¸nginxæœåŠ¡å™¨æŒ‚è½½ï¼Œå‹ç¼©æ‰€æœ‰è¿œç¨‹ç”¨æˆ·ä¸ºç‰¹å®šç”¨æˆ·(nginx)çš„UIDä¸GID /data/www/app 192.168.196.129(rw,sync,all_squash,anonuid=996,anongid=994) é…ç½®mysql $ yum install mariadb-server $ mysql_secure_installation \u0026lt;-- å®‰å…¨åˆå§‹åŒ–rootè´¦æˆ·å¯†ç  $ mysql -uroot -p Enter password: Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 18 Server version: 10.2.7-MariaDB-log MariaDB Server Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; create database blogdb; \u0026lt;-- åˆ›å»ºwordpressçš„æ•°æ®åº“ MariaDB [(none)]\u0026gt; grant all on blogdb.* to wpuser@\u0026#39;192.168.196.%\u0026#39; identified by \u0026#39;123456\u0026#39;; \u0026lt;-- åˆ›å»ºwordpressè¿æ¥mysqlçš„è´¦æˆ· å®‰è£…wordpress $ mkdir /data/www $ tar xf wordpress-4.8-zh_CN.tar.gz -C /data/www/ $ cd /data/www $ ln -sv wordpress app \u0026lt;--åˆ›å»ºæŒ‡å‘wordpressçš„è½¯é“¾æ¥ $ chown -R nginx.nginx app/* $ mv wp-config-sample.php wp-config.php $ vim wp-config.php \u0026lt;-- é…ç½®æ¥å£è¿æ¥è‡³mysqlæœåŠ¡å™¨ /** WordPressæ•°æ®åº“çš„åç§° */ define(\u0026#39;DB_NAME\u0026#39;, \u0026#39;blogdb\u0026#39;); /** MySQLæ•°æ®åº“ç”¨æˆ·å */ define(\u0026#39;DB_USER\u0026#39;, \u0026#39;wpuser\u0026#39;); /** MySQLæ•°æ®åº“å¯†ç  */ define(\u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;123456\u0026#39;); /** MySQLä¸»æœº */ define(\u0026#39;DB_HOST\u0026#39;, \u0026#39;192.168.196.131\u0026#39;); nginxæœåŠ¡å™¨æ ¹ç›®å½•æŒ‚è½½åˆ°nfså¯¼å‡ºç›®å½• # $ vim /etc/fstab 192.168.196.131:/data/www/app /data/www/web1 nfs defaults 0 0 $ mount -a $ mount 192.168.196.131:/data/www/app on /data/www/web1 type nfs (rw,relatime,vers=3,rsize=131072,wsize=131072,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=192.168.196.131,mountvers=3,mountport=20048,mountproto=udp,local_lock=none,addr=192.168.196.131) å®¢æˆ·ç«¯æµè§ˆå™¨è®¿é—®wordpress # å¼€å¯å„æœåŠ¡ä¹‹åï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®å¹¶åˆ›å»ºè´¦æˆ·ï¼Œå³å®Œæˆwordpresséƒ¨ç½²\n","date":"15 September 2016","permalink":"/2016/09/nginx-php-fpm/","section":"åšå®¢","summary":"\u003cp\u003eNginxæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªIMAP/POP3/SMTPæœåŠ¡å™¨ã€‚å®ƒæ˜¯åŸºäºäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œèƒ½æ‰¿å—ä¸‡çº§åˆ«çš„é«˜å¹¶å‘httpè¯·æ±‚ã€‚ç”±äºå…¶è´Ÿè½½æ€§èƒ½å¾ˆå¥½ï¼Œå®ƒåˆé€‚åšå‰ç«¯æœåŠ¡å™¨ï¼Œè€Œé«˜é€Ÿå¤„ç†é™æ€ç±»æ–‡ä»¶ä¹Ÿæ˜¯å®ƒçš„ä¼˜ç‚¹ã€‚nginxé€šè¿‡ä½¿ç”¨ngx_http_fastcgi_moduleæ¨¡å—ä¹Ÿå¯ä»¥å°†å®¢æˆ·ç«¯åŠ¨æ€è¯·æ±‚åå‘ä»£ç†åˆ°åç«¯çš„php-fpmï¼Œä¸¤è€…ä¹‹é—´éµå¾ªFastCGIåè®®ã€‚\u003c/p\u003e","title":"Nginx+php-fpmåˆ†ç¦»éƒ¨ç½²æ­å»ºwordpress"},{"content":"","date":"15 September 2016","permalink":"/tags/wordpress/","section":"Tags","summary":"","title":"wordpress"},{"content":"MariaDB æ˜¯ä¸€ä¸ªé‡‡ç”¨Maria å­˜å‚¨å¼•æ“çš„MySQLåˆ†æ”¯ç‰ˆæœ¬ï¼Œæ˜¯ç”±åŸæ¥ MySQL çš„ä½œè€…Michael Wideniusåˆ›åŠçš„å…¬å¸æ‰€å¼€å‘çš„å…è´¹å¼€æºçš„æ•°æ®åº“æœåŠ¡å™¨ã€‚MariaDBæ˜¯ç›®å‰æœ€å—å…³æ³¨çš„MySQLæ•°æ®åº“è¡ç”Ÿç‰ˆï¼Œä¹Ÿè¢«è§†ä¸ºå¼€æºæ•°æ®åº“MySQLçš„æ›¿ä»£å“ã€‚é™¤äº†ä½¿ç”¨Linux å„å‘è¡Œç‰ˆä¾›åº”å•†çš„ç¨‹åºåŒ…å®‰è£…ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åŸºäºäºŒè¿›åˆ¶æ ¼å¼çš„ç¨‹åºåŒ…è¿›è¡Œå®‰è£…ã€‚å…·ä½“å®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š\n1.ä¸‹è½½äºŒè¿›åˆ¶æºç  # å®˜ç½‘ä¸‹è½½åœ°å€http://downloads.mariadb.org\n2.åˆ›å»ºç³»ç»Ÿç”¨æˆ· # [root@Centos6 ~]# groupadd -r -g 36 mysql [root@Centos6 ~]# useradd -r -u 36 -g 36 mysql 3.å‡†å¤‡äºŒè¿›åˆ¶ç¨‹åº # è§£å‹ç¼©åŒ…åˆ°/usr/local\n[root@Centos6 ~]# tar xf /root/mariadb-5.5.57-linux-x86_64.tar.gz -C /usr/local/ åˆ›å»ºè½¯é“¾æ¥å¹¶ä¿®æ”¹ç›®å½•å±ç»„ä¸ºmysql\n[root@Centos6 local]#cd /usr/local [root@Centos6 local]#ln -sv mariadb-5.5.57-linux-x86_64/ mysql `mysql\u0026#39; -\u0026gt; `mariadb-5.5.57-linux-x86_64/\u0026#39; [root@Centos6 local]# chown -R root:mysql /usr/local/mysql/ 4.å‡†å¤‡mysqlæ•°æ®å­˜å‚¨ç›®å½• # å»ºè®®æŠŠmysqlæ•°æ®å­˜åœ¨åŸºäºé€»è¾‘å·çš„å•ç‹¬åˆ†åŒº\n[root@Centos6 local]#lvcreate -L 20G -n mydata vg_centos6 [root@Centos6 local]#mkfs.ext4 /dev/vg_centos6/mydata è®¾ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½é€»è¾‘å·mydataåˆ°/mydata\n[root@Centos6 local]mkdir /mydata [root@Centos6 local]vim /etc/fstab /dev/vg_centos6/mydata /mydata ext4 defaults 0 0 [root@Centos6 local]mount -a åˆ›å»ºå­˜å‚¨ç›®å½•/mydata/dataå¹¶ä¿®æ”¹å±ä¸»å±ç»„ä¸ºmysql\n[root@Centos6 local]chown mysql:mysql /mydata/data 5.åˆ›å»ºæ•°æ®åº“æ–‡ä»¶ # å®‰è£…åŒ…æä¾›äº†è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“çš„è„šæœ¬/usr/local/mysql/scripts/mysql_install_db,åœ¨/usr/local/mysqlç›®å½•ä¸‹è¿è¡Œè¯¥è„šæœ¬\n[root@Centos6 mysql]# ./scripts/mysql_install_db --user=mysql --datadir=/mydata/data [root@Centos6 mysql]# ./scripts/mysql_install_db --help \u0026lt;-- å¯ä»¥æŸ¥çœ‹è„šæœ¬å¸®åŠ© [root@Centos6 mysql]# ls /mydata/data aria_log.00000001 aria_log_control mysql performance_schema test 6.å‡†å¤‡mysqldç¨‹åºé…ç½®æ–‡ä»¶ # â€‹\té…ç½®æ–‡ä»¶æŸ¥æ‰¾æ¬¡åº: /etc/my.cnf \u0026ndash; \u0026gt; /etc/mysql/my.cnf \u0026ndash; \u0026gt; -- default-extrafile=/PATH/TO/CONF_FILE(ç¬¬5æ­¥ä¸­è„šæœ¬é€‰é¡¹æŒ‡å®šçš„é…ç½®æ–‡ä»¶) \u0026ndash; \u0026gt; ~/. my.cnf\nå®‰è£…åŒ…æä¾›äº†å‡ ç§ä¸åŒé…ç½®çš„æ¨¡æ¿é…ç½®æ–‡ä»¶,ä½äºç›®å½•/usr/local/mysql/suport-files/;å¯ä»¥æ ¹æ®æ•°æ®åº“çš„å¤§å°åŠæœåŠ¡å™¨é…ç½®ç­‰é€‰æ‹©åˆé€‚çš„æ¨¡æ¿è¿›è¡Œä¿®æ”¹\n[root@Centos6 mysql]# mkdir /etc/mysql [root@Centos6 mysql]# cp support-files/my-large.cnf /etc/mysql/my.cnf [root@Centos6 mysql]# vim /etc/mysql/my.cnf datadir = /mydata/data\t\u0026lt;--æŒ‡å®šæ•°æ®åº“æ–‡ä»¶å­˜å‚¨ç›®å½• innodb_file_per_table = on\t\u0026lt;--æ•°æ®åº“ä¸­å„è¡¨æ ¼ä»¥å•ä¸ªæ–‡ä»¶å­˜å‚¨ skip_name_resolve = on\t\u0026lt;--ç¦æ­¢ä¸»æœºåè§£æ 7.å‡†å¤‡æ—¥å¿—æ–‡ä»¶ # Centos6\u0026ndash;\u0026gt;/var/log/mysqld.log\næ³¨æ„åœ¨Centos7é‡Œè‡ªåŠ¨ç”Ÿæˆï¼Œä¸ç”¨æ‰‹åŠ¨åˆ›å»º\u0026ndash;\u0026gt;/var/log/mariadb/mariadb.log\n[root@Centos6 mysql]# touch /var/log/mysqld.log [root@Centos6 mysql]# chown mysql:mysql /var/log/mysqld.log 8.å‡†å¤‡æœåŠ¡è„šæœ¬,å¹¶å¯åŠ¨æœåŠ¡ # [root@Centos6 mysql]# cp support-files/mysql.server /etc/rc.d/init.d/mysqld [root@Centos6 mysql]# chkconfig --add mysqld [root@Centos6 mysql]# chkconfig --list mysqld [root@Centos6 ~]# vi /etc/profile.d/my.sh \u0026lt;--åˆ›å»ºç³»ç»Ÿé…ç½®æ–‡ä»¶,å°†å¯æ‰§è¡Œç¨‹åºmysqlè·¯å¾„åŠ å…¥PATHå˜é‡ export PATH=/usr/local/mysql/bin/:$PATH [root@Centos6 mysql]#service mysqld start 9.è¿è¡Œmysqlå‘½ä»¤\u0026ndash;\u0026gt;äº¤äº’å¼å®¢æˆ·ç«¯ç¨‹åº # [root@Centos6 ~]#mysql \u0026lt;-- é»˜è®¤ç©ºå¯†ç ç™»å½• MariaDB [mysql]\u0026gt; use mysql Database changed MariaDB [mysql]\u0026gt; select user,host,password from user; +------+-----------+----------+ | user | host | password | +------+-----------+----------+ | root | localhost | | | root | centos6.9 | | | root | 127.0.0.1 | | | root | ::1 | | | | localhost | | \u0026lt;-- è¡¨ç¤ºå…è®¸åŒ¿åç™»å½• | | centos6.9 | | +------+-----------+----------+ 6 rows in set (0.01 sec) mysqlç”¨æˆ·è´¦å·ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š\u0026lsquo;USERNAME\u0026rsquo;@\u0026lsquo;HOST\u0026rsquo;\nHOSTç”¨äºé™åˆ¶æ­¤ç”¨æˆ·å¯é€šè¿‡å“ªäº›è¿œç¨‹ä¸»æœºè¿æ¥mysqlæœåŠ¡(é™åˆ¶å®¢æˆ·ç«¯)\nHOSTæ”¯æŒCIDR IPè¡¨ç¤ºæ³•ï¼›ä¹Ÿæ”¯æŒä½¿ç”¨é€šé…ç¬¦ï¼š\nâ€‹\t% åŒ¹é…ä»»æ„é•¿åº¦çš„ä»»æ„å­—ç¬¦ eg: 192.168.%.%\nâ€‹\t_ åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦\n10.å®‰å…¨åˆå§‹åŒ– # ä»æ–‡ç« ç¬¬9æ­¥å¯ä»¥çœ‹å‡ºï¼Œæ•°æ®åº“é»˜è®¤æ˜¯å…è®¸åŒ¿åç™»å½•åŠæ— å¯†ç ç™»å½•ï¼Œè¿™æ˜¯éå¸¸ä¸å®‰å…¨çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œå®‰å…¨åˆå§‹åŒ–\n[root@Centos6 ~]# /usr/local/mysql/bin/mysql_secure_installation NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB SERVERS IN PRODUCTION USE! PLEASE READ EACH STEP CAREFULLY! In order to log into MariaDB to secure it, we\u0026#39;ll need the current password for the root user. If you\u0026#39;ve just installed MariaDB, and you haven\u0026#39;t set the root password yet, the password will be blank, so you should just press enter here. Enter current password for root (enter for none): OK, successfully used password, moving on... Setting the root password ensures that nobody can log into the MariaDB root user without the proper authorisation. Set root password? [Y/n] y\tNew password:\t\u0026lt;-- è®¾ç½®rootå¯†ç  Re-enter new password: Password updated successfully! Reloading privilege tables.. ... Success! By default, a MariaDB installation has an anonymous user, allowing anyone to log into MariaDB without having to have a user account created for them. This is intended only for testing, and to make the installation go a bit smoother. You should remove them before moving into a production environment. Remove anonymous users? [Y/n] y \u0026lt;-- ç¦æ­¢åŒ¿åç™»å½• ... Success! Normally, root should only be allowed to connect from \u0026#39;localhost\u0026#39;. This ensures that someone cannot guess at the root password from the network. Disallow root login remotely? [Y/n] y \u0026lt;-- ç¦æ­¢rootè¿œç¨‹ç™»å½• ... Success! By default, MariaDB comes with a database named \u0026#39;test\u0026#39; that anyone can access. This is also intended only for testing, and should be removed before moving into a production environment. Remove test database and access to it? [Y/n] - Dropping test database... ... Success! - Removing privileges on test database... ... Success! Reloading the privilege tables will ensure that all changes made so far will take effect immediately. Reload privilege tables now? [Y/n] y\t\u0026lt;-- ç”Ÿæ•ˆæƒé™ ... Success! Cleaning up... All done! If you\u0026#39;ve completed all of the above steps, your MariaDB installation should now be secure. Thanks for using MariaDB! [root@Centos6 ~]# mysql\t\u0026lt;-- æ— å¯†ç ç™»å½•å·²ç»ç¦æ­¢ ERROR 1045 (28000): Access denied for user \u0026#39;root\u0026#39;@\u0026#39;localhost\u0026#39; (using password: NO) [root@Centos6 ~]# mysql -uroot -p\t\u0026lt;-- æ­£ç¡®ç™»å…¥ Enter password: Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 17 Server version: 5.5.57-MariaDB MariaDB Server Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; use mysql Database changed MariaDB [mysql]\u0026gt; select user,host,password from user; +------+-----------+-------------------------------------------+ | user | host | password | +------+-----------+-------------------------------------------+ | root | localhost | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 | | root | 127.0.0.1 | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 | | root | ::1 | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 | +------+-----------+-------------------------------------------+ 3 rows in set (0.00 sec) ","date":"31 August 2016","permalink":"/2016/08/centos6-mariadb/","section":"åšå®¢","summary":"\u003cp\u003eMariaDB æ˜¯ä¸€ä¸ªé‡‡ç”¨Maria å­˜å‚¨å¼•æ“çš„MySQLåˆ†æ”¯ç‰ˆæœ¬ï¼Œæ˜¯ç”±åŸæ¥ MySQL çš„ä½œè€…Michael Wideniusåˆ›åŠçš„å…¬å¸æ‰€å¼€å‘çš„å…è´¹å¼€æºçš„æ•°æ®åº“æœåŠ¡å™¨ã€‚MariaDBæ˜¯ç›®å‰æœ€å—å…³æ³¨çš„MySQLæ•°æ®åº“è¡ç”Ÿç‰ˆï¼Œä¹Ÿè¢«è§†ä¸ºå¼€æºæ•°æ®åº“MySQLçš„æ›¿ä»£å“ã€‚é™¤äº†ä½¿ç”¨Linux å„å‘è¡Œç‰ˆä¾›åº”å•†çš„ç¨‹åºåŒ…å®‰è£…ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åŸºäºäºŒè¿›åˆ¶æ ¼å¼çš„ç¨‹åºåŒ…è¿›è¡Œå®‰è£…ã€‚å…·ä½“å®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š\u003c/p\u003e","title":"CentOS6 mariadbäºŒè¿›åˆ¶å®‰è£…"},{"content":"","date":"31 August 2016","permalink":"/tags/mariadb/","section":"Tags","summary":"","title":"mariadb"},{"content":"","date":"20 July 2016","permalink":"/tags/keepalived/","section":"Tags","summary":"","title":"keepalived"},{"content":"keepalivedç®€ä»‹ # keepalivedæ˜¯ä¸€æ¬¾è§£å†³è´Ÿè½½å‡è¡¡(è°ƒåº¦å™¨)çš„é«˜å¯ç”¨é—®é¢˜çš„è½¯ä»¶ï¼Œå¯ä»¥å®ç°è´Ÿè½½å‡è¡¡å™¨çš„æ•…éšœè½¬ç§»(failover)ï¼ŒåŸç”Ÿè®¾è®¡çš„ç›®çš„ä¸ºäº†é«˜å¯ç”¨ipvsæœåŠ¡ï¼Œåæ¥å¢åŠ äº†è„šæœ¬è°ƒç”¨æ¥å£ï¼Œä½¿å…¶ä¸€å®šç¨‹åº¦ä¸Šå…·æœ‰äº†ç®¡æ§æœåŠ¡è¿›ç¨‹çš„åŠŸèƒ½ï¼ŒåŸºäºæ­¤æ¥å£ä¹Ÿå¯ä»¥æ”¯æŒnginxã€haproxyè´Ÿè½½å‡è¡¡çš„é«˜å¯ç”¨ã€‚keepalivedæ˜¯VRRPåè®®çš„è½¯ä»¶å®ç°ï¼Œä¹ŸåŸºäºVRRPåè®®å®Œæˆåœ°å€æµåŠ¨ï¼Œé‚£ä»€ä¹ˆæ˜¯VRRPåè®®å‘¢ï¼Ÿ\nVRRPåè®® # VRRP(Virtual Routing Redundant Protocol)æ˜¯è§£å†³è·¯ç”±å™¨å†—ä½™çš„è™šæ‹Ÿè·¯ç”±å™¨å†—ä½™åè®®ã€‚\nåœ¨VRRPçš„æ‹“æ‰‘æ¨¡å‹ä¸­ï¼Œä¸»èŠ‚ç‚¹ä¼šå‘¨æœŸæ€§å‘å¤šç‚¹ä¼ é€åœ°å€(224.0.0.18)å‘é€ç»„æ’­ä¿¡æ¯å³VRRPæŠ¥æ–‡ï¼Œå¤‡ç”¨èŠ‚ç‚¹è‹¥ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°VRRPæŠ¥æ–‡ä¿¡æ¯ï¼Œå¤‡ç”¨èŠ‚ç‚¹å°±ä¼šè®¤ä¸ºä¸»èŠ‚ç‚¹å·²ç»å®•æœºï¼Œç„¶åæ˜ å°„VIP(è™šæ‹Ÿåœ°å€)ï¼Œå‘ç”Ÿæ•…éšœè½¬ç§»ã€‚\nVRRPæŠ¥æ–‡åŒ…æ‹¬ä»¥ä¸‹ä¸‰é¡¹æ•°æ®ï¼š\nVIP è™šæ‹ŸIPåœ°å€ Virtual Rtr ID è™šæ‹Ÿè·¯ç”±å™¨ID â€‹ ä¸€å°ç‰©ç†è·¯ç”±å™¨å¯èƒ½æœ‰å¤šä¸ªæ¥å£ï¼Œä¸åŒç‰©ç†è·¯ç”±å™¨çš„æ¥å£å¯ä»¥ç»„åˆå‡ºå¤šä¸ªè™šæ‹Ÿè·¯ç”±å™¨ï¼Œä»¥æ­¤IDåŒºåˆ†\nPriority ä¼˜å…ˆé¡ºåº\nVIPä¼˜å…ˆæ¼‚ç§»åˆ°é«˜ä¼˜å…ˆçº§çš„èŠ‚ç‚¹\nkeepalivedç‰¹ç‚¹ # åŸºäºVRRPåè®®å®ç°è´Ÿè½½å‡è¡¡å™¨çš„æ•…éšœè½¬ç§» ä¸ºé›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹ç”Ÿæˆipvsè§„åˆ™ï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­é¢„å…ˆå®šä¹‰ï¼‰ ä¸ºipvsé›†ç¾¤çš„å„RSåšå¥åº·çŠ¶æ€æ£€æµ‹ åŸºäºè„šæœ¬è°ƒç”¨æ¥å£é€šè¿‡æ‰§è¡Œè„šæœ¬å®Œæˆè„šæœ¬ä¸­å®šä¹‰çš„åŠŸèƒ½ï¼Œè¿›è€Œå½±å“é›†ç¾¤äº‹åŠ¡;æ­£æ˜¯åŸºäºæ­¤æ¥å£ï¼Œkeepalivedæ‰èƒ½å®ç°nginxè´Ÿè½½å‡è¡¡å™¨çš„æ•…éšœè½¬ç§» æœ¬æ–‡å°†ä»‹ç»å•ä¸»ã€åŒä¸»æ¨¡å‹ä¸‹nginxè´Ÿè½½å‡è¡¡é«˜å¯ç”¨é›†ç¾¤çš„å®ç°\nå•ä¸»æ¨¡å‹KAé«˜å¯ç”¨é›†ç¾¤å®ç° # æ‹“æ‰‘æ¨¡å‹ # åœ¨ä¸Šå›¾ç½‘ç»œæ‹“æ‰‘ä¸­ï¼Œnginx server1å’Œserver2ä¸ºå®‰è£…keepalivedçš„ä¸¤å°è´Ÿè½½å‡è¡¡å™¨ï¼š\nä¸»èŠ‚ç‚¹nginx server1æ­£å¸¸å·¥ä½œæ—¶(activeçŠ¶æ€)ï¼ŒVIPæ˜ å°„åœ¨å…¶ç½‘å¡ä¸Šï¼Œå®ƒè´Ÿè´£å°†å®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘è‡³åç«¯real serverï¼Œæ­¤æ—¶nginx server2å¤‡ç”¨çŠ¶æ€(passive) nginx server1å‘ç”Ÿæ•…éšœåï¼Œå¤‡ç”¨èŠ‚ç‚¹nginx server2å°±ä¼šå˜æˆä¸»èŠ‚ç‚¹ï¼ŒVIPæ¼‚ç§»æ˜ å°„åˆ°sever2ä¸Šï¼Œä¹‹åserver2 ä»£æ›¿server1å“åº”å®¢æˆ·ç«¯å¹¶åˆ†å‘è¯·æ±‚ï¼Œå®ç°æ•…éšœè½¬ç§» ä¸€ä¸ªèŠ‚ç‚¹å¤„äºactiveçŠ¶æ€ï¼Œå¦ä¸€ä¸ªèŠ‚ç‚¹å¤„äºpassiveçŠ¶æ€çš„KAé«˜å¯ç”¨æ¨¡å‹å°±ç§°ä¸ºå•ä¸»æ¨¡å‹\nIPåœ°å€åˆ†é… # nginx LB sever1:\nens33: 192.168.196.131/24\nens37: 172.16.253.93/16\nnginx LB sever2:\nens37: 192.168.196.133/24\nens33: 172.16.251.171/16\nWeb server1:\nens37: 192.168.196.129/24\nWeb server2:\nens37: 192.168.196.132/24\nVIP: 172.16.255.168/16 \u0026ndash;\u0026gt;å¯¹å¤–å…¬å¼€æä¾›æœåŠ¡åœ°å€\næœåŠ¡é…ç½® # å®ŒæˆæœåŠ¡å™¨å‡†å¤‡åŠIPé…ç½®åï¼Œé¦–å…ˆè¦åŒæ­¥æ—¶é—´ï¼Œä¿è¯å„æœåŠ¡å™¨ç³»ç»Ÿæ—¶é—´ä¸€è‡´æ€§ï¼Œå¯ä»¥å€ŸåŠ©ntpæˆ–è€…chronyæœåŠ¡ã€‚\nWeb server çš„é…ç½® # server1: $yum install -y nginx $echo \u0026#34;backend server 1\u0026#34; /usr/share/nginx/html/index.html $systemctl start nginx server2: $yum install -y nginx $echo \u0026#34;backend server 2\u0026#34; /usr/share/nginx/html/index.html $systemctl start nginx nginx server çš„é…ç½® # server1 \u0026ndash;\u0026gt; ä¸»èŠ‚ç‚¹\nå®‰è£…é…ç½®keepalived $ yum install -y keepalived $ vim /etc/keepalived/keepalived.conf \u0026lt;--ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶ global_defs { notification_email {\t\u0026lt;--é€šçŸ¥é‚®ä»¶ç›¸å…³è®¾ç½® root@localhost \u0026lt;--é‚®ä»¶å‘é€ç›®æ ‡åœ°å€ } notification_email_from keepalived@localhost \u0026lt;--é‚®ä»¶å‘ä»¶äºº smtp_server 127.0.0.1 \u0026lt;--ä½¿ç”¨æœ¬æœºé‚®ä»¶æœåŠ¡ smtp_connect_timeout 30 router_id node1 \u0026lt;--ç‰©ç†è·¯ç”±èŠ‚ç‚¹åç§° vrrp_mcast_group4 224.3.10.67 \u0026lt;--å‘é€VRRPæŠ¥æ–‡çš„ç»„æ’­åœ°å€ } vrrp_script chk_down { \u0026lt;--å‚è€ƒæ³¨é‡Š[1]å®šä¹‰å®ç°æ‰‹åŠ¨ç»´æŠ¤serverçš„è„šæœ¬ script \u0026#34;[[ -f /etc/keepalived/down ]] \u0026amp;\u0026amp; exit 1 || exit 0\u0026#34; interval 1 weight -10 } vrrp_script chk_nginx { \u0026lt;--å‚è€ƒæ³¨é‡Š[2]å®šä¹‰å®ç°æ£€æŸ¥nginxæœåŠ¡å¥åº·æ£€æŸ¥å‘¨æœŸçš„è„šæœ¬ script \u0026#34;killall -0 nginx \u0026amp;\u0026amp; exit 0 || exit 1\u0026#34; interval 1 \u0026lt;--æ£€æµ‹é—´éš” weight -10 \u0026lt;--è„šæœ¬æ‰§è¡ŒçŠ¶æ€ç»“æœä¸ºé0åˆ™è¯¥è™šæ‹Ÿè·¯ç”±ä¼˜å…ˆçº§-10 fall 2 \u0026lt;--å¤±è´¥æ£€æµ‹ä¸¤æ¬¡ rise 1 \u0026lt;--æˆåŠŸæ£€æµ‹ä¸€æ¬¡ } vrrp_instance VI_1 { \u0026lt;--è®¾ç½®vrrpå®ä¾‹å³è™šæ‹Ÿè·¯ç”± state MASTER \u0026lt;--è®¾ç½®è™šæ‹Ÿè·¯ç”±ä¸ºä¸»èŠ‚ç‚¹ interface ens37 \u0026lt;--è®¾ç½®è¿›è¡Œæ”¶å‘vrrpæŠ¥æ–‡çš„ç½‘å¡ virtual_router_id 51 \u0026lt;--è™šæ‹Ÿè·¯ç”±å™¨IDï¼Œå”¯ä¸€æ€§ priority 100 advert_int \u0026lt;--vrrpé€šå‘Šçš„æ—¶é—´é—´éš” authentication { auth_type PASS auth_pass AhpaeQ9J \u0026lt;--VRRPæŠ¥æ–‡åˆæ³•æ€§è®¤è¯ } virtual_ipaddress { 172.16.255.168/16 dev ens37 \u0026lt;--è®¾ç½®VIP } track_script { \u0026lt;--è°ƒç”¨å·²å®šä¹‰è„šæœ¬ chk_down chk_nginx } notify_master \u0026#34;/etc/keepalived/notify.sh master\u0026#34; \u0026lt;--å‚è€ƒæ³¨é‡Š[3] notify_backup \u0026#34;/etc/keepalived/notify.sh backup\u0026#34; notify_fault \u0026#34;/etc/keepalived/notify.sh fault\u0026#34; } $ scp /etc/keepalived/notify.sh 192.168.196.133:/etc/keepalived/notify.sh [1]æ£€æµ‹downæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è„šæœ¬æ‰§è¡ŒçŠ¶æ€ç»“æœä¸º1ï¼Œè°ƒç”¨è¯¥è„šæœ¬çš„vrrpå®ä¾‹(å³è™šæ‹Ÿè·¯ç”±å™¨)çš„ä¼˜å…ˆçº§å‡10ï¼›æœ¬æ–‡ä¸­masterä¼˜å…ˆçº§è®¾ä¸º100ï¼Œå‡10å˜ä¸º90ï¼Œåˆ™å°äºbackupèŠ‚ç‚¹çš„ä¼˜å…ˆçº§95ï¼ŒbackupèŠ‚ç‚¹å˜ä¸ºä¸»èŠ‚ç‚¹ï¼Œå®ç°æ•…éšœè½¬ç§»\n[2]æ£€æµ‹åˆ°nginxæœåŠ¡è¿›ç¨‹æ²¡æœ‰è¿è¡Œï¼Œåˆ™è„šæœ¬æ‰§è¡ŒçŠ¶æ€ç»“æœä¸º1ï¼Œè°ƒç”¨è¯¥è„šæœ¬çš„vrrpå®ä¾‹çš„ä¼˜å…ˆçº§å‡10\n[3]é€šç”¨æ ¼å¼çš„é€šçŸ¥è§¦å‘æœºåˆ¶ï¼Œä¸€ä¸ªè„šæœ¬å¯å®Œæˆmasterã€backupã€faultä¸‰ç§çŠ¶æ€çš„è½¬æ¢æ—¶çš„é€šçŸ¥\n$ vim /etc/keepalived/notify.sh #!/bin/bash # contact=\u0026#39;root@localhost\u0026#39; notify() { local mailsubject=\u0026#34;$(hostname) to be $1, vip floating\u0026#34; local mailbody=\u0026#34;$(date +\u0026#39;%F %T\u0026#39;): vrrp transition, $(hostname) changed to be $1\u0026#34; echo \u0026#34;$mailbody\u0026#34; | mail -s \u0026#34;$mailsubject\u0026#34; $contact } case $1 in master) notify master ;; backup) notify backup ;; fault) notify fault ;; *) echo \u0026#34;Usage: $(basename $0) {master|backup|fault}\u0026#34; exit 1 ;; esac é…ç½®nginxä»£ç† $ vim /etc/nginx/nginx.conf upstream srvs { server 192.168.196.129; server 192.168.196.132; server 127.0.0.1:8080 backup; \u0026lt;--nginxçƒ­å¤‡å®ç°sorry server,æ³¨æ„80ç«¯å£å·²è¢«å ç”¨ } sever{ ... location / { proxy_pass http://srvs; } ... } $ vim /etc/nginx/conf.d/web2.conf \u0026lt;--è®¾ç½®ç›‘å¬8080çš„è™šæ‹Ÿä¸»æœºåšsorry server server{ server_name www.web2.com; listen 8080 ; root /var/www/html/web2; } } $ echo \u0026#39;nginx LB sorry server 1\u0026#39; \u0026gt; /var/www/html/web2/index.html $ systemctl start nginx server2 \u0026ndash;\u0026gt; å¤‡ç”¨èŠ‚ç‚¹\nå®‰è£…é…ç½®keepalived $ yum install -y keepalived $ vim /etc/keepalived/keepalived.conf global_defs { notification_email { root@localhost } notification_email_from keepalived@localhost smtp_server 127.0.0.1 smtp_connect_timeout 30 router_id node2 vrrp_mcast_group4 224.3.10.67 \u0026lt;--ç›¸åŒçš„ç»„æ’­åœ°å€ } vrrp_script chk_down { script \u0026#34;[[ -f /etc/keepalived/down ]] \u0026amp;\u0026amp; exit 1 || exit 0\u0026#34; interval 1 weight -10 } vrrp_script chk_nginx { script \u0026#34;killall -0 nginx \u0026amp;\u0026amp; exit 0 || exit 1\u0026#34; interval 1 weight -10 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP \u0026lt;--çŠ¶æ€ä¸ºbackup interface ens33 virtual_router_id 51 priority 95 \u0026lt;--ä¼˜å…ˆçº§è¦ä½äºmaster advert_int 1 authentication { auth_type PASS auth_pass AhpaeQ9J } virtual_ipaddress { 172.16.255.168/16 dev ens33 \u0026lt;--ç›¸åŒçš„VIP } track_script { chk_down chk_nginx } notify_master \u0026#34;/etc/keepalived/notify.sh master\u0026#34; notify_backup \u0026#34;/etc/keepalived/notify.sh backup\u0026#34; notify_fault \u0026#34;/etc/keepalived/notify.sh fault\u0026#34; } é…ç½®nginxä»£ç† $ vim /etc/nginx/nginx.conf upstream srvs { server 192.168.196.129; server 192.168.196.132; server 127.0.0.1:8080 backup; } server{ ... location / { proxy_passhttp://srvs; } ... } $ vim /etc/nginx/conf.d/vhost.conf server{ server_name www.vhost.com; listen 8080; root \u0026#34;/usr/share/nginx/html\u0026#34;; } $ systemctl start nginx å¯ç”¨keepalivedå¹¶æµ‹è¯• # 1.node1\n$ systemctl start keepalived $ systemctl status keepalived â— keepalived.service - LVS and VRRP High Availability Monitor Loaded: loaded (/usr/lib/systemd/system/keepalived.service; disabled; vendor preset: disabled) Active: active (running) since Tue 2017-09-05 16:24:29 CST; 4s ago Process: 3721 ExecStart=/usr/sbin/keepalived $KEEPALIVED_OPTIONS (code=exited, status=0/SUCCESS) Main PID: 3722 (keepalived) CGroup: /system.slice/keepalived.service â”œâ”€3722 /usr/sbin/keepalived -D â”œâ”€3723 /usr/sbin/keepalived -D â””â”€3724 /usr/sbin/keepalived -D Sep 05 16:24:30 centos7.ffu.com Keepalived_healthcheckers[3723]: Registering Kernel netlink reflector Sep 05 16:24:30 centos7.ffu.com Keepalived_healthcheckers[3723]: Registering Kernel netlink command channel Sep 05 16:24:30 centos7.ffu.com Keepalived_healthcheckers[3723]: Opening file \u0026#39;/etc/keepalived/keepalived.conf\u0026#39;. Sep 05 16:24:30 centos7.ffu.com Keepalived_healthcheckers[3723]: Configuration is using : 7553 Bytes Sep 05 16:24:30 centos7.ffu.com Keepalived_healthcheckers[3723]: Using LinkWatch kernel netlink reflector... Sep 05 16:24:30 centos7.ffu.com Keepalived_vrrp[3724]: VRRP_Instance(VI_1) Transition to MASTER STATE Sep 05 16:24:31 centos7.ffu.com Keepalived_vrrp[3724]: VRRP_Instance(VI_1) Entering MASTER STATE Sep 05 16:24:31 centos7.ffu.com Keepalived_vrrp[3724]: VRRP_Instance(VI_1) setting protocol VIPs. Sep 05 16:24:31 centos7.ffu.com Keepalived_vrrp[3724]: VRRP_Instance(VI_1) Sending gratuitous ARPs on ens37 f....168 Sep 05 16:24:31 centos7.ffu.com Keepalived_healthcheckers[3723]: Netlink reflector reports IP 172.16.255.168 added Hint: Some lines were ellipsized, use -l to show in full. ä»çŠ¶æ€ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œnode1æˆä¸ºmasterèŠ‚ç‚¹ï¼Œå¹¶æ˜ å°„äº†VIPåˆ°æŒ‡å®šçš„ç‰©ç†ç½‘å¡ï¼›ip a list ens37 å‘½ä»¤æŸ¥çœ‹\n$ ip a list ens37 3: ens37: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:0c:29:f1:c7:d5 brd ff:ff:ff:ff:ff:ff inet 172.16.253.93/16 brd 172.16.255.255 scope global dynamic ens37 valid_lft 62845sec preferred_lft 62845sec inet 172.16.255.168/16 scope global secondary ens37 valid_lft forever preferred_lft forever inet6 fe80::fce:4707:e290:f1e0/64 scope link valid_lft forever preferred_lft forever mailæŸ¥çœ‹é‚®ä»¶ï¼Œç¡®è®¤æ”¶åˆ°äº†nodeçŠ¶æ€è½¬æ¢çš„é‚®ä»¶é€šçŸ¥\n$ mail Heirloom Mail version 12.5 7/5/10. Type ? for help. \u0026#34;/var/spool/mail/root\u0026#34;: 1 message 1 new \u0026gt;N 1 root Tue Sep 5 17:26 18/681 \u0026#34;centos7.ffu.com to be master, vip floating\u0026#34; 2.node2\n$ start keepalived $ systemctl status keepalived -l â— keepalived.service - LVS and VRRP High Availability Monitor Loaded: loaded (/usr/lib/systemd/system/keepalived.service; disabled; vendor preset: disabled) Active: active (running) since Tue 2017-09-05 16:38:24 CST; 19s ago Process: 8822 ExecStart=/usr/sbin/keepalived $KEEPALIVED_OPTIONS (code=exited, status=0/SUCCESS) Main PID: 8825 (keepalived) CGroup: /system.slice/keepalived.service â”œâ”€8825 /usr/sbin/keepalived -D â”œâ”€8826 /usr/sbin/keepalived -D â””â”€8827 /usr/sbin/keepalived -D Sep 05 16:38:24 Centos7 Keepalived_healthcheckers[8826]: Netlink reflector reports IP fe80::d254:507:7c6e:2e23 added Sep 05 16:38:24 Centos7 Keepalived_healthcheckers[8826]: Netlink reflector reports IP fe80::250:56ff:fe20:3183 added Sep 05 16:38:24 Centos7 Keepalived_healthcheckers[8826]: Registering Kernel netlink reflector Sep 05 16:38:24 Centos7 Keepalived_healthcheckers[8826]: Registering Kernel netlink command channel Sep 05 16:38:24 Centos7 Keepalived_healthcheckers[8826]: Opening file \u0026#39;/etc/keepalived/keepalived.conf\u0026#39;. Sep 05 16:38:24 Centos7 Keepalived_healthcheckers[8826]: Configuration is using : 7807 Bytes Sep 05 16:38:24 Centos7 Keepalived_healthcheckers[8826]: Using LinkWatch kernel netlink reflector... Sep 05 16:38:24 Centos7 Keepalived_vrrp[8827]: VRRP_Instance(VI_1) Entering BACKUP STATE Sep 05 16:38:24 Centos7 Keepalived_vrrp[8827]: VRRP sockpool: [ifindex(2), proto(112), unicast(0), fd(10,11)] Sep 05 16:38:24 Centos7 Keepalived_vrrp[8827]: VRRP_Script(chk_down) succeeded Sep 05 16:38:24 Centos7 Keepalived_vrrp[8827]: VRRP_Script(chk_nginx) succeeded node2ä¼˜å…ˆçº§95ä½äºnode1çš„100ï¼Œä»çŠ¶æ€ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œchk_down/chk_nginx è„šæœ¬æ‰§è¡ŒçŠ¶æ€è¿”å›ç»“æœå‡ä¸º0æ˜¾ç¤ºsuccessï¼Œnode2æˆä¸ºbackupèŠ‚ç‚¹ï¼Œä¸ä¼šæ˜ å°„VIP\n$ mail Heirloom Mail version 12.5 7/5/10. Type ? for help. \u0026#34;/var/spool/mail/root\u0026#34;: 1 message 1 new \u0026gt;N 1 root Tue Sep 5 17:26 18/693 \u0026#34;Centos7 to be backup, vip floating\u0026#34; 3.clientæµ‹è¯•\né€šè¿‡VIPè®¿é—®WebæœåŠ¡ï¼ŒæˆåŠŸå®ç°è°ƒåº¦ $ while : ; do curl http://172.16.255.168 ;sleep 1 ;done backend server 1 backend server 2 backend server 1 backend server 2 æ‰‹åŠ¨åœæ­¢node1 nginxè¿›ç¨‹ï¼Œè„šæœ¬chk_nginxçŠ¶æ€è¿”å›å€¼ä¸º1ï¼Œpriorityå‡ä¸º90å°äºnode2çš„95ï¼Œnode2èŠ‚ç‚¹åˆ™æˆä¸ºmasterèŠ‚ç‚¹ï¼ŒVIPæ¼‚ç§»å¹¶å®Œæˆæ•…éšœè½¬ç§»ã€‚åŒæ ·å¯ä»¥æŸ¥çœ‹keepalivedã€IPã€mailçŠ¶æ€ \u0026ndash;\u0026gt; node1\n$ systemctl stop nginx $ systemctl status keepalived â— keepalived.service - LVS and VRRP High Availability Monitor Loaded: loaded (/usr/lib/systemd/system/keepalived.service; disabled; vendor preset: disabled) Active: active (running) since Tue 2017-09-05 16:37:24 CST; 11min ago ... ä¸­é—´çœç•¥... Sep 05 16:47:53 centos7.ffu.com Keepalived_vrrp[5171]: VRRP_Script(chk_nginx) failed Sep 05 16:47:55 centos7.ffu.com Keepalived_vrrp[5171]: VRRP_Instance(VI_1) Received higher prio advert Sep 05 16:47:55 centos7.ffu.com Keepalived_vrrp[5171]: VRRP_Instance(VI_1) Entering BACKUP STATE Sep 05 16:47:55 centos7.ffu.com Keepalived_vrrp[5171]: VRRP_Instance(VI_1) removing protocol VIPs. Sep 05 16:47:55 centos7.ffu.com Keepalived_healthcheckers[5170]: Netlink reflector reports IP 172.16.255.168 removed Hint: Some lines were ellipsized, use -l to show in full. $ ip a list ens37 3: ens37: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:0c:29:f1:c7:d5 brd ff:ff:ff:ff:ff:ff inet 172.16.253.93/16 brd 172.16.255.255 scope global dynamic ens37 valid_lft 61554sec preferred_lft 61554sec inet6 fe80::fce:4707:e290:f1e0/64 scope link valid_lft forever preferred_lft forever $ mail Heirloom Mail version 12.5 7/5/10. Type ? for help. \u0026#34;/var/spool/mail/root\u0026#34;: 2 messages 1 new 2 unread U 1 root Tue Sep 5 17:26 19/691 \u0026#34;centos7.ffu.com to be master, vip floating\u0026#34; \u0026gt;N 2 root Tue Sep 5 17:30 18/681 \u0026#34;centos7.ffu.com to be backup, vip floating\u0026#34; \u0026ndash;\u0026gt; node2\n[root@Centos7 keepalived]# systemctl status keepalived â— keepalived.service - LVS and VRRP High Availability Monitor Loaded: loaded (/usr/lib/systemd/system/keepalived.service; disabled; vendor preset: disabled) Active: active (running) since Tue 2017-09-05 16:38:24 CST; 10min ago ... ä¸­é—´çœç•¥... Sep 05 16:38:24 Centos7 Keepalived_vrrp[8827]: VRRP_Script(chk_nginx) succeeded Sep 05 16:47:55 Centos7 Keepalived_vrrp[8827]: VRRP_Instance(VI_1) forcing a new MASTER election Sep 05 16:47:56 Centos7 Keepalived_vrrp[8827]: VRRP_Instance(VI_1) Transition to MASTER STATE Sep 05 16:47:57 Centos7 Keepalived_vrrp[8827]: VRRP_Instance(VI_1) Entering MASTER STATE Sep 05 16:47:57 Centos7 Keepalived_vrrp[8827]: VRRP_Instance(VI_1) setting protocol VIPs. Sep 05 16:47:57 Centos7 Keepalived_vrrp[8827]: VRRP_Instance(VI_1) Sending gratuitous ARPs on ens33 for 172.1....168 Sep 05 16:47:57 Centos7 Keepalived_healthcheckers[8826]: Netlink reflector reports IP 172.16.255.168 added Sep 05 16:48:02 Centos7 Keepalived_vrrp[8827]: VRRP_Instance(VI_1) Sending gratuitous ARPs on ens33 for 172.1....168 Hint: Some lines were ellipsized, use -l to show in full. $ ip a list ens33 2: ens33: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:50:56:38:c5:21 brd ff:ff:ff:ff:ff:ff inet 172.16.251.171/16 brd 172.16.255.255 scope global dynamic ens33 valid_lft 55724sec preferred_lft 55724sec inet 172.16.255.168/16 scope global secondary ens33 valid_lft forever preferred_lft forever inet6 fe80::d254:507:7c6e:2e23/64 scope link valid_lft forever preferred_lft forever $ mail Heirloom Mail version 12.5 7/5/10. Type ? for help. \u0026#34;/var/spool/mail/root\u0026#34;: 2 messages 1 new 2 unread U 1 root Tue Sep 5 17:26 19/703 \u0026#34;Centos7 to be backup, vip floating\u0026#34; \u0026gt;N 2 root Tue Sep 5 17:30 18/693 \u0026#34;Centos7 to be master, vip floating\u0026#34; \u0026ndash;\u0026gt;è®¿é—®æµ‹è¯•ä¹Ÿå¯ä»¥çœ‹å‡ºæ•…éšœè½¬ç§»è¿‡ç¨‹\nbackend server 1 backend server 2 curl: (7) Failed connect to 172.16.255.168:80; Connection refused curl: (7) Failed connect to 172.16.255.168:80; Connection refused curl: (7) Failed connect to 172.16.255.168:80; Connection refused backend server 1 backend server 2 é‡æ–°å¯åŠ¨node1 nginxæœåŠ¡ï¼Œå³å¯å®ç°æ•…éšœè½¬å›(failback)\nä¾æ¬¡å…³é—­Web server cluster çš„æ‰€æœ‰nginxæœåŠ¡ï¼Œå¯ç”¨sorry serverï¼Œè®¿é—®æµ‹è¯•å¯ä»¥çœ‹å‡º backend server 1 backend server 2 backend server 1 backend server 1 nginx LB sorry server 2 nginx LB sorry server 2 é‡æ–°å¯åŠ¨Web server nginx æœåŠ¡ï¼Œå³å¯å‘å¤–éƒ¨æä¾›WebæœåŠ¡\nåŒä¸»æ¨¡å‹KAé«˜å¯ç”¨é›†ç¾¤å®ç° # å¯¹æ¯”ä¸Šæ–‡æ‹“æ‰‘æ¨¡å‹ï¼ŒåŒä¸»æ¨¡å‹ä¸åŒçš„æ˜¯ï¼Œæ¯å°è´Ÿè½½å‡è¡¡å™¨ä¸Šé…ç½®ä¸¤ä¸ªVRRPå®ä¾‹ï¼Œäº’ä¸ºä¸»å¤‡ï¼ŒVIP1å’ŒVIP2åŒæ—¶é¢å‘ç½‘ç»œç”¨æˆ·ï¼Œæ­¤æ—¶ä¸¤å°è´Ÿè½½å‡è¡¡å™¨å‡å¤„äºactiveçŠ¶æ€\næ²¿ç”¨ä¸Šæ–‡æ‹“æ‰‘æ¨¡å‹ï¼Œåœ¨ä¸¤ä¸ªèŠ‚ç‚¹çš„keepalivedé…ç½®æ–‡ä»¶ä¸­æ·»åŠ vrrpå®ä¾‹ \u0026ndash;\u0026gt; node1\nvrrp_instance VI_2 { state BACKUP interface ens37 virtual_router_id 61 \u0026lt;--æ³¨æ„åŒä¸€å°ç‰©ç†è·¯ç”±çš„è™šæ‹Ÿè·¯ç”±IDå”¯ä¸€æ€§ priority 95 advert_int 1 authentication { auth_type PASS auth_pass AhpaeQ0J } virtual_ipaddress { 172.16.255.68/16 dev ens37 \u0026lt;--æŒ‡å®šVIP2 } track_script { chk_down chk_nginx } notify_master \u0026#34;/etc/keepalived/notify.sh master\u0026#34; notify_backup \u0026#34;/etc/keepalived/notify.sh backup\u0026#34; notify_fault \u0026#34;/etc/keepalived/notify.sh fault\u0026#34; } \u0026ndash;\u0026gt; node2\nvrrp_instance VI_2 { state MASTER interface ens33 virtual_router_id 61 priority 100 advert_int 1 authentication { auth_type PASS auth_pass AhpaeQ0J } virtual_ipaddress { 172.16.255.68/16 dev ens33 } track_script { chk_down chk_nginx } notify_master \u0026#34;/etc/keepalived/notify.sh master\u0026#34; notify_backup \u0026#34;/etc/keepalived/notify.sh backup\u0026#34; notify_fault \u0026#34;/etc/keepalived/notify.sh fault\u0026#34; } å¯åŠ¨node1ã€node2 keepalivedæœåŠ¡ VIP1å’ŒVIP2åˆ†åˆ«æ˜ å°„åœ¨node1å’Œnode2ä¸Š\n$ ip a list ens37 3: ens37: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:0c:29:f1:c7:d5 brd ff:ff:ff:ff:ff:ff inet 172.16.253.93/16 brd 172.16.255.255 scope global dynamic ens37 valid_lft 79856sec preferred_lft 79856sec inet 172.16.255.168/16 scope global secondary ens37 valid_lft forever preferred_lft forever $ ip a list ens33 2: ens33: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:50:56:38:c5:21 brd ff:ff:ff:ff:ff:ff inet 172.16.251.171/16 brd 172.16.255.255 scope global dynamic ens33 valid_lft 39490sec preferred_lft 39490sec inet 172.16.255.68/16 scope global secondary ens33 valid_lft forever preferred_lft forever è®¿é—®æµ‹è¯•ï¼Œä¸¤å°è´Ÿè½½å‡è¡¡å™¨å‡å¤„äºactiveçŠ¶æ€ $ while : ; do curl http://172.16.255.68 ;sleep 1 ;done backend server 1 backend server 2 backend server 1 backend server 2 $ while : ; do curl http://172.16.255.168 ;sleep 1 ;done backend server 1 backend server 2 backend server 1 backend server 2 æ‰‹åŠ¨åœæ­¢node1 nginxæœåŠ¡ï¼ŒVIP1æ¼‚ç§»åˆ°node2ä¸Šï¼Œå®ç°æ•…éšœè½¬ç§»; \u0026ndash;\u0026gt; node2 åŒæ—¶æ˜ å°„VIP1ã€VIP2\n$ ip a list ens33 2: ens33: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:50:56:38:c5:21 brd ff:ff:ff:ff:ff:ff inet 172.16.251.171/16 brd 172.16.255.255 scope global dynamic ens33 valid_lft 38315sec preferred_lft 38315sec inet 172.16.255.68/16 scope global secondary ens33 valid_lft forever preferred_lft forever inet 172.16.255.168/16 scope global secondary ens33 valid_lft forever preferred_lft forever \u0026ndash;\u0026gt; è®¿é—®æµ‹è¯•ä¹Ÿå¯ä»¥çœ‹å‡ºæ•…éšœè½¬ç§»è¿‡ç¨‹\n$ while : ; do curl http://172.16.255.68 ;sleep 1 ;done backend server 2 backend server 1 curl: (7) Failed connect to 172.16.255.168:80; Connection refused curl: (7) Failed connect to 172.16.255.168:80; Connection refused backend server 2 backend server 1 åŒæ ·çš„è¿˜å¯ä»¥æµ‹è¯•node2çš„æ•…éšœè½¬ç§»ï¼Œè‡³æ­¤å•ä¸»ã€åŒä¸»æ¨¡å‹keepalived+nginxè´Ÿè½½å‡è¡¡é«˜å¯ç”¨é›†ç¾¤(ä¸¤èŠ‚ç‚¹)å·²ç»å®ç°ã€‚\n","date":"20 July 2016","permalink":"/2016/07/keepalived-nginx/","section":"åšå®¢","summary":"\u003ch3 class=\"relative group\"\u003ekeepalivedç®€ä»‹ \n    \u003cdiv id=\"keepalivedç®€ä»‹\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#keepalived%e7%ae%80%e4%bb%8b\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h3\u003e\n\u003cp\u003ekeepalivedæ˜¯ä¸€æ¬¾è§£å†³è´Ÿè½½å‡è¡¡(è°ƒåº¦å™¨)çš„é«˜å¯ç”¨é—®é¢˜çš„è½¯ä»¶ï¼Œå¯ä»¥å®ç°è´Ÿè½½å‡è¡¡å™¨çš„æ•…éšœè½¬ç§»(failover)ï¼ŒåŸç”Ÿè®¾è®¡çš„ç›®çš„ä¸ºäº†é«˜å¯ç”¨ipvsæœåŠ¡ï¼Œåæ¥å¢åŠ äº†è„šæœ¬è°ƒç”¨æ¥å£ï¼Œä½¿å…¶ä¸€å®šç¨‹åº¦ä¸Šå…·æœ‰äº†ç®¡æ§æœåŠ¡è¿›ç¨‹çš„åŠŸèƒ½ï¼ŒåŸºäºæ­¤æ¥å£ä¹Ÿå¯ä»¥æ”¯æŒnginxã€haproxyè´Ÿè½½å‡è¡¡çš„é«˜å¯ç”¨ã€‚keepalivedæ˜¯VRRPåè®®çš„è½¯ä»¶å®ç°ï¼Œä¹ŸåŸºäºVRRPåè®®å®Œæˆåœ°å€æµåŠ¨ï¼Œé‚£ä»€ä¹ˆæ˜¯VRRPåè®®å‘¢ï¼Ÿ\u003c/p\u003e","title":"Keepalived+nginx LBé«˜å¯ç”¨é›†ç¾¤å®ç°"},{"content":"","date":"3 June 2016","permalink":"/tags/lvs/","section":"Tags","summary":"","title":"LVS"},{"content":"","date":"3 June 2016","permalink":"/series/lvs/","section":"Series","summary":"","title":"LVS"},{"content":" ä¸Šç¯‡å…³äº LVS-nat æ¨¡å¼çš„è´Ÿè½½å‡è¡¡å®ç°åšå®¢ä¸­å·²ç»ç®€å•ä»‹ç»äº†æœ‰å…³LVSé›†ç¾¤çš„æ¦‚å¿µã€å››ç§IPè´Ÿè½½å‡è¡¡æŠ€æœ¯ä»¥åŠåç§è°ƒåº¦ç®—æ³•ï¼Œæœ¬æ–‡å°†è¯¦ç»†ä»‹ç»LVS-DR(ç›´æ¥è·¯ç”±)æ¨¡å¼çš„å®ç°\nâ€‹ LVS-DRï¼šDirect Routing, LVSé»˜è®¤æ¨¡å¼, é€šè¿‡ä¸ºè¯·æ±‚æŠ¥æ–‡é‡æ–°å°è£…ä¸€ä¸ªMACé¦–éƒ¨è¿›è¡Œè½¬å‘ï¼ŒæºMACæ˜¯DIPæ‰€åœ¨çš„æ¥å£çš„MACï¼Œç›®æ ‡MACæ˜¯æŸæŒ‘é€‰å‡ºçš„RSçš„RIPæ‰€åœ¨æ¥å£çš„MACåœ°å€ï¼›æºIP/PORTï¼Œä»¥åŠç›®æ ‡IP/PORTå‡ä¿æŒä¸å˜ã€‚è¯·æ±‚æŠ¥æ–‡åŒæ ·è¦ç»ç”± Directorï¼Œä½†ä¸natä¸åŒçš„æ˜¯DRæ¨¡å¼ä¸‹çš„å“åº”æŠ¥æ–‡ä¸ç»ç”± Directorï¼Œè€Œç”±RSç›´æ¥å‘å¾€Client\nDRæ¨¡å¼è°ƒåº¦æµç¨‹ # ç½‘ç»œä¼ è¾“æ—¶ï¼Œç»è¿‡è·¯ç”±è½¬å‘ï¼Œä¼šä¿®æ”¹æºmacä¸ºè¯¥è½¬å‘è·¯ç”±çš„mac\nDirectorå’Œå„RSéƒ½é…ç½®æœ‰VIP\nç¡®ä¿RSå“åº”æŠ¥æ–‡ä¸­æºIPä¸ºVIPï¼Œè¿›è€Œèµ°ç›´æ¥è·¯ç”±è¿”å›client\nè§£å†³åœ°å€å†²çª, ç¡®ä¿å‰ç«¯è·¯ç”±å™¨å°†ç›®æ ‡IPä¸ºVIPçš„è¯·æ±‚æŠ¥æ–‡å‘å¾€Director,è€Œä¸æ˜¯RSï¼Œä¸‰ç§æ–¹æ³•ï¼š\nåœ¨å‰ç«¯ç½‘å…³åšé™æ€ç»‘å®šVIPå’ŒDirectorçš„MACåœ°å€\nåœ¨RSä¸Šä½¿ç”¨arptableså·¥å…·\narptables -A IN -d VIP -j DROP arptables -A OUT -s VIP -j mangle \u0026ndash;mangle -ip -s RIP\nåœ¨å„RSä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œæ¥é™åˆ¶arpå“åº”å’Œé€šå‘Šçš„çº§åˆ«\né™åˆ¶å“åº”çº§åˆ«ï¼š arp_ignore\n1 \u0026ndash;\u0026gt; ä»…åœ¨è¯·æ±‚çš„ç›®æ ‡IPé…ç½®åœ¨æœ¬åœ°ä¸»æœºçš„æ¥æ”¶åˆ°è¯·æ±‚æŠ¥æ–‡çš„æ¥å£ä¸Šæ—¶ï¼Œæ‰ç»™äºˆå“åº”\neg: echo 1 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_ignore\né™åˆ¶é€šå‘Šçº§åˆ«ï¼šarp_announce\n2 \u0026ndash;\u0026gt; å¿…é¡»é¿å…å°†æ¥å£ä¿¡æ¯å‘éæœ¬ç½‘ç»œè¿›è¡Œé€šå‘Š\neg: echo 2 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_announce\nHTTPæœåŠ¡è´Ÿè½½å‡è¡¡å®éªŒ # ç½‘ç»œæ‹“æ‰‘æ­å»º # ä½¿ç”¨VMwareæ­å»ºå®éªŒç½‘ç»œæ‹“æ‰‘\nVIPä¸RIPå¯ä»¥åœ¨ä¸€ä¸ªç½‘æ®µä¹Ÿå¯ä»¥ä¸åœ¨åŒä¸€ç½‘æ®µã€‚æ­¤å®éªŒä¸­ï¼ŒVIPæ˜¯ä¸RIPåœ¨åŒä¸€ç½‘æ®µï¼Œå‰ç«¯è·¯ç”±ä¸´è¿‘çš„æ¥å£åªç”¨é…ä¸€ä¸ªåœ°å€ï¼Œå¦åˆ™è¦é¢å¤–é…ç½®ä¸€ä¸ªvipç½‘æ®µçš„åœ°å€\nè°ƒåº¦å™¨Directorè¦æ‰“å¼€æ ¸å¿ƒè½¬å‘åŠŸèƒ½\n$ echo \u0026quot;net.ipv4.ip_forward = 1\u0026quot; \u0026gt;\u0026gt; /etc/sysctl.conf\nå¦‚æœè¦å¯ç”¨sorry server, VS çš„ç½‘å…³è¦æŒ‡å‘å‰ç«¯è·¯ç”±ä¸´è¿‘çš„æ¥å£ï¼›å¦åˆ™ï¼ŒæŒ‡å‘RIPæ‰€åœ¨ç½‘æ®µä»»æ„IPçš†å¯\nRS ç½‘å…³è¦æŒ‡å‘å‰ç«¯è·¯ç”±\né…ç½®RS httpdæœåŠ¡å¹¶å¯åŠ¨\nRS1 â€“\u0026gt;$ echo â€œRS1 SRVâ€ \u0026gt; /var/www/html/index.html\nRS2 â€“\u0026gt;$ echo â€œRS2 SRVâ€ \u0026gt; /var/www/html/index.html\nè„šæœ¬å®ç°RSé…ç½®\n$ bash lvs_dr_rs.sh start\n#!/bin/bash vip=192.168.196.186 dev=lo:1\t\u0026lt;-- é…ç½®VIPåœ¨å›ç¯loçš„åˆ«åä¸Š case $1 in start) echo 1 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_ignore echo 1 \u0026gt; /proc/sys/net/ipv4/conf/lo/arp_ignore echo 2 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_announce echo 2 \u0026gt; /proc/sys/net/ipv4/conf/lo/arp_announce ifconfig $dev $vip netmask 255.255.255.255 broadcast $vip up ;; stop) ifconfig $dev down echo 0 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_ignore echo 0 \u0026gt; /proc/sys/net/ipv4/conf/lo/arp_ignore echo 0 \u0026gt; /proc/sys/net/ipv4/conf/all/arp_announce echo 0 \u0026gt; /proc/sys/net/ipv4/conf/lo/arp_announce ;; *) echo \u0026#34;Usage: $(basename $0) start|stop\u0026#34; exit 1 ;; esac DIRECTORä¸Šç®¡ç†é›†ç¾¤æœåŠ¡å¹¶æµ‹è¯• # è„šæœ¬å®ç°é›†ç¾¤æœåŠ¡ç®¡ç†\n$ bash lvs_dr_vs.sh start\n#!/bin/bash vip=192.168.196.186 port=80 service=$vip:$port dev=ens33:1 RS1=192.168.196.155 RS2=192.168.196.196 scheduler=rr tp=\u0026#34;-g\u0026#34; case $1 in start) ifconfig $dev $vip/32 broadcast $vip up ipvsadm -A -t $service -s $scheduler ipvsadm -a -t $service -r $RS1 $tp -w 1 ipvsadm -a -t $service -r $RS2 $tp -w 1 ;; stop) ipvsadm -C ifconfig $dev down ;; *) echo \u0026#34;Usage $(basename $0) start|stopr\u0026#34;;exit 1 ;; esac æŸ¥çœ‹å½“å‰çŠ¶æ€\n$ ipvsadm -Ln IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -\u0026gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 192.168.196.186:80 rr -\u0026gt; 192.168.196.155:80 Route 1 0 0 -\u0026gt; 192.168.196.196:80 Route 1 0 1 å®¢æˆ·ç«¯æµ‹è¯•\n$ for i in {1..10}; do curl 192.168.196.186;sleep 1;done RS2 SRV RS1 SRV RS2 SRV RS1 SRV RS2 SRV RS1 SRV RS2 SRV RS1 SRV RS2 SRV RS1 SRV ldirectordå·¥å…·å®ç°é«˜å¯ç”¨çš„lvs # ldirectordï¼šç›‘æ§å’Œæ§åˆ¶LVSå®ˆæŠ¤è¿›ç¨‹ï¼Œå¯ç®¡ç†LVSè§„åˆ™ rpmåŒ… \u0026ndash;\u0026gt; ldirectord-3.9.6-0rc1.1.1.x86_64.rpm\n$ rpm -ql ldirectord /etc/ha.d /etc/ha.d/resource.d /etc/ha.d/resource.d/ldirectord /etc/logrotate.d/ldirectord /usr/lib/ocf/resource.d/heartbeat/ldirectord /usr/lib/systemd/system/ldirectord.service /usr/sbin/ldirectord /usr/share/doc/ldirectord-3.9.6 /usr/share/doc/ldirectord-3.9.6/COPYING /usr/share/doc/ldirectord-3.9.6/ldirectord.cf \u0026lt;-- é…ç½®æ–‡ä»¶æ¨¡æ¿ /usr/share/man/man8/ldirectord.8.gz $cp /usr/share/doc/ldirectord-3.9.6/ldirectord.cf /etc/ha.d ä¿®æ”¹é…ç½®æ–‡ä»¶ # $ vim /etc/ha.d/ldirectord.cf checktimeout=3 \u0026lt;-- å“åº”è¶…æ—¶æ—¶é—´ checkinterval=1 \u0026lt;-- æ£€æŸ¥é—´éš”æ—¶é—´ #fallback=127.0.0.1:80 #fallback6=[::1]:80 autoreload=yes \u0026lt;-- è‡ªåŠ¨è¯»å–åŠ è½½é…ç½®æ–‡ä»¶ logfile=\u0026#34;/var/log/ldirectord.log\u0026#34; #logfile=\u0026#34;local0\u0026#34;\t\u0026lt;-- æŒ‡å®šrsyslogæ—¥å¿—æœåŠ¡çš„facilityåç§° #emailalert=\u0026#34;admin@x.y.z\u0026#34; #emailalertfreq=3600 #emailalertstatus=all quiescent=no \u0026lt;-- noä»£è¡¨ä¸€æ—¦å®•æœºåˆ™ä»é›†ç¾¤ä¸­ç§»é™¤RSï¼›yesä»£è¡¨ä¸€æ—¦å®•æœºåˆ™å°†è¯¥RSæƒé‡è®¾ç½®ä¸º0 # Sample for an http virtual service \u0026lt;-- Director Serverçš„é…ç½®(ä»¥ä¸Šæ–‡å®éªŒé…ç½®ä¸ºä¾‹) virtual=192.168.196.186:80 real=192.168.196.155:80 gate \u0026lt;-- gate å¯¹åº”-g dræ¨¡å¼ real=192.168.196.196:80 gate fallback=127.0.0.1:80 gate \u0026lt;-- sorry server; RSå…¨éƒ¨å®•æœºæ—¶çš„å“åº” service=http scheduler=rr #persistent=600 #netmask=255.255.255.255 protocol=tcp checktype=negotiate checkport=80 request=\u0026#34;index.html\u0026#34; receive=\u0026#34;SRV\u0026#34;\t\u0026lt;-- æŠ“å–ç½‘é¡µå…³é”®å­—ï¼Œåˆ¤æ–­ $ echo \u0026#34;Sorry, server is down\u0026#34; \u0026gt; /var/www/html/index.html $ systemctl start httpd \u0026lt;-- å¯åŠ¨è°ƒåº¦æœåŠ¡å™¨çš„httpæœåŠ¡ å¯åŠ¨ldirectoræœåŠ¡ # $ ifconfig ens33:1 192.168.196.186/32 broadcast 192.168.196.186 up \u0026lt;-- VSä¸Šæ‰‹åŠ¨æ·»åŠ VIP $ systemctl start ldirectord $ ipvsadm -Ln IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -\u0026gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 192.168.196.186:80 rr -\u0026gt; 192.168.196.155:80 Route 1 0 0 -\u0026gt; 192.168.196.196:80 Route 1 0 0 å®¢æˆ·ç«¯æµ‹è¯• # lvsé›†ç¾¤å·²ç»å®ç°è½®è¯¢ç®—æ³•çš„è°ƒåº¦ $ for i in {1..5}; do curl --connect-timeout 1 192.168.196.186;sleep 1; done RS2 SRV RS1 SRV RS2 SRV RS1 SRV RS2 SRV åœæ­¢RS1çš„httpæœåŠ¡æ¨¡æ‹Ÿå®•æœº\nVSä¸ŠæŸ¥çœ‹é›†ç¾¤æœåŠ¡çŠ¶æ€\n$ ipvsadm -Ln IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -\u0026gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 192.168.196.186:80 rr -\u0026gt; 192.168.196.196:80 Route 1 0 0 \u0026lt;--è‡ªåŠ¨ç§»é™¤å®•æœºçš„RS1 å®¢æˆ·ç«¯æµ‹è¯•æ˜¾ç¤ºRS1å®•æœºåï¼ŒDRå°†è¯·æ±‚è‡ªåŠ¨è°ƒåº¦åˆ°RS2ä¸Š\n$ for i in {1..5}; do curl --connect-timeout 1 192.168.196.186;sleep 1; done RS2 SRV RS1 SRV RS2 SRV RS2 SRV \u0026lt;-- æ­¤æ—¶RS1 httpæœåŠ¡åœæ­¢ RS2 SRV åœæ­¢æ‰€æœ‰RSçš„httpæœåŠ¡\nVSä¸ŠæŸ¥çœ‹é›†ç¾¤æœåŠ¡çŠ¶æ€\n$ ipvsadm -Ln IP Virtual Server version 1.2.1 (size=4096) Prot LocalAddress:Port Scheduler Flags -\u0026gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 192.168.196.186:80 rr -\u0026gt; 127.0.0.1:80 Route 1 0 0 \u0026lt;--è‡ªåŠ¨å¯ç”¨æœ¬æœºsorry server å®¢æˆ·ç«¯æµ‹è¯•ç»“æœ\n[root@Centos7 ~]#for i in {1..100}; do curl --connect-timeout 1 192.168.196.186;sleep 1; done RS1 SRV RS2 SRV RS1 SRV RS2 SRV RS1 SRV RS1 SRV \u0026lt;--RS2å®•æœº RS1 SRV sorry,server is down \u0026lt;--RS1åŒæ—¶å®•æœºï¼Œå¯ç”¨sorry server sorry,server is down ","date":"3 June 2016","permalink":"/2016/06/lvs-dr/","section":"åšå®¢","summary":"ä¸Šç¯‡å…³äº LVS-nat æ¨¡å¼çš„è´Ÿè½½å‡è¡¡å®ç°åšå®¢ä¸­å·²ç»ç®€å•ä»‹ç»äº†æœ‰å…³LVSé›†ç¾¤çš„æ¦‚å¿µã€å››ç§IPè´Ÿè½½å‡è¡¡æŠ€æœ¯ä»¥åŠåç§è°ƒåº¦ç®—æ³•ï¼Œæœ¬æ–‡å°†è¯¦ç»†ä»‹ç»LVS-DR(ç›´æ¥è·¯ç”±)æ¨¡å¼çš„å®ç°\nâ€‹ LVS-DRï¼šDirect Routing, LVSé»˜è®¤æ¨¡å¼, é€šè¿‡ä¸ºè¯·æ±‚æŠ¥æ–‡é‡æ–°å°è£…ä¸€ä¸ªMACé¦–éƒ¨è¿›è¡Œè½¬å‘ï¼ŒæºMACæ˜¯DIPæ‰€åœ¨çš„æ¥å£çš„MACï¼Œç›®æ ‡MACæ˜¯æŸæŒ‘é€‰å‡ºçš„RSçš„RIPæ‰€åœ¨æ¥å£çš„MACåœ°å€ï¼›æºIP/PORTï¼Œä»¥åŠç›®æ ‡IP/PORTå‡ä¿æŒä¸å˜ã€‚è¯·æ±‚æŠ¥æ–‡åŒæ ·è¦ç»ç”± Directorï¼Œä½†ä¸natä¸åŒçš„æ˜¯DRæ¨¡å¼ä¸‹çš„å“åº”æŠ¥æ–‡ä¸ç»ç”± Directorï¼Œè€Œç”±RSç›´æ¥å‘å¾€Client\nDRæ¨¡å¼è°ƒåº¦æµç¨‹ # ç½‘ç»œä¼ è¾“æ—¶ï¼Œç»è¿‡è·¯ç”±è½¬å‘ï¼Œä¼šä¿®æ”¹æºmacä¸ºè¯¥è½¬å‘è·¯ç”±çš„mac\nDirectorå’Œå„RSéƒ½é…ç½®æœ‰VIP\nç¡®ä¿RSå“åº”æŠ¥æ–‡ä¸­æºIPä¸ºVIPï¼Œè¿›è€Œèµ°ç›´æ¥è·¯ç”±è¿”å›client\nè§£å†³åœ°å€å†²çª, ç¡®ä¿å‰ç«¯è·¯ç”±å™¨å°†ç›®æ ‡IPä¸ºVIPçš„è¯·æ±‚æŠ¥æ–‡å‘å¾€Director,è€Œä¸æ˜¯RSï¼Œä¸‰ç§æ–¹æ³•ï¼š\nåœ¨å‰ç«¯ç½‘å…³åšé™æ€ç»‘å®šVIPå’ŒDirectorçš„MACåœ°å€\nåœ¨RSä¸Šä½¿ç”¨arptableså·¥å…·\narptables -A IN -d VIP -j DROP arptables -A OUT -s VIP -j mangle \u0026ndash;mangle -ip -s RIP","title":"LVS DR è´Ÿè½½å‡è¡¡å®ç°"},{"content":"ä»€ä¹ˆæ˜¯LVS # LVS: Linux Virtual Serverï¼Œå³Linuxè™šæ‹ŸæœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æœåŠ¡å™¨é›†ç¾¤ç³»ç»Ÿ\nLVSé›†ç¾¤ç”±VS(Virtual Server)è´Ÿè´£è°ƒåº¦,RS(Real Server)è´Ÿè´£çœŸæ­£æä¾›æœåŠ¡ã€‚VSæ ¹æ®è¯·æ±‚æŠ¥æ–‡çš„ç›®æ ‡IPå’Œç›®æ ‡åè®®åŠç«¯å£å°†å…¶è°ƒåº¦è½¬å‘è‡³æŸRSï¼Œæ ¹æ®è°ƒåº¦ç®—æ³•æ¥æŒ‘é€‰RSï¼Œå®ç°è´Ÿè½½å‡è¡¡ï¼Œè€Œä¸”è°ƒåº¦å™¨è‡ªåŠ¨å±è”½æ‰æœåŠ¡å™¨çš„æ•…éšœï¼Œä»è€Œå°†ä¸€ç»„æœåŠ¡å™¨æ„æˆä¸€ä¸ªé«˜æ€§èƒ½çš„ã€é«˜å¯ç”¨çš„è™šæ‹ŸæœåŠ¡å™¨ã€‚ lvsé›†ç¾¤çš„ç±»å‹ï¼š\nlvs-natï¼šå¤šç›®æ ‡IPçš„DNAT(Network Address Translation)ï¼Œé€šè¿‡å°†è¯·æ±‚æŠ¥æ–‡ä¸­çš„ç›®æ ‡åœ°å€å’Œç›®æ ‡ç«¯å£ä¿®æ”¹ä¸ºæŸæŒ‘å‡ºçš„RSçš„RIPå’ŒPORTå®ç°è½¬å‘\u0026mdash;\u0026ndash;æœ¬æ–‡å°†å¯¹natæ¨¡å¼åŠå…¶å®ç°åšè¯¦ç»†è§£é‡Š lvs-drï¼šDirect Routing, LVSé»˜è®¤æ¨¡å¼, é€šè¿‡ä¸ºè¯·æ±‚æŠ¥æ–‡é‡æ–°å°è£…ä¸€ä¸ªMACé¦–éƒ¨è¿›è¡Œè½¬å‘ï¼ŒæºMACæ˜¯DIPæ‰€åœ¨çš„æ¥å£çš„MACï¼Œç›®æ ‡MACæ˜¯æŸæŒ‘é€‰å‡ºçš„RSçš„RIPæ‰€åœ¨æ¥å£çš„MACåœ°å€ï¼›æºIP/PORTï¼Œä»¥åŠç›®æ ‡IP/PORTå‡ä¿æŒä¸å˜ lvs-tunï¼šä¸ä¿®æ”¹è¯·æ±‚æŠ¥æ–‡çš„IPé¦–éƒ¨, åœ¨åŸè¯·æ±‚IPæŠ¥æ–‡ä¹‹å¤–å°è£…ä¸€ä¸ªIPé¦–éƒ¨, å°†æŠ¥æ–‡å‘å¾€æŒ‘é€‰å‡ºçš„ç›®æ ‡RS,RSç›´æ¥å“åº”ç»™å®¢æˆ·ç«¯ lvs-fullnatï¼šé€šè¿‡åŒæ—¶ä¿®æ”¹è¯·æ±‚æŠ¥æ–‡çš„æºIPåœ°å€å’Œç›®æ ‡IPåœ°å€è¿›è¡Œè½¬å‘,æ­¤ç±»å‹kernelé»˜è®¤ä¸æ”¯æŒ ipvsadmä¸ipvsï¼š\nipvsadmæ˜¯ç”¨æˆ·ç©ºé—´çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè§„åˆ™ç®¡ç†å™¨ï¼Œå®ç°ç”¨æˆ·ç®¡ç†é›†ç¾¤æœåŠ¡åŠRealServer ç®¡ç†é›†ç¾¤æœåŠ¡ï¼šå¢ã€æ”¹ã€åˆ  å¢ã€æ”¹ï¼š\nipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]\nåˆ é™¤ï¼š\nipvsadm -D -t|u|f service-address\nç®¡ç†é›†ç¾¤ä¸Šçš„RSï¼šå¢ã€æ”¹ã€åˆ  å¢ã€æ”¹ï¼š\nipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [ -w weight] -g: gateway, drç±»å‹ï¼Œé»˜è®¤ -i: ipip, tunç±»å‹ -m: masquerade, natç±»å‹\nåˆ ï¼š\nipvsadm -d -t|u|f service-address -r serveraddress\nipvsæ˜¯å·¥ä½œäºå†…æ ¸ç©ºé—´netfilterçš„INPUTé’©å­ä¸Šçš„æ¡†æ¶ï¼Œæ­¤æ¡†æ¶ä½¿è°ƒåº¦å™¨å…·å¤‡è°ƒåº¦è½¬å‘åŠŸèƒ½ï¼Œè€Œè°ƒåº¦ç®—æ³•åˆå†³å®šæŒ‘é€‰å“ªä¸ªRSè¿›è¡Œè½¬å‘ ipvs è°ƒåº¦ç®—æ³•ï¼š æ ¹æ®å…¶è°ƒåº¦æ—¶æ˜¯å¦è€ƒè™‘å„RSå½“å‰çš„è´Ÿè½½çŠ¶æ€ï¼Œåˆ†ä¸ºé™æ€æ–¹æ³•ä¸åŠ¨æ€æ–¹æ³•\né™æ€æ–¹æ³•ï¼šä»…æ ¹æ®ç®—æ³•æœ¬èº«è¿›è¡Œè°ƒåº¦ åŠ¨æ€æ–¹æ³•ï¼šä¸»è¦æ ¹æ®æ¯RSå½“å‰çš„è´Ÿè½½çŠ¶æ€åŠè°ƒåº¦ç®—æ³•è¿›è¡Œè°ƒåº¦Overhead=value è¾ƒå°çš„RSå°†è¢«è°ƒåº¦ LVS-NAT æ¨¡å¼è´Ÿè½½å‡è¡¡çš„å®ç° # NATæ¨¡å¼IPè°ƒåº¦æµç¨‹ # å®¢æˆ·ç«¯å‘è°ƒåº¦å™¨(Director Server,VS)å‘é€è¯·æ±‚æŠ¥æ–‡, Directoré€šè¿‡å°†è¯·æ±‚æŠ¥æ–‡ä¸­çš„ç›®æ ‡åœ°å€å’Œç›®æ ‡ç«¯å£ä¿®æ”¹ä¸ºæŸæŒ‘å‡ºçš„RSçš„RIPå’ŒPORTå®ç°è½¬å‘ã€‚æ­¤æ¨¡å¼ä¸‹è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡éƒ½å¿…é¡»ç»ç”±Directorï¼Œè°ƒåº¦å™¨æ˜“äºæˆä¸ºç³»ç»Ÿç“¶é¢ˆ\nhttpæœåŠ¡è´Ÿè½½å‡è¡¡å®éªŒ\u0026ndash;ç½‘ç»œæ‹“æ‰‘æ­å»º # ä½¿ç”¨VMwareæ­å»ºå®éªŒç½‘ç»œæ‹“æ‰‘\nè°ƒåº¦å™¨Directorè¦æ‰“å¼€æ ¸å¿ƒè½¬å‘åŠŸèƒ½\n$ echo \u0026quot;net.ipv4.ip_forward = 1\u0026quot; \u0026gt;\u0026gt; /etc/sysctl.conf\nRS ç½‘å…³è¦æŒ‡å‘DIP\né…ç½®RS httpdæœåŠ¡å¹¶å¯åŠ¨\nRS1 \u0026ndash;\u0026gt;$ echo â€œRS1 SRVâ€ \u0026gt; /var/www/html/index.html\nRS2 \u0026ndash;\u0026gt;$ echo â€œRS2 SRVâ€ \u0026gt; /var/www/html/index.html\nDirectorä¸Šç®¡ç†é›†ç¾¤æœåŠ¡å¹¶æµ‹è¯• # æ·»åŠ é›†ç¾¤æœåŠ¡\n$ ipvsadm -A -t 172.16.253.153:80 -s rr -- -s æŒ‡å®šç®—æ³•ä¸ºrrè½®è¯¢ æ·»åŠ é›†ç¾¤çš„RS\n$ ipvsadm -a -t 172.16.253.153:80 -r 192.168.196.155 -m -- -mæŒ‡å®šä¸ºnatæ¨¡å¼ $ ipvsadm -a -t 172.16.253.153:80 -r 192.168.196.196 -m $ ipvsadm -LnIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags -\u0026gt; RemoteAddress:Port Forward Weight ActiveConn InActConn TCP 172.16.253.153:80 rr -\u0026gt; 192.168.196.155:80 Masq 1 0 0 -\u0026gt; 192.168.196.196:80 Masq 1 0 0 å®¢æˆ·ç«¯æµ‹è¯•\n$ for i in {1..10}; do curl 172.16.253.153;sleep 1;done RS1 SRV RS2 SRV RS1 SRV RS2 SRV RS1 SRV RS2 SRV RS1 SRV RS2 SRV RS1 SRV RS2 SRV ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå®¢æˆ·ç«¯è®¿é—®VSï¼Œè°ƒåº¦å™¨æŒ‰ç…§è½®è¯¢ç®—æ³•ä¾æ¬¡è½¬å‘ç»™RS1ã€RS2\næœ¬æ–‡çš„å®éªŒåªæ¼”ç¤ºäº†RRç®—æ³•ï¼Œè¿˜æœ‰å…¶ä»–ç®—æ³•å¯ä»¥é€‰æ‹©ï¼ŒåŒæ—¶LVS-natæ¨¡å¼è¿˜æ”¯æŒç«¯å£æ˜ å°„ï¼Œä»¥httpdé›†ç¾¤æœåŠ¡ä¸ºä¾‹ï¼ŒRSçš„æœåŠ¡ç«¯å£ä¹Ÿå¯ä»¥æ˜¯è‡ªå®šä¹‰ç«¯å£(eg: 8080)ã€‚åç»­ä¼šæ›´æ–° å…³äºLVS-DRæ¨¡å¼ã€é›†ç¾¤æœåŠ¡åˆå¹¶åŠLVSé«˜å¯ç”¨æ€§çš„å®ç°\n","date":"16 May 2016","permalink":"/2016/05/lvs-nat/","section":"åšå®¢","summary":"ä»€ä¹ˆæ˜¯LVS # LVS: Linux Virtual Serverï¼Œå³Linuxè™šæ‹ŸæœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æœåŠ¡å™¨é›†ç¾¤ç³»ç»Ÿ\nLVSé›†ç¾¤ç”±VS(Virtual Server)è´Ÿè´£è°ƒåº¦,RS(Real Server)è´Ÿè´£çœŸæ­£æä¾›æœåŠ¡ã€‚VSæ ¹æ®è¯·æ±‚æŠ¥æ–‡çš„ç›®æ ‡IPå’Œç›®æ ‡åè®®åŠç«¯å£å°†å…¶è°ƒåº¦è½¬å‘è‡³æŸRSï¼Œæ ¹æ®è°ƒåº¦ç®—æ³•æ¥æŒ‘é€‰RSï¼Œå®ç°è´Ÿè½½å‡è¡¡ï¼Œè€Œä¸”è°ƒåº¦å™¨è‡ªåŠ¨å±è”½æ‰æœåŠ¡å™¨çš„æ•…éšœï¼Œä»è€Œå°†ä¸€ç»„æœåŠ¡å™¨æ„æˆä¸€ä¸ªé«˜æ€§èƒ½çš„ã€é«˜å¯ç”¨çš„è™šæ‹ŸæœåŠ¡å™¨ã€‚ lvsé›†ç¾¤çš„ç±»å‹ï¼š\nlvs-natï¼šå¤šç›®æ ‡IPçš„DNAT(Network Address Translation)ï¼Œé€šè¿‡å°†è¯·æ±‚æŠ¥æ–‡ä¸­çš„ç›®æ ‡åœ°å€å’Œç›®æ ‡ç«¯å£ä¿®æ”¹ä¸ºæŸæŒ‘å‡ºçš„RSçš„RIPå’ŒPORTå®ç°è½¬å‘\u0026mdash;\u0026ndash;æœ¬æ–‡å°†å¯¹natæ¨¡å¼åŠå…¶å®ç°åšè¯¦ç»†è§£é‡Š lvs-drï¼šDirect Routing, LVSé»˜è®¤æ¨¡å¼, é€šè¿‡ä¸ºè¯·æ±‚æŠ¥æ–‡é‡æ–°å°è£…ä¸€ä¸ªMACé¦–éƒ¨è¿›è¡Œè½¬å‘ï¼ŒæºMACæ˜¯DIPæ‰€åœ¨çš„æ¥å£çš„MACï¼Œç›®æ ‡MACæ˜¯æŸæŒ‘é€‰å‡ºçš„RSçš„RIPæ‰€åœ¨æ¥å£çš„MACåœ°å€ï¼›æºIP/PORTï¼Œä»¥åŠç›®æ ‡IP/PORTå‡ä¿æŒä¸å˜ lvs-tunï¼šä¸ä¿®æ”¹è¯·æ±‚æŠ¥æ–‡çš„IPé¦–éƒ¨, åœ¨åŸè¯·æ±‚IPæŠ¥æ–‡ä¹‹å¤–å°è£…ä¸€ä¸ªIPé¦–éƒ¨, å°†æŠ¥æ–‡å‘å¾€æŒ‘é€‰å‡ºçš„ç›®æ ‡RS,RSç›´æ¥å“åº”ç»™å®¢æˆ·ç«¯ lvs-fullnatï¼šé€šè¿‡åŒæ—¶ä¿®æ”¹è¯·æ±‚æŠ¥æ–‡çš„æºIPåœ°å€å’Œç›®æ ‡IPåœ°å€è¿›è¡Œè½¬å‘,æ­¤ç±»å‹kernelé»˜è®¤ä¸æ”¯æŒ ipvsadmä¸ipvsï¼š\nipvsadmæ˜¯ç”¨æˆ·ç©ºé—´çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œè§„åˆ™ç®¡ç†å™¨ï¼Œå®ç°ç”¨æˆ·ç®¡ç†é›†ç¾¤æœåŠ¡åŠRealServer ç®¡ç†é›†ç¾¤æœåŠ¡ï¼šå¢ã€æ”¹ã€åˆ  å¢ã€æ”¹ï¼š\nipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]","title":"LVS NAT è´Ÿè½½å‡è¡¡çš„å®ç°"},{"content":"CAåŠè¯ä¹¦ # éå¯¹ç§°åŠ å¯†æ˜¯ä¸ºäº†ä¿è¯äº’è”ç½‘ä¸­é€šè®¯ä¿¡æ¯å®‰å…¨ä½¿ç”¨çš„ä¸€ç§ç®—æ³•ï¼Œå¯†é’¥æ˜¯æˆå¯¹å‡ºç°(å…¬é’¥å’Œç§é’¥ï¼‰ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å‘é€æ–¹Aä½¿ç”¨æ¥æ”¶æ–¹Bçš„å…¬é’¥åŠ å¯†æ•°æ®ï¼Œæ‰€æœ‰åªæœ‰Bæ‹¥æœ‰ä¸ä¹‹é…å¯¹çš„ç§é’¥è§£å¯†è¯¥æ•°æ®ï¼Œåä¹‹äº¦ç„¶ã€‚é‚£ä¹ˆï¼ŒAå’ŒBä¹‹é—´æ€ä¹ˆäº¤æ¢å¾—åˆ°å¯¹æ–¹çš„çœŸå®å®‰å…¨çš„å…¬é’¥å‘¢ï¼Ÿæ­¤æ—¶å°±éœ€è¦ä¸€ä¸ªæƒå¨çš„æœºæ„æ¥éªŒè¯å…¬é’¥çš„åˆæ³•æ€§ï¼Œè¿™ä¸ªæœºæ„ç§°ä¹‹ä¸ºCA(Certification Authority)ã€‚CAä¸ºæ¯ä¸ªä½¿ç”¨å…¬å¼€å¯†é’¥çš„å®¢æˆ·å‘æ”¾æ•°å­—è¯ä¹¦ï¼Œæ•°å­—è¯ä¹¦çš„ä½œç”¨æ˜¯è¯æ˜è¯ä¹¦ä¸­åˆ—å‡ºçš„å®¢æˆ·åˆæ³•æ‹¥æœ‰è¯ä¹¦ä¸­åˆ—å‡ºçš„å…¬å¼€å¯†é’¥ã€‚\nè·å–è¯ä¹¦ä¸¤ç§æ–¹æ³• # ä½¿ç”¨è¯ä¹¦æˆæƒæœºæ„ï¼š # ç”Ÿæˆç­¾åè¯·æ±‚(csr) â€“\u0026gt;å°†csrå‘é€ç»™CA â€“\u0026gt; ä»CAå¤„æ¥æ”¶ç­¾å ã€‚å‚è€ƒä¸‹å›¾ï¼š CAè¯ä¹¦é¢å‘è¿‡ç¨‹(å‡è®¾åªæœ‰ä¸€çº§CA) å¾ˆå¤šæƒå¨çš„æ ¹CAä¼šè¢«å†…ç½®åˆ°æ“ä½œç³»ç»Ÿé‡Œé¢ï¼Œç”¨æˆ·å®‰è£…ç³»ç»Ÿä¹‹åä¹Ÿå°±ä¼šæ‹¥æœ‰æ ¹CAçš„å…¬é’¥ï¼Œæ‰€ä»¥å¯ä»¥è·å¾—ä¸Šçº§CAçš„å…¬é’¥ï¼Œè¿›è€Œå¯ä»¥ç”³è¯·è¯ä¹¦ã€‚å‚è€ƒä¸‹å›¾ï¼šä¸»æœºé€šè¿‡RootCAè·å¾—ä¸Šçº§CAçš„å…¬é’¥\nè‡ªç­¾åçš„è¯ä¹¦ # OpenSSLæ˜¯ä¸€ä¸ªå…è´¹å¼€æºçš„åº“ï¼Œå®ƒæä¾›äº†æ„å»ºæ•°å­—è¯ä¹¦çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå…¶ä¸­ä¸€äº›å¯ä»¥ç”¨æ¥è‡ªå»ºRootCAå¹¶ç­¾å‘è‡ªå·±çš„å…¬é’¥\n1.åˆ›å»ºç§æœ‰CA # åˆ›å»ºä¹‹å‰è¦äº†è§£ä¸€ä¸‹opensslçš„é…ç½®æ–‡ä»¶ï¼š /etc/pki/tls/openssl.cnf\n[ ca ] default_ca = CA_default # The default ca section \u0026lt;--å¯ç”¨çš„CAåå­— [ CA_default ] dir = /etc/pki/CA # Where everything is kept \u0026lt;--ç›¸å…³æ–‡ä»¶å­˜æ”¾ç›®å½• certs = $dir/certs # Where the issued certs are kept \u0026lt;--å­˜æ¡£é¢å‘è¯ä¹¦æ–‡ä»¶ crl_dir = $dir/crl # Where the issued crl are kept \u0026lt;--åŠé”€è¯ä¹¦åˆ—è¡¨ database = $dir/index.txt # database index file. \u0026lt;--è¯ä¹¦ç´¢å¼•æ•°æ®åº“ #unique_subject = no # Set to \u0026#39;no\u0026#39; to allow creation of \u0026lt;--æ˜¯å¦å…è®¸åˆ›å»ºå…·æœ‰ç›¸åŒä¸»é¢˜çš„å¤šä¸ªè¯ä¹¦ # several certificates with same subject. new_certs_dir = $dir/newcerts # default place for new certs. certificate = $dir/cacert.pem # The CA certificate \u0026lt;--è‡ªç­¾åçš„è¯ä¹¦ serial = $dir/serial # The current serial number \u0026lt;--å½“å‰å¯ç”¨çš„åºåˆ—å·(ä¸‹ä¸€ä¸ªè¦é¢å‘è¯ä¹¦çš„åºåˆ—å·) crlnumber = $dir/crlnumber # the current crl number \u0026lt;--åŠé”€è¯ä¹¦ç¼–å· # must be commented out to leave a V1 CRL crl = $dir/crl.pem # The current CRL private_key = $dir/private/cakey.pem# The private key \u0026lt;--CAçš„ç§é’¥æ–‡ä»¶ RANDFILE = $dir/private/.rand # private random number file default_days = 365 # how long to certify for \u0026lt;--è¯ä¹¦æœ‰æ•ˆæœŸ default_crl_days= 30 # how long before next CRL \u0026lt;--å‘å¸ƒåŠé”€è¯ä¹¦åˆ—è¡¨å‘¨æœŸ default_md = sha256 # use SHA-256 by default \u0026lt;--ç®—æ³• policy = policy_match \u0026lt;--ä½¿ç”¨å“ªä¸ªç­–ç•¥ # For the CA policy [ policy_match ] countryName = match \u0026lt;--CAä¸å®¢æˆ·ç«¯çš„ç”³è¯·ä¿¡æ¯å¿…é¡»ä¸€è‡´ stateOrProvinceName = match organizationName = match organizationalUnitName = optional \u0026lt;--å¯å¡«å¯ä¸å¡« commonName = supplied \u0026lt;--å¿…é¡»å¡« emailAddress = optional # For the \u0026#39;anything\u0026#39; policy # At this point in time, you must list all acceptable \u0026#39;object\u0026#39; # types. [ policy_anything ] countryName = optional stateOrProvinceName = optional localityName = optional organizationName = optional organizationalUnitName = optional commonName = supplied emailAddress = optional a.åœ¨CentOS7ä¸Šåˆ›å»ºCAçš„ç§é’¥ # [root@centos7 ~]#(umask 066;openssl genrsa -out /etc/pki/CA/private/cakey.pem 2048) \u0026lt;--ç§é’¥æ–‡ä»¶åªå¯¹å±ä¸»æœ‰æƒé™ Generating RSA private key, 2048 bit long modulus ...+++ .............+++ e is 65537 (0x10001) [root@centos7 ~]#tree /etc/pki/CA /etc/pki/CA â”œâ”€â”€ certs â”œâ”€â”€ crl â”œâ”€â”€ newcerts â””â”€â”€ private â””â”€â”€ cakey.pem 4 directories, 1 file b.ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ # [root@centos7 ~]#openssl req -new -x509 \\ \u0026lt;-- -x509 ä¸“ç”¨äºCAç”Ÿæˆè‡ªç­¾è¯ä¹¦ \u0026gt; -key /etc/pki/CA/private/cakey.pem \\ \u0026lt;-- ç”Ÿæˆè¯·æ±‚æ—¶ç”¨åˆ°çš„ç§é’¥æ–‡ä»¶ \u0026gt; -out /etc/pki/CA/cacert.pem \\ \u0026lt;-- è¯ä¹¦çš„ä¿å­˜è·¯å¾„ \u0026gt; -days 365 \u0026lt;-- è¯ä¹¦çš„æœ‰æ•ˆæœŸé™ You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter \u0026#39;.\u0026#39;, the field will be left blank. ----- Country Name (2 letter code) [XX]:CN State or Province Name (full name) []:BeiJing Locality Name (eg, city) [Default City]:BeiJing Organization Name (eg, company) [Default Company Ltd]:ffu Organizational Unit Name (eg, section) []:IT Common Name (eg, your name or your server\u0026#39;s hostname) []:ca.ffu.com Email Address []:ffu@outlook.com c.æŸ¥çœ‹è‡ªç­¾åè¯ä¹¦ä¿¡æ¯ # [root@centos7 ~]#openssl x509 -in /etc/pki/CA/cacert.pem -noout -text Certificate: Data: Version: 3 (0x2) Serial Number: 14141409927417363425 (0xc440616792e4fbe1) Signature Algorithm: sha256WithRSAEncryption Issuer: C=CN, ST=BeiJing, L=BeiJing, O=ffu, OU=IT, CN=ca.ffu.com/emailAddress=ffu@outlook.com Validity Not Before: Jul 16 08:57:27 2017 GMT Not After : Jul 16 08:57:27 2018 GMT Subject: C=CN, ST=BeiJing, L=BeiJing, O=ffu, OU=IT, CN=ca.ffu.com/emailAddress=ffu@outlook.com Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (2048 bit) ....åé¢çœç•¥.... d.åˆ›å»ºæ‰€éœ€æ•°æ®åº“æ–‡ä»¶ # [root@centos7 CA]#touch /etc/pki/CA/index.txt \u0026lt;--ç”Ÿæˆè¯ä¹¦ç´¢å¼•æ•°æ®åº“æ–‡ä»¶ [root@centos7 CA]#echo 01 \u0026gt; /etc/pki/CA/serial \u0026lt;--æŒ‡å®šç¬¬ä¸€ä¸ªé¢å‘è¯ä¹¦çš„åºåˆ—å·;åå…­è¿›åˆ¶ï¼Œå¿…é¡»æ˜¯ä¸¤ä½æ•° 2.é¢å‘è¯ä¹¦ # a.ç”ŸæˆCentOS6ä¸»æœºçš„ç§é’¥ # [root@centos6 ~]#(umask 066;openssl genrsa -out /app/service.key 2048) Generating RSA private key, 2048 bit long modulus .............+++ .................................+++ e is 65537 (0x10001) b.ç”Ÿæˆè¯ä¹¦ç”³è¯·æ–‡ä»¶ # [root@centos6 app]#openssl req -new -key /app/service.key -out /app/service.csr You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter \u0026#39;.\u0026#39;, the field will be left blank. ----- Country Name (2 letter code) [XX]:CN \u0026lt;--æŒ‰ç…§æ‰€é€‰policyï¼Œå¿…é¡»å’Œç”³è¯·CAçš„ä¿¡æ¯ä¸€è‡´ State or Province Name (full name) []:BeiJing \u0026lt;--æŒ‰ç…§æ‰€é€‰policyï¼Œå¿…é¡»å’Œç”³è¯·CAçš„ä¿¡æ¯ä¸€è‡´ Locality Name (eg, city) [Default City]:Zhengzhou Organization Name (eg, company) [Default Company Ltd]:ffu \u0026lt;--æŒ‰ç…§æ‰€é€‰policyï¼Œå¿…é¡»å’Œç”³è¯·CAçš„ä¿¡æ¯ä¸€è‡´ Organizational Unit Name (eg, section) []:cs Common Name (eg, your name or your server\u0026#39;s hostname) []:*.ffu.com Email Address []: Please enter the following \u0026#39;extra\u0026#39; attributes to be sent with your certificate request A challenge password []: An optional company name []: c.å°†è¯ä¹¦è¯·æ±‚æ–‡ä»¶ä¼ è¾“ç»™CA # [root@centos6 app]#scp service.csr 192.168.196.166:/etc/pki/CA/ d.CAç­¾ç½²è¯ä¹¦ï¼Œå¹¶å°†è¯ä¹¦é¢å‘ç»™è¯·æ±‚è€… # [root@centos7 CA]#openssl ca -in /etc/pki/CA/service.csr -out /etc/pki/CA/certs/service.crt -days 100 Using configuration from /etc/pki/tls/openssl.cnf Check that the request matches the signature Signature ok Certificate Details: Serial Number: 1 (0x1) Validity Not Before: Jul 16 09:44:51 2017 GMT Not After : Oct 24 09:44:51 2017 GMT Subject: countryName = CN stateOrProvinceName = BeiJing organizationName = ffu organizationalUnitName = cs commonName = *.ffu.com X509v3 extensions: X509v3 Basic Constraints: CA:FALSE Netscape Comment: OpenSSL Generated Certificate X509v3 Subject Key Identifier: 89:01:83:51:84:C8:1F:A9:1F:E7:F5:60:6E:6E:5D:5A:2B:59:5A:F2 X509v3 Authority Key Identifier: keyid:A9:5F:1B:D6:F6:7E:99:5D:2F:EE:7D:40:F7:DA:61:AE:29:EE:D1:6F Certificate is to be certified until Oct 24 09:44:51 2017 GMT (100 days) Sign the certificate? [y/n]:y 1 out of 1 certificate requests certified, commit? [y/n]y Write out database with 1 new entries Data Base Updated [root@centos7 CA]#ll certs/service.crt newcerts/01.pem -rw-r--r--. 1 root root 4456 Jul 16 17:45 certs/service.crt -rw-r--r--. 1 root root 4456 Jul 16 17:45 newcerts/01.pem \u0026lt;--è‡ªåŠ¨ç”Ÿæˆä»¥è¯ä¹¦åºåˆ—å·å‘½åçš„æ–‡ä»¶ï¼Œå†…å®¹ä¸è¯ä¹¦ä¸€è‡´ [root@centos7 CA]#cat index.txt serial V 171024094451Z 01 unknown /C=CN/ST=BeiJing/O=ffu/OU=cs/CN=ffu \u0026lt;--è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“ 02 \u0026lt;--è‡ªåŠ¨æ›´æ–°ä¸‹ä¸€ä¸ªé¢å‘è¯ä¹¦çš„åºåˆ—å· ç„¶åï¼ŒCAå°±å¯ä»¥æŠŠè¯ä¹¦å‘é€ç»™ä¸»æœºï¼Œä¸»æœºç›¸å…³WebæœåŠ¡å°±å¯ä»¥ä½¿ç”¨äº†\n3.å¦‚ä½•åŠé”€è¯ä¹¦ # a.åœ¨å®¢æˆ·ç«¯ä¸Šå…ˆæŸ¥çœ‹è¯ä¹¦serial # openssl x509 -in /etc/pki/CA/service.crt -noout -text\nb.åŠé”€è¯ä¹¦ # åœ¨CAä¸Šï¼Œæ ¹æ®å®¢æˆ·æäº¤çš„serialä¸subjectä¿¡æ¯ï¼Œå¯¹æ¯”æ£€éªŒæ˜¯å¦ä¸index.txtæ–‡ä»¶ä¸­çš„ä¿¡æ¯ä¸€è‡´ï¼ŒåŠé”€è¯ä¹¦\n[root@centos7 CA]#openssl ca -revoke /etc/pki/CA/newcerts/01.pem Using configuration from /etc/pki/tls/openssl.cnf Revoking Certificate 01. Data Base Updated [root@centos7 CA]#cat index.txt R 171024094451Z 170716112929Z 01 unknown /C=CN/ST=BeiJing/O=ffu/OU=cs/CN=ffu \u0026lt;--Rä»£è¡¨removed c.æŒ‡å®šç¬¬ä¸€ä¸ªåŠé”€è¯ä¹¦çš„ç¼–å· # [root@centos7 CA]#echo 01 \u0026gt; /etc/pki/CA/crlnumber \u0026lt;--ç¬¬ä¸€æ¬¡æ›´æ–°è¯ä¹¦åŠé”€åˆ—è¡¨å‰ï¼Œæ‰éœ€è¦æ‰§è¡Œ d.æ›´æ–°è¯ä¹¦åŠé”€åˆ—è¡¨ # [root@centos7 CA]#openssl ca -gencrl -out /etc/pki/CA/crl/crl.pem Using configuration from /etc/pki/tls/openssl.cnf [root@centos7 CA]#cat crlnumber 02 \u0026lt;--è‡ªåŠ¨æ›´æ–°ä¸‹ä¸€ä¸ªåŠé”€è¯ä¹¦çš„åºåˆ—å· [root@centos7 CA]#openssl crl -in /etc/pki/CA/crl/crl.pem -noout -text \u0026lt;--æŸ¥çœ‹åŠé”€è¯ä¹¦æ–‡ä»¶è¯¦æƒ… Certificate Revocation List (CRL): Version 2 (0x1) Signature Algorithm: sha256WithRSAEncryption Issuer: /C=CN/ST=BeiJing/L=BeiJing/O=ffu/OU=IT/CN=ffu/emailAddress=ffu@outloo.co Last Update: Jul 16 11:35:48 2017 GMT Next Update: Aug 15 11:35:48 2017 GMT CRL extensions: X509v3 CRL Number: 1 Revoked Certificates: Serial Number: 01 Revocation Date: Jul 16 11:29:29 2017 GMT Signature Algorithm: sha256WithRSAEncryption .....åé¢çœç•¥..... ","date":"20 April 2016","permalink":"/2016/04/openssl-ca/","section":"åšå®¢","summary":"CAåŠè¯ä¹¦ # éå¯¹ç§°åŠ å¯†æ˜¯ä¸ºäº†ä¿è¯äº’è”ç½‘ä¸­é€šè®¯ä¿¡æ¯å®‰å…¨ä½¿ç”¨çš„ä¸€ç§ç®—æ³•ï¼Œå¯†é’¥æ˜¯æˆå¯¹å‡ºç°(å…¬é’¥å’Œç§é’¥ï¼‰ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å‘é€æ–¹Aä½¿ç”¨æ¥æ”¶æ–¹Bçš„å…¬é’¥åŠ å¯†æ•°æ®ï¼Œæ‰€æœ‰åªæœ‰Bæ‹¥æœ‰ä¸ä¹‹é…å¯¹çš„ç§é’¥è§£å¯†è¯¥æ•°æ®ï¼Œåä¹‹äº¦ç„¶ã€‚é‚£ä¹ˆï¼ŒAå’ŒBä¹‹é—´æ€ä¹ˆäº¤æ¢å¾—åˆ°å¯¹æ–¹çš„çœŸå®å®‰å…¨çš„å…¬é’¥å‘¢ï¼Ÿæ­¤æ—¶å°±éœ€è¦ä¸€ä¸ªæƒå¨çš„æœºæ„æ¥éªŒè¯å…¬é’¥çš„åˆæ³•æ€§ï¼Œè¿™ä¸ªæœºæ„ç§°ä¹‹ä¸ºCA(Certification Authority)ã€‚CAä¸ºæ¯ä¸ªä½¿ç”¨å…¬å¼€å¯†é’¥çš„å®¢æˆ·å‘æ”¾æ•°å­—è¯ä¹¦ï¼Œæ•°å­—è¯ä¹¦çš„ä½œç”¨æ˜¯è¯æ˜è¯ä¹¦ä¸­åˆ—å‡ºçš„å®¢æˆ·åˆæ³•æ‹¥æœ‰è¯ä¹¦ä¸­åˆ—å‡ºçš„å…¬å¼€å¯†é’¥ã€‚\nè·å–è¯ä¹¦ä¸¤ç§æ–¹æ³• # ä½¿ç”¨è¯ä¹¦æˆæƒæœºæ„ï¼š # ç”Ÿæˆç­¾åè¯·æ±‚(csr) â€“\u0026gt;å°†csrå‘é€ç»™CA â€“\u0026gt; ä»CAå¤„æ¥æ”¶ç­¾å ã€‚å‚è€ƒä¸‹å›¾ï¼š CAè¯ä¹¦é¢å‘è¿‡ç¨‹(å‡è®¾åªæœ‰ä¸€çº§CA) å¾ˆå¤šæƒå¨çš„æ ¹CAä¼šè¢«å†…ç½®åˆ°æ“ä½œç³»ç»Ÿé‡Œé¢ï¼Œç”¨æˆ·å®‰è£…ç³»ç»Ÿä¹‹åä¹Ÿå°±ä¼šæ‹¥æœ‰æ ¹CAçš„å…¬é’¥ï¼Œæ‰€ä»¥å¯ä»¥è·å¾—ä¸Šçº§CAçš„å…¬é’¥ï¼Œè¿›è€Œå¯ä»¥ç”³è¯·è¯ä¹¦ã€‚å‚è€ƒä¸‹å›¾ï¼šä¸»æœºé€šè¿‡RootCAè·å¾—ä¸Šçº§CAçš„å…¬é’¥\nè‡ªç­¾åçš„è¯ä¹¦ # OpenSSLæ˜¯ä¸€ä¸ªå…è´¹å¼€æºçš„åº“ï¼Œå®ƒæä¾›äº†æ„å»ºæ•°å­—è¯ä¹¦çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå…¶ä¸­ä¸€äº›å¯ä»¥ç”¨æ¥è‡ªå»ºRootCAå¹¶ç­¾å‘è‡ªå·±çš„å…¬é’¥\n1.åˆ›å»ºç§æœ‰CA # åˆ›å»ºä¹‹å‰è¦äº†è§£ä¸€ä¸‹opensslçš„é…ç½®æ–‡ä»¶ï¼š /etc/pki/tls/openssl.cnf\n[ ca ] default_ca = CA_default # The default ca section \u0026lt;--å¯ç”¨çš„CAåå­— [ CA_default ] dir = /etc/pki/CA # Where everything is kept \u0026lt;--ç›¸å…³æ–‡ä»¶å­˜æ”¾ç›®å½• certs = $dir/certs # Where the issued certs are kept \u0026lt;--å­˜æ¡£é¢å‘è¯ä¹¦æ–‡ä»¶ crl_dir = $dir/crl # Where the issued crl are kept \u0026lt;--åŠé”€è¯ä¹¦åˆ—è¡¨ database = $dir/index.","title":"å¦‚ä½•ä½¿ç”¨opensslå·¥å…·åˆ›å»ºç§æœ‰CA"},{"content":"","date":"29 March 2016","permalink":"/tags/pxe/","section":"Tags","summary":"","title":"PXE"},{"content":"PXEä»‹ç» # PXEï¼š Preboot Excution Environmentï¼Œç”±Intelå…¬å¸ç ”å‘ï¼Œå¯ä»¥ä½¿æ²¡æœ‰ä»»ä½•æ“ä½œç³»ç»Ÿçš„ä¸»æœºèƒ½å¤ŸåŸºäºç½‘ç»œå®Œæˆç³»ç»Ÿçš„å®‰è£…å·¥ä½œï¼Œå®ç°æœåŠ¡å™¨çš„è‡ªåŠ¨åŒ–å®‰è£…ç³»ç»Ÿ\nPXEå·¥ä½œåŸç† # Clientå‘PXE Serverä¸Šçš„DHCPå‘é€IPåœ°å€è¯·æ±‚æ¶ˆæ¯ï¼ŒDHCPæ£€æµ‹Clientæ˜¯å¦åˆæ³•ï¼ˆä¸»è¦æ˜¯æ£€æµ‹Clientçš„ç½‘å¡MACåœ°å€ï¼‰ï¼Œå¦‚æœåˆæ³•åˆ™è¿”å›Clientçš„IPåœ°å€ï¼ŒåŒæ—¶å°†å¯åŠ¨æ–‡ä»¶pxelinux.0çš„ä½ç½®ä¿¡æ¯ä¸€å¹¶ä¼ é€ç»™Client Clientå‘PXE Serverä¸Šçš„TFTPå‘é€è·å–pxelinux.0è¯·æ±‚æ¶ˆæ¯ï¼Œ TFTPæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åå†å‘Clientå‘é€pxelinux.0å¤§å°ä¿¡æ¯ï¼Œè¯•æ¢Clientæ˜¯å¦æ»¡æ„ï¼Œå½“TFTPæ”¶åˆ°Clientå‘å›çš„åŒæ„å¤§å°ä¿¡æ¯ä¹‹åï¼Œæ­£å¼å‘Clientå‘é€pxelinux.0 Clientæ‰§è¡Œæ¥æ”¶åˆ°çš„pxelinux.0æ–‡ä»¶ Clientå‘TFTP Serverå‘é€é’ˆå¯¹æœ¬æœºçš„é…ç½®ä¿¡æ¯æ–‡ä»¶ï¼ˆåœ¨TFTP æœåŠ¡çš„pxelinux.cfgç›®å½•ä¸‹ï¼‰ï¼Œ TFTPå°†é…ç½®æ–‡ä»¶å‘å›Clientï¼Œç»§è€ŒClientæ ¹æ®é…ç½®æ–‡ä»¶æ‰§è¡Œåç»­æ“ä½œ Clientå‘TFTPå‘é€Linuxå†…æ ¸è¯·æ±‚ä¿¡æ¯ï¼Œ TFTPæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åå°†å†…æ ¸æ–‡ä»¶å‘é€ç»™Client Clientå‘TFTPå‘é€æ ¹æ–‡ä»¶è¯·æ±‚ä¿¡æ¯ï¼Œ TFTPæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åè¿”å›Linuxæ ¹æ–‡ä»¶ç³»ç»Ÿ Clientå¯åŠ¨Linuxå†…æ ¸ Clientä¸‹è½½å®‰è£…æºæ–‡ä»¶ï¼Œè¯»å–è‡ªåŠ¨åŒ–å®‰è£…è„šæœ¬ PXE Server çš„é…ç½® # 1. DHCPæœåŠ¡çš„é…ç½® # â€‹\tå®‰è£…åŒ…ï¼šdhcp-4.2.5-47.el7.centos.x86_64\n[root@centos7 ~]#cp /usr/share/doc/dhcp*/dhcpd.conf.example /etc/dhcp/dhcpd.conf --\u0026gt; ä½¿ç”¨æ¨¡æœ¬é…ç½®æ–‡ä»¶ [root@centos7 ~]#vi /etc/dhcp/dhcpd.conf subnet 192.168.196.0 netmask 255.255.255.0 { --\u0026gt; å®šä¹‰ç½‘æ®µ range 192.168.196.10 192.168.196.40; --\u0026gt; å®šä¹‰åˆ†é…IPèŒƒå›´ option routers 192.168.196.1; --\u0026gt; é…ç½®è·¯ç”± filename \u0026#34;pxelinux.0\u0026#34;; --\u0026gt; å¯åŠ¨æ–‡ä»¶åç§° next-server 192.168.196.188; --\u0026gt; dhcpæœåŠ¡å™¨åœ°å€ } [root@centos7 ~]#systemctl start dhcpd [root@centos7 ~]#systemctl enable dhcpd é…ç½®å®Œæˆï¼Œå¹¶è®¾ç½®DHCPé™æ€IP192.168.196.188ã€‚ç›®æ ‡ä¸»æœºå¼€æœºè·å–IPåï¼Œå¯ä»¥è®¿é—®PXE Sever\n2. tftpã€httpdæœåŠ¡çš„é…ç½® # â€‹\tå®‰è£…åŒ…ï¼štftp-5.2-13.el7.x86_64 httpd-2.4.6-45.el7.centos.x86_64\n[root@Centos7 ~]#yum -q -y tftp [root@Centos7 ~]#yum -q -y httpd [root@Centos7 ~]#systemctl start tftpd.socket httpd [root@Centos7 ~]#systemctl enable tftp.socket [root@Centos7 ~]#systemctl enable httpd æ³¨æ„ï¼šcentos6é‡Œtftpæ˜¯ç”±xinetdæœåŠ¡ä»£ç†çš„ï¼Œéœ€è¦å…ˆå®‰è£…xinetdæœåŠ¡ï¼Œå†chkconfig tftp on å‘½ä»¤å¼€å¯tftpæœåŠ¡\n3. å…³é—­SElinuxã€é˜²ç«å¢™ # [root@Centos7 ~]#setenforce 0 [root@Centos7 ~]#vi /etc/selinux/config --\u0026gt; ä¿®æ”¹é…ç½®æ–‡ä»¶ SELINUX=permissive [root@Centos7 ~]#systemctl stop firewalld [root@Centos7 ~]#systemctl disable firewalld 4.kickstartåº”ç­”æ–‡ä»¶å‡†å¤‡ # [root@centos7 ~]#mkdir /var/www/html/{centos7,ks} --\u0026gt; PXE Sever httpæœåŠ¡ä¼šæä¾›ç½‘ç»œæºäºksæ–‡ä»¶ [root@centos7 ~]#cp ~/anaconda-ks.cfg /var/www/html/ks/centos7-m.cfg --\u0026gt; ä»¥ç³»ç»Ÿå®‰è£…ksæ–‡ä»¶ä¸ºèŒƒæœ¬ [root@centos7 ks]#vi centos7-m.cfg #version=DEVEL # System authorization information auth --enableshadow --passalgo=sha512 url --url=http://192.168.196.188/centos7/ --\u0026gt; ç½‘ç»œæºç”±PXE Sever httpæœåŠ¡æä¾› text --\u0026gt; æ–‡æœ¬ç•Œé¢å®‰è£… # Run the Setup Agent on first boot firstboot --disable reboot --\u0026gt; å®‰è£…å®Œæˆåé‡å¯ ignoredisk --only-use=sda # Keyboard layouts keyboard --vckeymap=us --xlayouts=\u0026#39;us\u0026#39; # System language lang en_US.UTF-8 # Network information network --bootproto=dhcp --device=ens33 --onboot=on --ipv6=auto --activate --\u0026gt;ç½‘å¡é…ç½® network --hostname=centos7.ffu.com # Root password rootpw --iscrypted $6$8sIxlzOyC1RQ4g.X$UXgct3LHH67rVNH5StXAall/82K/5OkK6.QijHagr.DB4zw8IbnI0CYIUUAhTSDa.dfVfnZabRVZ8nFq5Cc1c1 # System services services --disabled=\u0026#34;chronyd\u0026#34; # System timezone timezone Asia/Shanghai --isUtc --nontp # System bootloader configuration bootloader --append=\u0026#34; crashkernel=auto\u0026#34; --location=mbr --boot-drive=sda # Partition clearing information clearpart --none --initlabel # Disk partitioning information part swap --fstype=\u0026#34;swap\u0026#34; --ondisk=sda --size=2048 part /app --fstype=\u0026#34;ext4\u0026#34; --ondisk=sda --size=50000 part / --fstype=\u0026#34;ext4\u0026#34; --ondisk=sda --size=100000 part /boot --fstype=\u0026#34;ext4\u0026#34; --ondisk=sda --size=1000 %packages --\u0026gt; å®‰è£…åŒ…é€‰æ‹© @^minimal @core %end --\u0026gt;å„ä¸ªæ¨¡å—è¦ä»¥%endç»“æŸ %addon com_redhat_kdump --enable --reserve-mb=\u0026#39;auto\u0026#39; %end %post --\u0026gt;å®‰è£…å®Œæˆåè¿è¡Œè‡ªå®šä¹‰è„šæœ¬ useradd ffu echo 123456|passwd --stdin ffu rm -rf /etc/yum.repos.d/* cat \u0026gt; /etc/yum.repos.d/base.repo \u0026lt;\u0026lt; EOF [base] name=base baseurl=https://mirrors.aliyun.com/centos/7/os/x86_64/ gpgcheck=0 EOF %end %anaconda pwpolicy root --minlen=6 --minquality=50 --notstrict --nochanges --notempty pwpolicy user --minlen=6 --minquality=50 --notstrict --nochanges --notempty pwpolicy luks --minlen=6 --minquality=50 --notstrict --nochanges --notempty %end [root@centos7 ks]#chmod a+r centos7-m.cfg --\u0026gt; ä¸ºotheråŠ è¯»æƒé™ï¼Œä»¥ä¾¿èƒ½é€šè¿‡httpè®¿é—® [root@centos7 ks]#ll -rw-r--r--. 1 root root 2042 Jul 24 15:00 centos7-m.cfg 5.å®‰è£…æºå‡†å¤‡ # [root@centos7 ks]# mount /dev/sr0 /var/www/html/centos7/ 6.å¯åŠ¨èœå•ã€å†…æ ¸ç­‰ç›¸å…³æ–‡ä»¶å‡†å¤‡ # a.ç›¸å…³æ–‡ä»¶å‡†å¤‡ # [root@centos7 tftpboot]#mkdir /var/lib/tftpboot/pxelinux.cfg [root@centos7 tftpboot]#cp /var/www/html/centos7/isolinux/isolinux.cfg pxelinux.cfg/default --\u0026gt;å¤åˆ¶å®‰è£…å…‰ç›˜å¯åŠ¨èœå•å¹¶é‡å‘½å [root@centos7 tftpboot]#cp /usr/share/syslinux/menu.c32 /usr/share/syslinux/pxelinux.0 ./ --\u0026gt;å¤åˆ¶syslinuxçš„èœå•åŠå¯åŠ¨æ–‡ä»¶ [root@centos7 tftpboot]#cp /var/www/html/centos7/isolinux/vmlinuz /var/www/html/centos7/isolinux/initrd.img ./ [root@centos7 tftpboot]#tree --\u0026gt;ç›®å½•ç»“æ„ . â”œâ”€â”€ initrd.img â”œâ”€â”€ menu.c32 â”œâ”€â”€ pxelinux.0 â”œâ”€â”€ pxelinux.cfg â”‚ â””â”€â”€ default â””â”€â”€ vmlinuz b.å¯åŠ¨èœå•å®šåˆ¶ # [root@centos7 tftpboot]#vi pxelinux.cfg/default default menu.c32 --\u0026gt;æ‰€ç”¨èœå•æ–‡ä»¶ timeout 600 menu title PXE CentOS Linux 7 Install Menu label linux-mini menu label ^Auto-install CentOS Linux 7 Mini kernel vmlinuz append initrd=initrd.img ks=http://192.168.196.188/ks/centos7-m.cfg --\u0026gt;ksæ–‡ä»¶ç”±PXE Sever httpæœåŠ¡æä¾› label linux-desktop menu label Test Auto-install CentOS Linux 7 ^Desktop kernel vmlinuz append initrd=initrd.img ks=http://192.168.196.188/ks/centos7.cfg --\u0026gt;å¯æ ¹æ®ä¸åŒç›®çš„å®šåˆ¶ä¸åŒåº”ç­”æ–‡ä»¶ label linux-manual menu label Test ^Manual-Install CentOS Linux 7 kernel vmlinuz append initrd=initrd.img label local menu label Boot from ^local drive menu default localboot 0xffff å®ç°ä¸»æœºè‡ªåŠ¨åŒ–å®‰è£…ç³»ç»Ÿ # å¯ä»¥ä½¿ç”¨VMwareè¿›è¡Œå®éªŒï¼Œæ ¹æ®ä»¥ä¸Šæ­¥éª¤é…ç½®PXE Server,ç„¶åæ–°å»ºè™šæ‹Ÿæœºï¼Œå¼€æœºè¿›å…¥å¯åŠ¨èœå•ï¼Œé€‰æ‹©æœ€å°åŒ–å®‰è£…ï¼Œå®‰è£…å®Œæˆæ˜¾ç¤ºç™»å½•ç•Œé¢ã€‚\næ³¨æ„éœ€è¦æŠŠæœ¬åœ°DHCPè·å–IPæœåŠ¡å…³é—­\n","date":"29 March 2016","permalink":"/2016/03/pxe/","section":"åšå®¢","summary":"PXEä»‹ç» # PXEï¼š Preboot Excution Environmentï¼Œç”±Intelå…¬å¸ç ”å‘ï¼Œå¯ä»¥ä½¿æ²¡æœ‰ä»»ä½•æ“ä½œç³»ç»Ÿçš„ä¸»æœºèƒ½å¤ŸåŸºäºç½‘ç»œå®Œæˆç³»ç»Ÿçš„å®‰è£…å·¥ä½œï¼Œå®ç°æœåŠ¡å™¨çš„è‡ªåŠ¨åŒ–å®‰è£…ç³»ç»Ÿ\nPXEå·¥ä½œåŸç† # Clientå‘PXE Serverä¸Šçš„DHCPå‘é€IPåœ°å€è¯·æ±‚æ¶ˆæ¯ï¼ŒDHCPæ£€æµ‹Clientæ˜¯å¦åˆæ³•ï¼ˆä¸»è¦æ˜¯æ£€æµ‹Clientçš„ç½‘å¡MACåœ°å€ï¼‰ï¼Œå¦‚æœåˆæ³•åˆ™è¿”å›Clientçš„IPåœ°å€ï¼ŒåŒæ—¶å°†å¯åŠ¨æ–‡ä»¶pxelinux.0çš„ä½ç½®ä¿¡æ¯ä¸€å¹¶ä¼ é€ç»™Client Clientå‘PXE Serverä¸Šçš„TFTPå‘é€è·å–pxelinux.0è¯·æ±‚æ¶ˆæ¯ï¼Œ TFTPæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åå†å‘Clientå‘é€pxelinux.0å¤§å°ä¿¡æ¯ï¼Œè¯•æ¢Clientæ˜¯å¦æ»¡æ„ï¼Œå½“TFTPæ”¶åˆ°Clientå‘å›çš„åŒæ„å¤§å°ä¿¡æ¯ä¹‹åï¼Œæ­£å¼å‘Clientå‘é€pxelinux.0 Clientæ‰§è¡Œæ¥æ”¶åˆ°çš„pxelinux.0æ–‡ä»¶ Clientå‘TFTP Serverå‘é€é’ˆå¯¹æœ¬æœºçš„é…ç½®ä¿¡æ¯æ–‡ä»¶ï¼ˆåœ¨TFTP æœåŠ¡çš„pxelinux.cfgç›®å½•ä¸‹ï¼‰ï¼Œ TFTPå°†é…ç½®æ–‡ä»¶å‘å›Clientï¼Œç»§è€ŒClientæ ¹æ®é…ç½®æ–‡ä»¶æ‰§è¡Œåç»­æ“ä½œ Clientå‘TFTPå‘é€Linuxå†…æ ¸è¯·æ±‚ä¿¡æ¯ï¼Œ TFTPæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åå°†å†…æ ¸æ–‡ä»¶å‘é€ç»™Client Clientå‘TFTPå‘é€æ ¹æ–‡ä»¶è¯·æ±‚ä¿¡æ¯ï¼Œ TFTPæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åè¿”å›Linuxæ ¹æ–‡ä»¶ç³»ç»Ÿ Clientå¯åŠ¨Linuxå†…æ ¸ Clientä¸‹è½½å®‰è£…æºæ–‡ä»¶ï¼Œè¯»å–è‡ªåŠ¨åŒ–å®‰è£…è„šæœ¬ PXE Server çš„é…ç½® # 1. DHCPæœåŠ¡çš„é…ç½® # â€‹\tå®‰è£…åŒ…ï¼šdhcp-4.","title":"PXEè‡ªåŠ¨åŒ–å®‰è£…CentOS7"},{"content":"","date":"2 March 2016","permalink":"/tags/yum/","section":"Tags","summary":"","title":"yum"},{"content":"ä»€ä¹ˆæ˜¯yum # æˆ‘ä»¬åœ¨Linuxç³»ç»Ÿä¸Šå®‰è£…å¤„ç†è½¯ä»¶ï¼Œä¸€èˆ¬æ˜¯ä½¿ç”¨RPMï¼Œå®ƒæ˜¯é€šè¿‡é¢„å…ˆç¼–è¯‘å®Œæˆå¹¶ä¸”æŠŠè½¯ä»¶æ‰“åŒ…ä¸ºRPMæ–‡ä»¶æ ¼å¼åï¼Œå†åŠ ä»¥å®‰è£…çš„ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨è€…åªè¦æ‹¿åˆ°è¿™ä¸ªæ‰“åŒ…å¥½çš„è½¯ä»¶ï¼Œç„¶åå°†é‡Œå¤´çš„æ–‡ä»¶æ”¾ç½®åˆ°åº”è¯¥æ‘†æ”¾çš„ç›®å½•ï¼Œè¿™æ ·å°±å®Œæˆäº†å®‰è£…ã€‚ä½†æ˜¯ï¼Œç”±äºæœ‰äº›è½¯ä»¶æ˜¯æœ‰ä¾èµ–äºå…¶ä»–è½¯ä»¶çš„ï¼Œå½“ä½ è¦å®‰è£…æŸä¸ªRPMç±»å‹çš„è½¯ä»¶æ—¶ï¼ŒRPMä¼šæ£€éªŒRPMè½¯ä»¶æ•°æ®åº“ï¼Œå®ƒæ‰€ä¾èµ–çš„ç›¸å…³è½¯ä»¶åŒ…æ˜¯å¦éƒ½å·²å­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰æ£€ç´¢åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªRPMæ–‡ä»¶é»˜è®¤å°±ä¸èƒ½å®‰è£…ã€‚ç”šè‡³æ˜¯æœ‰äº›åŒ…ä¹‹é—´è¿˜ä¼šå­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œè¿™æ—¶RPMå°±ä¸èƒ½å¿«é€Ÿæœ‰æ•ˆçš„è¿›è¡Œè½¯ä»¶å®‰è£…äº†ã€‚ å¯¹äºRPMçš„ä¸Šè¿°å±€é™æ€§ï¼Œyumçš„å‡ºç°å°±è§£å†³äº†åŒ…ä¹‹é—´çš„ä¾èµ–æ€§çš„é—®é¢˜ã€‚æ–‡ç« å‰é¢æåˆ°äº†ï¼ŒRPMæŠŠè½¯ä»¶ä¾èµ–å…³ç³»å‚¨å­˜åœ¨æœ¬åœ°æ•°æ®åº“é‡Œï¼Œé‚£æˆ‘ä»¬åœ¨å®‰è£…è½¯ä»¶çš„æ—¶å€™ï¼Œå¦‚æœå…ˆåˆ°æ•°æ®åº“é‡Œæ‰¾åˆ°æ‰€æœ‰ä¾èµ–åŒ…çš„åˆ—è¡¨ï¼Œå†æ£€ç´¢å“ªäº›å·²ç»å®‰è£…åˆ°æœ¬åœ°ï¼Œç„¶åæŠŠå‰©ä¸‹æ²¡å®‰è£…çš„ä¸€èµ·å®‰è£…ï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³åŒ…ä¾èµ–æ€§çš„é—®é¢˜äº†ï¼Œè¿™å°±æ˜¯yumæœºåˆ¶çš„ç”±æ¥\nyumçš„è¿ä½œæµç¨‹ # å„ç‰ˆæœ¬å‘è¡Œå•†éƒ½ä¼šé‡Šæ”¾å‡ºè½¯ä»¶å¹¶æ”¾ç½®äºyumæœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥yumæœåŠ¡å™¨å‚¨å­˜æœ‰æˆ‘ä»¬å„ç§æ‰€éœ€çš„è½¯ä»¶ã€‚å‚è€ƒä¸‹å›¾ï¼ŒyumæœåŠ¡å™¨ä¸ä»…å­˜å‚¨äº†å„ç§RPMåŒ…ï¼Œè¿˜æœ‰åŒ…çš„ç›¸å…³çš„å…ƒæ•°æ®æ–‡ä»¶ï¼ˆæ”¾ç½®äºç‰¹å®šç›®å½•repodataä¸‹ï¼‰ï¼Œå‰é¢æåˆ°çš„åŒ…çš„ä¾èµ–æ€§å…³ç³»å°±å‚¨å­˜åœ¨å…ƒæ•°æ®æ–‡ä»¶ä¸­ã€‚é€™äº›æ–‡ä»¶ä¸RPMè½¯ä»¶åŒ…æ‰€åœ¨çš„æœ¬åœ°æˆ–ç½‘ç»œä½ç½®å°±è¢«ç§°ä¸ºyumä»“åº“(yum repo)ã€‚å½“ç”¨æˆ·ç«¯æœ‰è½¯ä»¶å®‰è£…æˆ–å‡çº§çš„éœ€æ±‚æ—¶ï¼Œç”¨æˆ·ç«¯ä¼šè®¿é—®yumæœåŠ¡å™¨ä¸‹è½½æˆ–æ›´æ–°RPMè½¯ä»¶åˆ—è¡¨å¹¶å­˜åœ¨æœ¬æœºç¼“å­˜åˆ—è¡¨ä¸­ï¼Œç„¶åé€šè¿‡ç¼“å­˜åˆ—è¡¨ä¸æœ¬åœ°RPMæ•°æ®åº“ç›¸æ¯”å¯¹ï¼Œç­›é€‰å‡ºç¼ºå°‘å“ªäº›RPMè½¯ä»¶åŒ…å¹¶æ ¹æ®yumä»“åº“å‚¨å­˜çš„è·¯å¾„ä¸‹è½½ï¼ˆå¯ä»¥æ˜¯æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œï¼‰ï¼Œæœ€åé€šè¿‡RPMæœºåˆ¶ä¸€å¹¶è¿›è¡Œå®‰è£…ã€‚ å¦‚ä½•é…ç½®yumå®¢æˆ·ç«¯ # yumæœ¬èº«çš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æŒ‡å‘ä»“åº“çš„ä½ç½®ä»¥åŠç›¸å…³çš„å„ç§é…ç½®ä¿¡æ¯ã€‚\nä¸»é…ç½®æ–‡ä»¶ # /etc/yum.confï¼šä¸ºæ‰€æœ‰ä»“åº“æä¾›å…¬å…±é…ç½®\nå„ä»“åº“æŒ‡å‘çš„å®šä¹‰ # /etc/yum.repos.d/*.repoï¼šä¸ºä»“åº“çš„æŒ‡å‘æä¾›é…ç½®\n* [repositoryID] #ä»“åº“çš„åå­—ï¼Œå…·æœ‰å”¯ä¸€æ€§ï¼Œæ ‡è¯†repoçš„æŒ‡å‘ * name=Some name for this repository #ä»“åº“æè¿°ä¿¡æ¯ * baseurl=url://path/to/repository/ #æŒ‡æ˜repoçš„è®¿é—®è·¯å¾„ï¼Œé€šå¸¸ä¸ºä¸€ä¸ªæ–‡ä»¶æœåŠ¡å™¨ä¸Šè¾“å‡ºçš„æŸrepo #æ–‡ä»¶æœåŠ¡å™¨ç±»å‹ http://SEVER/PATH/TO/REPOSITORY https://SEVER/PATH/TO/REPOSITORY ftp://SEVER/PATH/TO/REPOSITORY file:///PATH/TO/REPOSITORY * enabled={1|0} #æ­¤ä»“åº“æ˜¯å¦å¯è¢«ä½¿ç”¨ * gpgcheck={1|0} #æ˜¯å¦å¯¹RPMåŒ…åšæ£€éªŒ * gpgkey=url://path/to/keyfile/ #æŒ‡æ˜gpgkeyæ–‡ä»¶è·¯å¾„ * enablegroups={1|0} #æ˜¯å¦å¯ç”¨åŒ…ç»„ * failovermethod={roundrobin|priority} #è®¾ç½®baseurlæœ‰å¤šä¸ªæ—¶çš„ä¼˜å…ˆçº§ roundrobinï¼šéšæœºæŒ‘é€‰ï¼Œé»˜è®¤å€¼ priority:æŒ‰é¡ºåºè®¿é—® * cost= #æŒ‡æ˜ä»“åº“çš„è®¿é—®å¼€é”€ï¼Œé»˜è®¤ä¸º1000 åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶ # æŒ‰ç…§ä»¥ä¸Šæ–¹å¼ï¼Œæˆ‘ä»¬å°±åœ¨/etc/yum.repos.d/ç›®å½•ä¸‹åˆ›å»ºnewbase.repoçš„é…ç½®æ–‡ä»¶ï¼ˆè¿™é‡Œè¦æ³¨æ„ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶åªè¦æœ‰ä¸€ä¸ªæœ‰é—®é¢˜å°±ä¼šå½±å“yumçš„ä½¿ç”¨ï¼‰\n[root@centos7 ~]#vi /etc/yum.repos.d/newbase.repo [NewBase] name=NewBase baseurl=https://mirrors.aliyun.com/centos/7/os/x86_64/ #ä½¿ç”¨é˜¿é‡Œäº‘CentOSç³»ç»Ÿyumæº file:///misc/cd/ #ä½¿ç”¨æœ¬åœ°å…‰ç›˜ä½œä¸ºyumæº enable=1 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 #ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ–‡ä»¶æœåŠ¡å™¨ä¸Šçš„ï¼Œhttps://mirrors.aliyun.com/centos/7/os/x86_64/RPM-GPG-KEY-CentOS-7 failovermethod={priority} #æŒ‰é¡ºåºè®¿é—®baseurlè·¯å¾„ å¯¹äºCentOSæ¥è¯´ï¼Œä¹Ÿæ”¯æŒç”±FedoraåŸºé‡‘ä¼šå‘å±•çš„å¤–åŠ è½¯ä»¶è®¡åˆ’(Extra Packages for Enterprise Linux, EPEL)ï¼ŒåŒ…å«äº†å¾ˆå¤šç¬¬ä¸‰æ–¹è½¯ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘çš„Epelçš„yumæºï¼šhttps://mirrors.aliyun.com/epel/7/x86_64ï¼Œåªéœ€åœ¨newbase.repoé…ç½®æ–‡ä»¶ä¸­åˆ›å»ºå¦ä¸€ä¸ªyumä»“åº“ï¼š\n[NewEpel] name=NewEpel baseurl=https://mirrors.aliyun.com/epel/7/x86_64/ enabled=1 gpgcheck=1 gpgkey=file:///etc/pki/rpm-gpg/rpm-gpg-key-epel-7 yumä»“åº“çš„æµ‹è¯• # yum repolist: åˆ—å‡ºå·²ç»é…ç½®çš„æ‰€æœ‰yumä»“åº“\nç”¨æ³•ï¼šyum repolist [all|enabled|disabled]\n[root@centos7 ~]#yum repolist all Loaded plugins: fastestmirror, langpacks Loading mirror speeds from cached hostfile * NewBase: repo id repo name status !Centos7 Centos7 disabled NewBase NewBase enabled: 9,363 NewEpel NewEpel enabled: 11,787 !epel7 epel7 disabled repolist: 21,150 # NewBaseå’ŒNewEpelä¸¤ä¸ªyumä»“åº“çš„statuséƒ½ä¸ºenabledï¼Œè¯´æ˜å·²ç»æˆåŠŸæ¿€æ´» yumå‘½ä»¤çš„ç”¨æ³• # yum [options][command] [package â€¦] Command:\næ˜¾ç¤ºæœåŠ¡å™¨æä¾›çš„ç¨‹åºåŒ…ï¼š # yum list\nyum list [all | glob_exp1][glob_exp2] [â€¦] #é»˜è®¤ä¸ºall,æ˜¾ç¤ºå…¨éƒ¨RPMåŒ…ï¼Œä¹Ÿæ”¯æŒglobé€šé…ç¬¦\nyum list {available|installed|updates} [glob_exp1][â€¦]\n[root@centos7 ~]#yum list|less Installed Packages #å·²å®‰è£…è½¯ä»¶ GConf2.x86_64 3.2.6-8.el7 @anaconda #éšå®‰è£…å‘å¯¼å®‰è£…çš„ apr.x86_64 1.4.8-3.el7 @Centos7 #é€šè¿‡Centos7yumä»“åº“å®‰è£… .....ä¸­é—´çœç•¥....... Available Packages #è¿˜å¯ä»¥å®‰è£…çš„è½¯ä»¶ 0ad.x86_64 0.0.21-1.el7 NewEpel #ä½ç½® 389-ds-base.x86_64 1.3.5.10-11.el7 NewBase #ä½ç½® .....(åº•ä¸‹çœç•¥)..... yum list updates ç›®å‰æœåŠ¡å™¨ä¸Šå¯ä¾›æœ¬æœºè¿›è¡Œå‡çº§çš„è½¯ä»¶æœ‰å“ªäº›ï¼Œä¸yum check-update ç±»ä¼¼\nå®‰è£…ç¨‹åºåŒ… # yum install package1 [package2][â€¦] (åŒ…å) â€‹\tå¦‚æœä¸€ä¸ªåŒ…åœ¨ä¸åŒä»“åº“ä¸­æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œé»˜è®¤ä¼šå®‰è£…æœ€æ–°ç‰ˆæœ¬ â€‹\tå¦‚æœè¦å®‰è£…åˆ¶å®šç‰ˆæœ¬ï¼šinstall PACKAGE-VERSIONâ€¦ yum reinstall package1 [package2][â€¦] (é‡æ–°å®‰è£…)\nå‡çº§ç¨‹åºåŒ… # yum update [package1][package2] [â€¦]\nyum downgrade package1 [package2][â€¦] (é™çº§)\nå¸è½½ç¨‹åºåŒ… # yum remove | erase package1 [package2][â€¦]\næ­¤å‘½ä»¤é»˜è®¤æ˜¯ä¸ä¼šå¸è½½æ‰€ä¾èµ–çš„åŒ…,ä½†æ˜¯ä¾èµ–äºæ­£å¸è½½çš„ç¨‹åºåŒ…çš„ç¨‹åºåŒ…ä¼šè¢«ä¸€å¹¶å¸è½½\næŸ¥çœ‹ç¨‹åºåŒ…information # yum info [â€¦]\næŸ¥çœ‹æŒ‡å®šçš„ç‰¹æ€§(å¯ä»¥æ˜¯æŸæ–‡ä»¶)æ˜¯ç”±å“ªä¸ªç¨‹åºåŒ…æ‰€æä¾› # yum provides | whatprovides feature1 [feature2][â€¦]\n[root@centos7 ~]#yum provides /usr/bin/bash Loaded plugins: fastestmirror, langpacks Loading mirror speeds from cached hostfile * NewBase: bash-4.2.46-20.el7_2.x86_64 : The GNU Bourne Again shell Repo : NewBase Matched from: Filename : /usr/bin/bash #bashçš„å¯æ‰§è¡Œç¨‹åºæ–‡ä»¶æ˜¯ç”±bash-4.2.46-20.el7_2.x86_64è¿™ä¸ªRPMåŒ…æä¾›çš„ ç¼“å­˜ç®¡ç† # æ¸…ç†æœ¬åœ°ç¼“å­˜ï¼š åœ¨yumè¿ä½œæµç¨‹ä¸­æˆ‘ä»¬æåˆ°äº†å®¢æˆ·ç«¯å­˜æœ‰ç¼“å­˜åˆ—è¡¨ï¼Œè¿™äº›æ–‡ä»¶é»˜è®¤æ˜¯å­˜åœ¨/var/cache/yum/ç›®å½•ä¸‹\n[root@centos7 ~]#ls /var/cache/yum/x86_64/7/ #æœ¬æœºyumçš„ç¼“å­˜ä½ç½® base Centos7 epel7 extras NewBase NewEpel timedhosts timedhosts.txt updates yum clean [ packages | metadata | expire-cache | rpmdb | plugins | all ]\n[root@centos7 ~]#yum clean all Loaded plugins: fastestmirror, langpacks Cleaning repos: NewBase NewEpel Cleaning up everything Cleaning up list of fastest mirrors æ„å»ºç¼“å­˜ï¼š yum makecache #è‡ªåŠ¨è¿æ¥è‡³æ¯ä¸€ä¸ªå¯ç”¨ä»“åº“ï¼Œä¸‹è½½æ•°æ®ï¼Œåˆ›å»ºä¸ºç¼“å­˜\n[root@centos7 ~]#yum makecache Loaded plugins: fastestmirror, langpacks NewBase | 3.6 kB 00:00:00 NewEpel | 4.3 kB 00:00:00 (1/4): NewBase/other_db | 2.4 MB 00:00:00 (2/4): NewBase/filelists_db | 6.6 MB 00:00:00 (3/4): NewEpel/other_db | 2.2 MB 00:00:02 (4/4): NewEpel/filelists_db | 8.0 MB 00:00:23 Loading mirror speeds from cached hostfile * NewBase: Metadata Cache Created æœç´¢ # yum search string1 [string2][â€¦] æœç´¢ä¸ä»¥æŒ‡å®šçš„å…³é”®å­—ç¨‹åºåŒ…åæœ‰å…³çš„è½¯ä»¶åˆ—è¡¨\næŸ¥çœ‹yumäº‹åŠ¡å†å² # yum history [info|list|packages- list|packages- info|summary|addon- info|redo|undo|rollback|new|sync|stats]\n#yum historyåˆ—å‡ºyumçš„è¯¦ç»†æ“ä½œå†å² [root@centos7 ~]#yum history Loaded plugins: fastestmirror, langpacks ID | Login user | Date and time | Action(s) | Altered ------------------------------------------------------------------------------- 6 | root \u0026lt;root\u0026gt; | 2017-06-11 19:39 | Install | 1 P\u0026lt; 5 | root \u0026lt;root\u0026gt; | 2017-06-11 18:10 | Install | 1 \u0026gt;\u0026lt; 4 | root \u0026lt;root\u0026gt; | 2017-06-11 17:40 | Install | 1 \u0026gt;\u0026lt; 3 | root \u0026lt;root\u0026gt; | 2017-06-10 09:28 | Install | 53 \u0026gt;\u0026lt; 2 | System \u0026lt;unset\u0026gt; | 2017-05-19 14:53 | Install | 1 \u0026gt; 1 | System \u0026lt;unset\u0026gt; | 2017-05-17 12:55 | Install | 1319 history list #yum history info 6 æŸ¥çœ‹ç¬¬6æ¡å†å²çš„è¯¦ç»†æ“ä½œï¼Œä»Conmand Lindå¯ä»¥çœ‹å‡ºæ˜¯å®‰è£…äº†treeè½¯ä»¶åŒ… [root@centos7 ~]#yum history info 6 Loaded plugins: fastestmirror, langpacks Transaction ID : 6 Begin time : Sun Jun 11 19:39:02 2017 Begin rpmdb : 1376:18487d64bcef03c85f0f14dca43701acce15328a End time : (0 seconds) End rpmdb : 1377:8e94811fa592da9c619827c4eb3a265af705bb45 User : root \u0026lt;root\u0026gt; Return-Code : Success Command Line : install tree Transaction performed with: Installed rpm-4.11.3-21.el7.x86_64 @anaconda Installed yum-3.4.3-150.el7.centos.noarch @anaconda Installed yum-plugin-fastestmirror-1.1.31-40.el7.noarch @anaconda Packages Altered: Install tree-1.6.0-10.el7.x86_64 @NewBase Rpmdb Problems: conflicts: ipa-client-4.4.0-12.el7.centos.x86_64 has installed conflicts freeipa-client: ipa-client-4.4.0-12.el7.centos.x86_64 Installed ipa-client-4.4.0-12.el7.centos.x86_64 @anaconda conflicts: ipa-client-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-client-common: : ipa-client-common-4.4.0-12.el7.centos.noarch Installed ipa-client-common-4.4.0-12.el7.centos.noarch @anaconda conflicts: ipa-common-4.4.0-12.el7.centos.noarch has installed conflicts freeipa-common: ipa-common-4.4.0-12.el7.centos.noarch Installed ipa-common-4.4.0-12.el7.centos.noarch @anaconda history info yum history undo 6 æ’¤æ¶ˆç¬¬6æ¡çš„æ“ä½œï¼Œå³å¸è½½treeåŒ… [root@centos7 ~]#yum history undo 6 Loaded plugins: fastestmirror, langpacks Undoing transaction 6, from Sun Jun 11 19:39:02 2017 Install tree-1.6.0-10.el7.x86_64 @NewBase Resolving Dependencies --\u0026gt; Running transaction check ---\u0026gt; Package tree.x86_64 0:1.6.0-10.el7 will be erased --\u0026gt; Finished Dependency Resolution Dependencies Resolved ==================================================================================================================================== Package Arch Version Repository Size ==================================================================================================================================== Removing: tree x86_64 1.6.0-10.el7 @NewBase 87 k Transaction Summary ==================================================================================================================================== Remove 1 Package Installed size: 87 k Is this ok [y/N]: y Downloading packages: Running transaction check Running transaction test Transaction test succeeded Running transaction Erasing : tree-1.6.0-10.el7.x86_64 1/1 Verifying : tree-1.6.0-10.el7.x86_64 1/1 Removed: tree.x86_64 0:1.6.0-10.el7 Complete! è¿™é‡Œè¦æ³¨æ„ï¼Œåœ¨ç¬¬å››ä¸ªå¸è½½å‘½ä»¤é‡Œæåˆ°äº†ï¼Œremoveå‘½ä»¤æ˜¯ä¸ä¼šæŠŠå…¶ä¾èµ–çš„åŒ…å¸è½½ï¼Œè€Œé€šè¿‡undo å‘½ä»¤æ˜¯å¯ä»¥å…¨éƒ¨å¸è½½çš„\nåŒ…ç»„ç®¡ç†çš„ç›¸å…³å‘½ä»¤ # yum grouplist\nåˆ—å‡ºæ‰€æœ‰å¯ä½¿ç”¨çš„è½¯ä»¶ç¾¤ç»„,ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å››ç±»ï¼š Installed environment groups: å·²ç»å®‰è£…çš„ç³»ç»Ÿç¯å¢ƒåŒ…ç»„ Available environment groups: è¿˜å¯ä»¥å®‰è£…çš„ç³»ç»Ÿç¯å¢ƒåŒ…ç»„ Installed groups: å·²ç»å®‰è£…çš„åŒ…ç»„ Available Groups: è¿˜èƒ½é¢å¤–å®‰è£…çš„åŒ…ç»„\nyum groupinstall group1 [group2][â€¦] å®‰è£…åŒ…ç»„\nyum groupupdate group1 [group2][â€¦]å‡çº§åŒ…ç»„\nyum groupremove group1 [group2][â€¦] å¸è½½åŒ…ç»„\nyum groupinfo group1 [â€¦]æ˜¾ç¤ºæŒ‡å®šåŒ…ç»„ä¿¡æ¯\nyumçš„å‘½ä»¤è¡Œé€‰é¡¹ # -y: è‡ªåŠ¨å›ç­”ä¸ºâ€œ yesâ€\n-q:é™é»˜æ¨¡å¼\n\u0026ndash;nogpgcheckï¼šç¦æ­¢è¿›è¡Œgpg check\n\u0026ndash;disablerepo=repoidglobï¼šä¸´æ—¶ç¦ç”¨æ­¤å¤„æŒ‡å®šçš„repo\n\u0026ndash;enablerepo=repoidglobï¼šä¸´æ—¶å¯ç”¨æ­¤å¤„æŒ‡å®šçš„repo\n\u0026ndash;nopluginsï¼šç¦ç”¨æ‰€æœ‰æ’ä»¶\nyumå‘½ä»¤çš„ç”¨æ³•å°±ç®€å•ä»‹ç»è¿™ä¹ˆå¤šï¼ŒåŒæ—¶å¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ å¯¹yumçš„ä½¿ç”¨æœ‰æ‰€å¸®åŠ©ã€‚\n","date":"2 March 2016","permalink":"/2016/03/yum/","section":"åšå®¢","summary":"ä»€ä¹ˆæ˜¯yum # æˆ‘ä»¬åœ¨Linuxç³»ç»Ÿä¸Šå®‰è£…å¤„ç†è½¯ä»¶ï¼Œä¸€èˆ¬æ˜¯ä½¿ç”¨RPMï¼Œå®ƒæ˜¯é€šè¿‡é¢„å…ˆç¼–è¯‘å®Œæˆå¹¶ä¸”æŠŠè½¯ä»¶æ‰“åŒ…ä¸ºRPMæ–‡ä»¶æ ¼å¼åï¼Œå†åŠ ä»¥å®‰è£…çš„ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨è€…åªè¦æ‹¿åˆ°è¿™ä¸ªæ‰“åŒ…å¥½çš„è½¯ä»¶ï¼Œç„¶åå°†é‡Œå¤´çš„æ–‡ä»¶æ”¾ç½®åˆ°åº”è¯¥æ‘†æ”¾çš„ç›®å½•ï¼Œè¿™æ ·å°±å®Œæˆäº†å®‰è£…ã€‚ä½†æ˜¯ï¼Œç”±äºæœ‰äº›è½¯ä»¶æ˜¯æœ‰ä¾èµ–äºå…¶ä»–è½¯ä»¶çš„ï¼Œå½“ä½ è¦å®‰è£…æŸä¸ªRPMç±»å‹çš„è½¯ä»¶æ—¶ï¼ŒRPMä¼šæ£€éªŒRPMè½¯ä»¶æ•°æ®åº“ï¼Œå®ƒæ‰€ä¾èµ–çš„ç›¸å…³è½¯ä»¶åŒ…æ˜¯å¦éƒ½å·²å­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰æ£€ç´¢åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªRPMæ–‡ä»¶é»˜è®¤å°±ä¸èƒ½å®‰è£…ã€‚ç”šè‡³æ˜¯æœ‰äº›åŒ…ä¹‹é—´è¿˜ä¼šå­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œè¿™æ—¶RPMå°±ä¸èƒ½å¿«é€Ÿæœ‰æ•ˆçš„è¿›è¡Œè½¯ä»¶å®‰è£…äº†ã€‚ å¯¹äºRPMçš„ä¸Šè¿°å±€é™æ€§ï¼Œyumçš„å‡ºç°å°±è§£å†³äº†åŒ…ä¹‹é—´çš„ä¾èµ–æ€§çš„é—®é¢˜ã€‚æ–‡ç« å‰é¢æåˆ°äº†ï¼ŒRPMæŠŠè½¯ä»¶ä¾èµ–å…³ç³»å‚¨å­˜åœ¨æœ¬åœ°æ•°æ®åº“é‡Œï¼Œé‚£æˆ‘ä»¬åœ¨å®‰è£…è½¯ä»¶çš„æ—¶å€™ï¼Œå¦‚æœå…ˆåˆ°æ•°æ®åº“é‡Œæ‰¾åˆ°æ‰€æœ‰ä¾èµ–åŒ…çš„åˆ—è¡¨ï¼Œå†æ£€ç´¢å“ªäº›å·²ç»å®‰è£…åˆ°æœ¬åœ°ï¼Œç„¶åæŠŠå‰©ä¸‹æ²¡å®‰è£…çš„ä¸€èµ·å®‰è£…ï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³åŒ…ä¾èµ–æ€§çš„é—®é¢˜äº†ï¼Œè¿™å°±æ˜¯yumæœºåˆ¶çš„ç”±æ¥\nyumçš„è¿ä½œæµç¨‹ # å„ç‰ˆæœ¬å‘è¡Œå•†éƒ½ä¼šé‡Šæ”¾å‡ºè½¯ä»¶å¹¶æ”¾ç½®äºyumæœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥yumæœåŠ¡å™¨å‚¨å­˜æœ‰æˆ‘ä»¬å„ç§æ‰€éœ€çš„è½¯ä»¶ã€‚å‚è€ƒä¸‹å›¾ï¼ŒyumæœåŠ¡å™¨ä¸ä»…å­˜å‚¨äº†å„ç§RPMåŒ…ï¼Œè¿˜æœ‰åŒ…çš„ç›¸å…³çš„å…ƒæ•°æ®æ–‡ä»¶ï¼ˆæ”¾ç½®äºç‰¹å®šç›®å½•repodataä¸‹ï¼‰ï¼Œå‰é¢æåˆ°çš„åŒ…çš„ä¾èµ–æ€§å…³ç³»å°±å‚¨å­˜åœ¨å…ƒæ•°æ®æ–‡ä»¶ä¸­ã€‚é€™äº›æ–‡ä»¶ä¸RPMè½¯ä»¶åŒ…æ‰€åœ¨çš„æœ¬åœ°æˆ–ç½‘ç»œä½ç½®å°±è¢«ç§°ä¸ºyumä»“åº“(yum repo)ã€‚å½“ç”¨æˆ·ç«¯æœ‰è½¯ä»¶å®‰è£…æˆ–å‡çº§çš„éœ€æ±‚æ—¶ï¼Œç”¨æˆ·ç«¯ä¼šè®¿é—®yumæœåŠ¡å™¨ä¸‹è½½æˆ–æ›´æ–°RPMè½¯ä»¶åˆ—è¡¨å¹¶å­˜åœ¨æœ¬æœºç¼“å­˜åˆ—è¡¨ä¸­ï¼Œç„¶åé€šè¿‡ç¼“å­˜åˆ—è¡¨ä¸æœ¬åœ°RPMæ•°æ®åº“ç›¸æ¯”å¯¹ï¼Œç­›é€‰å‡ºç¼ºå°‘å“ªäº›RPMè½¯ä»¶åŒ…å¹¶æ ¹æ®yumä»“åº“å‚¨å­˜çš„è·¯å¾„ä¸‹è½½ï¼ˆå¯ä»¥æ˜¯æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œï¼‰ï¼Œæœ€åé€šè¿‡RPMæœºåˆ¶ä¸€å¹¶è¿›è¡Œå®‰è£…ã€‚ å¦‚ä½•é…ç½®yumå®¢æˆ·ç«¯ # yumæœ¬èº«çš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æŒ‡å‘ä»“åº“çš„ä½ç½®ä»¥åŠç›¸å…³çš„å„ç§é…ç½®ä¿¡æ¯ã€‚\nä¸»é…ç½®æ–‡ä»¶ # /etc/yum.confï¼šä¸ºæ‰€æœ‰ä»“åº“æä¾›å…¬å…±é…ç½®\nå„ä»“åº“æŒ‡å‘çš„å®šä¹‰ # /etc/yum.repos.d/*.repoï¼šä¸ºä»“åº“çš„æŒ‡å‘æä¾›é…ç½®\n* [repositoryID] #ä»“åº“çš„åå­—ï¼Œå…·æœ‰å”¯ä¸€æ€§ï¼Œæ ‡è¯†repoçš„æŒ‡å‘ * name=Some name for this repository #ä»“åº“æè¿°ä¿¡æ¯ * baseurl=url://path/to/repository/ #æŒ‡æ˜repoçš„è®¿é—®è·¯å¾„ï¼Œé€šå¸¸ä¸ºä¸€ä¸ªæ–‡ä»¶æœåŠ¡å™¨ä¸Šè¾“å‡ºçš„æŸrepo #æ–‡ä»¶æœåŠ¡å™¨ç±»å‹ http://SEVER/PATH/TO/REPOSITORY https://SEVER/PATH/TO/REPOSITORY ftp://SEVER/PATH/TO/REPOSITORY file:///PATH/TO/REPOSITORY * enabled={1|0} #æ­¤ä»“åº“æ˜¯å¦å¯è¢«ä½¿ç”¨ * gpgcheck={1|0} #æ˜¯å¦å¯¹RPMåŒ…åšæ£€éªŒ * gpgkey=url://path/to/keyfile/ #æŒ‡æ˜gpgkeyæ–‡ä»¶è·¯å¾„ * enablegroups={1|0} #æ˜¯å¦å¯ç”¨åŒ…ç»„ * failovermethod={roundrobin|priority} #è®¾ç½®baseurlæœ‰å¤šä¸ªæ—¶çš„ä¼˜å…ˆçº§ roundrobinï¼šéšæœºæŒ‘é€‰ï¼Œé»˜è®¤å€¼ priority:æŒ‰é¡ºåºè®¿é—® * cost= #æŒ‡æ˜ä»“åº“çš„è®¿é—®å¼€é”€ï¼Œé»˜è®¤ä¸º1000 åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶ # æŒ‰ç…§ä»¥ä¸Šæ–¹å¼ï¼Œæˆ‘ä»¬å°±åœ¨/etc/yum.","title":"yumå®¢æˆ·ç«¯çš„é…ç½®åŠyumå‘½ä»¤ç”¨æ³•"},{"content":"","date":"14 January 2016","permalink":"/tags/rsyslog/","section":"Tags","summary":"","title":"rsyslog"},{"content":"è¿œç¨‹æ—¥å¿—æœåŠ¡å™¨çš„å®ç° # rsyslogå®¢æˆ·ç«¯ï¼šCentOS 7 ; 192.168.196.168 rsyslogæœåŠ¡ç«¯ï¼šCentOS 6 ; 192.168.196.155 /etc/rsyslog.conf å®¢æˆ·ç«¯é…ç½® #### RULES #### *.info;mail.none;authpriv.none;cron.none @@192.168.196.155 $ systemctl restart rsyslog é…ç½®æ–‡ä»¶æ ¼å¼ï¼šç”±ä¸‰éƒ¨åˆ†ç»„æˆ\nMODULESï¼šç›¸å…³æ¨¡å—é…ç½®\nGLOBAL DIRECTIVESï¼šå…¨å±€é…ç½®\nRULESï¼šæ—¥å¿—è®°å½•ç›¸å…³çš„è§„åˆ™é…ç½®\nRULESé…ç½®æ ¼å¼ï¼š\nfacilityï¼š *: æ‰€æœ‰çš„facility facility1,facility2,facility3,\u0026hellip;ï¼šæŒ‡å®šçš„facilityåˆ—è¡¨\npriorityï¼š *: æ‰€æœ‰çº§åˆ« noneï¼šæ²¡æœ‰çº§åˆ«ï¼Œå³ä¸è®°å½• PRIORITYï¼šæŒ‡å®šçº§åˆ«ï¼ˆå«ï¼‰ä»¥ä¸Šçš„æ‰€æœ‰çº§åˆ« =PRIORITYï¼šä»…è®°å½•æŒ‡å®šçº§åˆ«çš„æ—¥å¿—ä¿¡æ¯\ntargetï¼š æ–‡ä»¶è·¯å¾„ï¼šé€šå¸¸åœ¨/var/log/ï¼Œæ–‡ä»¶è·¯å¾„å‰çš„-è¡¨ç¤ºå¼‚æ­¥å†™å…¥ ç”¨æˆ·ï¼šå°†æ—¥å¿—äº‹ä»¶é€šçŸ¥ç»™æŒ‡å®šçš„ç”¨æˆ·ï¼Œ * è¡¨ç¤ºç™»å½•çš„æ‰€æœ‰ç”¨æˆ· æ—¥å¿—æœåŠ¡å™¨ï¼šæŠŠæ—¥å¿—é€å¾€è‡³æŒ‡å®šçš„è¿œç¨‹æœåŠ¡å™¨è®°å½• @HOST \u0026mdash;\u0026mdash;- UDPä¼ è¾“ @@HOST \u0026mdash;\u0026mdash;- TCPä¼ è¾“ ç®¡é“ï¼š | COMMANDï¼Œè½¬å‘ç»™å…¶å®ƒå‘½ä»¤å¤„ç†\n/etc/rsyslog.conf æœåŠ¡ç«¯é…ç½® #### MODULES #### # Provides TCP syslog reception $ModLoad imtcp $InputTCPServerRun 514 $ service rsyslog restart æµ‹è¯• [root@Centos7 ~]#logger \u0026#34;This is a test log from client~\u0026#34; [root@Centos6 ~]# tail -n1 /var/log/messages Aug 9 21:43:42 Centos7 root: This is a test log from client~ æ—¥å¿—æœåŠ¡å™¨è¿æ¥æ•°æ®åº“MYSQL # mysqlæœåŠ¡å™¨ï¼šCentOS 7 ; 192.168.196.168 åœ¨mysql serverä¸Šæˆæƒrsyslogèƒ½è¿æ¥è‡³å½“å‰æœåŠ¡å™¨ $ mysql -uroot -p123456 mysql\u0026gt; grant all on Syslog.* to \u0026#39;syslog\u0026#39;@\u0026#39;192.168.196.%\u0026#39; identified by \u0026#39;123456\u0026#39;; åœ¨rsyslogæœåŠ¡å™¨ä¸Šå®‰è£…mysqlæ¨¡å—ç›¸å…³çš„ç¨‹åºåŒ… $ yum install rsyslog-mysql $ rpm -ql rsyslog-mysql /lib64/rsyslog/ommysql.so /usr/share/doc/rsyslog-mysql-5.8.10 /usr/share/doc/rsyslog-mysql-5.8.10/createDB.sql \u0026lt;--ç”¨äºåˆ›å»ºrsyslogæ•°æ®åº“åŠè¡¨çš„è„šæœ¬æ–‡ä»¶ ä¸ºrsyslogåˆ›å»ºæ•°æ®åº“åŠè¡¨ $ mysql -usyslog -h192.168.196.168 -p123456 \u0026lt; /usr/share/doc/rsyslog-mysql-5.8.10/createDB.sql é…ç½®rsyslogæœåŠ¡ç«¯å°†æ—¥å¿—ä¿å­˜åˆ°mysqlä¸­ $ vim /etc/rsyslog.conf $ModLoad ommysql *.info;mail.none;authpriv.none;cron.none :ommysql:192.168.196.168,Syslog,syslog,123456 æŸ¥çœ‹mysqlæ•°æ®åº“ä¸­æ—¥å¿—æ•°æ® $ mysql -usyslog -h192.168.196.168 -p123456 MariaDB [(none)]\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | Syslog | | test | +--------------------+ 3 rows in set (0.00 sec) MariaDB [(none)]\u0026gt; use Syslog; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [Syslog]\u0026gt; show tables; +------------------------+ | Tables_in_Syslog | +------------------------+ | SystemEvents | | SystemEventsProperties | +------------------------+ 2 rows in set (0.00 sec) MariaDB [Syslog]\u0026gt; MariaDB [Syslog]\u0026gt; select * from SystemEvents \\G; *************************** 59. row ***************************\t\u0026lt;--æˆªå–å®¢æˆ·ç«¯è§¦å‘çš„æœ€è¿‘ä¸€æ¡log ID: 59 CustomerID: NULL ReceivedAt: 2017-08-09 22:06:04 DeviceReportedTime: 2017-08-09 22:06:25 Facility: 1 Priority: 5 FromHost: Centos7 Message: This is a test log from client~ NTSeverity: NULL Importance: NULL EventSource: NULL EventUser: NULL EventCategory: NULL EventID: NULL EventBinaryData: NULL MaxAvailable: NULL CurrUsage: NULL MinUsage: NULL MaxUsage: NULL InfoUnitID: 1 SysLogTag: root: EventLogType: NULL GenericFileName: NULL SystemID: NULL processid: checksum: 0 59 rows in set (0.00 sec) loganalyzerå±•ç¤ºæ•°æ®åº“ä¸­çš„æ—¥å¿— # åœ¨rsyslogæœåŠ¡å™¨ä¸Šå‡†å¤‡amp $ yum install httpd mysql-server php php-mysql php-gd\nå®‰è£…LogAnalyzer\n$ tar xf loganalyzer-4.1.5.tar.gz $ cp -a loganalyzer-4.1.5/src /var/www/html/ $ cat loganalyzer-4.1.5/contrib/configure.sh \u0026lt;-- æºç æ–‡ä»¶ä¸­çš„configureè„šæœ¬,æ‰‹åŠ¨æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ #!/bin/sh touch config.php chmod 666 config.php $ cd src $ touch config.php $ chmod 666 config.php $ service httpd start Webé¡µé¢é…ç½®loganalyzer æµè§ˆå™¨è®¿é—®http://192.168.196.155/src/install.php æŒ‰æ­¥éª¤é…ç½®loganalyzer å‰ä¸‰æ­¥ç›´æ¥ç‚¹å‡»next,è·³è½¬åˆ°é…ç½®mysqæ•°æ®åº“çš„é¡µé¢ï¼Œæ ¹æ®ä¸Šæ–‡mysqlæœåŠ¡å™¨çš„ä¿¡æ¯è¿›è¡Œé…ç½®ï¼›ç‚¹å‡»nextå®Œæˆé…ç½®\næµè§ˆå™¨è®¿é—®http://192.168.196.155/src,å¯ä»¥æŒ‰äº‹ä»¶æˆ–è€…æŠ¥è¡¨æŸ¥çœ‹æ•°æ®åº“ä¸­çš„æ—¥å¿— ","date":"14 January 2016","permalink":"/2016/01/rsyslog-collect/","section":"åšå®¢","summary":"\u003ch3 class=\"relative group\"\u003eè¿œç¨‹æ—¥å¿—æœåŠ¡å™¨çš„å®ç° \n    \u003cdiv id=\"è¿œç¨‹æ—¥å¿—æœåŠ¡å™¨çš„å®ç°\" class=\"anchor\"\u003e\u003c/div\u003e\n    \n    \u003cspan\n        class=\"absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\"\u003e\n        \u003ca class=\"group-hover:text-primary-300 dark:group-hover:text-neutral-700\"\n            style=\"text-decoration-line: none !important;\" href=\"#%e8%bf%9c%e7%a8%8b%e6%97%a5%e5%bf%97%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e5%ae%9e%e7%8e%b0\" aria-label=\"é”šç‚¹\"\u003e#\u003c/a\u003e\n    \u003c/span\u003e        \n    \n\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003ersyslogå®¢æˆ·ç«¯ï¼šCentOS 7 ; 192.168.196.168\u003c/li\u003e\n\u003cli\u003ersyslogæœåŠ¡ç«¯ï¼šCentOS 6 ; 192.168.196.155\u003c/li\u003e\n\u003c/ul\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003e/etc/rsyslog.conf\u003c/code\u003e å®¢æˆ·ç«¯é…ç½®\u003c/li\u003e\n\u003c/ol\u003e","title":"å¦‚ä½•å®ç°rsyslogçš„è¿œç¨‹æ—¥å¿—å­˜å‚¨"},{"content":"","date":"14 November 2015","permalink":"/tags/lvm/","section":"Tags","summary":"","title":"LVM"},{"content":"ä»€ä¹ˆæ˜¯LVM # LVM(Logical Volume Manager é€»è¾‘å·ç®¡ç†)å¯ä»¥å®ç°æŠŠå¤šä¸ªå®ä½“ç¡¬ç›˜åˆ†åŒºæ•´åˆåœ¨ä¸€èµ·ï¼Œå½“ä½œä¸€ä¸ªç¡¬ç›˜æ¥é‡æ–°æ“ä½œå¤„ç†ã€‚æœ€é‡è¦çš„æ˜¯LVMä¸åƒä¼ ç»Ÿåˆ†åŒºä¸€æ—¦ç¡®å®šåˆ†åŒºå¤§å°å°±ä¸èƒ½å†è°ƒæ•´ï¼Œå®ƒå…è®¸æˆ‘ä»¬å¼¹æ€§çš„è°ƒæ•´åˆ†åŒºåŠæ–‡ä»¶ç³»ç»Ÿå®¹é‡\né€šè¿‡å‡ é“ç»ƒä¹ é¢˜æ¥è¯´æ˜LVMçš„å®ç° # 1ã€åˆ›å»ºä¸€ä¸ªè‡³å°‘æœ‰ä¸¤ä¸ªPVç»„æˆçš„å¤§å°ä¸º20Gçš„åä¸ºtestvgçš„VGï¼›è¦æ±‚PEå¤§å°ä¸º16MB, è€Œååœ¨å·ç»„ä¸­åˆ›å»ºå¤§å°ä¸º5Gçš„é€»è¾‘å·testlvï¼›æŒ‚è½½è‡³/usersç›®å½•\n2ã€æ–°å»ºç”¨æˆ· archlinuxï¼Œè¦æ±‚å…¶å®¶ç›®å½•ä¸º/users/archlinuxï¼Œè€Œåsuåˆ‡æ¢è‡³archlinuxç”¨æˆ·ï¼Œå¤åˆ¶/etc/pam.dç›®å½•è‡³è‡ªå·±çš„å®¶ç›®å½•\n3ã€æ‰©å±•testlvè‡³7Gï¼Œè¦æ±‚archlinuxç”¨æˆ·çš„æ–‡ä»¶ä¸èƒ½ä¸¢å¤±\n4ã€æ”¶ç¼©testlvè‡³3Gï¼Œè¦æ±‚archlinuxç”¨æˆ·çš„æ–‡ä»¶ä¸èƒ½ä¸¢å¤±5ã€å¯¹testlvåˆ›å»ºå¿«ç…§ï¼Œå¹¶å°è¯•åŸºäºå¿«ç…§å¤‡ä»½æ•°æ®ï¼ŒéªŒæ­£å¿«ç…§çš„åŠŸèƒ½\né¢˜1: PVã€VGã€LVçš„åˆ›å»º # [root@centos6 ~]fdisk /dev/sda \u0026lt;--è°ƒæ•´åˆ†åŒºsda1 idä¸º8e [root@centos6 ~]fdisk /dev/sdc \u0026lt;--è°ƒæ•´åˆ†åŒºsdc1 idä¸º8e [root@centos6 ~]#pvcreate /dev/sd{a6,c1} \u0026lt;--æŒ‡å®šåˆ†åŒºä¸ºPV Physical volume \u0026#34;/dev/sda6\u0026#34; successfully created Physical volume \u0026#34;/dev/sdc1\u0026#34; successfully created [root@centos6 ~]#vgcreate -s 16M vg0 /dev/sd{a6,c1} \u0026lt;--åˆ›å»ºvgï¼›-s æŒ‡å®šPEå¤§å° Volume group \u0026#34;vg0\u0026#34; successfully created [root@centos6 ~]#lvcreate -n testlv -L 5G vg0 \u0026lt;--åˆ›å»ºlv; -n æŒ‡å®šlvåå­—ï¼›-L æŒ‰ç…§å®¹é‡æŒ‡å®šlvå¤§å°[MGT]å‚è€ƒ1ï¼‰ Wiping software RAID md superblock on /dev/vg0/testlv. Logical volume \u0026#34;testlv\u0026#34; created. [root@centos6 ~]#mkfs.ext4 /dev/vg0/testlv \u0026lt;--ä¸ºlvæŒ‡å®šæ–‡ä»¶ç³»ç»Ÿ [root@centos6 ~]#mount /dev/vg0/testlv /app/lvm \u0026lt;--æŒ‚è½½lv; åœ¨/etc/fstabæ·»åŠ å¯å®ç°å¼€æœºè‡ªåŠ¨æŒ‚è½½ lvåˆ›å»ºçš„æ—¶å€™ä¹Ÿå¯ä»¥æŒ‰ç…§PEæ•°é‡æŒ‡å®š ä¸ºtestlvåˆ†é…3000 ä¸ªPEï¼šlvcreate -n testlv -l 3000 vg0\næŠŠå·ç»„æ‰€æœ‰PEåˆ†é…ç»™testlvï¼šlvcreate -n testlv -l 100%vg vg0\nPVã€VGã€LVä¿¡æ¯æŸ¥è¯¢ [root@centos6 ~]#pvdisplay --- Physical volume --- PV Name /dev/sda6 VG Name vg0 PV Size 10.00 GiB / not usable 4.58 MiB Allocatable yes PE Size 16.00 MiB Total PE 640 \u0026lt;--æŒ‰ç…§æŒ‡å®šPE Size,è¯¥PVåˆ’åˆ†çš„PEæ•°é‡ Free PE 320 \u0026lt;--å‰©ä½™æ²¡æœ‰åˆ†é…ç»™LVçš„PEæ•°é‡ Allocated PE 320 \u0026lt;--å·²ç»åˆ†é…ç»™LVçš„PEæ•°é‡ PV UUID rbsdXo-s39N-vGar-Oxuc-5E6Z-sIuD-rZP5el --- Physical volume --- PV Name /dev/sdc1 VG Name vg0 PV Size 10.00 GiB / not usable 4.54 MiB Allocatable yes PE Size 16.00 MiB Total PE 640 Free PE 640 Allocated PE 0 PV UUID T9ehfV-wSc8-ez1y-ZlNF-T9P2-PU87-2rFe7Q [root@centos6 ~]#vgdisplay --- Volume group --- VG Name vg0 System ID Format lvm2 Metadata Areas 2 Metadata Sequence No 14 VG Access read/write VG Status resizable MAX LV 0 Cur LV 1 Open LV 0 Max PV 0 Cur PV 2 Act PV 2 VG Size 20.00 GiB PE Size 16.00 MiB Total PE 1280 Alloc PE / Size 320 / 5.00 GiB Free PE / Size 960 / 15.00 GiB VG UUID YlqvPD-Vhsk-2vxR-G5SY-X1HM-3GUk-BNoUzq [root@centos6 ~]#lvdisplay --- Logical volume --- LV Path /dev/vg0/testlv LV Name testlv VG Name vg0 LV UUID nx4ENL-mE35-xlIf-DWQl-6f6j-m2t1-uznnNd LV Write Access read/write LV Creation host, time centos6.ffu.com, 2017-06-22 15:29:38 +0800 LV Status available # open 0 LV Size 5.00 GiB Current LE 320 \u0026lt;--ç­‰åŒäºPEæ•°é‡ Segments 1 Allocation inherit Read ahead sectors auto - currently set to 256 Block device 253:0 é¢˜2ï¼šç”¨æˆ·åˆ›å»º # [root@centos6 app]#useradd -m -k /etc/skel -d /app/lvm/archlinux archlinux [root@centos6 app]#su archlinux [archlinux@centos6 app]$cp -r /etc/pam.d/ lvm/archlinux/ é¢˜3ï¼šlvçš„æ‰©å±• # é€»è¾‘å·çš„æ‰©å±•æ˜¯åœ¨çº¿æ‰©å±•ï¼Œä¸ç”¨å¸è½½lv,ä¸å½±å“ç”¨æˆ·ä½¿ç”¨\n[root@centos6 app]#lvextend -L +2G /dev/vg0/testlv \u0026lt;---L æŒ‰ç…§å®¹é‡æŒ‡å®šæ‰©å±•å¤§å°(Numå¢åŠ åˆ°;+Numé¢å¤–å¢åŠ );å‚è€ƒ1ï¼‰ [root@centos6 archlinux]#df -hTP Filesystem Type Size Used Avail Use% Mounted on /dev/sda2 ext4 96G 9.6G 82G 11% / tmpfs tmpfs 491M 76K 491M 1% /dev/shm /dev/sda3 ext4 48G 125M 46G 1% /app /dev/sda1 ext4 969M 35M 885M 4% /boot /dev/sdb7 ext4 2.0G 923M 1016M 48% /testdir /dev/sr0 iso9660 3.7G 3.7G 0 100% /media/CentOS_6.9_Final /dev/mapper/vg0-testlv ext4 4.8G 11M 4.6G 1% /app/lvm \u0026lt;--æ²¡æœ‰æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ,æ²¡æœ‰è¯†åˆ«å¢åŠ çš„2G [root@centos6 archlinux]#resize2fs /dev/vg0/testlv \u0026lt;--åŒæ­¥æ–‡ä»¶ç³»ç»Ÿï¼›å‚è€ƒ2ï¼‰ [root@centos6 archlinux]#df -hTP Filesystem Type Size Used Avail Use% Mounted on /dev/sda2 ext4 96G 9.6G 82G 11% / tmpfs tmpfs 491M 76K 491M 1% /dev/shm /dev/sda3 ext4 48G 125M 46G 1% /app /dev/sda1 ext4 969M 35M 885M 4% /boot /dev/sdb7 ext4 2.0G 923M 1016M 48% /testdir /dev/sr0 iso9660 3.7G 3.7G 0 100% /media/CentOS_6.9_Final /dev/mapper/vg0-testlv ext4 6.8G 12M 6.5G 1% /app/lvm åŒæ ·å¯ä»¥æŒ‰ç…§PVæ•°é‡æŒ‡å®š ä¸ºtestlvæ–°å¢600ä¸ªPEï¼šlvextend -l 600 /dev/vg0/testlv\næŠŠå·ç»„å‰©ä½™æ‰€æœ‰ç©ºé—²PEåˆ†é…ç»™testlvï¼šlvextend -l 100%free /dev/vg0/testlv\nresize2fs åªç”¨äºextç³»ç»Ÿï¼›å¯¹äºxfsç³»ç»Ÿè¦ç”¨xfs_growfs +æŒ‚è½½ç‚¹(æ³¨æ„ä¸æ˜¯è®¾å¤‡å) æ­¤ä¾‹ä¸­æ˜¯åœ¨æŒ‚è½½çš„çŠ¶æ€ä¸‹è¿›è¡Œæ‰©å±•ï¼Œå¦‚æœäº‹å…ˆå¸è½½çš„è¯ï¼Œå°±éœ€è¦å…ˆè¿›è¡Œå¼ºåˆ¶ç£ç›˜æ£€æŸ¥-\u0026gt;e2fsck -f /dev/vg0/testlv å…¶å®åœ¨æ‰©å±•lvæ—¶åŠ ä¸Š-ré€‰é¡¹å°±å¯ä»¥ä¸€å¹¶æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ-\u0026gt; lvextend -r -l +100%free /dev/vg0/testlv\né¢˜4ï¼šlvçš„ç¼©å‡ # é€»è¾‘å·çš„æ‰©å±•ä¼šå½±å“ç”¨æˆ·ä½¿ç”¨ï¼Œä¸èƒ½åœ¨çº¿æ‰©å±•\n[root@centos6 archlinux]#cp /app/lvm /app/test -r \u0026lt;--ç¼©å‡ä¼šå½±å“ç”¨æˆ·ä½¿ç”¨ï¼Œä¸èƒ½åœ¨çº¿æ“ä½œï¼Œç¼©å‡ä¹‹å‰å»ºè®®å…ˆå¤‡ä»½ [root@centos6 ~]#umount /app/lvm \u0026lt;--å¿…é¡»å…ˆå¸è½½ [root@centos6 ~]#e2fsck -f /dev/vg0/testlv \u0026lt;--å¼ºåˆ¶ç£ç›˜æ£€æŸ¥;å¿…è¦æ­¥éª¤ e2fsck 1.41.12 (17-May-2010) Pass 1: Checking inodes, blocks, and sizes Pass 2: Checking directory structure Pass 3: Checking directory connectivity` Pass 4: Checking reference counts Pass 5: Checking group summary information /dev/vg0/testlv: 80/458752 files (0.0% non-contiguous), 64511/1835008 blocks [root@centos6 ~]#resize2fs /dev/vg0/testlv 3G \u0026lt;--å…ˆç¼©å‡æ–‡ä»¶ç³»ç»Ÿ resize2fs 1.41.12 (17-May-2010) Resizing the filesystem on /dev/vg0/testlv to 786432 (4k) blocks. The filesystem on /dev/vg0/testlv is now 786432 blocks long. [root@centos6 ~]#lvreduce -L 3G /dev/vg0/testlv \u0026lt;--å†ç¼©å‡é€»è¾‘å· WARNING: Reducing active logical volume to 3.00 GiB. THIS MAY DESTROY YOUR DATA (filesystem etc.) Do you really want to reduce vg0/testlv? [y/n]: y Size of logical volume vg0/testlv changed from 7.00 GiB (448 extents) to 3.00 GiB (192 extents). Logical volume testlv successfully resized. [root@centos6 ~]#mount /dev/vg0/testlv /app/lvm \u0026lt;--æŒ‚è½½ [root@centos6 ~]#ls /app/lvm \u0026lt;--æ•°æ®å¹¶æ²¡æœ‰ä¸¢å¤± archlinux lost+found é¢˜5ï¼šå¿«ç…§çš„ä½¿ç”¨ # å¿«ç…§æ˜¯ä¸€ç§ç‰¹æ®Šçš„é€»è¾‘å·ï¼Œå®ƒæ˜¯åœ¨ç”Ÿæˆå¿«ç…§æ—¶å¯¹å­˜åœ¨åŒä¸€VGä¸‹çš„é€»è¾‘å·çš„å‡†ç¡®æ‹·è´ã€‚ å¿«ç…§åŒºæœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼šå˜æ›´ä¹‹å‰çš„æ•°æ®å’Œæœªå˜æ›´çš„æ•°æ®ç»„æˆã€‚å½“åŸæ¥çš„é€»è¾‘å·ä¸­æœ‰æ‰€æ”¹å˜æ—¶ï¼Œä¼šå°†æ—§çš„æ•°æ®å¤åˆ¶åˆ°å¿«ç…§ä¸­ï¼Œè€Œæ²¡æœ‰è¢«å˜åŠ¨çš„æ•°æ®ä¾æ—§ä¿æŒåœ¨åŸæœ¬çš„åŒºå—å†…ã€‚\n[root@centos6 ~]#df -hP \u0026lt;--æŸ¥çœ‹è¦å¤‡ä»½çš„lvä¸Šçš„æ•°æ®å¤§å° Filesystem Size Used Avail Use% Mounted on /dev/sda2 96G 9.6G 82G 11% / tmpfs 491M 76K 491M 1% /dev/shm /dev/sda3 48G 125M 46G 1% /app /dev/sda1 969M 35M 885M 4% /boot /dev/sdb7 2.0G 923M 1016M 48% /testdir /dev/sr0 3.7G 3.7G 0 100% /media/CentOS_6.9_Final /dev/mapper/vg0-testlv 2.9G 7.8M 2.7G 1% /app/lvm \u0026lt;--å¿«ç…§å¤§å°è®¾ç½®åº”ä¸å¤§äºæ•°æ®å¤§å° [root@centos6 ~]#lvcreate -n testlv-snapshot -s -L 16M -p r /dev/vg0/testlv \u0026lt;--å‚è€ƒ1) Logical volume \u0026#34;testlv-snapshot\u0026#34; created. [root@centos6 ~]#lvdisplay \u0026lt;--å¯ä»¥æŸ¥çœ‹å¿«ç…§é€»è¾‘å· [root@centos6 app]#mkdir snap [root@centos6 app]#mount /dev/vg0/testlv-snapshot /app/snap \u0026lt;--æŒ‚è½½å¿«ç…§ mount: block device /dev/mapper/vg0-testlv--snapshot is write-protected, mounting read-only [root@centos6 lvm]#rm -rf /app/lvm/archlinux/ \u0026lt;--åˆ é™¤é€»è¾‘å·testlvä¸Šçš„archlinuxç›®å½• [root@centos6 lvm]#ls ../snap \u0026lt;--å¯ä»¥çœ‹åˆ°å¿«ç…§ä¸­archlinuxç›®å½•è¿˜åœ¨ archlinux lost+found åˆ©ç”¨å¿«ç…§æ¢å¤testlv [root@centos6 app]#umount /app/lvm \u0026lt;--å¸è½½é€»è¾‘å· [root@centos6 app]#umount /app/snap/ \u0026lt;--å¸è½½å¿«ç…§ [root@centos6 app]#lvconvert --merge /dev/vg0/testlv-snapshot \u0026lt;--åˆ©ç”¨å¿«ç…§testlv-snapshotæ¢å¤testlv Merging of volume testlv-snapshot started. testlv: Merged: 100.0% Merge of snapshot into logical volume testlv has finished. Logical volume \u0026#34;testlv-snapshot\u0026#34; successfully removed \u0026lt;--æ¢å¤åå¿«ç…§è‡ªåŠ¨åˆ é™¤;å‚è€ƒ2) [root@centos6 app]#mount /dev/vg0/testlv /app/lvm [root@centos6 app]#ls /app/lvm \u0026lt;--archlinuxç›®å½•å·²ç»æ¢å¤ archlinux lost+found -s æŒ‡å®šåˆ›å»ºçš„é€»è¾‘å·ä¸ºå¿«ç…§ï¼›-n æŒ‡å®šå¿«ç…§åå­—ï¼›-L æŒ‡å®šå¿«ç…§å¤§å°(è‡³å°‘ä¸ºè®¾å®šçš„PEå¤§å°); -p r è®¾ä¸ºåªè¯»å±æ€§,ä¹Ÿå¯ä»¥æŒ‚è½½æ—¶å€™è®¾ç½®-\u0026gt;mount -o ro /dev/vg0/testlv-snapshot /app/snap å¿«ç…§æ¢å¤ä¹Ÿå¯æ‰‹åŠ¨æŠŠå¿«ç…§å†…æ•°æ®å¤åˆ¶åˆ°å¯¹åº”é€»è¾‘å·æŒ‚è½½ç›®å½•ä¸‹;æ‰‹åŠ¨åˆ é™¤å¿«ç…§å‘½ä»¤ä¸º:lvremove /dev/vg0/testlv-snapshot è¡¥å……ï¼šå¦‚ä½•ç§»é™¤ä¸€ä¸ªPV # æ²¿ç”¨ä¸Šä¾‹ï¼Œç§»é™¤sda6è®¾å¤‡ï¼Œé¦–å…ˆè¦æŸ¥çœ‹è¯¥è®¾å¤‡ä¸Šæ˜¯å¦æœ‰åˆ†é…ç»™lvçš„PE(ä¸æ˜¯æ•°æ®)ã€‚å¦‚æœæœ‰è¦è½¬ç§»åˆ°å¯¹åº”vgä¸‹çš„å…¶å®ƒpvä¸Š, è€Œä¸”å…¶PEæ•°é‡è¦å°äºå¯¹åº”vgçš„å‰©ä½™free PEæ•°é‡\n[root@centos6 ~]#pvdisplay --- Physical volume --- PV Name /dev/sda6 VG Name vg0 PV Size 10.00 GiB / not usable 4.58 MiB Allocatable yes PE Size 16.00 MiB Total PE 640 Free PE 448 Allocated PE 192 \u0026lt;--éœ€è¦æŠŠ192ä¸ªPEè½¬ç§»åˆ°/dev/sdc1 PV UUID rbsdXo-s39N-vGar-Oxuc-5E6Z-sIuD-rZP5el --- Physical volume --- PV Name /dev/sdc1 VG Name vg0 PV Size 10.00 GiB / not usable 4.54 MiB Allocatable yes PE Size 16.00 MiB Total PE 640 Free PE 640 Allocated PE 0 PV UUID T9ehfV-wSc8-ez1y-ZlNF-T9P2-PU87-2rFe7Q [root@centos6 ~]#pvmove /dev/sda6 /dev/sdc1 /dev/sda6: Moved: 0.5% /dev/sda6: Moved: 15.6% /dev/sda6: Moved: 30.7% /dev/sda6: Moved: 56.8% /dev/sda6: Moved: 78.6% /dev/sda6: Moved: 100.0% [root@centos6 ~]#vgreduce vg0 /dev/sda6 \u0026lt;--æŠŠpv/dev/sda6ä»vg0ä¸­ç§»é™¤ Removed \u0026#34;/dev/sda6\u0026#34; from volume group \u0026#34;vg0\u0026#34; [root@centos6 ~]#pvremove /dev/sda6 \u0026lt;--æŠŠè®¾å¤‡/dev/sda6ä»pvä¸­ç§»é™¤ Labels on physical volume \u0026#34;/dev/sda6\u0026#34; successfully wiped ","date":"14 November 2015","permalink":"/2015/11/logical-volume/","section":"åšå®¢","summary":"ä»€ä¹ˆæ˜¯LVM # LVM(Logical Volume Manager é€»è¾‘å·ç®¡ç†)å¯ä»¥å®ç°æŠŠå¤šä¸ªå®ä½“ç¡¬ç›˜åˆ†åŒºæ•´åˆåœ¨ä¸€èµ·ï¼Œå½“ä½œä¸€ä¸ªç¡¬ç›˜æ¥é‡æ–°æ“ä½œå¤„ç†ã€‚æœ€é‡è¦çš„æ˜¯LVMä¸åƒä¼ ç»Ÿåˆ†åŒºä¸€æ—¦ç¡®å®šåˆ†åŒºå¤§å°å°±ä¸èƒ½å†è°ƒæ•´ï¼Œå®ƒå…è®¸æˆ‘ä»¬å¼¹æ€§çš„è°ƒæ•´åˆ†åŒºåŠæ–‡ä»¶ç³»ç»Ÿå®¹é‡\né€šè¿‡å‡ é“ç»ƒä¹ é¢˜æ¥è¯´æ˜LVMçš„å®ç° # 1ã€åˆ›å»ºä¸€ä¸ªè‡³å°‘æœ‰ä¸¤ä¸ªPVç»„æˆçš„å¤§å°ä¸º20Gçš„åä¸ºtestvgçš„VGï¼›è¦æ±‚PEå¤§å°ä¸º16MB, è€Œååœ¨å·ç»„ä¸­åˆ›å»ºå¤§å°ä¸º5Gçš„é€»è¾‘å·testlvï¼›æŒ‚è½½è‡³/usersç›®å½•\n2ã€æ–°å»ºç”¨æˆ· archlinuxï¼Œè¦æ±‚å…¶å®¶ç›®å½•ä¸º/users/archlinuxï¼Œè€Œåsuåˆ‡æ¢è‡³archlinuxç”¨æˆ·ï¼Œå¤åˆ¶/etc/pam.dç›®å½•è‡³è‡ªå·±çš„å®¶ç›®å½•\n3ã€æ‰©å±•testlvè‡³7Gï¼Œè¦æ±‚archlinuxç”¨æˆ·çš„æ–‡ä»¶ä¸èƒ½ä¸¢å¤±\n4ã€æ”¶ç¼©testlvè‡³3Gï¼Œè¦æ±‚archlinuxç”¨æˆ·çš„æ–‡ä»¶ä¸èƒ½ä¸¢å¤±5ã€å¯¹testlvåˆ›å»ºå¿«ç…§ï¼Œå¹¶å°è¯•åŸºäºå¿«ç…§å¤‡ä»½æ•°æ®ï¼ŒéªŒæ­£å¿«ç…§çš„åŠŸèƒ½\né¢˜1: PVã€VGã€LVçš„åˆ›å»º # [root@centos6 ~]fdisk /dev/sda \u0026lt;--è°ƒæ•´åˆ†åŒºsda1 idä¸º8e [root@centos6 ~]fdisk /dev/sdc \u0026lt;--è°ƒæ•´åˆ†åŒºsdc1 idä¸º8e [root@centos6 ~]#pvcreate /dev/sd{a6,c1} \u0026lt;--æŒ‡å®šåˆ†åŒºä¸ºPV Physical volume \u0026#34;/dev/sda6\u0026#34; successfully created Physical volume \u0026#34;/dev/sdc1\u0026#34; successfully created [root@centos6 ~]#vgcreate -s 16M vg0 /dev/sd{a6,c1} \u0026lt;--åˆ›å»ºvgï¼›-s æŒ‡å®šPEå¤§å° Volume group \u0026#34;vg0\u0026#34; successfully created [root@centos6 ~]#lvcreate -n testlv -L 5G vg0 \u0026lt;--åˆ›å»ºlv; -n æŒ‡å®šlvåå­—ï¼›-L æŒ‰ç…§å®¹é‡æŒ‡å®šlvå¤§å°[MGT]å‚è€ƒ1ï¼‰ Wiping software RAID md superblock on /dev/vg0/testlv.","title":"é€»è¾‘å·LVMçš„å®ç°"},{"content":"â€‹\tä»¥centos6ä¸ºä¾‹ï¼Œ/bootç›®å½•ä¸‹æœ‰æœ€ä¸ºå…³é”®çš„å¼€æœºå¯åŠ¨æ‰€å¿…é¡»çš„å†…æ ¸æ–‡ä»¶ã€æ ¹æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨æ–‡ä»¶å·²ç»å¼•å¯¼åŠ è½½ç¨‹åº(bootloader)grubã€‚å½“æˆ‘ä»¬æ¸…ç©ºæ­¤æ–‡ä»¶å¤¹ä¹‹åå…³æœºï¼Œæœºå™¨å°±ä¸èƒ½æ­£å¸¸å¯åŠ¨äº†ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å€ŸåŠ©å…‰ç›˜å¯åŠ¨è¿›å…¥æ•‘æ´æ¨¡å¼è§£å†³ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\nå¼€æœºè¿›å…¥æ•‘æ´æ¨¡å¼ # è¿™é‡Œä¸åƒæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ˜¾ç¤ºæ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨/mnt/sysimageç›®å½•ï¼Œè€Œæ˜¯æç¤ºæ‰¾ä¸åˆ°åˆ†åŒºã€‚è¿™æ˜¯å› ä¸ºæˆ‘æŠŠ/etc/fstabæ–‡ä»¶åˆ é™¤äº†ï¼Œå³ä½¿æ•‘æ´æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿå¯åŠ¨ä¹Ÿä¸ä¼šæœç´¢æŒ‚è½½æ ¹ç›®å½•äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬åªèƒ½æŸ¥çœ‹æœ¬ä¸»æœºå„ä¸ªåˆ†åŒºæƒ…å†µï¼Œå°è¯•æ‰¾åˆ°æ ¹ç›®å½•å¹¶æ‰‹åŠ¨æŒ‚è½½ã€‚\næ‰‹åŠ¨æŒ‚è½½æ ¹ç›®å½•ï¼Œæ¢å¤/etc/fstabæ–‡ä»¶ # è¿›å…¥shellæ¨¡å¼ä¸‹ï¼Œæ ¹æ®åˆ†åŒºæƒ…å†µå¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†ä½¿ç³»ç»Ÿå®¹é‡å…·æœ‰æ‹“å±•æ€§ï¼Œæ ¹ç³»ç»ŸåŸºäºé€»è¾‘å·çš„ã€‚ä½†æ˜¯é€šè¿‡lvdisplayå‘½ä»¤å¯ä»¥çœ‹å‡ºï¼Œé€»è¾‘å·çš„çŠ¶æ€æ˜¯not availableï¼Œè¿™æ˜¯å› ä¸ºLVMåŠsoftware Raidè®¾å¤‡æ˜¯åœ¨è¿è¡Œç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬/etc/rc.d/rc.sysinitæ—¶æ‰è¢«æ¿€æ´»ã€‚å¾ˆæ˜¾ç„¶ï¼Œåœ¨æœ¬ä¾‹ä¸­bootLoaderéƒ½å·²ç»è¢«æŸåï¼Œlvmæ— æ³•è¢«è‡ªåŠ¨æ¿€æ´»ï¼Œä½¿ç”¨å‘½ä»¤#vgchange -ay æ‰‹åŠ¨æ¿€æ´»\næ¿€æ´»lvmä¹‹åï¼Œé€šè¿‡é€»è¾‘å·åå­—çœ‹å‡ºæ ¹æ–‡ä»¶ç³»ç»Ÿåº”è¯¥åœ¨dev/vg_www/lv_rooté€»è¾‘å·è®¾å¤‡ä¸Šï¼ŒæŒ‚è½½è¯¥è®¾å¤‡åˆ°/mnt/tmpç›®å½•ã€‚å‚è€ƒä¸‹å›¾lsç»“æœå¯çŸ¥ï¼Œæ­¤è®¾å¤‡ç¡®å®æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ›å»ºfstabæ–‡ä»¶å¹¶é‡å¯\né‡å¯ï¼Œè¿›å…¥æ•‘æ´æ¨¡å¼ï¼Œä¿®å¤/boot # 1)å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•‘æ´æ¨¡å¼ä¸‹å·²æ˜¾ç¤ºæ‰¾åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶æŒ‚è½½åœ¨/mnt/sysimageç›®å½•ã€‚è¿›å…¥shellæ¨¡å¼ï¼Œåœ¨/bootç›®å½•ä¸‹å®‰è£…kernelå’Œgrub\n2)grub.confæ–‡ä»¶å¯ä»¥åœ¨ä¸Šè¿°shellä¸‹ç›´æ¥ç¼–è¾‘ä¿®å¤ä¹Ÿå¯ä»¥åœ¨è¿›å…¥å¼€æœºèœå•æ—¶ä½¿ç”¨grubäº¤äº’ç¨‹åºè¾“å…¥\né‡å¯æœºå™¨ï¼Œç³»ç»Ÿç›´æ¥è¿›å…¥grubäº¤äº’ç•Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\nåˆ†åˆ«è¾“å…¥kernelå‚æ•°å’Œä¼ªæ ¹æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œå¹¶å¯åŠ¨\næŒ‡å®škernelå’Œinitrdçš„æ–‡ä»¶è·¯å¾„æ ¹ä¸º/bootæ‰€åœ¨çš„è®¾å¤‡åŠåˆ†åŒº;(hd0,0)ä»£è¡¨ç€ç¬¬ä¸€ä¸ªç¡¬ç›˜ä¸­ç¬¬ä¸€ä¸ªåˆ†åŒº\né‡å¯ä¹‹åï¼Œå¯ä»¥æ­£å¸¸ç™»é™†äº† # ç™»é™†ä¹‹åå†å»å®Œå–„/etc/fstabæ–‡ä»¶åŠgrub.confæ–‡ä»¶ï¼Œæœºå™¨å°±æ¢å¤æˆåŠŸäº†ã€‚\n","date":"6 October 2015","permalink":"/2015/10/partion-recover/","section":"åšå®¢","summary":"â€‹\tä»¥centos6ä¸ºä¾‹ï¼Œ/bootç›®å½•ä¸‹æœ‰æœ€ä¸ºå…³é”®çš„å¼€æœºå¯åŠ¨æ‰€å¿…é¡»çš„å†…æ ¸æ–‡ä»¶ã€æ ¹æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨æ–‡ä»¶å·²ç»å¼•å¯¼åŠ è½½ç¨‹åº(bootloader)grubã€‚å½“æˆ‘ä»¬æ¸…ç©ºæ­¤æ–‡ä»¶å¤¹ä¹‹åå…³æœºï¼Œæœºå™¨å°±ä¸èƒ½æ­£å¸¸å¯åŠ¨äº†ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å€ŸåŠ©å…‰ç›˜å¯åŠ¨è¿›å…¥æ•‘æ´æ¨¡å¼è§£å†³ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\nå¼€æœºè¿›å…¥æ•‘æ´æ¨¡å¼ # è¿™é‡Œä¸åƒæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ˜¾ç¤ºæ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨/mnt/sysimageç›®å½•ï¼Œè€Œæ˜¯æç¤ºæ‰¾ä¸åˆ°åˆ†åŒºã€‚è¿™æ˜¯å› ä¸ºæˆ‘æŠŠ/etc/fstabæ–‡ä»¶åˆ é™¤äº†ï¼Œå³ä½¿æ•‘æ´æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿå¯åŠ¨ä¹Ÿä¸ä¼šæœç´¢æŒ‚è½½æ ¹ç›®å½•äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬åªèƒ½æŸ¥çœ‹æœ¬ä¸»æœºå„ä¸ªåˆ†åŒºæƒ…å†µï¼Œå°è¯•æ‰¾åˆ°æ ¹ç›®å½•å¹¶æ‰‹åŠ¨æŒ‚è½½ã€‚\næ‰‹åŠ¨æŒ‚è½½æ ¹ç›®å½•ï¼Œæ¢å¤/etc/fstabæ–‡ä»¶ # è¿›å…¥shellæ¨¡å¼ä¸‹ï¼Œæ ¹æ®åˆ†åŒºæƒ…å†µå¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†ä½¿ç³»ç»Ÿå®¹é‡å…·æœ‰æ‹“å±•æ€§ï¼Œæ ¹ç³»ç»ŸåŸºäºé€»è¾‘å·çš„ã€‚ä½†æ˜¯é€šè¿‡lvdisplayå‘½ä»¤å¯ä»¥çœ‹å‡ºï¼Œé€»è¾‘å·çš„çŠ¶æ€æ˜¯not availableï¼Œè¿™æ˜¯å› ä¸ºLVMåŠsoftware Raidè®¾å¤‡æ˜¯åœ¨è¿è¡Œç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬/etc/rc.d/rc.sysinitæ—¶æ‰è¢«æ¿€æ´»ã€‚å¾ˆæ˜¾ç„¶ï¼Œåœ¨æœ¬ä¾‹ä¸­bootLoaderéƒ½å·²ç»è¢«æŸåï¼Œlvmæ— æ³•è¢«è‡ªåŠ¨æ¿€æ´»ï¼Œä½¿ç”¨å‘½ä»¤#vgchange -ay æ‰‹åŠ¨æ¿€æ´»\næ¿€æ´»lvmä¹‹åï¼Œé€šè¿‡é€»è¾‘å·åå­—çœ‹å‡ºæ ¹æ–‡ä»¶ç³»ç»Ÿåº”è¯¥åœ¨dev/vg_www/lv_rooté€»è¾‘å·è®¾å¤‡ä¸Šï¼ŒæŒ‚è½½è¯¥è®¾å¤‡åˆ°/mnt/tmpç›®å½•ã€‚å‚è€ƒä¸‹å›¾lsç»“æœå¯çŸ¥ï¼Œæ­¤è®¾å¤‡ç¡®å®æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ›å»ºfstabæ–‡ä»¶å¹¶é‡å¯\né‡å¯ï¼Œè¿›å…¥æ•‘æ´æ¨¡å¼ï¼Œä¿®å¤/boot # 1)å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•‘æ´æ¨¡å¼ä¸‹å·²æ˜¾ç¤ºæ‰¾åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶æŒ‚è½½åœ¨/mnt/sysimageç›®å½•ã€‚è¿›å…¥shellæ¨¡å¼ï¼Œåœ¨/bootç›®å½•ä¸‹å®‰è£…kernelå’Œgrub\n2)grub.confæ–‡ä»¶å¯ä»¥åœ¨ä¸Šè¿°shellä¸‹ç›´æ¥ç¼–è¾‘ä¿®å¤ä¹Ÿå¯ä»¥åœ¨è¿›å…¥å¼€æœºèœå•æ—¶ä½¿ç”¨grubäº¤äº’ç¨‹åºè¾“å…¥\né‡å¯æœºå™¨ï¼Œç³»ç»Ÿç›´æ¥è¿›å…¥grubäº¤äº’ç•Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\nåˆ†åˆ«è¾“å…¥kernelå‚æ•°å’Œä¼ªæ ¹æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œå¹¶å¯åŠ¨\næŒ‡å®škernelå’Œinitrdçš„æ–‡ä»¶è·¯å¾„æ ¹ä¸º/bootæ‰€åœ¨çš„è®¾å¤‡åŠåˆ†åŒº;(hd0,0)ä»£è¡¨ç€ç¬¬ä¸€ä¸ªç¡¬ç›˜ä¸­ç¬¬ä¸€ä¸ªåˆ†åŒº\né‡å¯ä¹‹åï¼Œå¯ä»¥æ­£å¸¸ç™»é™†äº† # ç™»é™†ä¹‹åå†å»å®Œå–„/etc/fstabæ–‡ä»¶åŠgrub.confæ–‡ä»¶ï¼Œæœºå™¨å°±æ¢å¤æˆåŠŸäº†ã€‚","title":"/etc/fstabåŠ/bootåˆ†åŒºæ–‡ä»¶æ¢å¤"},{"content":"","date":"1 January 0001","permalink":"/categories/","section":"Categories","summary":"","title":"Categories"},{"content":"ğŸ¤æ„Ÿå…´è¶£å¯ä»¥åŠ ä¸ªå¥½å‹ ","date":"1 January 0001","permalink":"/me/","section":"Welcome to feixiang's blog ğŸ‰","summary":"ğŸ¤æ„Ÿå…´è¶£å¯ä»¥åŠ ä¸ªå¥½å‹ ","title":"My Wechat"}]